<%- include('partials/header', { title: 'Dashboard Admin' , user, role }) %>

<div class="admin-content-wrapper">
    <!-- Bootstrap 5 CSS & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <div class="container-fluid px-3 mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">Dashboard Administrateur</h2>
            </div>
        </div>

        <% if (referentScopeActive) { %>
            <div class="alert alert-secondary d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2" role="status">
                <span>
                    <strong>Vue actuelle :</strong>
                    <%= showAllScope ? 'tous les catalogues, commandes et paniers de votre organisation.' : 'uniquement les catalogues, commandes et paniers dont vous êtes référent.' %>
                </span>
                <div class="d-flex flex-wrap gap-2">
                    <a class="btn btn-outline-primary btn-sm" href="?scope=<%= showAllScope ? 'referent' : 'all' %>#catalogues">
                        <i class="bi bi-filter"></i>
                        <%= showAllScope ? 'Voir uniquement mes éléments' : 'Voir tous les éléments' %>
                    </a>
                </div>
            </div>
        <% } %>

        <div class="mb-4">
            <div class="d-flex flex-wrap gap-2 justify-content-center justify-md-start">
                <a href="#catalogues" class="badge bg-primary text-decoration-none fs-6 py-2 px-3">
                    <i class="bi bi-book-fill me-1"></i>Catalogues
                </a>
                <a href="#commandes" class="badge bg-success text-decoration-none fs-6 py-2 px-3">
                    <i class="bi bi-bag-check-fill me-1"></i>Commandes
                </a>
                <a href="#paniers" class="badge bg-warning text-decoration-none fs-6 py-2 px-3">
                    <i class="bi bi-cart-fill me-1"></i>Paniers
                </a>
            </div>
        </div>

        <!-- Section Catalogues -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 id="catalogues" class="fs-5">Catalogues concernés par les commandes ci-dessous</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tbcataloguesencours" style="width: 100%;">
                        <thead class="table-dark">
                            <tr>
                                <th class="small" style="width: 5%;">N°</th>
                                <th class="small" style="width: 15%;">Nom</th>
                                <th class="small" style="width: 25%;">Description</th>
                                <th class="small d-none d-md-table-cell" style="width: 15%;">Date d'expiration</th>
                                <th class="small d-none d-md-table-cell" style="width: 15%;">Date de livraison</th>
                                <th class="small" style="width: 25%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% catalogues.forEach(function(c) { %>
                                <% 
                                    const now = new Date();
                                    const catalogueExpirationDate = c.expiration_date ? new Date(c.expiration_date) : null;
                                    const catalogueIsExpired = catalogueExpirationDate ? catalogueExpirationDate < now : false;
                                                                        const ONE_DAY_MS = 24 * 60 * 60 * 1000;
                                                                        const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;
                                                                        const showPrevoirCommande = catalogueExpirationDate
                                                                            ? ((now - catalogueExpirationDate) >= ONE_DAY_MS && (now - catalogueExpirationDate) <= THREE_DAYS_MS)
                                                                            : false;
                                %>
                                <tr>
                                    <td class="small">
                                        <%= c.id %>
                                    </td>
                                    <td class="small">
                                        <a href="/admin/catalogues/<%= c.id %>/edit" class="text-decoration-none">
                                            <%= c.originalname %>
                                        </a>
                                        <% if (role === 'SuperAdmin' && c.organization_name) { %>
                                            <span class="badge bg-secondary ms-1"><%= c.organization_name %></span>
                                        <% } %>
                                                                        </td>
                                                                        <td class="small">
                                                <% 
                                                    const catalogueDescription = c.description || '';
                                                                                const truncatedDescription = catalogueDescription.length > 150
                                                                                    ? catalogueDescription.slice(0, 150) + '...'
                                                        : catalogueDescription;
                                                %>
                                                <span class="d-none d-md-inline"><%= truncatedDescription %></span>
                        <div class="d-md-none text-muted">
                            <% if (c.expiration_date) { %>
                                <% 
                                    const expDate = catalogueExpirationDate;
                                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                    const dayName = expDate ? dayNames[expDate.getDay()] : '';
                                %>
                                <small><strong>Expire:</strong> <%= dayName %> <%= formatDate(c.expiration_date) %>
                                    <% if (showPrevoirCommande) { %>
                                        <span class="text-danger fw-bold ms-1">prévoir la commande</span>
                                    <% } %>
                                </small>
                            <% } else { %>
                                <small><strong>Expire:</strong> Non définie</small>
                            <% } %>
                            <br>
                            <% if (c.date_livraison) { %>
                                <% 
                                    const livrDate = new Date(c.date_livraison);
                                    const livrDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                    const livrDayName = livrDayNames[livrDate.getDay()];
                                %>
                                <small><strong>Livraison:</strong> <%= livrDayName %> <%= formatDate(c.date_livraison) %></small>
                            <% } else { %>
                                <small><strong>Livraison:</strong> Non définie</small>
                            <% } %>
                        </div>
                    </td>
                                    <td class="small d-none d-md-table-cell">
                                        <% if (c.expiration_date) { %>
                                                <% 
                                                    const expDate = catalogueExpirationDate;
                                                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                    const dayName = expDate ? dayNames[expDate.getDay()] : '';
                                                %>
                                                <small class="text-muted d-block"><%= dayName %></small>
                                                <small><%= formatDate(c.expiration_date) %></small>
                                                <% if (showPrevoirCommande) { %>
                                                    <small class="text-danger fw-bold d-block">prévoir la commande</small>
                                                <% } %>
                                            <% } %>
                                    </td>
                                    <td class="small d-none d-md-table-cell">
                                        <% if (c.date_livraison) { %>
                                            <% 
                                                const livrDate = new Date(c.date_livraison);
                                                const livrDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                const livrDayName = livrDayNames[livrDate.getDay()];
                                            %>
                                            <small class="text-muted d-block"><%= livrDayName %></small>
                                            <small><%= formatDate(c.date_livraison) %></small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column flex-md-row gap-1">
                                            <a href="/admin/catalogues/<%= c.id %>/synthese"
                                                class="btn btn-primary btn-sm text-nowrap">Synthèse</a>
                                            <a href="/admin/catalogues/<%= c.id %>/synthese-detaillee"
                                                class="btn btn-info btn-sm text-nowrap">Synthèse détaillée</a>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section Commandes -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 id="commandes" class="fs-5">Commandes</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tbcommandesencours" style="width: 100%;">
                        <thead class="table-dark">
                            <tr>
                                <th class="small" style="width: 8%;">N°</th>
                                <th class="small" style="width: 15%;">Propriétaire</th>
                                <th class="small" style="width: 20%;">Catalogue</th>
                                <th class="small d-none d-md-table-cell" style="width: 15%;">Date de livraison</th>
                                <th class="small" style="width: 42%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% commandes.forEach(function(c) { %>
                                <% 
                                    const hier = new Date();
                                    hier.setDate(hier.getDate() - 1);
                                    const commandeExpirationDate = c.expiration_date ? new Date(c.expiration_date) : null;
                                    const commandeIsExpired = commandeExpirationDate ? commandeExpirationDate < hier : false;
                                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                    const commandeExpirationDayName = commandeExpirationDate ? dayNames[commandeExpirationDate.getDay()] : '';
                                %>
                                <tr>
                                    <td class="small">
                                        <%= c.id %>
                                    </td>
                                    <td class="small" data-search="<%= c.username %>">
                                        <%= c.username %>
                                        <% if (role === 'SuperAdmin' && c.organization_name) { %>
                                            <span class="badge bg-secondary ms-1"><%= c.organization_name %></span>
                                        <% } %>
                                        <div class="text-muted mt-1">
                                            <small><%= formatDateTime(c.created_at).split(' ')[0] %> <%= formatDateTime(c.created_at).split(' ')[1] %></small>
                                        </div>
                                    </td>
                                    <td class="small">
                                        <a href="/admin/catalogues/<%= c.catalog_file_id %>/edit" class="text-decoration-none">
                                            <%= c.catalogue %>(<%= c.catalog_file_id %>)
                                        </a>
                                    </td>

                                    <td class="small d-none d-md-table-cell">
                                        <% if (c.date_livraison) { %>
                                            <% 
                                                const commandeLivrDate = new Date(c.date_livraison);
                                                const commandeLivrDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                const commandeLivrDayName = commandeLivrDayNames[commandeLivrDate.getDay()];
                                            %>
                                            <small class="text-muted d-block"><%= commandeLivrDayName %></small>
                                            <small><%= formatDate(c.date_livraison) %></small>
                                        <% } else { %>
                                            <small class="text-muted">Non définie</small>
                                        <% } %>
                                    </td>
                                    <td data-search="">
                        <!-- Actions sur mobile : 2 lignes de 2 boutons avec icônes -->
                        <div class="d-md-none d-flex flex-column gap-1">
                            <!-- Première ligne : Détail + Note -->
                            <div class="d-flex gap-1">
                                <a href="/commandes/<%= c.id %>" class="btn btn-outline-primary btn-sm flex-fill"
                                   title="Voir le détail de cette commande">
                                    <i class="bi bi-eye"></i>
                                </a>
                <button type="button" class="btn btn-outline-info btn-sm flex-fill position-relative" 
                                        onclick="toggleNote(this)"
                                        title="<% if (c.note && c.note.trim() !== '') { %>Modifier la note<% } else { %>Ajouter une note<% } %>">
                                    <i class="bi bi-pencil-square"></i>
                                    <% if (c.note && c.note.trim() !== '') { %>
                                        <span class="badge bg-warning position-absolute top-0 start-100 translate-middle p-1" style="font-size: 0.6em;">!</span>
                                    <% } %>
                                </button>
                            </div>
                            <!-- Deuxième ligne : Panier + Supprimer -->
                            <div class="d-flex gap-1">
                                <% if (!commandeIsExpired) { %>
                                    <form method="POST" action="/commandes/<%= c.panier_id %>/edit" style="display:inline; flex: 1;">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <input type="hidden" name="source" value="A">
                                        <input type="hidden" name="user_id" value="<%= c.user_id %>">
                                        <button type="submit" class="btn btn-success btn-sm w-100"
                                               title="Remettre cette commande en statut panier pour modification"
                                               onclick="return confirm('Remettre cette commande en panier pour modification(ne pas oublier de repasser en commande si besoin est) ?')">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark flex-fill d-flex align-items-center justify-content-center" title="Catalogue expiré">
                                        Exp: <%= commandeExpirationDayName %> <%= formatDate(c.expiration_date) %>
                                    </span>
                                <% } %>
                                <form method="POST" action="/admin/commandes/<%= c.panier_id %>/delete" style="display:inline; flex: 1;">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <button type="submit" class="btn btn-danger btn-sm w-100"
                                        title="Supprimer définitivement cette commande"
                                        onclick="return confirm('Supprimer cette commande ?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Actions sur desktop : 2 lignes de 2 boutons avec texte -->
                        <div class="d-none d-md-flex flex-column gap-1">
                            <!-- Première ligne : Détail + Note -->
                            <div class="d-flex gap-1">
                                <a href="/commandes/<%= c.id %>" class="btn btn-outline-primary btn-sm flex-fill"
                                   title="Voir le détail de cette commande">
                                    <i class="bi bi-eye"></i> Détail
                                </a>
                <button type="button" class="btn btn-outline-info btn-sm flex-fill" 
                                        onclick="toggleNote(this)">
                                    <i class="bi bi-pencil-square"></i> 
                                    <% if (c.note && c.note.trim() !== '') { %>
                                        Note <span class="badge bg-warning">!</span>
                                    <% } else { %>
                                        Note
                                    <% } %>
                                </button>
                            </div>
                            <!-- Deuxième ligne : Panier + Supprimer -->
                            <div class="d-flex gap-1">
                                <% if (!commandeIsExpired) { %>
                                    <form method="POST" action="/commandes/<%= c.panier_id %>/edit" style="display:inline; flex: 1;">
                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                        <input type="hidden" name="source" value="A">
                                        <input type="hidden" name="user_id" value="<%= c.user_id %>">
                                        <button type="submit" class="btn btn-success btn-sm w-100"
                                               title="Remettre cette commande en statut panier pour modification"
                                               onclick="return confirm('Remettre cette commande en panier pour modification ?')">
                                            <i class="bi bi-arrow-counterclockwise"></i> Panier
                                        </button>
                                    </form>
                                <% } else { %>
                                    <span class="badge bg-warning text-dark flex-fill d-flex align-items-center justify-content-center" title="Catalogue expiré">
                                        Exp: <%= commandeExpirationDayName %> <%= formatDate(c.expiration_date) %>
                                    </span>
                                <% } %>
                                <form method="POST" action="/admin/commandes/<%= c.panier_id %>/delete" style="display:inline; flex: 1;">
                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                    <button type="submit" class="btn btn-danger btn-sm w-100"
                                        title="Supprimer définitivement cette commande"
                                        onclick="return confirm('Supprimer cette commande ?')">
                                        <i class="bi bi-trash"></i> Supprimer
                                    </button>
                                </form>
                            </div>
                        </div>
                                        
                                        <!-- Formulaire note (masqué par défaut) -->
                                        <form action="/commandes/<%= c.id %>/note" method="POST" 
                                style="display: none;" class="mt-2 note-form">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <input type="hidden" name="source" value="A">
                                            <div class="input-group input-group-sm">
                                                <textarea name="note" rows="2" class="form-control"
                                                    placeholder="Ajouter une note..." style="resize: none;"><%= c.note || '' %></textarea>
                                                <button type="submit" class="btn btn-info btn-sm"
                                                       title="Sauvegarder la note">Sauver</button>
                              <button type="button" class="btn btn-outline-secondary btn-sm"
                                  onclick="toggleNote(this)"
                                                       title="Annuler">Annuler</button>
                                            </div>
                                        </form>
                                        
                                        <!-- Affichage de la note existante si elle existe -->
                                        <% if (c.note && c.note.trim() !== '') { %>
                                        <div class="small text-muted mt-1 note-display">
                                            <strong>Note:</strong> <%= c.note %>
                                        </div>
                                        <% } %>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section Paniers -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 id="paniers" class="fs-5">Paniers en cours</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tbpaniersencours" style="width: 100%;">
                        <thead class="table-dark">
                            <tr>
                                <th class="small" style="width: 5%;">N°</th>
                                <th class="small" style="width: 15%;">Propriétaire</th>
                                <th class="small" style="width: 25%;">Catalogue</th>
                                <th class="small d-none d-md-table-cell" style="width: 15%;">Date d'expiration</th>
                                <th class="small d-none d-md-table-cell" style="width: 15%;">Date ajout</th>
                                <th class="small" style="width: 25%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% paniers.forEach(function(p) { %>
                                <tr>
                                    <td>
                                        <%= p.id %>
                                    </td>
                                    <td data-search="<%= p.username %>">
                                        <%= p.username %>
                                        <% if (role === 'SuperAdmin' && p.organization_name) { %>
                                            <span class="badge bg-secondary ms-1"><%= p.organization_name %></span>
                                        <% } %>
                                    </td>
                                    <td data-search="">
                                        <a href="/admin/catalogues/<%= p.catalog_file_id %>/edit" class="text-decoration-none">
                                            <%= p.catalogue %>(<%= p.id2 %>)
                                        </a>
                                        <!-- Dates affichées sous le catalogue sur mobile -->
                                        <div class="d-md-none small text-muted mt-1">
                                            <% if (p.expiration_date) { %>
                                                <% 
                                                    const mobileExpDate = new Date(p.expiration_date);
                                                    const mobileDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                    const mobileExpDayName = mobileDayNames[mobileExpDate.getDay()];
                                                %>
                                                <div>Exp: <%= mobileExpDayName %> <%= formatDate(p.expiration_date) %></div>
                                            <% } else { %>
                                                <div>Exp: Non définie</div>
                                            <% } %>
                                            <% 
                                                const panierAddDate = new Date(p.created_at);
                                                const panierAddDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                const panierAddDayName = panierAddDayNames[panierAddDate.getDay()];
                                            %>
                                            <div>Ajouté: <%= panierAddDayName %> <%= formatDateTime(p.created_at) %></div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <% if (p.expiration_date) { %>
                                            <% 
                                                const panierExpDate = new Date(p.expiration_date);
                                                const panierExpDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                                const panierExpDayName = panierExpDayNames[panierExpDate.getDay()];
                                            %>
                                            <small class="text-muted d-block"><%= panierExpDayName %></small>
                                            <small><%= formatDate(p.expiration_date) %></small>
                                        <% } %>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <% 
                                            const panierCreatedDate = new Date(p.created_at);
                                            const panierCreatedDayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                                            const panierCreatedDayName = panierCreatedDayNames[panierCreatedDate.getDay()];
                                        %>
                                        <small class="text-muted d-block"><%= panierCreatedDayName %></small>
                                        <small><%= formatDateTime(p.created_at) %></small>
                                    </td>
                                    <td data-search="">
                                        <!-- Actions sur mobile : boutons compacts avec icônes uniquement -->
                                        <div class="d-md-none d-flex flex-column gap-1">
                                            <!-- Changement propriétaire mobile -->
                                            <div class="d-flex gap-1">
                                                <form action="/panier/<%= p.id %>/A/change-owner" method="POST" class="d-flex flex-fill">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <select name="user_id" class="form-select form-select-sm flex-fill" required style="font-size: 0.75rem;">
                                                        <% utilisateurs.forEach(u=> { %>
                                                            <option value="<%= u.id %>" <% if (u.id===p.user_id) { %>selected<% } %>><%= u.username %></option>
                                                        <% }) %>
                                                    </select>
                                                    <button type="submit" class="btn btn-warning btn-sm ms-1" 
                                                            title="Changer le propriétaire"
                                                            onclick="return confirm('Confirmer le changement ?')">
                                                        <i class="bi bi-arrow-left-right"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            <!-- Boutons d'actions mobile -->
                                            <div class="d-flex gap-1">
                                                <% if (p.modifiable) { %>
                                                    <a href="/panier/<%= p.id %>/modifier/vue" class="btn btn-primary btn-sm flex-fill" title="Modifier ce panier">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <form method="POST" action="/panier/submit" style="display:inline; flex: 1;">
                                                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                        <input type="hidden" name="panier_id" value="<%= p.id %>">
                                                        <input type="hidden" name="source" value="A">
                                                        <input type="hidden" name="note" value="<%= p.note || '' %>">
                                                        <button type="submit" class="btn btn-success btn-sm w-100"
                                                                title="Valider ce panier"
                                                                onclick="return confirm('Valider ce panier ?')">
                                                            <i class="bi bi-check-lg"></i>
                                                        </button>
                                                    </form>
                                                <% } else { %>
                                                    <span class="badge bg-warning text-dark flex-fill">Catalogue expiré</span>
                                                <% } %>
                                                <form method="POST" action="/admin/paniers/<%= p.id %>/delete" style="display:inline; flex: 1;">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <button type="submit" class="btn btn-danger btn-sm w-100"
                                                            title="Supprimer ce panier"
                                                            onclick="return confirm('Supprimer ce panier ?')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        <!-- Actions sur desktop : boutons avec texte -->
                                        <div class="d-none d-md-flex gap-1 flex-wrap">
                                            <!-- Changement propriétaire -->
                                            <form action="/panier/<%= p.id %>/A/change-owner" method="POST"
                                                class="d-flex">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <select name="user_id" class="form-select form-select-sm me-1" required
                                                    style="width: 120px;">
                                                    <% utilisateurs.forEach(u=> { %>
                                                        <option value="<%= u.id %>" <% if (u.id===p.user_id) { %>
                                                            selected<% } %>><%= u.username %>
                                                        </option>
                                                        <% }) %>
                                                </select>
                                                <button type="submit" class="btn btn-warning btn-sm"
                                                    onclick="return confirm('Confirmer le changement ?')">
                                                    Changer
                                                </button>
                                            </form>

                                            <% if (p.modifiable) { %>
                                                <a href="/panier/<%= p.id %>/modifier/vue" class="btn btn-primary btn-sm">Modifier</a>
                                                <form method="POST" action="/panier/submit" style="display:inline;">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <input type="hidden" name="panier_id" value="<%= p.id %>">
                                                    <input type="hidden" name="source" value="A">
                                                    <input type="hidden" name="note" value="<%= p.note || '' %>">
                                                    <button type="submit" class="btn btn-success btn-sm"
                                                        onclick="return confirm('Valider ce panier ?')">
                                                        Valider
                                                    </button>
                                                </form>
                                            <% } else { %>
                                                <span class="badge bg-warning text-dark">Catalogue expiré</span>
                                            <% } %>
                                            <form method="POST" action="/admin/paniers/<%= p.id %>/delete"
                                                style="display:inline;">
                                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                <button type="submit" class="btn btn-danger btn-sm"
                                                    onclick="return confirm('Supprimer ce panier ?')">
                                                    Supprimer
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bouton retour -->
        <div class="row">
            <div class="col-12">
                <a href="/admin/menu" class="btn btn-secondary">← Retour menu admin</a>
            </div>
        </div>
    </div>

    <!-- jQuery (obligatoire pour DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $(document).ready(function () {
            // Initialisation des tooltips Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Initialisation DataTables pour les trois tables
            $('#tbcataloguesencours').DataTable({
                responsive: true,
                order: [[0, 'desc']],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json'
                }, 
                dom: '<"row mb-3"<"col-sm-6"f><"col-sm-6"l>>rtip',
                columnDefs: [
                    { 
                        "targets": [3], // Date d'expiration
                        "type": "date",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
                                if (data && data !== 'N/A' && data.trim() !== '') {
                                    // Extraire tout le texte du HTML
                                    let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
                                    
                                    // Chercher un pattern DD/MM/YYYY dans le texte
                                    const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                                    if (dateMatch) {
                                        // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                                        const day = dateMatch[1].padStart(2, '0');
                                        const month = dateMatch[2].padStart(2, '0');
                                        const year = dateMatch[3];
                                        return year + '-' + month + '-' + day;
                                    }
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { 
                        "targets": [4], // Date de livraison
                        "type": "date",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
                                if (data && data !== 'N/A' && data.trim() !== '') {
                                    // Extraire tout le texte du HTML
                                    let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
                                    
                                    // Chercher un pattern DD/MM/YYYY dans le texte
                                    const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                                    if (dateMatch) {
                                        // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                                        const day = dateMatch[1].padStart(2, '0');
                                        const month = dateMatch[2].padStart(2, '0');
                                        const year = dateMatch[3];
                                        return year + '-' + month + '-' + day;
                                    }
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { "orderable": false, "targets": [5] } // Désactiver le tri sur la colonne Actions
                ]
            });
            $('#tbcommandesencours').DataTable({
                responsive: true,
                order: [[0, 'desc']],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json'
                },
                dom: '<"row mb-3"<"col-sm-6"f><"col-sm-6"l>>rtip',
                columnDefs: [
                    { 
                        "targets": [1], // Colonne Propriétaire
                        "searchable": true
                    },
                    { 
                        "targets": [2], // Colonne Catalogue
                        "className": "text-start",
                        "type": "string",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri, normaliser le texte (supprimer HTML, espaces, accents)
                                if (data) {
                                    let text = data.toString().trim();
                                    // Supprimer les balises HTML si présentes
                                    text = text.replace(/<[^>]*>/g, '');
                                    // Normaliser les espaces multiples
                                    text = text.replace(/\s+/g, ' ').trim();
                                    
                                    // Chercher un pattern comme "TEXTE(XX)" ou "TEXTE (XX)" pour extraire le numéro
                                    const match = text.match(/^(.+?)\s*\((\d+)\)$/);
                                    if (match) {
                                        // Retourner le texte normalisé + numéro padé pour tri correct
                                        const baseName = match[1].trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                                        const number = match[2].padStart(5, '0');
                                        return baseName.toLowerCase() + ' (' + number + ')';
                                    }
                                    // Si pas de numéro, normaliser juste le texte
                                    text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                                    return text.toLowerCase();
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { 
                        "targets": [3], // Date de livraison (maintenant colonne 3)
                        "type": "date",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
                                if (data && data !== 'N/A' && data.trim() !== '') {
                                    // Extraire tout le texte du HTML
                                    let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
                                    
                                    // Chercher un pattern DD/MM/YYYY dans le texte
                                    const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                                    if (dateMatch) {
                                        // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                                        const day = dateMatch[1].padStart(2, '0');
                                        const month = dateMatch[2].padStart(2, '0');
                                        const year = dateMatch[3];
                                        return year + '-' + month + '-' + day;
                                    }
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { "orderable": false, "targets": [4] } // Désactiver le tri sur la colonne Actions (maintenant colonne 4)
                ]
            });
            $('#tbpaniersencours').DataTable({
                responsive: true,
                order: [[0, 'desc']],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json'
                },
                dom: '<"row mb-3"<"col-sm-6"f><"col-sm-6"l>>rtip',
                columnDefs: [
                    { 
                        "targets": [1], // Colonne Propriétaire
                        "searchable": true
                    },
                    { 
                        "targets": [2], // Colonne Catalogue
                        "className": "text-start",
                        "type": "string",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri, normaliser le texte (supprimer HTML, espaces, accents)
                                if (data) {
                                    let text = data.toString().trim();
                                    // Supprimer les balises HTML si présentes
                                    text = text.replace(/<[^>]*>/g, '');
                                    // Normaliser les espaces multiples
                                    text = text.replace(/\s+/g, ' ').trim();
                                    
                                    // Chercher un pattern comme "TEXTE(XX)" ou "TEXTE (XX)" pour extraire le numéro
                                    const match = text.match(/^(.+?)\s*\((\d+)\)$/);
                                    if (match) {
                                        // Retourner le texte normalisé + numéro padé pour tri correct
                                        const baseName = match[1].trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                                        const number = match[2].padStart(5, '0');
                                        return baseName.toLowerCase() + ' (' + number + ')';
                                    }
                                    // Si pas de numéro, normaliser juste le texte
                                    text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                                    return text.toLowerCase();
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { 
                        "targets": [3], // Date d'expiration
                        "type": "date",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
                                if (data && data !== 'N/A' && data.trim() !== '') {
                                    // Extraire tout le texte du HTML
                                    let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
                                    
                                    // Chercher un pattern DD/MM/YYYY dans le texte
                                    const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                                    if (dateMatch) {
                                        // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                                        const day = dateMatch[1].padStart(2, '0');
                                        const month = dateMatch[2].padStart(2, '0');
                                        const year = dateMatch[3];
                                        return year + '-' + month + '-' + day;
                                    }
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { 
                        "targets": [4], // Date ajout
                        "type": "date",
                        "render": function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
                                if (data && data !== 'N/A' && data.trim() !== '') {
                                    // Extraire tout le texte du HTML
                                    let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
                                    
                                    // Chercher un pattern DD/MM/YYYY dans le texte
                                    const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                                    if (dateMatch) {
                                        // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                                        const day = dateMatch[1].padStart(2, '0');
                                        const month = dateMatch[2].padStart(2, '0');
                                        const year = dateMatch[3];
                                        return year + '-' + month + '-' + day;
                                    }
                                }
                                return '';
                            }
                            return data;
                        }
                    },
                    { "orderable": false, "targets": [5] } // Désactiver le tri sur la colonne Actions (maintenant colonne 5)
                ]
            });

            // Initialisation manuelle des dropdowns Bootstrap après DataTables
            setTimeout(function() {
                console.log('Initialisation des dropdowns...');
                
                // Vérifier si Bootstrap est disponible
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap n\'est pas disponible');
                    return;
                }
                
                // Réinitialiser tous les dropdowns
                var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
                console.log('Dropdowns trouvés:', dropdownElementList.length);
                
                // Debug : afficher les IDs des dropdowns trouvés
                dropdownElementList.forEach(function(element, index) {
                    console.log('Dropdown ' + index + ':', {
                        id: element.id,
                        hasDataBsToggle: element.hasAttribute('data-bs-toggle'),
                        dataToggleValue: element.getAttribute('data-bs-toggle'),
                        parentHasDropdownClass: element.closest('.dropdown') !== null
                    });
                });
                
                // Détruire les instances existantes d'abord
                dropdownElementList.forEach(function(element) {
                    var existingInstance = bootstrap.Dropdown.getInstance(element);
                    if (existingInstance) {
                        existingInstance.dispose();
                    }
                });
                
                // Créer de nouvelles instances
                var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                    try {
                        console.log('Initialisation dropdown avec ID:', dropdownToggleEl.id);
                        var instance = new bootstrap.Dropdown(dropdownToggleEl);
                        
                        // Test d'ouverture/fermeture pour vérifier que ça fonctionne
                        console.log('Instance créée pour:', dropdownToggleEl.id);
                        return instance;
                    } catch (error) {
                        console.error('Erreur lors de l\'initialisation du dropdown:', error);
                        return null;
                    }
                });
                
                console.log('Dropdowns initialisés avec succès:', dropdownList.filter(d => d !== null).length);
                
                // Si aucun dropdown n'a été initialisé avec succès, utiliser le fallback
                var successfulDropdowns = dropdownList.filter(d => d !== null).length;
                if (successfulDropdowns === 0 && dropdownElementList.length > 0) {
                    console.log('Aucun dropdown Bootstrap initialisé, passage en mode fallback...');
                    initFallbackDropdowns();
                }
                
                // Test manuel d'un dropdown pour vérifier le fonctionnement
                if (dropdownElementList.length > 0 && successfulDropdowns > 0) {
                    console.log('Test d\'ouverture du premier dropdown...');
                    setTimeout(function() {
                        var firstDropdown = bootstrap.Dropdown.getInstance(dropdownElementList[0]);
                        if (firstDropdown) {
                            console.log('Test: ouverture du dropdown');
                            firstDropdown.show();
                            setTimeout(function() {
                                console.log('Test: fermeture du dropdown');
                                firstDropdown.hide();
                            }, 1000);
                        }
                    }, 500);
                }
            }, 1000); // Augmenté à 1 seconde pour s'assurer que DataTables est complètement initialisé
        });

        // Fonction fallback pour gérer manuellement les dropdowns si Bootstrap échoue
        function initFallbackDropdowns() {
            console.log('Initialisation fallback des dropdowns...');
            
            // Trouver tous les boutons dropdown
            var dropdownButtons = document.querySelectorAll('.dropdown-toggle');
            
            dropdownButtons.forEach(function(button) {
                // Supprimer les anciens listeners
                button.removeEventListener('click', handleDropdownClick);
                
                // Ajouter le nouveau listener
                button.addEventListener('click', handleDropdownClick);
                console.log('Listener fallback ajouté pour:', button.id);
            });
            
            // Fermer les dropdowns en cliquant ailleurs
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown')) {
                    var openDropdowns = document.querySelectorAll('.dropdown-menu.show');
                    openDropdowns.forEach(function(menu) {
                        menu.classList.remove('show');
                    });
                }
            });
        }
        
        function handleDropdownClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            var button = event.currentTarget;
            var dropdown = button.closest('.dropdown');
            var menu = dropdown.querySelector('.dropdown-menu');
            
            // Fermer tous les autres dropdowns
            var allMenus = document.querySelectorAll('.dropdown-menu.show');
            allMenus.forEach(function(otherMenu) {
                if (otherMenu !== menu) {
                    otherMenu.classList.remove('show');
                }
            });
            
            // Toggle ce dropdown
            menu.classList.toggle('show');
            console.log('Dropdown toggled:', button.id, 'showing:', menu.classList.contains('show'));
        }

        // Fonction pour afficher/masquer les formulaires de note
        function toggleNote(element) {
            const cell = element.closest('td');
            if (!cell) {
                return;
            }

            const form = cell.querySelector('.note-form');
            if (!form) {
                return;
            }

            const display = cell.querySelector('.note-display');
            const shouldShow = form.style.display === 'none' || form.style.display === '';

            if (shouldShow) {
                form.style.display = 'block';
                if (display) {
                    display.style.display = 'none';
                }

                const textarea = form.querySelector('textarea');
                if (textarea) {
                    textarea.focus();
                }
            } else {
                form.style.display = 'none';
                if (display) {
                    display.style.display = 'block';
                }
            }
        }
    </script>

</div>
<%- include('partials/footer') %>