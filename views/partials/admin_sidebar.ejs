<style>
  body {
    overflow-x: hidden;
  }

  .admin-layout {
    display: flex;
    min-height: calc(100vh - 120px);
  }

  .admin-sidebar {
    width: 280px;
    background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
    border-right: 1px solid #dee2e6;
    padding: 0.5rem 0;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    overflow-y: auto;
    transition: transform 0.3s ease, opacity 0.15s ease;
    z-index: 900;
    will-change: transform, opacity;
  }

  .admin-sidebar.sidebar-hidden {
    transform: translateX(-100%);
    pointer-events: none; /* Empêche les interactions avec le sidebar masqué */
  }

  .admin-content-wrapper {
    margin-left: 280px;
    flex: 1;
    width: calc(100% - 280px);
    max-width: calc(100% - 280px);
    animation: fadeIn 0.2s ease-in;
    transition: margin-left 0.3s ease, width 0.3s ease, max-width 0.3s ease;
  }

  .admin-content-wrapper.sidebar-hidden {
    margin-left: 0;
    width: 100%;
    max-width: 100%;
  }

  /* Forcer les conteneurs à utiliser toute la largeur quand sidebar masqué */
  body.sidebar-hidden .admin-content-wrapper .container-fluid {
    max-width: 100%;
    width: 100%;
  }

  body.sidebar-hidden .admin-content-wrapper .container {
    max-width: 100%;
    width: 100%;
  }

  /* S'assurer que tous les éléments utilisent toute la largeur */
  body.sidebar-hidden .admin-content-wrapper {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
  }

  body.sidebar-hidden .admin-content-wrapper > * {
    max-width: 100% !important;
  }

  /* Supprimer toute marge/padding qui pourrait créer une bande vide */
  body.sidebar-hidden .admin-content-wrapper .row,
  body.sidebar-hidden .admin-content-wrapper .col,
  body.sidebar-hidden .admin-content-wrapper [class*="col-"] {
    margin-left: 0;
    padding-left: 0.75rem; /* Garder le padding Bootstrap normal */
    padding-right: 0.75rem;
  }

  /* S'assurer que les tableaux et autres éléments utilisent toute la largeur */
  body.sidebar-hidden .admin-content-wrapper table,
  body.sidebar-hidden .admin-content-wrapper .card,
  body.sidebar-hidden .admin-content-wrapper .card-body {
    width: 100%;
    max-width: 100%;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .ms-280 {
    margin-left: 280px !important;
    transition: margin-left 0.3s ease;
  }

  /* Supprimer toutes les marges liées au sidebar quand masqué */
  body.sidebar-hidden .ms-280,
  body.sidebar-hidden .alert.ms-280,
  body.sidebar-hidden div.ms-280,
  body.sidebar-hidden * .ms-280 {
    margin-left: 0 !important;
  }

  /* Ajuster les alertes quand le sidebar est masqué */
  body.sidebar-hidden .alert.ms-280 {
    margin-left: 1rem !important;
    margin-right: 1rem !important;
  }

  /* S'assurer que le body n'a pas de margin/padding qui crée une bande */
  body.sidebar-hidden {
    margin-left: 0 !important;
    padding-left: 0 !important;
  }

  /* Supprimer spécifiquement les marges gauches qui pourraient créer une bande */
  body.sidebar-hidden .admin-content-wrapper {
    margin-left: 0 !important;
    padding-left: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* S'assurer que le contenu utilise toute la largeur */
  body.sidebar-hidden .admin-content-wrapper > .container-fluid,
  body.sidebar-hidden .admin-content-wrapper > .container {
    width: 100% !important;
    max-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
  }

  /* Exception : garder les paddings Bootstrap normaux pour les colonnes */
  body.sidebar-hidden .admin-content-wrapper [class*="col-"] {
    padding-left: 0.75rem !important;
    padding-right: 0.75rem !important;
  }

  .sidebar-toggle-btn {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1000;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: left 0.3s ease, transform 0.2s ease, background 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #495057;
  }

  .sidebar-toggle-btn:hover {
    background: #f8f9fa;
    transform: scale(1.05);
    color: #007bff;
  }

  .admin-sidebar.sidebar-hidden ~ .sidebar-toggle-btn,
  body.sidebar-hidden .sidebar-toggle-btn {
    left: 1rem;
  }

  .sidebar-section {
    margin-bottom: 0.25rem;
  }

  .sidebar-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 700;
    color: #6c757d;
    padding: 0.5rem 1rem;
    margin-bottom: 0;
    letter-spacing: 0.3px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sidebar-section-title:hover {
    background: rgba(0, 123, 255, 0.05);
    color: #007bff;
  }

  .sidebar-section-title .toggle-icon {
    transition: transform 0.2s ease;
    font-size: 0.75rem;
    margin-left: auto;
    flex-shrink: 0;
  }

  .sidebar-section-title.collapsed .toggle-icon {
    transform: rotate(-90deg);
  }

  /* Section avec lien dans le titre (ex. Administration → accueil) ou texte + chevron */
  .sidebar-section-title-with-link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  .sidebar-section-title-text {
    flex: 1;
    min-width: 0;
  }
  .sidebar-section-title-link {
    flex: 1;
    min-width: 0;
    text-decoration: none;
    color: inherit;
    padding: 0.5rem 0;
    display: flex;
    align-items: center;
  }
  .sidebar-section-title-link:hover {
    color: inherit;
  }
  .sidebar-section-precommandes .sidebar-section-title-link:hover {
    color: #1a4a7a;
  }
  .sidebar-section-caisse .sidebar-section-title-link:hover {
    color: #1e4d1e;
  }
  .sidebar-section-administration .sidebar-section-title-link:hover {
    color: #5c4610;
  }
  .sidebar-section-admin-site .sidebar-section-title-link:hover {
    color: #6b2e00;
  }
  .sidebar-section-title-link.active {
    font-weight: 600;
  }
  .sidebar-section-toggle {
    flex-shrink: 0;
    background: none;
    border: none;
    padding: 0.35rem;
    cursor: pointer;
    color: inherit;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sidebar-section-toggle:hover {
    background: rgba(0, 0, 0, 0.06);
  }
  .sidebar-section-precommandes .sidebar-section-toggle:hover {
    background: rgba(135, 206, 250, 0.25);
  }
  .sidebar-section-caisse .sidebar-section-toggle:hover {
    background: rgba(144, 238, 144, 0.3);
  }
  .sidebar-section-administration .sidebar-section-toggle:hover {
    background: rgba(255, 235, 156, 0.4);
  }
  .sidebar-section-admin-site .sidebar-section-toggle:hover {
    background: rgba(255, 183, 77, 0.35);
  }
  .sidebar-section-mon-compte .sidebar-section-toggle:hover {
    background: rgba(200, 190, 220, 0.2);
  }
  .sidebar-section-toggle .toggle-icon {
    font-size: 0.75rem;
    transition: transform 0.2s ease;
  }
  .sidebar-section-toggle.collapsed .toggle-icon {
    transform: rotate(-90deg);
  }

  .sidebar-section-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.2s ease;
    opacity: 1;
  }

  .sidebar-section-content.collapsed {
    max-height: 0 !important;
    opacity: 0;
  }

  .sidebar-subsection-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #dee2e6, transparent);
    margin: 0.5rem 1rem;
  }

  /* Sous-section repliable (ex. Administration > Stock) */
  .sidebar-subsection-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #7a5e12;
    padding: 0.4rem 1rem 0.4rem 1.25rem;
    margin-top: 0.25rem;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 0.35rem;
    transition: background 0.2s ease;
  }
  .sidebar-subsection-title-with-link {
    cursor: default;
  }
  .sidebar-subsection-title-with-link:hover {
    background: rgba(255, 235, 156, 0.3);
  }
  .sidebar-subsection-title-link {
    color: #7a5e12;
    text-decoration: none;
    font-weight: 600;
    flex: 1;
    padding: 0.2rem 0;
  }
  .sidebar-subsection-title-link:hover {
    color: #5c4610;
  }
  .sidebar-subsection-toggle {
    background: none;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sidebar-subsection-toggle .toggle-icon {
    font-size: 0.7rem;
    transition: transform 0.2s ease;
  }
  .sidebar-subsection-toggle.collapsed .toggle-icon {
    transform: rotate(-90deg);
  }
  .sidebar-subsection-title:hover {
    background: rgba(255, 235, 156, 0.3);
  }
  .sidebar-subsection-title .toggle-icon {
    font-size: 0.7rem;
    transition: transform 0.2s ease;
  }
  .sidebar-subsection-title.collapsed .toggle-icon {
    transform: rotate(-90deg);
  }
  .sidebar-subsection-content {
    max-height: 800px;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.2s ease;
    opacity: 1;
  }
  .sidebar-subsection-content.collapsed {
    max-height: 0 !important;
    opacity: 0;
  }
  .sidebar-subsection-content .sidebar-menu-item {
    padding-left: 1.5rem;
    font-size: 0.85rem;
  }

  .sidebar-menu-item {
    display: block;
    padding: 0.5rem 1rem;
    color: #495057;
    text-decoration: none;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    font-size: 0.9rem;
  }

  .sidebar-menu-item:hover {
    background: rgba(0, 123, 255, 0.1);
    border-left-color: #007bff;
    color: #007bff;
  }

  .sidebar-menu-item.active {
    background: rgba(0, 123, 255, 0.15);
    border-left-color: #007bff;
    color: #007bff;
    font-weight: 600;
  }

  .sidebar-menu-item i {
    width: 20px;
    margin-right: 0.5rem;
    text-align: center;
    font-size: 0.95rem;
  }

  .sidebar-menu-admin {
    background: rgba(108, 117, 125, 0.08);
    color: #6c757d;
  }

  .sidebar-menu-admin:hover {
    background: rgba(108, 117, 125, 0.15);
    border-left-color: #6c757d;
    color: #495057;
  }

  .sidebar-menu-admin.active {
    background: rgba(108, 117, 125, 0.2);
    border-left-color: #6c757d;
    color: #495057;
    font-weight: 600;
  }

  /* Couleurs pastel pour les sections */

  /* Caisse - Vert pastel, textes foncés pour lisibilité */
  .sidebar-section-caisse {
    background: linear-gradient(to right, rgba(144, 238, 144, 0.12), transparent);
  }

  .sidebar-section-caisse .sidebar-section-title {
    color: #2d6a2d;
  }

  .sidebar-section-caisse .sidebar-menu-item {
    background: rgba(144, 238, 144, 0.08);
    color: #2d6a2d;
  }

  .sidebar-section-caisse .sidebar-menu-item:hover {
    background: rgba(144, 238, 144, 0.2);
    border-left-color: #3d7a3d;
    color: #1e4d1e;
  }

  .sidebar-section-caisse .sidebar-menu-item.active {
    background: rgba(144, 238, 144, 0.25);
    border-left-color: #3d7a3d;
    color: #1e4d1e;
  }

  /* Pré-commandes - Bleu pastel, textes foncés pour lisibilité */
  .sidebar-section-precommandes .sidebar-section-title {
    background: rgba(135, 206, 250, 0.15);
    color: #2a6a94;
  }

  .sidebar-section-precommandes .sidebar-section-content {
    background: rgba(135, 206, 250, 0.03);
  }

  .sidebar-section-precommandes .sidebar-menu-item {
    background: rgba(135, 206, 250, 0.08);
    color: #2a6a94;
  }

  .sidebar-section-precommandes .sidebar-menu-item:hover {
    background: rgba(135, 206, 250, 0.2);
    border-left-color: #3d7ab5;
    color: #1a4a7a;
  }

  .sidebar-section-precommandes .sidebar-menu-item.active {
    background: rgba(135, 206, 250, 0.25);
    border-left-color: #3d7ab5;
    color: #1a4a7a;
  }

  /* Administration - Jaune pastel, textes foncés pour lisibilité */
  .sidebar-section-administration .sidebar-section-title {
    background: rgba(255, 235, 156, 0.3);
    color: #8b6914;
  }

  .sidebar-section-administration .sidebar-section-content {
    background: rgba(255, 235, 156, 0.05);
  }

  .sidebar-section-administration .sidebar-menu-item {
    background: rgba(255, 235, 156, 0.12);
    color: #7a5e12;
  }

  .sidebar-section-administration .sidebar-menu-item:hover {
    background: rgba(255, 235, 156, 0.35);
    border-left-color: #9a7b1a;
    color: #5c4610;
  }

  .sidebar-section-administration .sidebar-menu-item.active {
    background: rgba(255, 235, 156, 0.4);
    border-left-color: #9a7b1a;
    color: #5c4610;
  }

  /* En-têtes de tableaux : même pastel que le menu Administration (jaune, très clair) */
  .thead-administration th,
  .table thead.thead-administration th {
    background: rgba(255, 235, 156, 0.35) !important;
    color: #9a7b1a !important;
    border-color: rgba(212, 166, 23, 0.2);
  }

  /* Admin Site - Orange pastel, textes foncés pour lisibilité */
  .sidebar-section-admin-site .sidebar-section-title {
    background: rgba(255, 183, 77, 0.2);
    color: #a54a00;
  }

  .sidebar-section-admin-site .sidebar-section-content {
    background: rgba(255, 183, 77, 0.05);
  }

  .sidebar-section-admin-site .sidebar-menu-item {
    background: rgba(255, 183, 77, 0.12);
    color: #8b3d00;
  }

  .sidebar-section-admin-site .sidebar-menu-item:hover {
    background: rgba(255, 183, 77, 0.25);
    border-left-color: #b85a0a;
    color: #6b2e00;
  }

  .sidebar-section-admin-site .sidebar-menu-item.active {
    background: rgba(255, 183, 77, 0.3);
    border-left-color: #b85a0a;
    color: #6b2e00;
  }

  /* Mon compte - Gris/violet pastel pour le bloc utilisateur */
  .sidebar-section-mon-compte .sidebar-section-title {
    background: rgba(200, 190, 220, 0.25);
    color: #5a4a7a;
  }

  .sidebar-section-mon-compte .sidebar-section-content {
    background: rgba(200, 190, 220, 0.06);
  }

  .sidebar-section-mon-compte .sidebar-menu-item {
    background: rgba(200, 190, 220, 0.1);
    color: #5a4a7a;
  }

  .sidebar-section-mon-compte .sidebar-menu-item:hover {
    background: rgba(200, 190, 220, 0.2);
    border-left-color: #6a5a8a;
    color: #4a3a6a;
  }

  .sidebar-section-mon-compte .sidebar-menu-item.active {
    background: rgba(200, 190, 220, 0.25);
    border-left-color: #6a5a8a;
    color: #4a3a6a;
  }

  /* En-têtes de tableaux : même pastel que le menu Admin Site (orange, très clair) */
  .thead-admin-site th,
  .table thead.thead-admin-site th {
    background: rgba(255, 183, 77, 0.28) !important;
    color: #b85a0a !important;
    border-color: rgba(230, 126, 34, 0.2);
  }
  .card-header-admin-site {
    background: rgba(255, 183, 77, 0.28) !important;
    color: #b85a0a !important;
    border-color: rgba(230, 126, 34, 0.2);
  }
  .text-admin-site { color: #e67e22 !important; }
  .btn-admin-site {
    background-color: #e67e22;
    border-color: #e67e22;
    color: white;
  }
  .btn-admin-site:hover {
    background-color: #d86e22;
    border-color: #d86e22;
    color: white;
  }

  /* Pré-commandes : même pastel que le menu (bleu, très clair) pour en-têtes et cartes */
  .thead-precommandes th,
  .table thead.thead-precommandes th {
    background: rgba(135, 206, 250, 0.32) !important;
    color: #3d7ab5 !important;
    border-color: rgba(90, 159, 212, 0.25);
  }
  .card-header-precommandes {
    background: rgba(135, 206, 250, 0.32) !important;
    color: #3d7ab5 !important;
    border-color: rgba(90, 159, 212, 0.25);
  }
  .text-precommandes { color: #5a9fd4 !important; }
  .btn-precommandes {
    background-color: #5a9fd4;
    border-color: #5a9fd4;
    color: white;
  }
  .btn-precommandes:hover {
    background-color: #4a8fc4;
    border-color: #4a8fc4;
    color: white;
  }
  .btn-outline-precommandes {
    color: #5a9fd4;
    border-color: #5a9fd4;
  }
  .btn-outline-precommandes:hover {
    background-color: rgba(90, 159, 212, 0.15);
    border-color: #5a9fd4;
    color: #5a9fd4;
  }

  /* Caisse - même pastel que le menu Gestion de la Caisse (vert, très clair) */
  .thead-caisse th,
  .table thead.thead-caisse th {
    background: rgba(144, 238, 144, 0.35) !important;
    color: #3d7a3d !important;
    border-color: rgba(92, 184, 92, 0.25);
  }
  .card-header-caisse,
  .card.caisse-theme .card-header {
    background: rgba(144, 238, 144, 0.35) !important;
    color: #3d7a3d !important;
    border-color: rgba(92, 184, 92, 0.25);
  }
  .card-caisse { background: rgba(144, 238, 144, 0.35) !important; color: #3d7a3d !important; border-color: rgba(92, 184, 92, 0.25); }
  .text-caisse { color: #5cb85c !important; }
  .btn-caisse {
    background-color: #5cb85c;
    border-color: #5cb85c;
    color: white;
  }
  .btn-caisse:hover {
    background-color: #4a9b4a;
    border-color: #4a9b4a;
    color: white;
  }
  .btn-outline-caisse {
    color: #5cb85c;
    border-color: #5cb85c;
  }
  .btn-outline-caisse:hover {
    background-color: rgba(144, 238, 144, 0.2);
    border-color: #5cb85c;
    color: #5cb85c;
  }

  .mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 899;
  }

  @media (max-width: 991px) {
    .admin-sidebar {
      left: -280px;
      top: 0;
      height: 100vh;
      z-index: 1000;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }

    .admin-sidebar.show {
      left: 0;
    }

    .admin-sidebar.sidebar-hidden {
      left: -280px;
      transform: none;
    }

    .admin-content-wrapper {
      margin-left: 0;
      width: 100%;
      max-width: 100%;
    }

    .admin-content-wrapper.sidebar-hidden {
      margin-left: 0;
      width: 100%;
      max-width: 100%;
    }

    .ms-280 {
      margin-left: 1rem !important;
    }

    body.sidebar-hidden .ms-280 {
      margin-left: 1rem !important;
    }

    .mobile-menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-overlay.show {
      display: block;
    }
  }

  .sidebar-user-info {
    position: sticky;
    bottom: 0;
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-top: 1px solid #dee2e6;
    margin-top: auto;
    font-size: 0.85rem;
  }
</style>

<%
// Helper function to check access based on RBAC ONLY
function hasAccess(requiredPermissions) {
  // SuperAdmin voit tout (évite les soucis de cache après ajout de permission à son rôle)
  if (role === 'SuperAdmin') {
    return true;
  }
  if (!userPermissions || userPermissions.length === 0) {
    return false;
  }
  return requiredPermissions.some(perm => userPermissions.includes(perm));
}
%>

<!-- Bouton hamburger pour masquer/afficher le sidebar -->
<button type="button" class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="Masquer/Afficher le menu">
  <i class="bi bi-list" id="sidebarToggleIcon"></i>
</button>

<!-- Sidebar -->
<nav class="admin-sidebar" id="adminSidebar">
  <!-- Mon Espace : lien vers accueil (/vue) + section repliable -->
  <% if (hasAccess(['catalogues.view', 'paniers.view', 'commandes.view', 'catalogues', 'paniers.admin', 'commandes.admin', 'paniers.user', 'commandes.user', 'paniers.own', 'commandes.own'])) { %>
  <div class="sidebar-section sidebar-section-precommandes">
    <div class="sidebar-section-title sidebar-section-title-with-link">
      <a href="/vue" class="sidebar-section-title-link sidebar-menu-item" data-path="/vue">Mon Espace</a>
      <button type="button" class="sidebar-section-toggle" data-section="precommandes" aria-label="Ouvrir/Fermer le menu"><i class="bi bi-chevron-down toggle-icon"></i></button>
    </div>
    <div class="sidebar-section-content" data-section-content="precommandes">
      <% if (hasAccess(['catalogues.view', 'catalogues', 'paniers.admin', 'commandes.admin', 'paniers.user'])) { %>
      <a href="/catalogues/vue" class="sidebar-menu-item" data-path="/catalogues/vue">
        <i class="bi bi-journal-text"></i>
        <span>Catalogues disponibles</span>
      </a>
      <% } %>
      <% if (hasAccess(['paniers.view', 'paniers.admin', 'catalogues', 'commandes.admin', 'paniers.user', 'paniers.own'])) { %>
      <a href="/panier/vue" class="sidebar-menu-item" data-path="/panier/vue">
        <i class="bi bi-cart"></i>
        <span>Mes paniers</span>
      </a>
      <% } %>
      <% if (hasAccess(['commandes.view', 'commandes.admin', 'catalogues', 'paniers.admin', 'commandes.user', 'commandes.own'])) { %>
      <a href="/commandes/vue" class="sidebar-menu-item" data-path="/commandes/vue">
        <i class="bi bi-receipt"></i>
        <span>Mes Cdes & Passages Caisse</span>
      </a>
      <% } %>
      <a href="/commandes/cotisation" class="sidebar-menu-item" data-path="/commandes/cotisation">
        <i class="bi bi-coin"></i>
        <span>Mon historique de cotisation</span>
      </a>
    </div>
  </div>
  <% } %>

  <!-- Gestion de la Caisse -->
  <% if (hasAccess(['caisse.sell'])) { %>
  <div class="sidebar-section sidebar-section-caisse">
    <div class="sidebar-section-title sidebar-section-title-with-link">
      <a href="/caisse/accueil" class="sidebar-section-title-link sidebar-menu-item" data-path="/caisse/accueil">Gestion de la Caisse</a>
      <button type="button" class="sidebar-section-toggle" data-section="gestion-caisse" aria-label="Ouvrir/Fermer le menu"><i class="bi bi-chevron-down toggle-icon"></i></button>
    </div>
    <div class="sidebar-section-content" data-section-content="gestion-caisse">
      <a href="/caisse" class="sidebar-menu-item" data-path="/caisse">
        <i class="bi bi-cart-fill"></i>
        <span>Caisse</span>
      </a>
      <a href="/caisse/historique" class="sidebar-menu-item" data-path="/caisse/historique">
        <i class="bi bi-clock-history"></i>
        <span>Historique Caisse</span>
      </a>
    </div>
  </div>
  <% } %>

  <!-- Administration : gestion complète (catalogues/paniers/commandes admin, produits, catégories, fournisseurs, inventaire et stock) -->
  <% if (hasAccess(['catalogues', 'paniers.admin', 'commandes.admin', 'catalogues.manage', 'paniers.manage', 'commandes.manage', 'products', 'categories', 'suppliers', 'products.manage', 'categories.manage', 'suppliers.manage', 'inventory_stock'])) { %>
  <div class="sidebar-section sidebar-section-administration">
    <div class="sidebar-section-title sidebar-section-title-with-link">
      <a href="/admin/administration" class="sidebar-section-title-link sidebar-menu-item" data-path="/admin/administration">Administration</a>
      <button type="button" class="sidebar-section-toggle collapsed" data-section="administration" aria-label="Ouvrir/Fermer le menu"><i class="bi bi-chevron-down toggle-icon"></i></button>
    </div>
    <div class="sidebar-section-content collapsed" data-section-content="administration">
      <% if (hasAccess(['caisse.sell'])) { %>
      <a href="/caisse/cotisations-historique" class="sidebar-menu-item" data-path="/caisse/cotisations-historique">
        <i class="bi bi-wallet2"></i>
        <span>Historique des cotisations</span>
      </a>
      <% } %>
      <% if (hasAccess(['inventory_stock'])) { %>
      <div class="sidebar-subsection-title sidebar-subsection-title-with-link">
        <a href="/caisse/stock" class="sidebar-subsection-title-link sidebar-menu-item" data-path="/caisse/stock">Stock</a>
        <button type="button" class="sidebar-subsection-toggle collapsed" data-section="admin-stock" aria-label="Ouvrir/Fermer le sous-menu Stock"><i class="bi bi-chevron-down toggle-icon"></i></button>
      </div>
      <div class="sidebar-subsection-content collapsed" data-section-content="admin-stock">
        <a href="/caisse/inventaire" class="sidebar-menu-item" data-path="/caisse/inventaire">
          <i class="bi bi-upc-scan"></i>
          <span>Inventaire</span>
        </a>
        <a href="/caisse/receptions" class="sidebar-menu-item" data-path="/caisse/receptions">
          <i class="bi bi-truck"></i>
          <span>Réceptions</span>
        </a>
        <a href="/caisse/stock-mouvements" class="sidebar-menu-item" data-path="/caisse/stock-mouvements">
          <i class="bi bi-arrow-left-right"></i>
          <span>Mouvements stock</span>
        </a>
      </div>
      <% } %>
      <% if (hasAccess(['catalogues', 'paniers.admin', 'commandes.admin', 'catalogues.manage', 'paniers.manage', 'commandes.manage'])) { %>
      <a href="/admin/dashboard/vue" class="sidebar-menu-item sidebar-menu-admin" data-path="/admin/dashboard/vue">
        <i class="bi bi-speedometer2"></i>
        <span>Gestion Cdes & Paniers</span>
      </a>
      <a href="/admin/catalogues/vue" class="sidebar-menu-item sidebar-menu-admin" data-path="/admin/catalogues">
        <i class="bi bi-folder"></i>
        <span>Gestion catalogues</span>
      </a>
      <% } %>
      <% if (hasAccess(['products'])) { %>
      <a href="/admin/products/vue" class="sidebar-menu-item" data-path="/admin/products">
        <i class="bi bi-box-seam"></i>
        <span>Produits</span>
      </a>
      <% } %>
      <% if (hasAccess(['categories'])) { %>
      <a href="/admin/categories/vue" class="sidebar-menu-item" data-path="/admin/categories">
        <i class="bi bi-tags"></i>
        <span>Catégories</span>
      </a>
      <% } %>
      <% if (hasAccess(['suppliers'])) { %>
      <a href="/admin/suppliers/vue" class="sidebar-menu-item" data-path="/admin/suppliers">
        <i class="bi bi-truck"></i>
        <span>Fournisseurs</span>
      </a>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Admin Site : réservé aux vrais admins (pas reports.view_dashboard / rôle Utilisateur) -->
  <% if (hasAccess(['users', 'roles', 'bandeaux', 'organizations', 'admin']) || hasAccess(['reports', 'reports.view_analytics', 'reports.export'])) { %>
  <div class="sidebar-section sidebar-section-admin-site">
    <div class="sidebar-section-title sidebar-section-title-with-link">
      <a href="/admin/site" class="sidebar-section-title-link sidebar-menu-item" data-path="/admin/site">Admin Site</a>
      <button type="button" class="sidebar-section-toggle collapsed" data-section="admin-site" aria-label="Ouvrir/Fermer le menu"><i class="bi bi-chevron-down toggle-icon"></i></button>
    </div>
    <div class="sidebar-section-content collapsed" data-section-content="admin-site">
      <% if (hasAccess(['users', 'roles'])) { %>
      <a href="/admin/users/vue" class="sidebar-menu-item" data-path="/admin/users/vue">
        <i class="bi bi-people"></i>
        <span>Utilisateurs</span>
      </a>
      <a href="/admin/connected-users" class="sidebar-menu-item" data-path="/admin/connected-users">
        <i class="bi bi-person-check"></i>
        <span>Utilisateurs connectés</span>
      </a>
      <a href="/admin/roles/vue" class="sidebar-menu-item" data-path="/admin/roles">
        <i class="bi bi-shield-check"></i>
        <span>Rôles & Permissions</span>
      </a>
      <% } %>
      <!-- Stats & Monitoring : rapports complets uniquement (pas reports.view_dashboard) -->
      <% if (hasAccess(['reports', 'reports.view_analytics', 'reports.export'])) { %>
      <a href="/admin/stats" class="sidebar-menu-item" data-path="/admin/stats">
        <i class="bi bi-bar-chart-line"></i>
        <span>Statistiques</span>
      </a>
      <% } %>
      <% if (hasAccess(['catalogues', 'paniers.admin', 'commandes.admin'])) { %>
      <a href="/admin/dashboard-temps-reel" class="sidebar-menu-item" data-path="/admin/dashboard-temps-reel">
        <i class="bi bi-broadcast"></i>
        <span>Tableau de bord temps réel</span>
      </a>
      <% } %>
      <% if (hasAccess(['audit_logs'])) { %>
      <a href="/admin/trace" class="sidebar-menu-item" data-path="/admin/trace">
        <i class="bi bi-activity"></i>
        <span>Traces de MAJ</span>
      </a>
      <% } %>
      <% if (hasAccess(['admin'])) { %>
      <a href="/admin/email-queue" class="sidebar-menu-item" data-path="/admin/email-queue">
        <i class="bi bi-envelope-paper"></i>
        <span>File d'attente email</span>
      </a>
      <% } %>
      <% if (hasAccess(['organizations.view_all', 'admin'])) { %>
      <a href="/admin/maintenance" class="sidebar-menu-item" data-path="/admin/maintenance">
        <i class="bi bi-tools"></i>
        <span>Maintenance</span>
      </a>
      <% } %>
      <!-- Configuration -->
      <% if (hasAccess(['bandeaux', 'organizations', 'admin'])) { %>
      <a href="/admin/bandeaux" class="sidebar-menu-item" data-path="/admin/bandeaux">
        <i class="bi bi-megaphone"></i>
        <span>Bandeaux d'info</span>
      </a>
      <% } %>
      <% if (hasAccess(['organizations'])) { %>
      <a href="/admin/organizations" class="sidebar-menu-item" data-path="/admin/organizations">
        <i class="bi bi-building"></i>
        <span>Organisations</span>
      </a>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Mon compte : accès compte et déconnexion (même principe que les autres menus) -->
  <div class="sidebar-section sidebar-section-mon-compte">
    <div class="sidebar-section-title sidebar-section-title-with-link">
      <a href="/account" class="sidebar-section-title-link sidebar-menu-item" data-path="/account">Mon compte</a>
      <button type="button" class="sidebar-section-toggle" data-section="mon-compte" aria-label="Ouvrir/Fermer le menu"><i class="bi bi-chevron-down toggle-icon"></i></button>
    </div>
    <div class="sidebar-section-content" data-section-content="mon-compte">
      <a href="/account" class="sidebar-menu-item" data-path="/account">
        <i class="bi bi-person-circle"></i>
        <span>Mon Compte</span>
      </a>
      <a href="/logout" class="sidebar-menu-item" data-path="/logout">
        <i class="bi bi-box-arrow-right"></i>
        <span>Déconnexion</span>
      </a>
      <div class="sidebar-user-roles" style="padding: 0.5rem 0; border-top: 1px solid #dee2e6; margin-top: 0.5rem;">
        <% if (userRoles && userRoles.length > 0) { %>
          <small class="text-muted d-block mb-1">Rôles:</small>
          <div>
            <% userRoles.forEach(function(roleName) { %>
              <span class="badge bg-primary me-1 mb-1" style="font-size: 0.7rem;"><%= roleName %></span>
            <% }); %>
          </div>
        <% } else { %>
          <small class="text-muted d-block">Rôle: <span class="badge bg-secondary"><%= role || 'Aucun' %></span></small>
        <% } %>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i class="bi bi-list"></i>
</button>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script>
(function() {
  // Mobile menu toggle
  const sidebar = document.getElementById('adminSidebar');
  const mobileToggle = document.getElementById('mobileMenuToggle');
  const overlay = document.getElementById('sidebarOverlay');

  function toggleSidebar() {
    sidebar?.classList.toggle('show');
    overlay?.classList.toggle('show');
  }

  mobileToggle?.addEventListener('click', toggleSidebar);
  overlay?.addEventListener('click', toggleSidebar);

  // Close sidebar when clicking a link on mobile
  if (window.innerWidth <= 991) {
    document.querySelectorAll('.sidebar-menu-item').forEach(item => {
      item.addEventListener('click', () => {
        sidebar?.classList.remove('show');
        overlay?.classList.remove('show');
      });
    });
  }

  // Highlight active menu item based on current path
  const currentPath = window.location.pathname;
  let exactMatch = null;
  let longestMatch = null;
  let longestMatchLength = 0;

  // First pass: find exact match and longest prefix match
  document.querySelectorAll('.sidebar-menu-item').forEach(item => {
    const itemPath = item.getAttribute('data-path');
    if (!itemPath) return;

    // Check for exact match
    if (currentPath === itemPath) {
      exactMatch = item;
    }
    // Check for prefix match that's longer than current longest
    else if (currentPath.startsWith(itemPath) && itemPath.length > longestMatchLength) {
      longestMatch = item;
      longestMatchLength = itemPath.length;
    }
  });

  // Apply active class: prioritize exact match over longest prefix match
  if (exactMatch) {
    exactMatch.classList.add('active');
  } else if (longestMatch) {
    longestMatch.classList.add('active');
  }

  // Collapsible sections management
  const STORAGE_KEY = 'sidebar-sections-state';

  // Load saved state from localStorage
  function loadSectionsState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : {};
    } catch (e) {
      return {};
    }
  }

  // Save state to localStorage
  function saveSectionsState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.error('Failed to save sidebar state', e);
    }
  }

  // Toggle section
  function toggleSection(sectionName) {
    const title = document.querySelector(`[data-section="${sectionName}"]`);
    const content = document.querySelector(`[data-section-content="${sectionName}"]`);

    if (!title || !content) return;

    const isCollapsed = title.classList.contains('collapsed');

    if (isCollapsed) {
      title.classList.remove('collapsed');
      content.classList.remove('collapsed');
    } else {
      title.classList.add('collapsed');
      content.classList.add('collapsed');
    }

    // Save state
    const state = loadSectionsState();
    state[sectionName] = !isCollapsed; // true = collapsed
    saveSectionsState(state);
  }

  // Initialize sections state
  const savedState = loadSectionsState();
  const sectionTitles = document.querySelectorAll('[data-section]');

  console.log('Found sections:', sectionTitles.length);

  sectionTitles.forEach(title => {
    const sectionName = title.getAttribute('data-section');
    const content = document.querySelector(`[data-section-content="${sectionName}"]`);

    console.log('Initializing section:', sectionName, 'content found:', !!content);

    if (!content) return;

    // Apply saved state or keep default
    if (savedState.hasOwnProperty(sectionName)) {
      if (savedState[sectionName]) { // collapsed
        title.classList.add('collapsed');
        content.classList.add('collapsed');
      } else { // expanded
        title.classList.remove('collapsed');
        content.classList.remove('collapsed');
      }
    }
    // If no saved state, keep the default from HTML (collapsed for all except "Mes Actions")

    // Add click handler
    title.addEventListener('click', (e) => {
      console.log('Section clicked:', sectionName);
      e.preventDefault();
      e.stopPropagation();
      toggleSection(sectionName);
    });
  });

  // Ne plus auto-déplier la section contenant l'élément actif : on respecte l'état replié/déplié
  // choisi par l'utilisateur (chevron uniquement). L'état est stocké dans localStorage.

  // Save and restore scroll position
  const SCROLL_KEY = 'sidebar-scroll-position';

  // Restore scroll position
  const savedScroll = localStorage.getItem(SCROLL_KEY);
  if (savedScroll && sidebar) {
    sidebar.scrollTop = parseInt(savedScroll, 10);
  }

  // Save scroll position on scroll
  if (sidebar) {
    sidebar.addEventListener('scroll', function() {
      localStorage.setItem(SCROLL_KEY, sidebar.scrollTop.toString());
    });
  }

  // Prevent visual flash on navigation
  document.querySelectorAll('.sidebar-menu-item').forEach(item => {
    item.addEventListener('click', function(e) {
      // Store current state before navigation
      localStorage.setItem(SCROLL_KEY, sidebar.scrollTop.toString());

      // Add a slight fade to indicate navigation
      sidebar.style.opacity = '0.7';
      sidebar.style.transition = 'opacity 0.1s ease';
    });
  });

  // Sidebar toggle (hamburger menu)
  const SIDEBAR_STATE_KEY = 'sidebar-visible';
  const toggleBtn = document.getElementById('sidebarToggleBtn');
  const toggleIcon = document.getElementById('sidebarToggleIcon');
  const contentWrapper = document.querySelector('.admin-content-wrapper');

  function loadSidebarState() {
    try {
      const saved = localStorage.getItem(SIDEBAR_STATE_KEY);
      return saved !== null ? saved === 'true' : true; // Par défaut visible
    } catch (e) {
      return true;
    }
  }

  function saveSidebarState(isVisible) {
    try {
      localStorage.setItem(SIDEBAR_STATE_KEY, isVisible.toString());
    } catch (e) {
      console.error('Failed to save sidebar state', e);
    }
  }

  function toggleSidebar() {
    const isVisible = !sidebar.classList.contains('sidebar-hidden');
    
    if (isVisible) {
      // Masquer
      sidebar.classList.add('sidebar-hidden');
      if (contentWrapper) contentWrapper.classList.add('sidebar-hidden');
      document.body.classList.add('sidebar-hidden');
      if (toggleIcon) toggleIcon.className = 'bi bi-list';
      saveSidebarState(false);
    } else {
      // Afficher
      sidebar.classList.remove('sidebar-hidden');
      if (contentWrapper) contentWrapper.classList.remove('sidebar-hidden');
      document.body.classList.remove('sidebar-hidden');
      if (toggleIcon) toggleIcon.className = 'bi bi-x-lg';
      saveSidebarState(true);
    }
  }

  // Initialiser l'état du sidebar
  const sidebarVisible = loadSidebarState();
  if (!sidebarVisible) {
    sidebar.classList.add('sidebar-hidden');
    if (contentWrapper) contentWrapper.classList.add('sidebar-hidden');
    document.body.classList.add('sidebar-hidden');
    if (toggleIcon) toggleIcon.className = 'bi bi-x-lg';
  }

  // Ajouter l'événement click sur le bouton
  if (toggleBtn) {
    toggleBtn.addEventListener('click', toggleSidebar);
  }
})();
</script>
