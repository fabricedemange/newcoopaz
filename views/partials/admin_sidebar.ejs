<style>
  body {
    overflow-x: hidden;
  }

  .admin-layout {
    display: flex;
    min-height: calc(100vh - 120px);
  }

  .admin-sidebar {
    width: 280px;
    background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
    border-right: 1px solid #dee2e6;
    padding: 0.5rem 0;
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    overflow-y: auto;
    transition: opacity 0.15s ease;
    z-index: 900;
    will-change: opacity;
  }

  .admin-content-wrapper {
    margin-left: 280px;
    flex: 1;
    width: calc(100% - 280px);
    animation: fadeIn 0.2s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .ms-280 {
    margin-left: 280px !important;
  }

  .sidebar-section {
    margin-bottom: 0.25rem;
  }

  .sidebar-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    font-weight: 700;
    color: #6c757d;
    padding: 0.5rem 1rem;
    margin-bottom: 0;
    letter-spacing: 0.3px;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sidebar-section-title:hover {
    background: rgba(0, 123, 255, 0.05);
    color: #007bff;
  }

  .sidebar-section-title .toggle-icon {
    transition: transform 0.2s ease;
    font-size: 0.75rem;
    margin-left: auto;
    flex-shrink: 0;
  }

  .sidebar-section-title.collapsed .toggle-icon {
    transform: rotate(-90deg);
  }

  .sidebar-section-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.2s ease;
    opacity: 1;
  }

  .sidebar-section-content.collapsed {
    max-height: 0 !important;
    opacity: 0;
  }

  .sidebar-subsection-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #dee2e6, transparent);
    margin: 0.5rem 1rem;
  }

  .sidebar-menu-item {
    display: block;
    padding: 0.5rem 1rem;
    color: #495057;
    text-decoration: none;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    font-size: 0.9rem;
  }

  .sidebar-menu-item:hover {
    background: rgba(0, 123, 255, 0.1);
    border-left-color: #007bff;
    color: #007bff;
  }

  .sidebar-menu-item.active {
    background: rgba(0, 123, 255, 0.15);
    border-left-color: #007bff;
    color: #007bff;
    font-weight: 600;
  }

  .sidebar-menu-item i {
    width: 20px;
    margin-right: 0.5rem;
    text-align: center;
    font-size: 0.95rem;
  }

  .sidebar-menu-admin {
    background: rgba(108, 117, 125, 0.08);
    color: #6c757d;
  }

  .sidebar-menu-admin:hover {
    background: rgba(108, 117, 125, 0.15);
    border-left-color: #6c757d;
    color: #495057;
  }

  .sidebar-menu-admin.active {
    background: rgba(108, 117, 125, 0.2);
    border-left-color: #6c757d;
    color: #495057;
    font-weight: 600;
  }

  /* Couleurs pastel pour les sections */

  /* Caisse - Vert pastel */
  .sidebar-section-caisse {
    background: linear-gradient(to right, rgba(144, 238, 144, 0.12), transparent);
  }

  .sidebar-section-caisse .sidebar-menu-item {
    background: rgba(144, 238, 144, 0.08);
    color: #4a9b4a;
  }

  .sidebar-section-caisse .sidebar-menu-item:hover {
    background: rgba(144, 238, 144, 0.2);
    border-left-color: #5cb85c;
    color: #5cb85c;
  }

  .sidebar-section-caisse .sidebar-menu-item.active {
    background: rgba(144, 238, 144, 0.25);
    border-left-color: #5cb85c;
    color: #5cb85c;
  }

  /* Pré-commandes - Bleu pastel */
  .sidebar-section-precommandes .sidebar-section-title {
    background: rgba(135, 206, 250, 0.15);
    color: #5a9fd4;
  }

  .sidebar-section-precommandes .sidebar-section-content {
    background: rgba(135, 206, 250, 0.03);
  }

  .sidebar-section-precommandes .sidebar-menu-item {
    background: rgba(135, 206, 250, 0.08);
    color: #4a8fc4;
  }

  .sidebar-section-precommandes .sidebar-menu-item:hover {
    background: rgba(135, 206, 250, 0.2);
    border-left-color: #5a9fd4;
    color: #5a9fd4;
  }

  .sidebar-section-precommandes .sidebar-menu-item.active {
    background: rgba(135, 206, 250, 0.25);
    border-left-color: #5a9fd4;
    color: #5a9fd4;
  }

  /* Administration - Jaune pastel */
  .sidebar-section-administration .sidebar-section-title {
    background: rgba(255, 235, 156, 0.3);
    color: #d4a617;
  }

  .sidebar-section-administration .sidebar-section-content {
    background: rgba(255, 235, 156, 0.05);
  }

  .sidebar-section-administration .sidebar-menu-item {
    background: rgba(255, 235, 156, 0.12);
    color: #b89617;
  }

  .sidebar-section-administration .sidebar-menu-item:hover {
    background: rgba(255, 235, 156, 0.35);
    border-left-color: #d4a617;
    color: #d4a617;
  }

  .sidebar-section-administration .sidebar-menu-item.active {
    background: rgba(255, 235, 156, 0.4);
    border-left-color: #d4a617;
    color: #d4a617;
  }

  /* Admin Site - Orange pastel */
  .sidebar-section-admin-site .sidebar-section-title {
    background: rgba(255, 183, 77, 0.2);
    color: #e67e22;
  }

  .sidebar-section-admin-site .sidebar-section-content {
    background: rgba(255, 183, 77, 0.05);
  }

  .sidebar-section-admin-site .sidebar-menu-item {
    background: rgba(255, 183, 77, 0.12);
    color: #d86e22;
  }

  .sidebar-section-admin-site .sidebar-menu-item:hover {
    background: rgba(255, 183, 77, 0.25);
    border-left-color: #e67e22;
    color: #e67e22;
  }

  .sidebar-section-admin-site .sidebar-menu-item.active {
    background: rgba(255, 183, 77, 0.3);
    border-left-color: #e67e22;
    color: #e67e22;
  }

  .mobile-menu-toggle {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1001;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 24px;
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 899;
  }

  @media (max-width: 991px) {
    .admin-sidebar {
      left: -280px;
      top: 0;
      height: 100vh;
      z-index: 1000;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }

    .admin-sidebar.show {
      left: 0;
    }

    .admin-content-wrapper {
      margin-left: 0;
      width: 100%;
    }

    .ms-280 {
      margin-left: 1rem !important;
    }

    .mobile-menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-overlay.show {
      display: block;
    }
  }

  .sidebar-user-info {
    position: sticky;
    bottom: 0;
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-top: 1px solid #dee2e6;
    margin-top: auto;
    font-size: 0.85rem;
  }
</style>

<%
// Helper function to check access based on RBAC ONLY
function hasAccess(requiredPermissions) {
  // RBAC only - check if user has ANY of the required permissions
  if (!userPermissions || userPermissions.length === 0) {
    // Fallback: if permissions not loaded but user is SuperAdmin, allow access
    if (role === 'SuperAdmin') {
      return true;
    }
    return false;
  }
  return requiredPermissions.some(perm => userPermissions.includes(perm));
}
%>

<!-- Sidebar -->
<nav class="admin-sidebar" id="adminSidebar">
  <!-- Accueil (lien direct, pas de section) -->
  <a href="/vue" class="sidebar-menu-item" data-path="/vue" style="border-bottom: 1px solid #dee2e6; margin-bottom: 0.25rem;">
    <i class="bi bi-house"></i>
    <span>Accueil</span>
  </a>

  <!-- Gestion de la Caisse -->
  <% if (hasAccess(['caisse.sell'])) { %>
  <div class="sidebar-section sidebar-section-caisse">
    <div class="sidebar-section-title" data-section="gestion-caisse">
      <span>Gestion de la Caisse</span>
      <i class="bi bi-chevron-down toggle-icon"></i>
    </div>
    <div class="sidebar-section-content" data-section-content="gestion-caisse">
      <a href="/caisse" class="sidebar-menu-item" data-path="/caisse">
        <i class="bi bi-cart-fill"></i>
        <span>Caisse</span>
      </a>
      <a href="/caisse/historique" class="sidebar-menu-item" data-path="/caisse/historique">
        <i class="bi bi-clock-history"></i>
        <span>Historique Caisse</span>
      </a>
    </div>
  </div>
  <% } %>

  <!-- Pré-commandes -->
  <% if (hasAccess(['catalogues.view', 'paniers.view', 'commandes.view', 'catalogues', 'paniers.admin', 'commandes.admin'])) { %>
  <div class="sidebar-section sidebar-section-precommandes">
    <div class="sidebar-section-title" data-section="precommandes">
      <span>Pré-commandes</span>
      <i class="bi bi-chevron-down toggle-icon"></i>
    </div>
    <div class="sidebar-section-content" data-section-content="precommandes">
      <!-- Actions utilisateur -->
      <% if (hasAccess(['catalogues.view', 'catalogues', 'paniers.admin', 'commandes.admin'])) { %>
      <a href="/catalogues/vue" class="sidebar-menu-item" data-path="/catalogues/vue">
        <i class="bi bi-journal-text"></i>
        <span>Catalogues disponibles</span>
      </a>
      <% } %>
      <% if (hasAccess(['paniers.view', 'paniers.admin', 'catalogues', 'commandes.admin'])) { %>
      <a href="/panier/vue" class="sidebar-menu-item" data-path="/panier/vue">
        <i class="bi bi-cart"></i>
        <span>Mes paniers</span>
      </a>
      <% } %>
      <% if (hasAccess(['commandes.view', 'commandes.admin', 'catalogues', 'paniers.admin'])) { %>
      <a href="/commandes/vue" class="sidebar-menu-item" data-path="/commandes/vue">
        <i class="bi bi-receipt"></i>
        <span>Mes Cdes & Passages Caisse</span>
      </a>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Administration -->
  <% if (hasAccess(['catalogues', 'paniers.admin', 'commandes.admin', 'products', 'categories', 'suppliers'])) { %>
  <div class="sidebar-section sidebar-section-administration">
    <div class="sidebar-section-title collapsed" data-section="administration">
      <span>Administration</span>
      <i class="bi bi-chevron-down toggle-icon"></i>
    </div>
    <div class="sidebar-section-content collapsed" data-section-content="administration">
      <!-- Gestion Cdes & Paniers (en tête) -->
      <% if (hasAccess(['catalogues', 'paniers.admin', 'commandes.admin'])) { %>
      <a href="/admin/dashboard/vue" class="sidebar-menu-item sidebar-menu-admin" data-path="/admin/dashboard/vue">
        <i class="bi bi-speedometer2"></i>
        <span>Gestion Cdes & Paniers</span>
      </a>
      <a href="/admin/catalogues/vue" class="sidebar-menu-item sidebar-menu-admin" data-path="/admin/catalogues">
        <i class="bi bi-folder"></i>
        <span>Gestion catalogues</span>
      </a>
      <% } %>
      <!-- Produits -->
      <% if (hasAccess(['products'])) { %>
      <a href="/admin/products/vue" class="sidebar-menu-item" data-path="/admin/products">
        <i class="bi bi-box-seam"></i>
        <span>Produits</span>
      </a>
      <% } %>
      <% if (hasAccess(['categories'])) { %>
      <a href="/admin/categories/vue" class="sidebar-menu-item" data-path="/admin/categories">
        <i class="bi bi-tags"></i>
        <span>Catégories</span>
      </a>
      <% } %>
      <% if (hasAccess(['suppliers'])) { %>
      <a href="/admin/suppliers/vue" class="sidebar-menu-item" data-path="/admin/suppliers">
        <i class="bi bi-truck"></i>
        <span>Fournisseurs</span>
      </a>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Admin Site -->
  <% if (hasAccess(['users', 'roles', 'reports', 'bandeaux', 'organizations', 'admin'])) { %>
  <div class="sidebar-section sidebar-section-admin-site">
    <div class="sidebar-section-title collapsed" data-section="admin-site">
      <span>Admin Site</span>
      <i class="bi bi-chevron-down toggle-icon"></i>
    </div>
    <div class="sidebar-section-content collapsed" data-section-content="admin-site">
      <!-- Utilisateurs & Rôles -->
      <% if (hasAccess(['users', 'roles'])) { %>
      <a href="/admin/users/vue" class="sidebar-menu-item" data-path="/admin/users/vue">
        <i class="bi bi-people"></i>
        <span>Utilisateurs</span>
      </a>
      <a href="/admin/roles/vue" class="sidebar-menu-item" data-path="/admin/roles">
        <i class="bi bi-shield-check"></i>
        <span>Rôles & Permissions</span>
      </a>
      <% } %>
      <!-- Stats & Monitoring -->
      <% if (hasAccess(['reports'])) { %>
      <a href="/admin/stats" class="sidebar-menu-item" data-path="/admin/stats">
        <i class="bi bi-bar-chart-line"></i>
        <span>Statistiques</span>
      </a>
      <% } %>
      <% if (hasAccess(['audit_logs'])) { %>
      <a href="/admin/trace" class="sidebar-menu-item" data-path="/admin/trace">
        <i class="bi bi-activity"></i>
        <span>Traces de MAJ</span>
      </a>
      <% } %>
      <% if (hasAccess(['admin'])) { %>
      <a href="/admin/email-queue" class="sidebar-menu-item" data-path="/admin/email-queue">
        <i class="bi bi-envelope-paper"></i>
        <span>File d'attente email</span>
      </a>
      <% } %>
      <!-- Configuration -->
      <% if (hasAccess(['bandeaux', 'organizations', 'admin'])) { %>
      <a href="/admin/bandeaux" class="sidebar-menu-item" data-path="/admin/bandeaux">
        <i class="bi bi-megaphone"></i>
        <span>Bandeaux d'info</span>
      </a>
      <% } %>
      <% if (hasAccess(['organizations'])) { %>
      <a href="/admin/organizations" class="sidebar-menu-item" data-path="/admin/organizations">
        <i class="bi bi-building"></i>
        <span>Organisations</span>
      </a>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- User info and actions at bottom -->
  <div class="sidebar-user-info" style="padding-top: 0.5rem;">
    <a href="/account" class="sidebar-menu-item" data-path="/account" style="padding: 0.4rem 1rem; margin: 0 -1rem 0.5rem -1rem;">
      <i class="bi bi-person-circle"></i>
      <span><%= user %> - Mon Compte</span>
    </a>
    <a href="/logout" class="sidebar-menu-item" data-path="/logout" style="padding: 0.4rem 1rem; margin: 0 -1rem 0.5rem -1rem;">
      <i class="bi bi-box-arrow-right"></i>
      <span>Déconnexion</span>
    </a>
    <div style="padding: 0.5rem 0; border-top: 1px solid #dee2e6; margin-top: 0.5rem;">
      <% if (userRoles && userRoles.length > 0) { %>
        <small class="text-muted d-block mb-1">Rôles:</small>
        <div>
          <% userRoles.forEach(function(roleName) { %>
            <span class="badge bg-primary me-1 mb-1" style="font-size: 0.7rem;"><%= roleName %></span>
          <% }); %>
        </div>
      <% } else { %>
        <small class="text-muted d-block">Rôle: <span class="badge bg-secondary"><%= role || 'Aucun' %></span></small>
      <% } %>
    </div>
  </div>
</nav>

<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
  <i class="bi bi-list"></i>
</button>

<!-- Overlay for mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script>
(function() {
  // Mobile menu toggle
  const sidebar = document.getElementById('adminSidebar');
  const mobileToggle = document.getElementById('mobileMenuToggle');
  const overlay = document.getElementById('sidebarOverlay');

  function toggleSidebar() {
    sidebar?.classList.toggle('show');
    overlay?.classList.toggle('show');
  }

  mobileToggle?.addEventListener('click', toggleSidebar);
  overlay?.addEventListener('click', toggleSidebar);

  // Close sidebar when clicking a link on mobile
  if (window.innerWidth <= 991) {
    document.querySelectorAll('.sidebar-menu-item').forEach(item => {
      item.addEventListener('click', () => {
        sidebar?.classList.remove('show');
        overlay?.classList.remove('show');
      });
    });
  }

  // Highlight active menu item based on current path
  const currentPath = window.location.pathname;
  let exactMatch = null;
  let longestMatch = null;
  let longestMatchLength = 0;

  // First pass: find exact match and longest prefix match
  document.querySelectorAll('.sidebar-menu-item').forEach(item => {
    const itemPath = item.getAttribute('data-path');
    if (!itemPath) return;

    // Check for exact match
    if (currentPath === itemPath) {
      exactMatch = item;
    }
    // Check for prefix match that's longer than current longest
    else if (currentPath.startsWith(itemPath) && itemPath.length > longestMatchLength) {
      longestMatch = item;
      longestMatchLength = itemPath.length;
    }
  });

  // Apply active class: prioritize exact match over longest prefix match
  if (exactMatch) {
    exactMatch.classList.add('active');
  } else if (longestMatch) {
    longestMatch.classList.add('active');
  }

  // Collapsible sections management
  const STORAGE_KEY = 'sidebar-sections-state';

  // Load saved state from localStorage
  function loadSectionsState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : {};
    } catch (e) {
      return {};
    }
  }

  // Save state to localStorage
  function saveSectionsState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.error('Failed to save sidebar state', e);
    }
  }

  // Toggle section
  function toggleSection(sectionName) {
    const title = document.querySelector(`[data-section="${sectionName}"]`);
    const content = document.querySelector(`[data-section-content="${sectionName}"]`);

    if (!title || !content) return;

    const isCollapsed = title.classList.contains('collapsed');

    if (isCollapsed) {
      title.classList.remove('collapsed');
      content.classList.remove('collapsed');
    } else {
      title.classList.add('collapsed');
      content.classList.add('collapsed');
    }

    // Save state
    const state = loadSectionsState();
    state[sectionName] = !isCollapsed; // true = collapsed
    saveSectionsState(state);
  }

  // Initialize sections state
  const savedState = loadSectionsState();
  const sectionTitles = document.querySelectorAll('[data-section]');

  console.log('Found sections:', sectionTitles.length);

  sectionTitles.forEach(title => {
    const sectionName = title.getAttribute('data-section');
    const content = document.querySelector(`[data-section-content="${sectionName}"]`);

    console.log('Initializing section:', sectionName, 'content found:', !!content);

    if (!content) return;

    // Apply saved state or keep default
    if (savedState.hasOwnProperty(sectionName)) {
      if (savedState[sectionName]) { // collapsed
        title.classList.add('collapsed');
        content.classList.add('collapsed');
      } else { // expanded
        title.classList.remove('collapsed');
        content.classList.remove('collapsed');
      }
    }
    // If no saved state, keep the default from HTML (collapsed for all except "Mes Actions")

    // Add click handler
    title.addEventListener('click', (e) => {
      console.log('Section clicked:', sectionName);
      e.preventDefault();
      e.stopPropagation();
      toggleSection(sectionName);
    });
  });

  // Auto-expand section containing active item
  const activeItem = document.querySelector('.sidebar-menu-item.active');
  if (activeItem) {
    const section = activeItem.closest('.sidebar-section');
    if (section) {
      const title = section.querySelector('[data-section]');
      const content = section.querySelector('[data-section-content]');
      if (title && content) {
        title.classList.remove('collapsed');
        content.classList.remove('collapsed');
      }
    }
  }

  // Save and restore scroll position
  const SCROLL_KEY = 'sidebar-scroll-position';

  // Restore scroll position
  const savedScroll = localStorage.getItem(SCROLL_KEY);
  if (savedScroll && sidebar) {
    sidebar.scrollTop = parseInt(savedScroll, 10);
  }

  // Save scroll position on scroll
  if (sidebar) {
    sidebar.addEventListener('scroll', function() {
      localStorage.setItem(SCROLL_KEY, sidebar.scrollTop.toString());
    });
  }

  // Prevent visual flash on navigation
  document.querySelectorAll('.sidebar-menu-item').forEach(item => {
    item.addEventListener('click', function(e) {
      // Store current state before navigation
      localStorage.setItem(SCROLL_KEY, sidebar.scrollTop.toString());

      // Add a slight fade to indicate navigation
      sidebar.style.opacity = '0.7';
      sidebar.style.transition = 'opacity 0.1s ease';
    });
  });
})();
</script>
