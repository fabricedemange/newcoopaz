<%- include('partials/header', { title: 'Éditer un article', user, role }) %>

<div class="admin-content-wrapper">

<div class="container-fluid px-3 mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Éditer un article</h2>
    </div>
  </div>

  <div class="row">
    <div class="col-12 col-md-8 offset-md-2">
      <% if (error) { %>
        <div class="alert alert-danger" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <%= error %>
        </div>
      <% } %>
      
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Informations de l'article</h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label class="form-label">Image du produit</label>
            <div class="d-flex align-items-start gap-3">
              <div>
                <% if (article.image_filename) { %>
                  <img
                    src="/uploads/article-images/<%= article.image_filename %>"
                    alt="Image produit"
                    class="img-thumbnail"
                    style="width: 96px; height: 96px; object-fit: cover; cursor: zoom-in;"
                    data-bs-toggle="modal"
                    data-bs-target="#articleImageModal"
                    data-article-imgsrc="/uploads/article-images/<%= article.image_filename %>"
                  />
                <% } else { %>
                  <div class="border rounded bg-light d-flex align-items-center justify-content-center" style="width: 96px; height: 96px;">
                    <span class="text-muted small">Aucune</span>
                  </div>
                <% } %>
              </div>

              <div class="flex-grow-1">
                <form
                  action="/admin/catalogues/<%= catalogue_id %>/articles/<%= article.id %>/image"
                  method="post"
                  enctype="multipart/form-data"
                >
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input
                    type="file"
                    name="image"
                    accept="image/*"
                    class="visually-hidden article-image-file"
                    id="article_image_file"
                  />

                  <div class="d-flex flex-wrap gap-2">
                    <label class="btn btn-outline-secondary btn-sm js-article-image-pick" data-capture="0" for="article_image_file">Télécharger</label>
                    <label class="btn btn-outline-secondary btn-sm js-article-image-pick" data-capture="1" for="article_image_file">Photo</label>
                  </div>
                  <div class="form-text">Miniature sur la fiche + agrandissement au clic.</div>
                </form>

                <% if (article.image_filename) { %>
                  <form
                    action="/admin/catalogues/<%= catalogue_id %>/articles/<%= article.id %>/image/delete"
                    method="post"
                    class="mt-2"
                  >
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <button type="submit" class="btn btn-outline-danger btn-sm"
                      onclick="return confirm('Supprimer l\'image de ce produit ?')">
                      Supprimer l'image
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>

          <form action="/admin/catalogues/<%= catalogue_id %>/articles/<%= article.id %>/edit" method="post">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div class="mb-3">
              <label for="produit" class="form-label">Produit <span class="text-danger">*</span></label>
              <input type="text" id="produit" name="produit" class="form-control" 
                     value="<%= article.produit %>" required placeholder="Nom du produit">
              <div class="form-text">Le nom du produit tel qu'il apparaîtra dans le catalogue</div>
            </div>
            
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea id="description" name="description" class="form-control" rows="3" 
                        placeholder="Description détaillée du produit (optionnel)"><%= article.description %></textarea>
              <div class="form-text">Description détaillée du produit (optionnel)</div>
            </div>
            
            <div class="mb-3">
              <label for="prix" class="form-label">Prix <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="number" step="0.01" id="prix" name="prix" class="form-control" 
                       value="<%= article.prix %>" required placeholder="0.00">
                <span class="input-group-text">€</span>
              </div>
              <div class="form-text">Prix unitaire du produit en euros</div>
            </div>
            
<div class="mb-3">
  <label for="unite" class="form-label">Qté mini<span class="text-danger">*</span></label>
  <div class="input-group">
    <input type="number" step="0.1" min="0.1" max="1" id="unite" name="unite" class="form-control" value="<%= article.unite %>" required
      placeholder="0.0">
   
  </div>
  <div class="form-text">Quantité minimale commandable</div>
</div>

            <div class="d-flex flex-column flex-md-row gap-2">
              <button type="submit" class="btn btn-success">
                Enregistrer les modifications
              </button>
              <a href="/admin/catalogues/<%= catalogue_id %>/edit" class="btn btn-secondary">
                Annuler
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Boutons de navigation -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="/admin/catalogues/<%= catalogue_id %>/edit" class="btn btn-outline-secondary">
          Retour à l'édition du catalogue
        </a>
        <a href="/admin/catalogues/vue" class="btn btn-outline-secondary">
          Retour à la liste des catalogues
        </a>
        <a href="/admin/menu" class="btn btn-outline-secondary">
          Retour au menu admin
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'agrandissement d'image -->
<div class="modal fade" id="articleImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="articleImageModalImg" src="" alt="Image produit" style="width: 100%; height: auto; display: block;" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-submit quand un fichier est choisi (Télécharger / Photo)
document.addEventListener('change', function(e) {
  const input = e.target;
  if (!input || !input.classList || !input.classList.contains('article-image-file')) return;
  if (!input.files || input.files.length === 0) return;
  const form = input.closest('form');
  if (form) form.submit();
});

// Un seul input file: on active/désactive capture avant ouverture (Photo vs Télécharger)
document.addEventListener('pointerdown', function(e) {
  const btn = e.target.closest('.js-article-image-pick');
  if (!btn) return;
  const inputId = btn.getAttribute('for');
  if (!inputId) return;
  const input = document.getElementById(inputId);
  if (!input) return;
  const capture = btn.getAttribute('data-capture');
  if (capture === '1') {
    input.setAttribute('capture', 'environment');
  } else {
    input.removeAttribute('capture');
  }
});

// Alimentation du modal d'agrandissement
document.addEventListener('click', function(e) {
  const thumb = e.target.closest('[data-article-imgsrc]');
  if (!thumb) return;
  const img = document.getElementById('articleImageModalImg');
  if (img) img.src = thumb.getAttribute('data-article-imgsrc');
});
</script>

</div>
<%- include('partials/footer') %>
