<%- include('partials/header', { title: 'Catalogues', user, role }) %>

<div class="admin-content-wrapper">
<div class="container-fluid px-3 mt-4">
  <div class="row">
    <div class="col-12">

      <h2 class="mb-4">Catalogues disponibles</h2>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <% if (catalogues.length === 0) { %>
        <div class="alert alert-info text-center">
          <h4>Aucun catalogue actif</h4>
          <p>Il n'y a actuellement aucun catalogue disponible pour faire des commandes.</p>
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="tbcatalogues">
            <thead class="table-dark">
              <tr>
                <th>N°</th>
                <th>Nom</th>
                <th class="d-none d-md-table-cell">Description</th>
                <th class="d-none d-md-table-cell">Expiration Commande</th>
                <th class="d-none d-md-table-cell">Livraison Estimée</th>
                <th>Action</th>
                <th class="d-none d-md-table-cell">Référent</th>
                <th class="d-none d-md-table-cell">Pan.</th>
                <th class="d-none d-md-table-cell">Cde.</th>
              </tr>
            </thead>
            <tbody>
              <% 
                // Calculer la date hier (même heure que maintenant)
                const today = new Date();
                const hier = new Date(today);
                hier.setDate(today.getDate() - 1);
              %>
              <% catalogues.forEach(function(catalogue) { %>
                <tr>
                  <td class="text-center" data-order="<%= catalogue.id %>" data-search="<%= catalogue.id %>">
                    <%= catalogue.id %>
                  </td>
                  <td>
                    <div class="d-flex align-items-start gap-2">
                      <% if (catalogue.image_filename) { %>
                        <img
                          src="/uploads/catalogue-images/<%= catalogue.image_filename %>"
                          alt="Image catalogue"
                          class="img-thumbnail"
                          style="width: 48px; height: 48px; object-fit: cover; flex: 0 0 auto; cursor: zoom-in;"
                          data-bs-toggle="modal"
                          data-bs-target="#catalogueImageModal"
                          data-catalogue-imgsrc="/uploads/catalogue-images/<%= catalogue.image_filename %>"
                        />
                      <% } %>
                      <div class="fw-bold"><%= catalogue.originalname %></div>
                    </div>
                    <!-- Informations supplémentaires sur mobile uniquement -->
                    <div class="d-md-none small text-muted">
                      <% if (catalogue.expiration_date) { %>
                        <% 
                          const expDate = new Date(catalogue.expiration_date);
                          const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                          const dayName = dayNames[expDate.getDay()];
                        %>
                        Expire le: <%= dayName %> <%= formatDate(catalogue.expiration_date) %>
                      <% } %>
                      <% if (catalogue.date_livraison) { %>
                        <% 
                          const livrDate = new Date(catalogue.date_livraison);
                          const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                          const dayName = dayNames[livrDate.getDay()];
                        %>
                        <br>Livraison: <%= dayName %> <%= formatDate(catalogue.date_livraison) %>
                      <% } %>
                      <br>Référent: <%= catalogue.username %>
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <%= catalogue.description || '' %>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <% if (catalogue.expiration_date) { %>
                      <% 
                        const expDate = new Date(catalogue.expiration_date);
                        const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                        const dayName = dayNames[expDate.getDay()];
                      %>
                      <small class="text-muted d-block"><%= dayName %></small>
                      <%= formatDate(catalogue.expiration_date) %>
                    <% } %>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <% if (catalogue.date_livraison) { %>
                      <% 
                        const livrDate = new Date(catalogue.date_livraison);
                        const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                        const dayName = dayNames[livrDate.getDay()];
                      %>
                      <small class="text-muted d-block"><%= dayName %></small>
                      <%= formatDate(catalogue.date_livraison) %>
                    <% } %>
                  </td>
                  <td>
                    <% if (!catalogue.expiration_date || new Date(catalogue.expiration_date) > hier) { %>
                      <!-- Bouton sur mobile : pleine largeur -->
                      <div class="d-sm-none">

                        <a href="/panier/new/<%= catalogue.id %>" class="btn btn-success btn-sm w-100">
                          Faire un panier
                        </a>
                      </div>
                      <!-- Bouton sur desktop : compact -->
                      <div class="d-none d-sm-block">

                        <a href="/panier/new/<%= catalogue.id %>" class="btn btn-success btn-sm w-100">
                          Faire un panier
                        </a>
                      </div>
                    <% } else { %>
                      <span class="badge bg-secondary">Expiré</span>
                    <% } %>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <%= catalogue.username %>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <%= catalogue.nb_paniers_non_submis %>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <%= catalogue.nb_paniers_submis %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

</div>

<!-- DataTables CSS et JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<style>
</style>

<script>
$(document).ready(function() {
  // Configuration DataTables pour la vue utilisateur
  $('#tbcatalogues').DataTable({
    "language": {
      "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
    },
    "order": [[0, "asc"]], // Tri par défaut sur la colonne Numéro
    "pageLength": 25,
    "responsive": true,
    "dom": '<"row justify-content-center"<"col-auto"f><"col-auto"p>>rt<"row justify-content-center"<"col-auto"i><"col-auto"l>>',
    "columnDefs": [
      { 
        "targets": [0], // Numéro de catalogue
        "className": "text-center",
        "type": "num",
        "render": function(data, type) {
          if (type === 'sort' || type === 'type') {
            if (data) {
              const clean = data.toString().replace(/<[^>]*>/g, '');
              const match = clean.match(/\d+/);
              return match ? parseInt(match[0], 10) : 0;
            }
            return 0;
          }
          return data;
        }
      },
      { 
        "targets": [1], // Nom du catalogue
        "className": "text-start",
        "type": "string",
        "render": function(data, type) {
          if (type === 'sort' || type === 'type') {
            if (data) {
              let text = data.toString().trim();
              text = text.replace(/<[^>]*>/g, '');
              text = text.replace(/\s+/g, ' ').trim();
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [2], // Description
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'display') {
            // Limiter l'affichage à 200 caractères
            if (data && data.toString().trim().length > 200) {
              return data.toString().trim().substring(0, 200) + '...';
            }
            return data;
          }
          if (type === 'sort' || type === 'type') {
            if (data) {
              let text = data.toString().trim();
              text = text.replace(/<[^>]*>/g, '');
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [3], // Date d'expiration
        "type": "date",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
            if (data && data !== 'N/A' && data.trim() !== '') {
              // Extraire tout le texte du HTML
              let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
              
              // Chercher un pattern DD/MM/YYYY dans le texte
              const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if (dateMatch) {
                // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                const year = dateMatch[3];
                return year + '-' + month + '-' + day;
              }
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [4], // Date de livraison
        "type": "date",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri des dates, extraire seulement la date DD/MM/YYYY du HTML
            if (data && data !== 'N/A' && data.trim() !== '') {
              // Extraire tout le texte du HTML
              let dateText = data.toString().replace(/<[^>]*>/g, '').trim();
              
              // Chercher un pattern DD/MM/YYYY dans le texte
              const dateMatch = dateText.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if (dateMatch) {
                // Convertir DD/MM/YYYY en YYYY-MM-DD pour tri correct
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                const year = dateMatch[3];
                return year + '-' + month + '-' + day;
              }
            }
            return '';
          }
          return data;
        }
      },
      { "orderable": false, "targets": [5] }, // Désactiver le tri sur la colonne Actions
      { "searchable": false, "targets": [5] }, // Désactiver la recherche sur la colonne Actions
      { 
        "targets": [6], // Référent
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            if (data) {
              let text = data.toString().trim();
              text = text.replace(/<[^>]*>/g, '');
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [7, 8], // Paniers et Commandes
        "type": "num",
        "className": "text-center",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            if (data) {
              const match = data.toString().match(/\d+/);
              return match ? parseInt(match[0]) : 0;
            }
            return 0;
          }
          return data;
        }
      }
    ]
  });
});
</script>

<!-- Modal d'agrandissement d'image catalogue -->
<div class="modal fade" id="catalogueImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="catalogueImageModalImg" src="" alt="Image catalogue" style="width: 100%; height: auto; display: block;" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Alimentation du modal d'agrandissement (catalogue)
document.addEventListener('click', function(e) {
  const thumb = e.target.closest('[data-catalogue-imgsrc]');
  if (!thumb) return;
  const img = document.getElementById('catalogueImageModalImg');
  if (img) img.src = thumb.getAttribute('data-catalogue-imgsrc');
});
</script>

</div>
<%- include('partials/footer') %>