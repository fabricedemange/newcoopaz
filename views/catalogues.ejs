<%- include('partials/header', { title: 'Catalogue' , user, role }) %>

<div class="admin-content-wrapper">

<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<!-- DataTables Responsive CSS -->
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">

<style>
  /* Styles personnalisés pour DataTables */
  .dataTables_wrapper .dataTables_length,
  .dataTables_wrapper .dataTables_filter,
  .dataTables_wrapper .dataTables_info,
  .dataTables_wrapper .dataTables_paginate {
    margin: 10px 0;
  }

  .dataTables_wrapper .dataTables_filter input {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.375rem 0.75rem;
  }

  .dataTables_wrapper .dataTables_length select {
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
    padding: 0.375rem 0.75rem;
  }

  .table-responsive .dataTables_wrapper {
    overflow-x: visible;
  }
</style>
  <div class="container-fluid px-3 mt-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-4">Catalogue</h2>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="cataloguesTable">
            <thead class="table-dark">
              <tr>
                <th>Produit</th>
                <th class="d-none d-md-table-cell">Description</th>
                <th class="d-none d-sm-table-cell">Prix</th>
                <th>Actions</th>
              </tr>
              <tr>
                <th><input type="text" placeholder="Rechercher produit..." class="form-control form-control-sm" /></th>
                <th class="d-none d-md-table-cell"><input type="text" placeholder="Rechercher description..." class="form-control form-control-sm" /></th>
                <th class="d-none d-sm-table-cell"></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% articles.forEach(function(a) { %>
                <tr>
                  <td>
                    <div class="fw-bold">
                      <%= a.produit %>
                    </div>
                    <!-- Informations supplémentaires sur mobile -->
                    <div class="d-md-none small text-muted">
                      <%= a.description %>
                    </div>
                    <div class="d-sm-none small text-muted">
                      Prix: <%= a.prix %>
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <%= a.description %>
                  </td>
                  <td class="d-none d-sm-table-cell">
                    <%= a.prix %>
                  </td>
                  <td>
                    <!-- Actions sur mobile : boutons empilés -->
                    <div class="d-sm-none">
                      <form action="/panier/add" method="POST" class="mb-2">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="article_id" value="<%= a.id %>">
                        <button type="submit" class="btn btn-success btn-sm w-100">
                          Ajouter au panier
                        </button>
                      </form>
                    </div>

                    <!-- Actions sur desktop/tablet : boutons horizontaux -->
                    <div class="d-none d-sm-block">
                      <form action="/panier/add" method="POST" class="d-inline">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="article_id" value="<%= a.id %>">
                        <button type="submit" class="btn btn-success btn-sm">
                          Ajouter au panier
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<!-- jQuery (requis pour DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<!-- DataTables Responsive JS -->
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
  // Configuration DataTables pour le tableau des catalogues
  var table = $('#cataloguesTable').DataTable({
    "language": {
      "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
    },
    "order": [[0, "asc"]], // Tri par défaut sur la colonne "Produit"
    "pageLength": 25,
    "responsive": true,
    "dom": '<"row mb-3"<"col-sm-6"l><"col-sm-6"f>>rtip',
    "orderCellsTop": true,
    "fixedHeader": true,
    "columnDefs": [
      { 
        "targets": [0], // Produit
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri, extraire le texte du produit et normaliser
            if (data) {
              let text = data.toString().trim();
              // Supprimer les balises HTML si présentes
              text = text.replace(/<[^>]*>/g, '');
              // Normaliser les accents pour le tri
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [1], // Description
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri de la description, normaliser le texte
            if (data) {
              let text = data.toString().trim();
              // Supprimer les balises HTML si présentes
              text = text.replace(/<[^>]*>/g, '');
              // Normaliser les accents pour le tri
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [2], // Prix
        "className": "text-end",
        "type": "num",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri, extraire le nombre de la chaîne de prix
            if (data) {
              const match = data.toString().match(/[\d,\.]+/);
              if (match) {
                return parseFloat(match[0].replace(',', '.'));
              }
            }
            return 0;
          }
          return data;
        }
      },
      { 
        "targets": [3], // Actions - désactiver le tri car contient des formulaires
        "orderable": false,
        "searchable": false,
        "className": "text-center"
      }
    ]
  });

  // Filtre par colonne pour Produit et Description
  $('#cataloguesTable thead tr:eq(1) th').each(function(i) {
    if (i === 0 || i === 1) { // Colonnes Produit et Description
      $('input', this).on('keyup change', function() {
        if (table.column(i).search() !== this.value) {
          table
            .column(i)
            .search(this.value)
            .draw();
        }
      });
    }
  });
});
</script>

</div>
  <%- include('partials/footer') %>
