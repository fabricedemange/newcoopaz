<%- include('partials/header', { title: 'Synthèse commandes', user, role }) %>

<div class="admin-content-wrapper">


<div class="container-fluid px-3 mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Synthèse des commandes par produit</h2>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <% if (synthese.length === 0) { %>
        <div class="alert alert-info text-center">
          <h4>Aucune commande pour ce catalogue</h4>
          <p>Aucune commande n'a été passée pour ce catalogue.</p>
          <a href="/admin/catalogues" class="btn btn-primary">Retour aux catalogues</a>
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="syntheseTable">
            <thead class="table-dark">
              <tr>
                <th>Produit</th>
                <th class="d-none d-sm-table-cell">Prix unitaire</th>
                <th class="d-none d-lg-table-cell text-center">Quantité totale</th>
                <th class="text-end">Montant total</th>
              </tr>
            </thead>
            <tbody>
              <% var totalGeneral = 0; %>
              <% synthese.forEach(function(row) { %>
                <% var montantProduit = (row.prix * (row.total_commande || 0)); %>
                <% totalGeneral += montantProduit; %>
                <tr>
                  <td>
                    <div class="fw-bold"><%= row.produit %></div>
                    <% if (row.note && row.note.trim() !=='' ) { %>
                      <div><span style="text-decoration: underline;">Note Commande: <%= row.note %></span>
                      </div>
                      <% } %>
                    <% if (row.note_article && row.note_article.trim() !=='' ) { %>
                      <div><span style="text-decoration: underline;">Note Article: <%= row.note_article %></span>
                      </div>             
                    <% } %>
                    <div class="d-sm-none small text-muted">
                      Prix: <%= row.prix %> €
                    </div>
                    <div class="d-lg-none small text-muted">
                      Quantité: <%= row.total_commande || 0 %>
                    </div>
                  </td>
         
                  <td class="d-none d-sm-table-cell">
                    <%= row.prix %> €
                  </td>
                  <td class="d-none d-lg-table-cell text-center">
                    <span class="badge bg-primary"><%= row.total_commande || 0 %></span>
                  </td>
                  <td class="text-end">
                    <strong><%= montantProduit.toFixed(2) %> €</strong>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Section d'export -->
  <% if (synthese.length > 0) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Exporter les données</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-column flex-sm-row gap-2">

              <a href="/admin/catalogues/<%= catalogueId %>/synthese/export/xlsx" class="btn btn-outline-success">
                <i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel
              </a>
              <a href="/admin/catalogues/<%= catalogueId %>/synthese/export/pdf/S" class="btn btn-outline-danger">
                <i class="bi bi-file-earmark-pdf me-2"></i>Exporter en PDF
              </a>

<!-- Bouton Envoi Mail -->
<button id="send-mail-btn" class="btn btn-primary">
  Envoyer la synthèse par mail à <%= organizationName %>
</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Statistiques -->
  <% if (synthese.length > 0) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Statistiques</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-md-3">
                <div class="text-center">
                  <h4 class="text-primary"><%= synthese.length %></h4>
                  <p class="text-muted">Produits</p>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center">
                  <h4 class="text-success"><%= synthese.reduce((sum, row) => sum + (row.total_commande || 0), 0) %></h4>
                  <p class="text-muted">Quantité totale</p>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center">
                  <h4 class="text-info"><%= (synthese.reduce((sum, row) => sum + (row.prix * (row.total_commande || 0)), 0) / synthese.length).toFixed(2) %> €</h4>
                  <p class="text-muted">Montant moyen</p>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center">
                  <h4 class="text-warning"><%= synthese.reduce((sum, row) => sum + (row.prix * (row.total_commande || 0)), 0).toFixed(2) %> €</h4>
                  <p class="text-muted">Total général</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Top 5 des produits les plus commandés -->
  <% if (synthese.length > 0) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Top 5 des produits les plus commandés</h5>
          </div>
          <div class="card-body">
            <% 
              let topProduits = synthese
                .sort((a, b) => (b.total_commande || 0) - (a.total_commande || 0))
                .slice(0, 5);
            %>
            <div class="list-group">
              <% topProduits.forEach(function(produit, index) { %>
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1"><%= index + 1 %>. <%= produit.produit %></h6>
                    <small class="text-muted">Prix: <%= produit.prix %> €</small>
                  </div>
                  <div class="text-end">
                    <span class="badge bg-primary rounded-pill"><%= produit.total_commande || 0 %></span>
                    <div class="small text-muted">
                      <%= ((produit.prix * (produit.total_commande || 0))).toFixed(2) %> €
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Boutons de navigation -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="/admin/catalogues/vue" class="btn btn-secondary">
          Retour à la liste des catalogues
        </a>

        <a href="/admin/catalogues/<%= catalogueId %>/synthese-detaillee/vue" class="btn btn-outline-primary">
          Voir la synthèse détaillée
        </a>
        <a href="/admin/menu" class="btn btn-outline-secondary">
          Retour au menu admin
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Toast Bootstrap pour la notification -->
<div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="mailToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="mail-toast-msg">
        Mail envoyé !
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Fermer"></button>
    </div>
  </div>
</div>

<!-- DataTables CSS et JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function() {
    // Configuration DataTables pour le tableau de synthèse
    $('#syntheseTable').DataTable({
      "language": {
        "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
      },
      "order": [[3, "desc"]], // Tri par défaut sur la colonne "Montant total" (index 3)
      "pageLength": 50,
      "responsive": true,
      "dom": '<"row mb-3"<"col-sm-6"f><"col-sm-6"l>>rtip',
      "columnDefs": [
        { 
          "targets": [0], // Produit
          "className": "text-start",
          "type": "string",
          "render": function(data, type, row) {
            if (type === 'sort' || type === 'type') {
              // Pour le tri, normaliser le texte du produit
              if (data) {
                let text = data.toString().trim();
                // Supprimer les balises HTML si présentes
                text = text.replace(/<[^>]*>/g, '');
                // Normaliser les accents pour le tri
                text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return text.toLowerCase();
              }
              return '';
            }
            return data;
          }
        },
        { 
          "targets": [1], // Prix unitaire
          "className": "text-end",
          "type": "num",
          "render": function(data, type, row) {
            if (type === 'sort' || type === 'type') {
              // Pour le tri, extraire le nombre de la chaîne "X.XX €"
              if (data) {
                const match = data.toString().match(/[\d,\.]+/);
                if (match) {
                  return parseFloat(match[0].replace(',', '.'));
                }
              }
              return 0;
            }
            return data;
          }
        },
        { 
          "targets": [2], // Quantité
          "className": "text-center",
          "type": "num"
        },
        { 
          "targets": [3], // Montant total
          "className": "text-end",
          "type": "num",
          "render": function(data, type, row) {
            if (type === 'sort' || type === 'type') {
              // Pour le tri, extraire le nombre de la chaîne avec HTML
              if (data) {
                // Supprimer les balises HTML d'abord
                let cleanValue = data.toString().replace(/<[^>]*>/g, '');
                // Extraire le nombre
                const match = cleanValue.match(/[\d,\.]+/);
                if (match) {
                  return parseFloat(match[0].replace(',', '.'));
                }
              }
              return 0;
            }
            return data;
          }
        }
      ],
      "footerCallback": function (row, data, start, end, display) {
        var api = this.api();
        
        // Fonction pour convertir les montants en nombres
        var intVal = function (i) {
          if (typeof i === 'string') {
            // Supprimer les balises HTML et extraire le nombre
            var cleanValue = i.replace(/<[^>]*>/g, '').replace(/[\€\s]/g, '').replace(',', '.');
            var result = parseFloat(cleanValue) || 0;
            // Debug temporaire
            if (cleanValue) console.log('Original:', i, 'Clean:', cleanValue, 'Result:', result);
            return result;
          }
          return typeof i === 'number' ? i : 0;
        };

        // Calcul du total filtré (uniquement les lignes affichées après filtre)
        var totalFiltre = api
          .column(3, {search: 'applied'})
          .data()
          .reduce(function (a, b) {
            return intVal(a) + intVal(b);
          }, 0);

        // Affichage du total dans le footer
        var existingFooter = $(api.table().container()).find('tfoot');
        if (existingFooter.length === 0) {
          // Déterminer le colspan selon la largeur d'écran
          var colspanValue = 3;
          var screenWidth = window.innerWidth;
          
          if (screenWidth < 576) {
            colspanValue = 1;
          } else if (screenWidth < 992) {
            colspanValue = 2;
          } else {
            colspanValue = 3;
          }
          
          $(api.table().container()).find('table').append(
            '<tfoot><tr class="table-secondary">' +
            '<th colspan="' + colspanValue + '" class="text-end">Total filtré :</th>' +
            '<th class="text-end"><span class="badge bg-info fs-6" id="total-amount"></span></th>' +
            '</tr></tfoot>'
          );
        } else {
          // Mettre à jour le colspan si le footer existe déjà
          var colspanValue = 3;
          var screenWidth = window.innerWidth;
          
          if (screenWidth < 576) {
            colspanValue = 1;
          } else if (screenWidth < 992) {
            colspanValue = 2;
          } else {
            colspanValue = 3;
          }
          existingFooter.find('th:first').attr('colspan', colspanValue);
        }
        
        // Mise à jour du montant filtré
        $('#total-amount').html(totalFiltre.toFixed(2) + ' €');
      }
    });

    // Gestionnaire de redimensionnement pour ajuster le footer responsive
    $(window).on('resize', function() {
      var table = $('#syntheseTable').DataTable();
      // Redessiner le tableau pour recalculer le footer
      table.draw(false);
    });
  });

  // Script existant pour l'envoi de mail
  document.getElementById("send-mail-btn").onclick = function () {
    fetch("/admin/catalogues/<%= catalogueId %>/synthese/export/pdf/M")
      .then(response => response.text())
      .then(msg => {
        // Affiche le toast Bootstrap
        document.getElementById('mail-toast-msg').innerText = msg;
        var toast = new bootstrap.Toast(document.getElementById('mailToast'));
        toast.show();
      })
      .catch(err => {
        document.getElementById('mail-toast-msg').innerText = "Erreur lors de l'envoi du mail.";
        var toast = new bootstrap.Toast(document.getElementById('mailToast'));
        toast.show();
      });
  };
</script>

</div>
<%- include('partials/footer') %>
