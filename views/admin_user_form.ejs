<%- include('partials/header', { title: action === 'add' ? 'Ajouter un utilisateur' : 'Éditer un utilisateur', user, role }) %>

<div class="admin-content-wrapper">
<div class="container">
  <h2><%= action === 'add' ? 'Ajouter un utilisateur' : 'Éditer un utilisateur' %></h2>
  <% if(error){ %><div class="alert alert-danger"><%= error %></div><% } %>
 
  <form method="POST" action="<%= action === 'add' ? '/admin/users/new' : '/admin/users/' + user.id + '/edit' %>">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <div class="mb-3">
    
      <label class="form-label">Nom d'utilisateur</label>
      <input type="text" name="username" class="form-control" required value="<%= user ? user.username : '' %>">
    </div>
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" name="email" class="form-control" required value="<%= user ? user.email : '' %>">
    </div>
    <input type="hidden" name="email_catalogue" value="0">
    <div class="form-check form-switch mb-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="email_catalogue"
        name="email_catalogue"
        value="1"
        <%= user ? (user.email_catalogue ? 'checked' : '') : 'checked' %>
      >
      <label class="form-check-label" for="email_catalogue">
        Recevoir les notifications des nouveaux catalogues
      </label>
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <input type="text" name="description" class="form-control" value="<%= user ? user.description : '' %>">
    </div>
    <div class="mb-3">
      <label class="form-label">Mot de passe <%= action === 'edit' ? '(laisser vide pour ne pas changer)' : '' %></label>
      <input type="password" name="password" class="form-control" <%= action === 'add' ? 'required' : '' %>>
    </div>
<div class="mb-3">
  <label class="form-label">Rôles RBAC</label>
  <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
    <% if (allRoles && allRoles.length > 0) { %>
      <% allRoles.forEach(function(rbacRole) { %>
        <div class="form-check mb-2">
          <input
            class="form-check-input"
            type="checkbox"
            name="rbac_roles[]"
            value="<%= rbacRole.id %>"
            id="role_<%= rbacRole.id %>"
            <%= userRoleIds && userRoleIds.includes(rbacRole.id) ? 'checked' : '' %>
            <%= rbacRole.name === 'utilisateur' && (!userRoleIds || userRoleIds.length === 0) ? 'checked' : '' %>
          >
          <label class="form-check-label" for="role_<%= rbacRole.id %>">
            <strong><%= rbacRole.display_name %></strong>
            <% if (rbacRole.name === 'utilisateur') { %>
              <span class="badge bg-secondary ms-1">Par défaut</span>
            <% } %>
            <% if (rbacRole.description) { %>
              <br><small class="text-muted"><%= rbacRole.description %></small>
            <% } %>
          </label>
        </div>
      <% }); %>
    <% } else { %>
      <p class="text-muted mb-0">Aucun rôle disponible</p>
    <% } %>
  </div>
  <small class="form-text text-muted">
    Sélectionnez un ou plusieurs rôles. Le rôle "Utilisateur" est sélectionné par défaut pour les nouveaux utilisateurs.
  </small>
</div>
<% if (role === 'SuperAdmin' && organizations) { %>
  <div class="mb-3">
    <label for="orgSelect" class="form-label">Organisation</label>
    <select class="form-select" id="orgSelect" name="organization_id" required>
      <option value="">Sélectionner une organisation</option>
      <% organizations.forEach(function(org) { %>
        <option value="<%= org.id %>" <%= user && user.organization_id == org.id ? "selected" : "" %>><%= org.name %></option>
      <% }) %>
    </select>
  </div>
<% } %>
    <button type="submit" class="btn btn-primary"><%= action === 'add' ? 'Ajouter' : 'Enregistrer' %></button>
    <a href="/admin/users/vue" class="btn btn-secondary">Annuler</a>
  </form>
</div>
</div>
<%- include('partials/footer') %>
