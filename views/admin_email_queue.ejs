<%- include('partials/header', { title: "File d'attente email", user, role }) %>

<div class="admin-content-wrapper">

<div class="container-fluid px-3 mt-4">
  <div class="row mb-3">
    <div class="col-12">
      <h2 class="mb-2">Suivi des envois d'emails</h2>
      <p class="text-muted mb-0">
        Derniers <%= limit %> enregistrements triés par date de création décroissante.
      </p>
    </div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <% if (subjectSummary && subjectSummary.length) { %>
    <div class="card mb-4">
      <div class="card-header bg-light">
        <strong>Notifications catalogue / produits</strong>
      </div>
      <div class="card-body p-3">
        <div class="table-responsive">
          <table id="notificationSummaryTable" class="table table-sm table-striped align-middle mb-0 w-100">
            <thead class="table-light">
              <tr>
                <th scope="col">Sujet</th>
                <th scope="col">Initiateur</th>
                <th scope="col" class="text-end">En attente</th>
                <th scope="col" class="text-end">Envoyés</th>
                <th scope="col" class="text-end">Total</th>
                <th scope="col">Dernière activité</th>
              </tr>
            </thead>
            <tbody>
              <% subjectSummary.forEach(function(item) { %>
                <tr>
                  <td><div class="text-wrap" style="max-width: 360px;"><%= item.subject %></div></td>
                  <td><%= item.initiated_by_display %></td>
                  <td class="text-end"><%= item.pending_count %></td>
                  <td class="text-end"><%= item.sent_count %></td>
                  <td class="text-end"><%= item.total_count %></td>
                  <td data-order="<%= item.last_activity_ts !== null ? item.last_activity_ts : 0 %>">
                    <%= item.last_activity ? new Date(item.last_activity).toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }) : '—' %>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% } %>

  <div class="card">
    <div class="card-body p-3">
      <div class="row justify-content-center align-items-center g-2 mb-3" id="emailQueueControls" style="display:none;">
        <div class="col-12 col-lg-auto d-flex justify-content-center" id="emailQueueFilterContainer"></div>
        <div class="col-12 col-lg-auto d-flex justify-content-center" id="emailQueueLengthContainer"></div>
        <div class="col-12 col-lg-auto d-flex justify-content-center" id="emailQueuePaginationContainer"></div>
      </div>
      <div class="table-responsive">
        <table id="emailQueueTable" class="table table-striped table-hover align-middle w-100">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Statut</th>
              <th scope="col">Initiateur</th>
              <th scope="col">Destinataires</th>
              <th scope="col">Sujet</th>
              <th scope="col">Tentatives</th>
              <th scope="col">Programmé le</th>
              <th scope="col">Envoyé le</th>
              <th scope="col">Dernière mise à jour</th>
              <th scope="col">Erreur</th>
            </tr>
          </thead>
          <tbody>
            <% if (!entries || entries.length === 0) { %>
              <tr>
                <td colspan="10" class="text-center py-4 text-muted">Aucun enregistrement trouvé.</td>
              </tr>
            <% } else { %>
              <% entries.forEach(function(entry) { %>
                <tr>
                  <td><code><%= entry.id %></code></td>
                  <td>
                    <% if (entry.status === 'sent') { %>
                      <span class="badge bg-success">envoyé</span>
                    <% } else if (entry.status === 'pending') { %>
                      <span class="badge bg-secondary">en attente</span>
                    <% } else if (entry.status === 'sending') { %>
                      <span class="badge bg-info text-dark">en cours</span>
                    <% } else { %>
                      <span class="badge bg-danger">erreur</span>
                    <% } %>
                  </td>
                  <td><%= entry.initiated_by_display %></td>
                  <td><div class="text-wrap" style="max-width: 250px;"><%= entry.to_display %></div></td>
                  <td><div class="text-wrap" style="max-width: 280px;"><%= entry.subject || '' %></div></td>
                  <td><%= entry.attempt_count %></td>
                  <td><%= entry.scheduled_at_formatted %></td>
                  <td><%= entry.sent_at_formatted %></td>
                  <td><%= entry.updated_at_formatted %></td>
                  <td>
                    <% if (entry.last_error) { %>
                      <span class="text-danger" title="<%= entry.last_error %>">
                        <%= entry.last_error.substring(0, 80) %><%= entry.last_error.length > 80 ? '…' : '' %>
                      </span>
                    <% } else { %>
                      <span class="text-muted">—</span>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dataTablesLanguage = {
      url: "/public/js/i18n/datatables.fr.json",
      search: "",
      searchPlaceholder: "Rechercher…",
    };

    const summaryTableElement = $("#notificationSummaryTable");
    if (summaryTableElement.length) {
      const summaryTable = summaryTableElement.DataTable({
        order: [[5, "desc"]],
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100, 250],
        dom: "lfrtip",
        language: dataTablesLanguage,
      });

      const summaryContainer = $(summaryTable.table().container());
      const summaryFilter = summaryContainer.find(".dataTables_filter");
      if (summaryFilter.length) {
        const summaryLabel = summaryFilter.find("label");
        summaryLabel
          .addClass("d-flex align-items-center gap-2 mb-0")
          .contents()
          .filter(function () {
            return this.nodeType === 3;
          })
          .remove();
        summaryLabel
          .find("input")
          .addClass("form-control form-control-sm")
          .attr("placeholder", "Rechercher…")
          .css({ maxWidth: "220px" });
      }

      const summaryLength = summaryContainer.find(".dataTables_length");
      if (summaryLength.length) {
        summaryLength
          .addClass("d-inline-flex align-items-center gap-2 mb-2")
          .find("select")
          .addClass("form-select form-select-sm");
      }
    }

    const table = $("#emailQueueTable").DataTable({
      order: [[0, "desc"]],
      pageLength: 25,
      lengthMenu: [10, 25, 50, 100, 200],
      dom: "lfrtip",
      language: dataTablesLanguage,
      drawCallback: function () {
        const pagination = $("#emailQueueTable_paginate");
        if (pagination && pagination.length) {
          pagination.addClass("justify-content-center");
        }
      },
    });

    const controls = document.getElementById("emailQueueControls");
    if (controls) {
      controls.style.display = "";
    }

    const tableContainer = $(table.table().container());
    const filter = tableContainer.find("#emailQueueTable_filter");
    const length = tableContainer.find("#emailQueueTable_length");
    const paginate = tableContainer.find("#emailQueueTable_paginate");

    if (filter.length) {
      const filterLabel = filter.find("label");
      filter
        .addClass("d-flex justify-content-center")
        .css({ float: "none", textAlign: "center" });
      filterLabel
        .addClass("d-flex align-items-center gap-2 mb-0")
        .removeClass("w-100");
      filterLabel.contents().filter(function () {
        return this.nodeType === 3;
      }).remove();
      filterLabel.find("input")
        .addClass("form-control text-center mx-auto")
        .attr("placeholder", "Rechercher…")
        .css({ maxWidth: "260px" });
      $("#emailQueueFilterContainer").append(filter);
    }

    if (length.length) {
      length
        .addClass("d-inline-flex align-items-center justify-content-center")
        .find("label")
        .addClass("w-100 mb-0");
      length.find("select").addClass("form-select text-center");
      length.find("label").contents().filter(function () {
        return this.nodeType === 3;
      }).remove();
      length.css({ float: "none", textAlign: "center" });
      $("#emailQueueLengthContainer").append(length);
    }

    if (paginate.length) {
      paginate
        .addClass("d-flex align-items-center justify-content-center gap-2 mt-0")
        .css({ float: "none" })
        .appendTo("#emailQueuePaginationContainer");
      $("#emailQueuePaginationContainer").addClass("d-flex justify-content-center");
    }
  });
</script>

</div>
<%- include('partials/footer') %>
