<%- include('partials/header', { title: 'Synthèse détaillée par utilisateur', user, role }) %>

<div class="admin-content-wrapper">

<div class="container-fluid px-3 mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Synthèse détaillée des commandes (par utilisateur)</h2>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <% if (details.length === 0) { %>
        <div class="alert alert-info text-center">
          <h4>Aucune commande pour ce catalogue</h4>
          <p>Aucune commande n'a été passée pour ce catalogue.</p>
          <a href="/admin/catalogues/vue" class="btn btn-primary">Retour aux catalogues</a>
        </div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="syntheseDetailTable">
            <thead class="table-dark">
              <tr>
                <th>Utilisateur</th>
                <th class="d-none d-md-table-cell">Produit</th>
                <th class="d-none d-sm-table-cell">Prix</th>
                <th class="d-none d-md-table-cell text-center">Quantité</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              <% var montantTotal = 0; %>
              <% details.forEach(function(row) { %>
                <% montantTotal += parseFloat(row.montant_utilisateur || 0); %>
                <tr>
                  <td>
                    <div class="fw-bold"><%= row.username2 %></div>
                    <% if (row.note && row.note.trim() !=='' ) { %>
                      <div><span style="text-decoration: underline;">Note Commande: <%= row.note %></span>
                      </div>
                      <% } %>
                    <% if (row.note_article && row.note_article.trim() !=='' ) { %>
                      <div><span style="text-decoration: underline;">Note Perso: <%= row.note_article %></span>
                      </div>
                      <% } %>
                    <!-- Informations supplémentaires sur mobile -->
                    <div class="d-md-none small text-muted mt-1">
                      <strong><%= row.produit %></strong>
                    </div>
                    <div class="d-sm-none small text-muted">
                      Prix: <%= row.prix %> €
                    </div>
                    <div class="d-md-none small text-muted">
                      Quantité: <%= row.quantite %>
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <strong><%= row.produit %></strong>
                  </td>

                  <td class="d-none d-sm-table-cell">
                    <%= row.prix %> €
                  </td>
                  <td class="d-none d-md-table-cell text-center">
                    <%= row.quantite %>
                  </td>
                  <td class="text-end">
                    <strong><%= row.montant_utilisateur %> €</strong>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Section d'export -->
  <% if (details.length > 0) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Exporter les données</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-column flex-sm-row gap-2">

              <a href="/admin/catalogues/<%= catalogueId %>/synthese-detaillee/export/xlsx" class="btn btn-outline-success">
                <i class="bi bi-file-earmark-excel me-2"></i>Exporter en Excel
              </a>
              <a href="/admin/catalogues/<%= catalogueId %>/synthese-detaillee/export/pdf/S" class="btn btn-outline-danger">
                <i class="bi bi-file-earmark-pdf me-2"></i>Exporter en PDF
              </a>

<!-- Bouton Envoi Mail -->
<button id="send-mail-btn" class="btn btn-primary">
  Envoyer la synthèse par mail à <%= organizationName %>
</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Statistiques -->
  <% if (details.length > 0) { %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Statistiques</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-primary"><%= details.length %></h4>
                  <p class="text-muted">Lignes</p>
                </div>
              </div>
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-success"><%= new Set(details.map(d => d.username2)).size %></h4>
                  <p class="text-muted">Utilisateurs/Paniers</p>
                </div>
              </div>
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-info"><%= new Set(details.map(d => d.produit)).size %></h4>
                  <p class="text-muted">Produits</p>
                </div>
              </div>
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-secondary"><%= details.reduce((sum, d) => sum + parseInt(d.quantite || 0), 0) %></h4>
                  <p class="text-muted">Quantité totale</p>
                </div>
              </div>
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-warning"><%= details.reduce((sum, d) => sum + parseFloat(d.montant_utilisateur || 0), 0).toFixed(2) %> €</h4>
                  <p class="text-muted">Total €</p>
                </div>
              </div>
              <div class="col-6 col-md-2">
                <div class="text-center">
                  <h4 class="text-dark"><%= (details.reduce((sum, d) => sum + parseFloat(d.montant_utilisateur || 0), 0) / details.length).toFixed(2) %> €</h4>
                  <p class="text-muted">Montant moyen</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Boutons de navigation -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="/admin/catalogues/vue" class="btn btn-secondary">
          Retour à la liste des catalogues
        </a>

        <a href="/admin/menu" class="btn btn-outline-secondary">
          Retour au menu admin
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Toast Bootstrap pour la notification -->
<div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="mailToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="mail-toast-msg">
        Mail envoyé !
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Fermer"></button>
    </div>
  </div>
</div>

<!-- DataTables CSS et JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function() {
    // Configuration DataTables pour le tableau de synthèse détaillée
    $('#syntheseDetailTable').DataTable({
      "language": {
        "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
      },
      "order": [[0, "asc"]], // Tri par défaut sur la colonne "Utilisateur"
      "pageLength": 50,
      "responsive": true,
      "dom": '<"row mb-3"<"col-sm-6"f><"col-sm-6"l>>rtip',
      "columnDefs": [
        { 
          "targets": [2], // Prix
          "render": function(data, type, row) {
            if (type === 'display') {
              return data;
            }
            // Pour le tri, extraire le nombre de la chaîne "X.XX €"
            return parseFloat(data.replace(/[\€\s]/g, '').replace(',', '.')) || 0;
          }
        },
        { 
          "targets": [3], // Quantité
          "className": "text-center",
          "type": "num"
        },
        { 
          "targets": [4], // Total
          "className": "text-end",
          "render": function(data, type, row) {
            if (type === 'display') {
              return data;
            }
            // Pour le tri, extraire le nombre avec HTML
            var cleanValue = data.replace(/<[^>]*>/g, '').replace(/[\€\s]/g, '').replace(',', '.');
            return parseFloat(cleanValue) || 0;
          }
        }
      ],
      "footerCallback": function (row, data, start, end, display) {
        var api = this.api();
        
        // Fonction pour convertir les montants en nombres
        var intVal = function (i) {
          if (typeof i === 'string') {
            // Supprimer les balises HTML et extraire le nombre
            var cleanValue = i.replace(/<[^>]*>/g, '').replace(/[\€\s]/g, '').replace(',', '.');
            var result = parseFloat(cleanValue) || 0;
            return result;
          }
          return typeof i === 'number' ? i : 0;
        };

        // Calcul du total général (toutes les pages)
        var totalGeneral = api
          .column(4, {page:'all'})
          .data()
          .reduce(function (a, b) {
            return intVal(a) + intVal(b);
          }, 0);

        // Déterminer le colspan selon la largeur d'écran (responsive Bootstrap)
        var colspanValue = 4; // Par défaut (desktop)
        var screenWidth = window.innerWidth;
        
        if (screenWidth < 576) {
          // xs - très petit écran : seules Utilisateur et Total sont visibles
          colspanValue = 1;
        } else if (screenWidth < 768) {
          // sm - petit écran : Utilisateur, Prix, Total
          colspanValue = 2;
        } else if (screenWidth < 992) {
          // md - écran moyen : Utilisateur, Produit, Prix, Total
          colspanValue = 3;
        } else {
          // lg et plus - grand écran : toutes les colonnes
          colspanValue = 4;
        }

        // Affichage du total dans le footer (on l'ajoute dynamiquement)
        var existingFooter = $(api.table().container()).find('tfoot');
        if (existingFooter.length === 0) {
          $(api.table().container()).find('table').append(
            '<tfoot><tr class="table-secondary">' +
            '<th colspan="' + colspanValue + '" class="text-end">Total général :</th>' +
            '<th class="text-end">' +
              '<span class="badge bg-success fs-6" id="total-detail-amount"></span>' +
            '</th>' +
            '</tr></tfoot>'
          );
        } else {
          // Mettre à jour le colspan si le footer existe déjà
          existingFooter.find('th:first').attr('colspan', colspanValue);
        }
        
        // Mise à jour du montant total seulement
        $('#total-detail-amount').html(totalGeneral.toFixed(2) + ' €');
      }
    });

    // Gestionnaire de redimensionnement pour ajuster le footer responsive
    $(window).on('resize', function() {
      var table = $('#syntheseDetailTable').DataTable();
      // Redessiner le tableau pour recalculer le footer
      table.draw(false);
    });
  });

  // Script existant pour l'envoi de mail
  document.getElementById("send-mail-btn").onclick = function () {
    fetch("/admin/catalogues/<%= catalogueId %>/synthese-detaillee/export/pdf/M")
      .then(response => response.text())
      .then(msg => {
        // Affiche le toast Bootstrap
        document.getElementById('mail-toast-msg').innerText = msg;
        var toast = new bootstrap.Toast(document.getElementById('mailToast'));
        toast.show();
      })
      .catch(err => {
        document.getElementById('mail-toast-msg').innerText = "Erreur lors de l'envoi du mail.";
        var toast = new bootstrap.Toast(document.getElementById('mailToast'));
        toast.show();
      });
  };
</script>


</div>
<%- include('partials/footer') %>
