<%- include('partials/header', { title: 'Articles du catalogue', user, role }) %>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  /* Force la colonne Produit √† avoir au moins 400px de wide */
  #tbarticles tbody td:first-child,
  #tbarticles thead th:first-child {
    min-width: 400px !important;
    width: 400px;
  }
</style>

<div class="admin-content-wrapper">
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex align-items-start gap-3 mb-3">
        <% if (catalogue.image_filename) { %>
          <img
            src="/uploads/catalogue-images/<%= catalogue.image_filename %>"
            alt="Image catalogue"
            class="img-thumbnail"
            style="width: 88px; height: 88px; object-fit: cover; flex: 0 0 auto; cursor: zoom-in;"
            data-bs-toggle="modal"
            data-bs-target="#catalogueImageModal"
            data-catalogue-imgsrc="/uploads/catalogue-images/<%= catalogue.image_filename %>"
          />
        <% } %>
        <div>
          <h2 class="mb-1">Panier N¬∞<%= panier.id %> - Articles du catalogue (N¬∞:<%= catalogue.id %>) <%= catalogue.originalname %></h2>
          <p class="text-muted mb-0"><%= catalogue.description %></p>
        </div>
      </div>
      
      <!-- Informations sur les dates du catalogue -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="alert alert-info">
            <div class="row">
              <% if (catalogue.expiration_date) { %>
                <div class="col-md-6">
                  <strong>üìÖ Date limite commande :</strong> <%= formatDate(catalogue.expiration_date) %>
                </div>
              <% } %>
              <% if (catalogue.date_livraison) { %>
                <div class="col-md-6">
                  <strong>üöö Livraison estim√©e :</strong> <%= formatDate(catalogue.date_livraison) %>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      
      <% if (!modifiable) { %>
        <div class="alert alert-warning">
          Ce catalogue est expir√©, vous ne pouvez plus modifier votre panier.
        </div>
      <% } %>
    </div>
  </div>
  <!-- Pr√©remplissage du panier -->

   <div class="row mt-3 justify-content-center">
    <div class="col-auto text-center">
      <p class="text-muted">Cliquez sur le bouton ci-dessous pour pr√©remplir le panier avec vos articles command√©s r√©cemment.</p>
      <button class="btn btn-primary" id="auto-fill-cart" onclick="autoFillCart()">
        Pr√©remplir le panier avec vos commandes pass√©es
      </button>
    </div>
  </div>
  
  <br>
  <div class="row">
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="tbarticles">
          <thead class="table-dark">
            <tr>
              <th>Produit</th>
              <th class="d-none d-md-table-cell">Description</th>
              <th class="d-none d-md-table-cell">Prix</th>
              <th class="d-none d-lg-table-cell text-center">- Qt√© panier +</th>
            </tr>
          </thead>
          <tbody>
            <% articles.forEach(function(article) { %>
              <tr id="article-<%= article.id %>">
                <td>
                  <div class="d-flex align-items-start gap-2">
                    <% if (article.image_filename) { %>
                      <img
                        src="/uploads/article-images/<%= article.image_filename %>"
                        alt="Image produit"
                        class="img-thumbnail"
                        style="width: 56px; height: 56px; object-fit: cover; cursor: zoom-in; flex: 0 0 auto;"
                        data-bs-toggle="modal"
                        data-bs-target="#catalogueArticleImageModal"
                        data-article-imgsrc="/uploads/article-images/<%= article.image_filename %>"
                      />
                    <% } %>
                    <div class="flex-grow-1">
                      <div class="fw-bold"><%= article.produit %></div>
                    </div>
                  </div>
                  <!-- Informations suppl√©mentaires sur mobile -->
                  <div class="d-md-none small text-muted">
                    <%= article.description %>
                  </div>
                  <div class="d-md-none small text-muted">
                    Prix: <%= article.prix %>
                  </div>
                  <div class="d-lg-none small text-muted">
                    Quantit√© dans panier: <span class="article-quantity" data-article-id="<%= article.id %>"><%= quantitesDansPanier[article.id] || 0 %></span>
                  </div>
                  
                  <!-- Gestion des notes pour TOUS les √©crans (dans la colonne 1 Produit) -->
                  <% if (modifiable) { %>
                    <div class="article-note-container mt-2 mb-1 <%= (quantitesDansPanier[article.id] && quantitesDansPanier[article.id] > 0 && idParArticle && idParArticle[article.id]) ? '' : 'd-none' %>"
                         data-catalogue-article-id="<%= article.id %>"
                         <% if (quantitesDansPanier[article.id] && quantitesDansPanier[article.id] > 0 && idParArticle && idParArticle[article.id]) { %>
                           data-panier-article-id="<%= idParArticle[article.id] %>" data-note-initialized="true"
                         <% } %>>
                      <% if (quantitesDansPanier[article.id] && quantitesDansPanier[article.id] > 0 && idParArticle && idParArticle[article.id]) { %>
                        <!-- Bouton pour ouvrir/fermer la note -->
                        <button type="button" class="btn btn-outline-info btn-sm w-100" data-note-trigger="true" data-panier-article-id="<%= idParArticle[article.id] %>"
                                onclick="toggleArticleNote('<%= idParArticle[article.id] %>')"
                                title="<% if (NoteParArticle[article.id] && NoteParArticle[article.id].trim() !== '') { %>Modifier la note<% } else { %>Ajouter une note<% } %>">
                          <i class="bi bi-pencil-square"></i>
                          <% if (NoteParArticle[article.id] && NoteParArticle[article.id].trim() !== '') { %>
                            <span class="badge bg-warning">!</span> Note
                          <% } else { %>
                            Note
                          <% } %>
                        </button>

                        <!-- Affichage de la note existante -->
                        <% if (NoteParArticle[article.id] && NoteParArticle[article.id].trim() !== '') { %>
                          <div class="small text-muted mt-1 p-2 article-note-display" id="note-display-article-<%= idParArticle[article.id] %>"
                               style="background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 0.25rem;">
                            <strong>Note:</strong> <span class="note-content"><%= NoteParArticle[article.id] %></span>
                          </div>
                        <% } %>

                        <!-- Formulaire note unique pour tous les √©crans -->
                        <form class="note-form mt-2" data-note-form="true" data-article-id="<%= idParArticle[article.id] %>"
                              id="note-form-article-<%= idParArticle[article.id] %>" style="display: none;">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <textarea name="note" rows="3" class="form-control form-control-sm mb-2"
                            placeholder="Votre note personnelle..." style="resize: vertical; font-size: 0.9rem;"><%= NoteParArticle[article.id] || '' %></textarea>
                          <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-info btn-sm flex-grow-1">
                              <i class="bi bi-check-circle"></i> Sauvegarder
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                   onclick="toggleArticleNote('<%= idParArticle[article.id] %>')">
                              <i class="bi bi-x-circle"></i> Annuler
                            </button>
                          </div>
                          <span class="save-status text-success small mt-2 d-none">‚úì Sauvegard√© avec succ√®s</span>
                        </form>
                      <% } %>
                    </div>
                  <% } %>
                  
                  <!-- Actions mobiles (visible uniquement sur petits √©crans < 992px) -->
                  <% if (modifiable) { %>
                    <div class="d-lg-none mt-2">
                      <div class="d-flex gap-2 align-items-center justify-content-center">
                        <!-- Boutons Retirer/Quantit√©/Ajouter -->
                        <form method="POST" action="/panier/add" class="m-0 quantity-form">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <input type="hidden" name="catalog_product_id" value="<%= article.id %>">
                          <input type="hidden" name="panier_id" value="<%= panier.id %>">
                          <input type="hidden" name="catalog_file_id" value="<%= catalogue.id %>">
                          <input type="hidden" name="quantity" value="<%= -(article.unite || 1) %>">
                          <button type="submit" class="btn btn-danger btn-sm" title="Retirer <%= article.unite || 1 %>">
                            <i class="bi bi-dash-circle"></i>
                          </button>
                        </form>
                        <span class="badge bg-primary fs-6 px-3 article-quantity" data-article-id="<%= article.id %>"><%= quantitesDansPanier[article.id] || 0 %></span>
                        <form method="POST" action="/panier/add" class="m-0 quantity-form">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <input type="hidden" name="catalog_product_id" value="<%= article.id %>">
                          <input type="hidden" name="panier_id" value="<%= panier.id %>">
                          <input type="hidden" name="catalog_file_id" value="<%= catalogue.id %>">
                          <input type="hidden" name="quantity" value="<%= article.unite || 1 %>">
                          <button type="submit" class="btn btn-success btn-sm" title="Ajouter <%= article.unite || 1 %>">
                            <i class="bi bi-plus-circle"></i>
                          </button>
                        </form>
                      </div>
                    </div>
                  <% } %>
                </td> 
                <td class="d-none d-md-table-cell">
                  <%= article.description %>
                </td>
                <td class="d-none d-md-table-cell">
                  <%= article.prix %>
                </td>

                <% if (modifiable) { %>
                  <!-- Colonne Actions : Boutons Retirer/Quantit√©/Ajouter -->
                  <td class="d-none d-lg-table-cell">
                    <div class="d-flex align-items-center gap-2 justify-content-center">
                      <form method="POST" action="/panier/add" class="m-0 quantity-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="catalog_product_id" value="<%= article.id %>">
                        <input type="hidden" name="panier_id" value="<%= panier.id %>">
                        <input type="hidden" name="catalog_file_id" value="<%= catalogue.id %>">
                        <input type="hidden" name="quantity" value="<%= -(article.unite || 1) %>">
                        <button type="submit" class="btn btn-danger btn-sm" title="Retirer <%= article.unite || 1 %>">
                          <i class="bi bi-dash-circle"></i>
                        </button>
                      </form>
                      <span class="badge bg-primary fs-6 px-3 article-quantity" data-article-id="<%= article.id %>"><%= quantitesDansPanier[article.id] || 0 %></span>
                      <form method="POST" action="/panier/add" class="m-0 quantity-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="catalog_product_id" value="<%= article.id %>">
                        <input type="hidden" name="panier_id" value="<%= panier.id %>">
                        <input type="hidden" name="catalog_file_id" value="<%= catalogue.id %>">
                        <input type="hidden" name="quantity" value="<%= article.unite || 1 %>">
                        <button type="submit" class="btn btn-success btn-sm" title="Ajouter <%= article.unite || 1 %>">
                          <i class="bi bi-plus-circle"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                <% } else { %>
                  <!-- Si non modifiable, afficher seulement la quantit√© -->
                  <td class="d-none d-lg-table-cell text-center">
                    <span class="badge bg-secondary fs-6"><%= quantitesDansPanier[article.id] || 0 %></span>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- L√©gende responsive -->
  <div class="row mt-3">
    <div class="col-12">
      <div class="d-md-none">
        <small class="text-muted">
          * Toutes les informations sont affich√©es sous le nom du produit sur mobile
        </small>
      </div>
      <div class="d-none d-md-block">
        <small class="text-muted">
          * Produit et Description sont les champs obligatoires
        </small>
      </div>
    </div>
  </div>


</div>

<!-- DataTables CSS et JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
// üîí Fonction de protection XSS : √©chappe les caract√®res HTML dangereux
function escapeHtml(text) {
  if (!text) return '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
    '/': '&#x2F;'
  };
  return String(text).replace(/[&<>"'\/]/g, s => map[s]);
}

let cachedCsrfTokenValue;

function getCsrfTokenValue() {
  if (typeof cachedCsrfTokenValue === 'string') {
    return cachedCsrfTokenValue;
  }
  const csrfInput = document.querySelector('input[name="_csrf"]');
  cachedCsrfTokenValue = csrfInput ? csrfInput.value : '';
  return cachedCsrfTokenValue;
}

function getStepDecimals(step) {
  if (!Number.isFinite(step) || step <= 0) {
    return 0;
  }
  const stepString = String(step);
  if (stepString.includes('e-')) {
    const [, exponent] = stepString.split('e-');
    const parsed = parseInt(exponent, 10);
    return Number.isFinite(parsed) ? Math.min(6, Math.max(parsed, 0)) : 0;
  }
  const decimals = (stepString.split('.')[1] || '').replace(/0+$/, '').length;
  return Math.min(6, Math.max(decimals, 0));
}

function roundToStep(value, step) {
  if (!Number.isFinite(value) || !Number.isFinite(step) || step <= 0) {
    return value;
  }
  const ratio = value / step;
  const roundedRatio = Math.round(ratio);
  const result = roundedRatio * step;
  const decimals = getStepDecimals(step) + 2;
  return Number(result.toFixed(Math.min(decimals, 8)));
}

function formatQuantityForDisplay(value, step) {
  if (!Number.isFinite(value)) {
    return '0';
  }
  if (!Number.isFinite(step) || step <= 0) {
    return value.toString();
  }

  const normalizedValue = roundToStep(value, step);
  const decimals = getStepDecimals(step);
  const fixedValue = normalizedValue.toFixed(decimals);
  if (decimals === 0) {
    return fixedValue;
  }

  const trimmed = fixedValue
    .replace(/(\.\d*?[1-9])0+$/, '$1')
    .replace(/\.0+$/, '');

  return trimmed === '' ? '0' : trimmed;
}

function getNoteContainer(articleId) {
  return document.querySelector(`.article-note-container[data-catalogue-article-id="${articleId}"]`);
}

function getNoteContainerByPanierArticleId(panierArticleId) {
  return document.querySelector(`.article-note-container[data-panier-article-id="${panierArticleId}"]`);
}

function ensureNoteElements(container, panierArticleId) {
  if (!container || !panierArticleId) {
    return;
  }

  container.dataset.panierArticleId = panierArticleId;
  container.classList.remove('d-none');

  let button = container.querySelector('[data-note-trigger="true"]');
  if (!button) {
    button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-outline-info btn-sm w-100';
    button.setAttribute('data-note-trigger', 'true');
    container.appendChild(button);
  }
  button.setAttribute('data-panier-article-id', panierArticleId);
  button.setAttribute('onclick', `toggleArticleNote('${panierArticleId}')`);
  if (!button.innerHTML || button.innerHTML.trim() === '') {
    button.innerHTML = '<i class="bi bi-pencil-square"></i> Note';
  }
  if (!button.title) {
    button.title = 'Ajouter une note';
  }

  let display = container.querySelector('.article-note-display');
  if (!display) {
    display = document.createElement('div');
    display.className = 'small text-muted mt-1 p-2 article-note-display';
    display.style.cssText = 'display: none; background: #fff3cd; border-left: 3px solid #ffc107; border-radius: 0.25rem;';
    display.innerHTML = '<strong>Note:</strong> <span class="note-content"></span>';
    container.appendChild(display);
  }
  display.id = `note-display-article-${panierArticleId}`;

  let form = container.querySelector('form.note-form');
  if (!form) {
    form = document.createElement('form');
    form.className = 'note-form mt-2';
    form.setAttribute('data-note-form', 'true');
    form.style.display = 'none';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '_csrf';
    csrfInput.value = getCsrfTokenValue();
    form.appendChild(csrfInput);

    const textarea = document.createElement('textarea');
    textarea.name = 'note';
    textarea.rows = 3;
    textarea.className = 'form-control form-control-sm mb-2';
    textarea.placeholder = 'Votre note personnelle...';
    textarea.style.resize = 'vertical';
    textarea.style.fontSize = '0.9rem';
    form.appendChild(textarea);

    const actions = document.createElement('div');
    actions.className = 'd-flex gap-2';

    const saveButton = document.createElement('button');
    saveButton.type = 'submit';
    saveButton.className = 'btn btn-info btn-sm flex-grow-1';
    saveButton.innerHTML = '<i class="bi bi-check-circle"></i> Sauvegarder';
    actions.appendChild(saveButton);

    const cancelButton = document.createElement('button');
    cancelButton.type = 'button';
    cancelButton.className = 'btn btn-outline-secondary btn-sm';
    cancelButton.setAttribute('onclick', `toggleArticleNote('${panierArticleId}')`);
    cancelButton.innerHTML = '<i class="bi bi-x-circle"></i> Annuler';
    actions.appendChild(cancelButton);

    form.appendChild(actions);

    const status = document.createElement('span');
    status.className = 'save-status text-success small mt-2 d-none';
    status.textContent = '‚úì Sauvegard√© avec succ√®s';
    form.appendChild(status);

    container.appendChild(form);
  }
  form.setAttribute('data-article-id', panierArticleId);
  form.id = `note-form-article-${panierArticleId}`;
  const csrfField = form.querySelector('input[name="_csrf"]');
  if (csrfField) {
    csrfField.value = getCsrfTokenValue();
  }
  const cancelAction = form.querySelector('.btn-outline-secondary');
  if (cancelAction) {
    cancelAction.setAttribute('onclick', `toggleArticleNote('${panierArticleId}')`);
  }

  container.dataset.noteInitialized = 'true';
}

function ensureNoteSection(articleId, panierArticleId) {
  if (!articleId || !panierArticleId) {
    return;
  }
  const container = getNoteContainer(articleId);
  if (!container) {
    return;
  }
  ensureNoteElements(container, panierArticleId);
}

function hideNoteSection(articleId) {
  const container = getNoteContainer(articleId);
  if (!container) {
    return;
  }
  container.classList.add('d-none');
  const form = container.querySelector('form.note-form');
  if (form) {
    form.style.display = 'none';
  }
}

function updateNoteButtonAppearance(panierArticleId, hasNote) {
  const buttons = document.querySelectorAll(`[data-note-trigger="true"][data-panier-article-id="${panierArticleId}"]`);
  buttons.forEach(btn => {
    if (hasNote) {
      if (!btn.querySelector('.badge')) {
        btn.innerHTML = '<i class="bi bi-pencil-square"></i> <span class="badge bg-warning">!</span> Note';
      }
      btn.title = 'Modifier la note';
    } else {
      btn.innerHTML = '<i class="bi bi-pencil-square"></i> Note';
      btn.title = 'Ajouter une note';
    }
  });
}

function updateNoteDisplay(panierArticleId, noteText) {
  const display = document.getElementById(`note-display-article-${panierArticleId}`);
  if (!display) {
    return;
  }
  const content = display.querySelector('.note-content');
  if (content) {
    content.textContent = noteText;
  } else {
    display.textContent = noteText;
  }
  if (noteText && noteText.trim() !== '') {
    display.style.display = 'block';
  } else {
    display.style.display = 'none';
  }
}

function hasExistingNoteContent(panierArticleId) {
  const display = document.getElementById(`note-display-article-${panierArticleId}`);
  if (!display) {
    return false;
  }
  const content = display.querySelector('.note-content');
  if (content) {
    return content.textContent.trim() !== '';
  }
  return display.textContent.trim() !== '';
}

$(document).ready(function() {
  // Configuration DataTables pour le tableau des articles
  var table = $('#tbarticles').DataTable({
    "language": {
      "url": "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
    },
    "order": [], // Pas de tri par d√©faut - utilise l'ordre SQL du serveur
    "ordering": true, // Active le tri sur les colonnes
    "pageLength": 25,
    "responsive": true,
    "dom": '<"row justify-content-center mb-3"<"col-auto"f><"col-auto"p>>rt<"row justify-content-center"<"col-auto"i><"col-auto"l>>',
    "columnDefs": [
      { 
        "targets": [0], // Produit
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri, extraire le texte du produit et normaliser
            if (data) {
              let text = data.toString().trim();
              // Supprimer les balises HTML si pr√©sentes
              text = text.replace(/<[^>]*>/g, '');
              // Normaliser les accents pour le tri
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [1], // Description
        "className": "text-start",
        "type": "string",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri de la description, normaliser le texte
            if (data) {
              let text = data.toString().trim();
              // Supprimer les balises HTML si pr√©sentes
              text = text.replace(/<[^>]*>/g, '');
              // Normaliser les accents pour le tri
              text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
              return text.toLowerCase();
            }
            return '';
          }
          return data;
        }
      },
      { 
        "targets": [2], // Prix
        "className": "text-end",
        "type": "num",
        "render": function(data, type, row) {
          if (type === 'sort' || type === 'type') {
            // Pour le tri, extraire le nombre de la cha√Æne de prix
            if (data) {
              const match = data.toString().match(/[\d,\.]+/);
              if (match) {
                return parseFloat(match[0].replace(',', '.'));
              }
            }
            return 0;
          }
          return data;
        }
      },
      { 
        "targets": [3], // Actions (boutons -/+) avec quantit√© au centre
        "orderable": false,
        "searchable": false,
        "className": "text-center"
      }
    ]
  });

  // Scroll automatique vers l'article modifi√© (si pr√©sent dans l'URL)
  const urlParams = new URLSearchParams(window.location.search);
  const articleId = urlParams.get('article');
  
  if (articleId) {
    // Attendre que le DataTable soit compl√®tement initialis√©
    setTimeout(function() {
      const articleRow = document.getElementById('article-' + articleId);
      
      if (articleRow) {
        // Scroller vers l'article avec un effet smooth
        articleRow.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // Ajouter un effet visuel temporaire pour mettre en √©vidence l'article
        articleRow.style.backgroundColor = '#fff3cd'; // Jaune clair
        articleRow.style.transition = 'background-color 2s ease';
        
        setTimeout(function() {
          articleRow.style.backgroundColor = '';
        }, 2000);
      }
    }, 500); // D√©lai pour s'assurer que DataTables a fini de rendre la page
  }

  // Fonction pour afficher/masquer le formulaire de note
  window.toggleArticleNote = function(articleId) {
    const form = document.getElementById(`note-form-article-${articleId}`);
    const display = document.getElementById(`note-display-article-${articleId}`);
    
    if (!form) return; // Pas de formulaire trouv√©
    
    if (form.style.display === 'none' || form.style.display === '') {
      // Afficher le formulaire
      form.style.display = 'block';
      // Masquer l'affichage de la note existante
      if (display) {
        display.style.display = 'none';
      }
      // Focus sur le textarea
      const textarea = form.querySelector('textarea');
      if (textarea) {
        textarea.focus();
      }
    } else {
      // Masquer le formulaire
      form.style.display = 'none';
      // R√©afficher l'affichage de la note existante
      if (display) {
        display.style.display = 'block';
      }
    }
  };

  // AJAX pour sauvegarder les notes sans recharger la page
  $(document).on('submit', '.note-form', function(e) {
    e.preventDefault();
    
  const form = $(this);
  const articleId = form.data('article-id');
  const note = form.find('textarea[name="note"]').val();
  const csrf = form.find('input[name="_csrf"]').val();
  const status = form.find('.save-status');
    
    $.ajax({
      url: '/article/' + articleId + '/note',
      method: 'POST',
      data: {
        note: note,
        _csrf: csrf
      },
      success: function() {
        // Afficher le message de confirmation
        status.removeClass('d-none').addClass('d-block');
        setTimeout(function() {
          status.removeClass('d-block').addClass('d-none');
        }, 2000);
        
        const trimmedNote = (note || '').trim();
        const formElement = document.getElementById(`note-form-article-${articleId}`);
        const container = getNoteContainerByPanierArticleId(articleId) || (formElement ? formElement.closest('.article-note-container') : null);

        if (container) {
          ensureNoteElements(container, articleId);
        }

        if (trimmedNote !== '') {
          updateNoteDisplay(articleId, note);
          updateNoteButtonAppearance(articleId, true);
        } else {
          updateNoteDisplay(articleId, '');
          updateNoteButtonAppearance(articleId, false);
        }
        
        // Masquer le formulaire apr√®s sauvegarde
        setTimeout(function() {
          toggleArticleNote(articleId);
        }, 2000);
      },
      error: function() {
        alert('Erreur lors de la sauvegarde de la note');
      }
    });
  });

  // Gestion AJAX des formulaires quantit√© (+/-) pour √©viter le rechargement complet
  const articleUpdateState = {};

  $(document).on('submit', '.quantity-form', function(e) {
    e.preventDefault();

    const $form = $(this);
    const formData = new FormData(this);
    const payload = new URLSearchParams();
    formData.forEach((value, key) => {
      payload.append(key, value);
    });

    const articleId = formData.get('catalog_product_id');
    const deltaValue = Number(formData.get('quantity')) || 0;
    const stepValue = Math.abs(deltaValue) > 0 ? Math.abs(deltaValue) : 1;
    const quantityElements = Array.from(document.querySelectorAll(`.article-quantity[data-article-id="${articleId}"]`));
    const previousQuantity = quantityElements.length
      ? Number(quantityElements[0].textContent) || 0
      : 0;
    const optimisticQuantity = Math.max(0, roundToStep(previousQuantity + deltaValue, stepValue));
    const optimisticDisplay = formatQuantityForDisplay(optimisticQuantity, stepValue);

    quantityElements.forEach(el => {
      el.textContent = optimisticDisplay;
    });

    const requestToken = (articleUpdateState[articleId]?.token || 0) + 1;
    const noteContainer = getNoteContainer(articleId);
    articleUpdateState[articleId] = {
      token: requestToken,
      previous: previousQuantity,
      previousDisplay: quantityElements.length ? quantityElements[0].textContent.trim() : '0',
      step: stepValue,
      noteVisibleBefore: noteContainer ? !noteContainer.classList.contains('d-none') : false,
      previousPanierArticleId: noteContainer ? (noteContainer.dataset.panierArticleId || null) : null
    };

    fetch($form.attr('action'), {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      },
      body: payload
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('R√©ponse serveur invalide');
        }
        return response.json();
      })
      .then(data => {
        if (!data || data.success !== true) {
          throw new Error(data && data.error ? data.error : 'Erreur inconnue');
        }

        if (articleUpdateState[articleId]?.token !== requestToken) {
          return;
        }

        const newQuantity = Math.max(0, roundToStep(Number(data.quantity) || 0, stepValue));
        const displayQuantity = formatQuantityForDisplay(newQuantity, stepValue);
        const panierArticleId = data.panierArticleId || null;
        quantityElements.forEach(el => {
          el.textContent = displayQuantity;
        });

        if (newQuantity > 0 && panierArticleId) {
          ensureNoteSection(articleId, panierArticleId);
          updateNoteButtonAppearance(panierArticleId, hasExistingNoteContent(panierArticleId));
        } else {
          const container = getNoteContainer(articleId);
          if (container && panierArticleId) {
            container.dataset.panierArticleId = panierArticleId;
          }
          hideNoteSection(articleId);
        }
      })
      .catch(error => {
        console.error('Erreur lors de la mise √† jour du panier:', error);
        if (articleUpdateState[articleId]?.token === requestToken) {
          quantityElements.forEach(el => {
            const previousState = articleUpdateState[articleId];
            const fallbackStep = previousState && Number.isFinite(previousState.step) ? previousState.step : stepValue;
            const display = previousState && previousState.previousDisplay
              ? previousState.previousDisplay
              : formatQuantityForDisplay(previousState ? previousState.previous : previousQuantity, fallbackStep);
            el.textContent = display;
          });
          const previousState = articleUpdateState[articleId];
          if (previousState) {
            if (previousState.noteVisibleBefore && previousState.previousPanierArticleId) {
              ensureNoteSection(articleId, previousState.previousPanierArticleId);
              updateNoteButtonAppearance(previousState.previousPanierArticleId, hasExistingNoteContent(previousState.previousPanierArticleId));
            } else {
              hideNoteSection(articleId);
            }
          }
          alert("Impossible de mettre √† jour la quantit√©. Merci de r√©essayer.");
        }
      })
      .finally(() => {
        if (articleUpdateState[articleId]?.token === requestToken) {
          delete articleUpdateState[articleId];
        }
      });
  });

  // Fonction pour pr√©remplir le panier avec les commandes pass√©es
  window.autoFillCart = function() {
    const panierId = "<%= panier.id %>";
    const catalogId = "<%= catalogue.id %>";
    const userId = "<%= user.id %>";

    fetch('/panier/auto-fill', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'CSRF-Token': getCsrfTokenValue()
      },
      body: JSON.stringify({ panierId, catalogId, userId })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Erreur lors du pr√©remplissage du panier');
      }
      return response.json();
    })
    .then(data => {
      alert('Panier pr√©rempli avec succ√®s !');
      location.reload();
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Une erreur est survenue lors du pr√©remplissage du panier.');
    });
  };
});
</script>

<!-- Modal d'agrandissement d'image produit -->
<div class="modal fade" id="catalogueArticleImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="catalogueArticleImageModalImg" src="" alt="Image produit" style="width: 100%; height: auto; display: block;" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Alimentation du modal d'agrandissement
document.addEventListener('click', function(e) {
  const thumb = e.target.closest('[data-article-imgsrc]');
  if (!thumb) return;
  const img = document.getElementById('catalogueArticleImageModalImg');
  if (img) img.src = thumb.getAttribute('data-article-imgsrc');
});
</script>

<!-- Modal d'agrandissement d'image catalogue -->
<div class="modal fade" id="catalogueImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="catalogueImageModalImg" src="" alt="Image catalogue" style="width: 100%; height: auto; display: block;" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
// Alimentation du modal d'agrandissement (catalogue)
document.addEventListener('click', function(e) {
  const thumb = e.target.closest('[data-catalogue-imgsrc]');
  if (!thumb) return;
  const img = document.getElementById('catalogueImageModalImg');
  if (img) img.src = thumb.getAttribute('data-catalogue-imgsrc');
});
</script>

</div>
<%- include('partials/footer') %>