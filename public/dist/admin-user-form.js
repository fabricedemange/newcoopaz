import{i as N,o as t,c as r,a as s,t as i,j as R,d as n,e as u,v as g,k as x,F as A,l as z,s as I,b as T,w as j,r as d,g as V,h as E}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as M}from"./chunks/pinia-gLxYYWQL.js";import{_ as q}from"./chunks/BackButton-DzFd1NqY.js";const B={class:"container"},C={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},P={class:"mb-0"},D={key:0,class:"alert alert-danger"},F=["value"],L={class:"mb-3"},O={class:"mb-3"},$={class:"form-check form-switch mb-3"},K={class:"mb-3"},G={class:"mb-3"},H={class:"form-label"},J=["required"],Q={class:"mb-3"},W={class:"border rounded p-3",style:{"max-height":"300px","overflow-y":"auto"}},X=["id","value"],Y=["for"],Z={key:0,class:"badge bg-secondary ms-1"},ee={key:1},ae={key:2,class:"text-muted"},se={key:0,class:"text-muted mb-0"},le={key:0,class:"mb-3"},oe=["value"],te=["disabled"],re={key:0,class:"spinner-border spinner-border-sm me-1"},ie={__name:"AdminUserFormPage",setup(ne){const a=d({username:"",email:"",description:"",email_catalogue:1,password:"",rbac_roles:[],organization_id:""}),v=d([]),p=d(null),y=d("add"),w=d(null),c=d(""),_=d(!1),h=V(()=>window.CSRF_TOKEN||""),m=V(()=>y.value==="add");N(()=>{const o=window.INITIAL_DATA||{};if(y.value=o.action||"add",v.value=o.allRoles||[],p.value=o.organizations||null,c.value=o.error||"",o.user)w.value=o.user.id,a.value.username=o.user.username||"",a.value.email=o.user.email||"",a.value.description=o.user.description||"",a.value.email_catalogue=o.user.email_catalogue?1:0,a.value.organization_id=o.user.organization_id!=null?String(o.user.organization_id):"",a.value.rbac_roles=(o.userRoleIds||[]).map(Number);else{a.value.email_catalogue=1;const e=v.value.find(l=>l.name==="utilisateur");e&&(!o.userRoleIds||o.userRoleIds.length===0)&&(a.value.rbac_roles=[Number(e.id)])}});async function U(){c.value="",_.value=!0;try{const o=Array.isArray(a.value.rbac_roles)?a.value.rbac_roles.filter(f=>f!=null&&f!==""):[a.value.rbac_roles].filter(Boolean),e=new URLSearchParams({username:a.value.username,email:a.value.email,description:a.value.description||"",email_catalogue:a.value.email_catalogue?"1":"0",password:a.value.password,_csrf:h.value});o.forEach(f=>e.append("rbac_roles[]",f)),a.value.organization_id&&e.append("organization_id",a.value.organization_id);const l=m.value?"/admin/users/new":`/admin/users/${w.value}/edit`,b=await(await fetch(l,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e.toString(),credentials:"include"})).json().catch(()=>({}));if(b.success&&b.redirect){window.location.href=b.redirect;return}c.value=b.error||"Une erreur est survenue."}catch{c.value="Erreur de connexion. Veuillez réessayer."}finally{_.value=!1}}return(o,e)=>(t(),r("div",B,[s("div",C,[s("h2",P,i(m.value?"Ajouter un utilisateur":"Éditer un utilisateur"),1),R(q)]),c.value?(t(),r("div",D,i(c.value),1)):n("",!0),s("form",{onSubmit:j(U,["prevent"])},[s("input",{type:"hidden",name:"_csrf",value:h.value},null,8,F),s("div",L,[e[7]||(e[7]=s("label",{class:"form-label"},"Nom d'utilisateur",-1)),u(s("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>a.value.username=l),type:"text",class:"form-control",required:""},null,512),[[g,a.value.username]])]),s("div",O,[e[8]||(e[8]=s("label",{class:"form-label"},"Email",-1)),u(s("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.email=l),type:"email",class:"form-control",required:""},null,512),[[g,a.value.email]])]),s("div",$,[u(s("input",{id:"email_catalogue","onUpdate:modelValue":e[2]||(e[2]=l=>a.value.email_catalogue=l),class:"form-check-input",type:"checkbox","true-value":1,"false-value":0},null,512),[[x,a.value.email_catalogue]]),e[9]||(e[9]=s("label",{class:"form-check-label",for:"email_catalogue"},"Recevoir les notifications des nouveaux catalogues",-1))]),s("div",K,[e[10]||(e[10]=s("label",{class:"form-label"},"Description",-1)),u(s("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.description=l),type:"text",class:"form-control"},null,512),[[g,a.value.description]])]),s("div",G,[s("label",H,"Mot de passe "+i(m.value?"":"(laisser vide pour ne pas changer)"),1),u(s("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.password=l),type:"password",class:"form-control",required:m.value},null,8,J),[[g,a.value.password]])]),s("div",Q,[e[11]||(e[11]=s("label",{class:"form-label"},"Rôles RBAC",-1)),s("div",W,[(t(!0),r(A,null,z(v.value,l=>(t(),r("div",{key:l.id,class:"form-check mb-2"},[u(s("input",{id:"role_"+l.id,"onUpdate:modelValue":e[5]||(e[5]=k=>a.value.rbac_roles=k),type:"checkbox",class:"form-check-input",value:Number(l.id)},null,8,X),[[x,a.value.rbac_roles]]),s("label",{class:"form-check-label",for:"role_"+l.id},[s("strong",null,i(l.display_name),1),l.name==="utilisateur"?(t(),r("span",Z,"Par défaut")):n("",!0),l.description?(t(),r("br",ee)):n("",!0),l.description?(t(),r("small",ae,i(l.description),1)):n("",!0)],8,Y)]))),128)),v.value.length?n("",!0):(t(),r("p",se,"Aucun rôle disponible"))])]),p.value&&p.value.length?(t(),r("div",le,[e[13]||(e[13]=s("label",{for:"orgSelect",class:"form-label"},"Organisation",-1)),u(s("select",{id:"orgSelect","onUpdate:modelValue":e[6]||(e[6]=l=>a.value.organization_id=l),class:"form-select",required:""},[e[12]||(e[12]=s("option",{value:""},"Sélectionner une organisation",-1)),(t(!0),r(A,null,z(p.value,l=>(t(),r("option",{key:l.id,value:l.id},i(l.name),9,oe))),128))],512),[[I,a.value.organization_id]])])):n("",!0),s("button",{type:"submit",class:"btn btn-primary",disabled:_.value},[_.value?(t(),r("span",re)):n("",!0),T(" "+i(m.value?"Ajouter":"Enregistrer"),1)],8,te),e[14]||(e[14]=s("a",{href:"/admin/users/vue",class:"btn btn-secondary ms-2"},"Annuler",-1))],32)]))}},S=E(ie);S.use(M());S.mount("#admin-user-form-app");
