import{i as R,o as t,c as r,a as s,t as i,d as n,e as u,v as g,j as x,F as A,k as z,q as N,b as I,w as T,r as d,g as S,h as q}from"./chunks/runtime-dom.esm-bundler-BlMAuMpH.js";import{c as E}from"./chunks/pinia-BNknc8Vm.js";const M={class:"container"},j={key:0,class:"alert alert-danger"},B=["value"],C={class:"mb-3"},P={class:"mb-3"},D={class:"form-check form-switch mb-3"},F={class:"mb-3"},L={class:"mb-3"},O={class:"form-label"},K=["required"],$={class:"mb-3"},G={class:"border rounded p-3",style:{"max-height":"300px","overflow-y":"auto"}},H=["id","value"],J=["for"],Q={key:0,class:"badge bg-secondary ms-1"},W={key:1},X={key:2,class:"text-muted"},Y={key:0,class:"text-muted mb-0"},Z={key:0,class:"mb-3"},ee=["value"],ae=["disabled"],le={key:0,class:"spinner-border spinner-border-sm me-1"},se={__name:"AdminUserFormPage",setup(oe){const a=d({username:"",email:"",description:"",email_catalogue:1,password:"",rbac_roles:[],organization_id:""}),v=d([]),p=d(null),y=d("add"),w=d(null),c=d(""),b=d(!1),h=S(()=>window.CSRF_TOKEN||""),m=S(()=>y.value==="add");R(()=>{const o=window.INITIAL_DATA||{};if(y.value=o.action||"add",v.value=o.allRoles||[],p.value=o.organizations||null,c.value=o.error||"",o.user)w.value=o.user.id,a.value.username=o.user.username||"",a.value.email=o.user.email||"",a.value.description=o.user.description||"",a.value.email_catalogue=o.user.email_catalogue?1:0,a.value.organization_id=o.user.organization_id!=null?String(o.user.organization_id):"",a.value.rbac_roles=(o.userRoleIds||[]).map(Number);else{a.value.email_catalogue=1;const e=v.value.find(l=>l.name==="utilisateur");e&&(!o.userRoleIds||o.userRoleIds.length===0)&&(a.value.rbac_roles=[Number(e.id)])}});async function V(){c.value="",b.value=!0;try{const o=Array.isArray(a.value.rbac_roles)?a.value.rbac_roles.filter(f=>f!=null&&f!==""):[a.value.rbac_roles].filter(Boolean),e=new URLSearchParams({username:a.value.username,email:a.value.email,description:a.value.description||"",email_catalogue:a.value.email_catalogue?"1":"0",password:a.value.password,_csrf:h.value});o.forEach(f=>e.append("rbac_roles[]",f)),a.value.organization_id&&e.append("organization_id",a.value.organization_id);const l=m.value?"/admin/users/new":`/admin/users/${w.value}/edit`,_=await(await fetch(l,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e.toString(),credentials:"include"})).json().catch(()=>({}));if(_.success&&_.redirect){window.location.href=_.redirect;return}c.value=_.error||"Une erreur est survenue."}catch{c.value="Erreur de connexion. Veuillez réessayer."}finally{b.value=!1}}return(o,e)=>(t(),r("div",M,[s("h2",null,i(m.value?"Ajouter un utilisateur":"Éditer un utilisateur"),1),c.value?(t(),r("div",j,i(c.value),1)):n("",!0),s("form",{onSubmit:T(V,["prevent"])},[s("input",{type:"hidden",name:"_csrf",value:h.value},null,8,B),s("div",C,[e[7]||(e[7]=s("label",{class:"form-label"},"Nom d'utilisateur",-1)),u(s("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>a.value.username=l),type:"text",class:"form-control",required:""},null,512),[[g,a.value.username]])]),s("div",P,[e[8]||(e[8]=s("label",{class:"form-label"},"Email",-1)),u(s("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.email=l),type:"email",class:"form-control",required:""},null,512),[[g,a.value.email]])]),s("div",D,[u(s("input",{id:"email_catalogue","onUpdate:modelValue":e[2]||(e[2]=l=>a.value.email_catalogue=l),class:"form-check-input",type:"checkbox","true-value":1,"false-value":0},null,512),[[x,a.value.email_catalogue]]),e[9]||(e[9]=s("label",{class:"form-check-label",for:"email_catalogue"},"Recevoir les notifications des nouveaux catalogues",-1))]),s("div",F,[e[10]||(e[10]=s("label",{class:"form-label"},"Description",-1)),u(s("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.description=l),type:"text",class:"form-control"},null,512),[[g,a.value.description]])]),s("div",L,[s("label",O,"Mot de passe "+i(m.value?"":"(laisser vide pour ne pas changer)"),1),u(s("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.password=l),type:"password",class:"form-control",required:m.value},null,8,K),[[g,a.value.password]])]),s("div",$,[e[11]||(e[11]=s("label",{class:"form-label"},"Rôles RBAC",-1)),s("div",G,[(t(!0),r(A,null,z(v.value,l=>(t(),r("div",{key:l.id,class:"form-check mb-2"},[u(s("input",{id:"role_"+l.id,"onUpdate:modelValue":e[5]||(e[5]=k=>a.value.rbac_roles=k),type:"checkbox",class:"form-check-input",value:Number(l.id)},null,8,H),[[x,a.value.rbac_roles]]),s("label",{class:"form-check-label",for:"role_"+l.id},[s("strong",null,i(l.display_name),1),l.name==="utilisateur"?(t(),r("span",Q,"Par défaut")):n("",!0),l.description?(t(),r("br",W)):n("",!0),l.description?(t(),r("small",X,i(l.description),1)):n("",!0)],8,J)]))),128)),v.value.length?n("",!0):(t(),r("p",Y,"Aucun rôle disponible"))])]),p.value&&p.value.length?(t(),r("div",Z,[e[13]||(e[13]=s("label",{for:"orgSelect",class:"form-label"},"Organisation",-1)),u(s("select",{id:"orgSelect","onUpdate:modelValue":e[6]||(e[6]=l=>a.value.organization_id=l),class:"form-select",required:""},[e[12]||(e[12]=s("option",{value:""},"Sélectionner une organisation",-1)),(t(!0),r(A,null,z(p.value,l=>(t(),r("option",{key:l.id,value:l.id},i(l.name),9,ee))),128))],512),[[N,a.value.organization_id]])])):n("",!0),s("button",{type:"submit",class:"btn btn-primary",disabled:b.value},[b.value?(t(),r("span",le)):n("",!0),I(" "+i(m.value?"Ajouter":"Enregistrer"),1)],8,ae),e[14]||(e[14]=s("a",{href:"/admin/users/vue",class:"btn btn-secondary ms-2"},"Annuler",-1))],32)]))}},U=q(se);U.use(E());U.mount("#admin-user-form-app");
