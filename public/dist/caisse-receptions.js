import{m as he,i as ge,o as n,c as r,a as t,b as d,t as a,d as v,F as b,l as V,n as E,e as C,s as ke,v as q,k as xe,r as p,g as K,h as Ce}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as Ne}from"./chunks/pinia-gLxYYWQL.js";import{V as Pe,W as Re,X as we,Y as ee,Z as M,_ as Ve,$ as te,a0 as se,a1 as De,a2 as Le,a3 as Se}from"./chunks/index-CY5spq3H.js";const qe={class:"container-fluid px-3 mt-4"},$e={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},Ae={class:"d-flex gap-2"},je={key:0,class:"alert alert-danger alert-dismissible fade show"},Fe={key:0,class:"text-center py-5"},Be={key:1,class:"alert alert-info"},Ue={key:2,class:"card"},Te={class:"card-body p-0"},Ee={class:"table-responsive"},Me={class:"table table-hover mb-0"},ze=["onClick"],Ie=["onClick"],Oe=["onClick"],Qe={class:"card mb-4"},We={class:"card-header"},Xe={class:"mb-0"},Ye={class:"card-body"},Ze={class:"row g-3 mb-4"},Ge={class:"col-md-4"},He=["disabled"],Je=["value"],Ke={class:"col-md-4"},et={class:"col-md-4 d-flex align-items-end"},tt={class:"form-check"},st=["disabled"],lt={key:0,class:"mb-3"},nt={key:0,class:"text-muted small"},rt={key:1,class:"mb-3"},it={class:"d-flex flex-wrap gap-2 align-items-center"},ot={class:"badge bg-light text-dark border"},at={key:0,class:"small text-muted"},ut=["disabled","onClick"],dt={key:0,class:"spinner-border spinner-border-sm"},ct={key:2,class:"text-muted small mb-2"},pt={key:3,class:"text-muted small"},mt={key:4,class:"table-responsive mb-2",style:{"max-height":"200px"}},vt={class:"table table-sm table-hover mb-0"},bt=["disabled","onClick"],_t={key:0,class:"spinner-border spinner-border-sm"},ft={key:5,class:"text-muted small mb-2"},yt=["disabled"],ht={key:0,class:"spinner-border spinner-border-sm me-1"},gt={key:1,class:"bi bi-download me-1"},kt={key:1,class:"mb-2"},xt={class:"table-responsive"},Ct={class:"table table-bordered"},Nt={class:"table-light"},Pt={key:0,style:{width:"50px"}},Rt={class:"text-end"},wt=["onUpdate:modelValue"],Vt={key:1},Dt={class:"text-end"},Lt=["onUpdate:modelValue"],St={key:1},qt={class:"text-end"},$t=["onUpdate:modelValue"],At={key:1},jt={key:0},Ft=["onClick"],Bt={key:2,class:"text-muted small"},Ut={class:"mt-4 d-flex gap-2 flex-wrap"},Tt=["disabled"],Et={key:0,class:"spinner-border spinner-border-sm me-1"},Mt={key:1,class:"bi bi-save me-1"},zt=["disabled"],It={key:0,class:"spinner-border spinner-border-sm me-1"},Ot=["disabled"],Qt={key:0,class:"spinner-border spinner-border-sm me-1"},Wt=["disabled"],Xt={key:0,class:"spinner-border spinner-border-sm me-1"},Yt={key:0,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},Zt={class:"modal-dialog"},Gt={class:"modal-content"},Ht={class:"modal-header"},Jt={class:"modal-body"},Kt={key:0,class:"text-center py-2"},es={key:1,class:"list-group list-group-flush"},ts=["onClick"],ss={class:"text-muted small"},ls={key:0,class:"list-group-item text-muted"},ns={__name:"ReceptionsPage",setup(rs){const h=p("list"),j=p([]),z=p([]),D=p(!1),u=p(null),c=p(null),f=p(null),i=p({supplier_id:"",bl_number:"",is_from_preorder:!1,lignes:[]}),m=p(!1),g=p(!1),N=p([]),F=p(!1),P=p([]),B=p(!1),L=p(null),$=p(!1),R=p(""),x=p([]),U=p(!1);let I=null;const S=K(()=>i.value.supplier_id&&(i.value.bl_number||"").trim()&&i.value.lignes.length>0),A=K(()=>S.value);function O(s){if(!s)return"-";const e=new Date(s);return isNaN(e.getTime())?s:e.toLocaleString("fr-FR")}function ne(s){if(!s)return"";const e=new Date(s);return isNaN(e.getTime())?String(s):e.toLocaleDateString("fr-FR")}function Q(s){const e=s.prix_base!=null?Number(s.prix_base):null,o=s.prix_unitaire!=null?Number(s.prix_unitaire):null;return e==null||o==null?!1:Math.abs(o-e)>.001}function re(){i.value.lignes=[],x.value=[],N.value=[],P.value=[]}he(()=>[i.value.supplier_id,i.value.is_from_preorder],([s,e])=>{if(!s||!e){N.value=[],P.value=[];return}F.value=!0,B.value=!0,Promise.all([Pe(s),Re(s)]).then(([o,_])=>{N.value=o.receptions||[],P.value=_.catalogues||[]}).catch(()=>{N.value=[],P.value=[]}).finally(()=>{F.value=!1,B.value=!1})},{immediate:!0});function ie(s){g.value=!0,ee(s).then(e=>{const o=(e.lignes||[]).map(_=>({product_id:_.product_id,product_nom:_.product_nom,quantite_recue:Number(_.quantite_recue)||0,prix_unitaire:Number(_.prix_unitaire)||0,prix_base:_.prix_base!=null?Number(_.prix_base):null,comment:(_.comment||"").trim()||""}));i.value.lignes=o}).catch(e=>{u.value=e.message}).finally(()=>{g.value=!1})}function y(){D.value=!0,u.value=null,we().then(s=>{j.value=s.receptions||[]}).catch(s=>{u.value=s.message}).finally(()=>{D.value=!1})}function W(){Le().then(s=>{z.value=s.suppliers||[]}).catch(()=>{})}function oe(){c.value=null,f.value=null,i.value={supplier_id:"",bl_number:"",is_from_preorder:!1,lignes:[]},h.value="form",W()}function ae(){i.value.supplier_id&&(g.value=!0,te(i.value.supplier_id).then(s=>X(s)).catch(s=>{u.value=s.message}).finally(()=>{g.value=!1}))}function X(s){const e=(s.lines||[]).map(o=>({product_id:o.product_id,product_nom:o.product_nom,quantite_recue:Number(o.quantite_commandee)||0,prix_unitaire:Number(o.prix_base)||0,prix_base:o.prix_base!=null?Number(o.prix_base):null,comment:""}));i.value.lignes=e}function ue(s){i.value.supplier_id&&(L.value=s,te(i.value.supplier_id,s).then(e=>X(e)).catch(e=>{u.value=e.message}).finally(()=>{L.value=null}))}function de(){clearTimeout(I),I=setTimeout(ce,300)}function ce(){if(!i.value.supplier_id||R.value.length<2){x.value=[];return}U.value=!0,Se(i.value.supplier_id,R.value).then(s=>{x.value=s.products||[]}).catch(()=>{x.value=[]}).finally(()=>{U.value=!1})}function pe(s){i.value.lignes.some(o=>o.product_id===s.id)||(i.value.lignes.push({product_id:s.id,product_nom:s.nom,quantite_recue:1,prix_unitaire:Number(s.prix)||0,prix_base:s.prix!=null?Number(s.prix):null,comment:""}),$.value=!1,R.value="",x.value=[])}function T(){return i.value.lignes.filter(s=>(Number(s.quantite_recue)||0)>0).map(s=>({product_id:s.product_id,quantite_recue:Number(s.quantite_recue)||0,prix_unitaire:Number(s.prix_unitaire)||0,comment:(s.comment||"").trim()||""}))}function me(){S.value&&(m.value=!0,u.value=null,se({supplier_id:i.value.supplier_id,bl_number:i.value.bl_number.trim(),is_from_preorder:i.value.is_from_preorder,lignes:T()}).then(s=>{var e;c.value=(e=s.reception)==null?void 0:e.id,f.value=s.reception,y(),alert("Brouillon enregistré.")}).catch(s=>{u.value=s.message}).finally(()=>{m.value=!1}))}function ve(){A.value&&confirm("Enregistrer et valider la réception ? Les stocks seront mis à jour.")&&(m.value=!0,u.value=null,se({supplier_id:i.value.supplier_id,bl_number:i.value.bl_number.trim(),is_from_preorder:i.value.is_from_preorder,lignes:T()}).then(s=>{var o;const e=(o=s.reception)==null?void 0:o.id;if(e)return M(e);throw new Error("Réception non créée")}).then(()=>{alert("Réception validée. Les stocks ont été mis à jour."),h.value="list",y()}).catch(s=>{u.value=s.message}).finally(()=>{m.value=!1}))}function Y(s){c.value=s,h.value="form",D.value=!0,u.value=null,ee(s).then(e=>{f.value=e.reception,i.value={supplier_id:e.reception.supplier_id,bl_number:e.reception.bl_number,is_from_preorder:!!e.reception.is_from_preorder,lignes:(e.lignes||[]).map(o=>({product_id:o.product_id,product_nom:o.product_nom,quantite_recue:o.quantite_recue,prix_unitaire:o.prix_unitaire,prix_base:o.prix_base,comment:o.comment||""}))},W()}).catch(e=>{u.value=e.message}).finally(()=>{D.value=!1})}function be(){!c.value||!S.value||(m.value=!0,u.value=null,De(c.value,{bl_number:i.value.bl_number.trim(),is_from_preorder:i.value.is_from_preorder,lignes:T()}).then(()=>{y(),alert("Réception mise à jour."),Y(c.value)}).catch(s=>{u.value=s.message}).finally(()=>{m.value=!1}))}function _e(){!c.value||!A.value||confirm("Valider cette réception ? Les quantités en stock seront augmentées. Cette action est définitive.")&&(m.value=!0,u.value=null,M(c.value).then(()=>{alert("Réception validée. Les stocks ont été mis à jour."),h.value="list",y()}).catch(s=>{u.value=s.message}).finally(()=>{m.value=!1}))}function fe(s){confirm("Valider cette réception ? Les stocks seront mis à jour.")&&(m.value=!0,M(s).then(()=>{y(),alert("Réception validée.")}).catch(e=>{u.value=e.message}).finally(()=>{m.value=!1}))}function ye(s){confirm("Supprimer ce brouillon ?")&&Ve(s).then(()=>y()).catch(e=>{u.value=e.message})}return ge(()=>{y()}),(s,e)=>{var o,_;return n(),r("div",qe,[t("div",$e,[e[13]||(e[13]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-truck me-2"}),d("Réceptions de commandes")],-1)),t("div",Ae,[e[11]||(e[11]=t("a",{href:"/caisse/accueil",class:"btn btn-outline-secondary"},[t("i",{class:"bi bi-arrow-left me-1"}),d("Retour ")],-1)),e[12]||(e[12]=t("a",{href:"/caisse/inventaire",class:"btn btn-outline-primary"},"Inventaire",-1)),h.value==="list"?(n(),r("button",{key:0,type:"button",class:"btn btn-primary",onClick:oe},[...e[9]||(e[9]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),d("Nouvelle réception ",-1)])])):(n(),r("button",{key:1,type:"button",class:"btn btn-outline-secondary",onClick:e[0]||(e[0]=l=>{h.value="list",y()})},[...e[10]||(e[10]=[t("i",{class:"bi bi-list me-1"},null,-1),d("Liste ",-1)])]))])]),u.value?(n(),r("div",je,[d(a(u.value)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[1]||(e[1]=l=>u.value=null)})])):v("",!0),h.value==="list"?(n(),r(b,{key:1},[D.value?(n(),r("div",Fe,[...e[14]||(e[14]=[t("div",{class:"spinner-border text-primary"},null,-1)])])):j.value.length===0?(n(),r("div",Be,[...e[15]||(e[15]=[d(" Aucune réception. Cliquez sur ",-1),t("strong",null,"Nouvelle réception",-1),d(" pour en créer une. ",-1)])])):(n(),r("div",Ue,[t("div",Te,[t("div",Ee,[t("table",Me,[e[19]||(e[19]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"BL"),t("th",null,"Fournisseur"),t("th",null,"Précommande"),t("th",null,"Date"),t("th",null,"Statut"),t("th",null,"Actions")])],-1)),t("tbody",null,[(n(!0),r(b,null,V(j.value,l=>(n(),r("tr",{key:l.id},[t("td",null,[t("code",null,a(l.bl_number),1)]),t("td",null,a(l.supplier_nom),1),t("td",null,a(l.is_from_preorder?"Oui":"Non"),1),t("td",null,a(O(l.created_at)),1),t("td",null,[t("span",{class:E(["badge",l.statut==="validated"?"bg-success":"bg-secondary"])},a(l.statut==="validated"?"Validée":"Brouillon"),3)]),t("td",null,[t("button",{type:"button",class:"btn btn-sm btn-outline-primary me-1",onClick:k=>Y(l.id)},[...e[16]||(e[16]=[t("i",{class:"bi bi-eye"},null,-1)])],8,ze),l.statut==="draft"?(n(),r(b,{key:0},[t("button",{type:"button",class:"btn btn-sm btn-success me-1",onClick:k=>fe(l.id)},[...e[17]||(e[17]=[t("i",{class:"bi bi-check-lg"},null,-1),d(" Valider ",-1)])],8,Ie),t("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:k=>ye(l.id)},[...e[18]||(e[18]=[t("i",{class:"bi bi-trash"},null,-1)])],8,Oe)],64)):v("",!0)])]))),128))])])])])]))],64)):(n(),r(b,{key:2},[t("div",Qe,[t("div",We,[t("h5",Xe,a(c.value?"Détail / Modifier la réception":"Nouvelle réception"),1)]),t("div",Ye,[t("div",Ze,[t("div",Ge,[e[21]||(e[21]=t("label",{class:"form-label"},[d("Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),C(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>i.value.supplier_id=l),class:"form-select",disabled:!!c.value,onChange:re},[e[20]||(e[20]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(n(!0),r(b,null,V(z.value,l=>(n(),r("option",{key:l.id,value:l.id},a(l.nom),9,Je))),128))],40,He),[[ke,i.value.supplier_id]])]),t("div",Ke,[e[22]||(e[22]=t("label",{class:"form-label"},[d("N° Bon de livraison (BL) "),t("span",{class:"text-danger"},"*")],-1)),C(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>i.value.bl_number=l),type:"text",class:"form-control",placeholder:"Ex: BL-2024-001"},null,512),[[q,i.value.bl_number]])]),t("div",et,[t("div",tt,[C(t("input",{id:"from_preorder","onUpdate:modelValue":e[4]||(e[4]=l=>i.value.is_from_preorder=l),type:"checkbox",class:"form-check-input",disabled:!!c.value},null,8,st),[[xe,i.value.is_from_preorder]]),e[23]||(e[23]=t("label",{class:"form-check-label",for:"from_preorder"},"Réception issue d'une précommande",-1))])])]),!c.value&&i.value.supplier_id&&i.value.is_from_preorder?(n(),r("div",lt,[e[28]||(e[28]=t("h6",{class:"text-muted mb-2"},"Catalogues / Précommandes concernés",-1)),B.value?(n(),r("div",nt,[...e[24]||(e[24]=[t("span",{class:"spinner-border spinner-border-sm me-1"},null,-1),d("Chargement…",-1)])])):P.value.length>0?(n(),r("div",rt,[t("div",it,[(n(!0),r(b,null,V(P.value,l=>(n(),r("div",{key:l.id,class:"d-flex align-items-center gap-1 flex-wrap"},[t("span",ot,"#"+a(l.id)+" — "+a(l.originalname||l.description||"Catalogue "+l.id),1),l.date_livraison?(n(),r("span",at,"(livr. "+a(ne(l.date_livraison))+")",1)):v("",!0),t("button",{type:"button",class:"btn btn-sm btn-outline-primary",disabled:L.value!==null,onClick:k=>ue(l.id)},[L.value===l.id?(n(),r("span",dt)):(n(),r(b,{key:1},[d("Préremplir")],64))],8,ut)]))),128))])])):(n(),r("p",ct,"Aucun catalogue (date de livraison à ce jour ou passée) pour ce fournisseur.")),e[29]||(e[29]=t("h6",{class:"text-muted mb-2 mt-3"},"Dernières précommandes livrées",-1)),F.value?(n(),r("div",pt,[...e[25]||(e[25]=[t("span",{class:"spinner-border spinner-border-sm me-1"},null,-1),d("Chargement…",-1)])])):N.value.length>0?(n(),r("div",mt,[t("table",vt,[e[26]||(e[26]=t("thead",{class:"table-light sticky-top"},[t("tr",null,[t("th",null,"BL"),t("th",null,"Date livraison"),t("th",null,"Lignes"),t("th")])],-1)),t("tbody",null,[(n(!0),r(b,null,V(N.value,l=>(n(),r("tr",{key:l.id},[t("td",null,[t("code",null,a(l.bl_number),1)]),t("td",null,a(O(l.validated_at)),1),t("td",null,a(l.nb_lignes),1),t("td",null,[t("button",{type:"button",class:"btn btn-sm btn-outline-primary",disabled:g.value,onClick:k=>ie(l.id)},[g.value?(n(),r("span",_t)):(n(),r(b,{key:1},[d("Préremplir")],64))],8,bt)])]))),128))])])])):(n(),r("p",ft,"Aucune réception validée (précommande) pour ce fournisseur.")),t("button",{type:"button",class:"btn btn-outline-primary",disabled:g.value||L.value!==null,onClick:ae},[g.value?(n(),r("span",ht)):(n(),r("i",gt)),e[27]||(e[27]=d("Préremplir avec les lignes des précommandes (paniers en cours) ",-1))],8,yt)])):v("",!0),e[42]||(e[42]=t("h6",{class:"mt-4"},"Lignes de réception",-1)),!c.value&&i.value.supplier_id?(n(),r("div",kt,[t("button",{type:"button",class:"btn btn-sm btn-outline-secondary",onClick:e[5]||(e[5]=l=>$.value=!0)},[...e[30]||(e[30]=[t("i",{class:"bi bi-plus me-1"},null,-1),d("Ajouter un produit ",-1)])])])):v("",!0),t("div",xt,[t("table",Ct,[t("thead",Nt,[t("tr",null,[e[31]||(e[31]=t("th",null,"Produit",-1)),e[32]||(e[32]=t("th",{class:"text-end",style:{width:"100px"}},"Qté reçue",-1)),e[33]||(e[33]=t("th",{class:"text-end",style:{width:"100px"}},"Prix unit. réception",-1)),e[34]||(e[34]=t("th",{class:"text-end",style:{width:"90px"}},"Prix base",-1)),e[35]||(e[35]=t("th",null,"Commentaire",-1)),!c.value||((o=f.value)==null?void 0:o.statut)==="draft"?(n(),r("th",Pt)):v("",!0)])]),t("tbody",null,[(n(!0),r(b,null,V(i.value.lignes,(l,k)=>{var Z,G,H,J;return n(),r("tr",{key:l.product_id+"-"+k,class:E({"table-warning":Q(l)})},[t("td",null,a(l.product_nom),1),t("td",Rt,[!c.value||((Z=f.value)==null?void 0:Z.statut)==="draft"?C((n(),r("input",{key:0,"onUpdate:modelValue":w=>l.quantite_recue=w,type:"number",class:"form-control form-control-sm text-end",min:"0.001",step:"0.001"},null,8,wt)),[[q,l.quantite_recue,void 0,{number:!0}]]):(n(),r("span",Vt,a(l.quantite_recue),1))]),t("td",Dt,[!c.value||((G=f.value)==null?void 0:G.statut)==="draft"?C((n(),r("input",{key:0,"onUpdate:modelValue":w=>l.prix_unitaire=w,type:"number",class:"form-control form-control-sm text-end",min:"0",step:"0.01"},null,8,Lt)),[[q,l.prix_unitaire,void 0,{number:!0}]]):(n(),r("span",St,a((Number(l.prix_unitaire)||0).toFixed(2))+" €",1))]),t("td",qt,[t("span",{class:E({"text-danger fw-bold":Q(l)})},a(l.prix_base!=null?Number(l.prix_base).toFixed(2):"-")+" € ",3)]),t("td",null,[!c.value||((H=f.value)==null?void 0:H.statut)==="draft"?C((n(),r("input",{key:0,"onUpdate:modelValue":w=>l.comment=w,type:"text",class:"form-control form-control-sm",placeholder:"Commentaire"},null,8,$t)),[[q,l.comment]]):(n(),r("span",At,a(l.comment||"-"),1))]),!c.value||((J=f.value)==null?void 0:J.statut)==="draft"?(n(),r("td",jt,[t("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:w=>i.value.lignes.splice(k,1)},[...e[36]||(e[36]=[t("i",{class:"bi bi-trash"},null,-1)])],8,Ft)])):v("",!0)],2)}),128))])])]),i.value.lignes.length===0?(n(),r("div",Bt,"Aucune ligne. Préremplir depuis une précommande ou ajouter des produits.")):v("",!0),t("div",Ut,[c.value?((_=f.value)==null?void 0:_.statut)==="draft"?(n(),r(b,{key:1},[t("button",{type:"button",class:"btn btn-primary",disabled:m.value||!S.value,onClick:be},[m.value?(n(),r("span",Qt)):v("",!0),e[40]||(e[40]=d(" Enregistrer ",-1))],8,Ot),t("button",{type:"button",class:"btn btn-success",disabled:m.value||!A.value,onClick:_e},[m.value?(n(),r("span",Xt)):v("",!0),e[41]||(e[41]=d(" Valider la réception ",-1))],8,Wt)],64)):v("",!0):(n(),r(b,{key:0},[t("button",{type:"button",class:"btn btn-primary",disabled:m.value||!S.value,onClick:me},[m.value?(n(),r("span",Et)):(n(),r("i",Mt)),e[37]||(e[37]=d("Enregistrer le brouillon ",-1))],8,Tt),t("button",{type:"button",class:"btn btn-success",disabled:m.value||!A.value,onClick:ve},[m.value?(n(),r("span",It)):v("",!0),e[38]||(e[38]=t("i",{class:"bi bi-check-lg me-1"},null,-1)),e[39]||(e[39]=d("Enregistrer et valider ",-1))],8,zt)],64)),t("button",{type:"button",class:"btn btn-outline-secondary",onClick:e[6]||(e[6]=l=>{h.value="list",y()})}," Annuler / Retour ")])])]),$.value?(n(),r("div",Yt,[t("div",Zt,[t("div",Gt,[t("div",Ht,[e[43]||(e[43]=t("h5",{class:"modal-title"},"Ajouter un produit",-1)),t("button",{type:"button",class:"btn-close",onClick:e[7]||(e[7]=l=>$.value=!1)})]),t("div",Jt,[C(t("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>R.value=l),type:"text",class:"form-control mb-3",placeholder:"Rechercher par nom...",onInput:de},null,544),[[q,R.value]]),U.value?(n(),r("div",Kt,[...e[44]||(e[44]=[t("div",{class:"spinner-border spinner-border-sm"},null,-1)])])):(n(),r("ul",es,[(n(!0),r(b,null,V(x.value,l=>(n(),r("li",{key:l.id,class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",style:{cursor:"pointer"},onClick:k=>pe(l)},[t("span",null,a(l.nom),1),t("span",ss,a((Number(l.prix)||0).toFixed(2))+" €",1)],8,ts))),128)),x.value.length===0&&R.value.length>=2?(n(),r("li",ls,"Aucun produit trouvé")):v("",!0)]))])])])])):v("",!0)],64))])}}},le=Ce(ns);le.use(Ne());le.mount("#receptions-app");
