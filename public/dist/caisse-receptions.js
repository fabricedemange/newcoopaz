import{m as be,i as _e,o as n,c as i,a as t,b as u,t as r,d as v,F as b,l as P,n as T,e as x,s as fe,v as D,k as ge,r as m,g as J,h as ye}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as he}from"./chunks/pinia-gLxYYWQL.js";import{V as ke,W as xe,X as Ce,Y as Re,Z as E,_ as Ne,$ as Pe,a0 as K,a1 as we,a2 as Ve,a3 as De}from"./chunks/index-CY5spq3H.js";const Le={class:"container-fluid px-3 mt-4"},Se={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},qe={class:"d-flex gap-2"},Ae={key:0,class:"alert alert-danger alert-dismissible fade show"},$e={key:0,class:"text-center py-5"},je={key:1,class:"alert alert-info"},Be={key:2,class:"card"},Ue={class:"card-body p-0"},Fe={class:"table-responsive"},Te={class:"table table-hover mb-0"},Ee={key:0},Me={key:0},ze={key:1},Oe=["onClick"],Qe=["onClick"],We=["onClick"],Xe={class:"card mb-4"},Ye={class:"card-header"},Ze={class:"mb-0"},Ge={class:"card-body"},He={class:"row g-3 mb-4"},Ie={class:"col-md-4"},Je=["disabled"],Ke=["value"],et={class:"col-md-4"},tt={class:"col-md-4 d-flex align-items-end"},lt={class:"form-check"},st=["disabled"],nt={key:0,class:"mb-3"},it={key:0,class:"text-muted small"},ot={key:1,class:"mb-3"},at={class:"d-flex flex-wrap gap-2 align-items-center"},rt={class:"badge bg-light text-dark border"},ut={key:0,class:"small text-muted"},dt=["disabled","onClick"],ct={key:0,class:"spinner-border spinner-border-sm"},pt={key:2,class:"text-muted small mb-2"},mt={key:3,class:"text-muted small"},vt={key:4,class:"table-responsive mb-2",style:{"max-height":"200px"}},bt={class:"table table-sm table-hover mb-0"},_t={key:5,class:"text-muted small mb-2"},ft={key:6,class:"small text-success mb-2"},gt={key:0},yt={key:1},ht={key:1,class:"mb-2"},kt={class:"table-responsive"},xt={class:"table table-bordered"},Ct={class:"table-light"},Rt={key:0,style:{width:"50px"}},Nt={class:"text-end"},Pt=["onUpdate:modelValue"],wt={key:1},Vt={class:"text-end"},Dt=["onUpdate:modelValue"],Lt={key:1},St={class:"text-end"},qt=["onUpdate:modelValue"],At={key:1},$t={key:0},jt=["onClick"],Bt={key:2,class:"text-muted small"},Ut={class:"mt-4 d-flex gap-2 flex-wrap"},Ft=["disabled"],Tt={key:0,class:"spinner-border spinner-border-sm me-1"},Et={key:1,class:"bi bi-save me-1"},Mt=["disabled"],zt={key:0,class:"spinner-border spinner-border-sm me-1"},Ot=["disabled"],Qt={key:0,class:"spinner-border spinner-border-sm me-1"},Wt=["disabled"],Xt={key:0,class:"spinner-border spinner-border-sm me-1"},Yt={key:0,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},Zt={class:"modal-dialog"},Gt={class:"modal-content"},Ht={class:"modal-header"},It={class:"modal-body"},Jt={key:0,class:"text-center py-2"},Kt={key:1,class:"list-group list-group-flush"},el=["onClick"],tl={class:"text-muted small"},ll={key:0,class:"list-group-item text-muted"},sl={__name:"ReceptionsPage",setup(nl){const y=m("list"),$=m([]),M=m([]),w=m(!1),c=m(null),d=m(null),_=m(null),o=m({supplier_id:"",bl_number:"",is_from_preorder:!1,catalog_file_id:null,lignes:[]}),p=m(!1),C=m([]),j=m(!1),f=m([]),B=m(!1),L=m(null),S=m(!1),R=m(""),h=m([]),U=m(!1);let z=null;const V=J(()=>o.value.supplier_id&&(o.value.bl_number||"").trim()&&o.value.lignes.length>0),q=J(()=>V.value);function O(s){if(!s)return"-";const e=new Date(s);return isNaN(e.getTime())?s:e.toLocaleString("fr-FR")}function te(s){if(!s)return"";const e=new Date(s);return isNaN(e.getTime())?String(s):e.toLocaleDateString("fr-FR")}function Q(s){const e=s.prix_base!=null?Number(s.prix_base):null,a=s.prix_unitaire!=null?Number(s.prix_unitaire):null;return e==null||a==null?!1:Math.abs(a-e)>.001}function le(){o.value.lignes=[],o.value.catalog_file_id=null,h.value=[],C.value=[],f.value=[]}be(()=>[o.value.supplier_id,o.value.is_from_preorder],([s,e])=>{if(!s||!e){C.value=[],f.value=[];return}j.value=!0,B.value=!0,Promise.all([ke(s),xe(s)]).then(([a,A])=>{C.value=a.receptions||[],f.value=A.catalogues||[]}).catch(()=>{C.value=[],f.value=[]}).finally(()=>{j.value=!1,B.value=!1})},{immediate:!0});function g(){w.value=!0,c.value=null,Ce().then(s=>{$.value=s.receptions||[]}).catch(s=>{c.value=s.message}).finally(()=>{w.value=!1})}function W(){Ve().then(s=>{M.value=s.suppliers||[]}).catch(()=>{})}function se(){d.value=null,_.value=null,o.value={supplier_id:"",bl_number:"",is_from_preorder:!1,catalog_file_id:null,lignes:[]},y.value="form",W()}function ne(s){const e=(s.lines||[]).map(a=>({product_id:a.product_id,product_nom:a.product_nom,quantite_recue:Number(a.quantite_commandee)||0,prix_unitaire:Number(a.prix_base)||0,prix_base:a.prix_base!=null?Number(a.prix_base):null,comment:""}));o.value.lignes=e}function ie(s){o.value.supplier_id&&(L.value=s,Pe(o.value.supplier_id,s).then(e=>{ne(e),o.value.catalog_file_id=s}).catch(e=>{c.value=e.message}).finally(()=>{L.value=null}))}function oe(){clearTimeout(z),z=setTimeout(ae,300)}function ae(){if(!o.value.supplier_id||R.value.length<2){h.value=[];return}U.value=!0,De(o.value.supplier_id,R.value).then(s=>{h.value=s.products||[]}).catch(()=>{h.value=[]}).finally(()=>{U.value=!1})}function re(s){o.value.lignes.some(a=>a.product_id===s.id)||(o.value.lignes.push({product_id:s.id,product_nom:s.nom,quantite_recue:1,prix_unitaire:Number(s.prix)||0,prix_base:s.prix!=null?Number(s.prix):null,comment:""}),S.value=!1,R.value="",h.value=[])}function F(){return o.value.lignes.filter(s=>(Number(s.quantite_recue)||0)>0).map(s=>({product_id:s.product_id,quantite_recue:Number(s.quantite_recue)||0,prix_unitaire:Number(s.prix_unitaire)||0,comment:(s.comment||"").trim()||""}))}function ue(){V.value&&(p.value=!0,c.value=null,K({supplier_id:o.value.supplier_id,bl_number:o.value.bl_number.trim(),is_from_preorder:o.value.is_from_preorder,catalog_file_id:o.value.catalog_file_id||void 0,lignes:F()}).then(s=>{var e;d.value=(e=s.reception)==null?void 0:e.id,_.value=s.reception,g(),alert("Brouillon enregistré.")}).catch(s=>{c.value=s.message}).finally(()=>{p.value=!1}))}function de(){q.value&&confirm("Enregistrer et valider la réception ? Les stocks seront mis à jour.")&&(p.value=!0,c.value=null,K({supplier_id:o.value.supplier_id,bl_number:o.value.bl_number.trim(),is_from_preorder:o.value.is_from_preorder,catalog_file_id:o.value.catalog_file_id||void 0,lignes:F()}).then(s=>{var a;const e=(a=s.reception)==null?void 0:a.id;if(e)return E(e);throw new Error("Réception non créée")}).then(()=>{alert("Réception validée. Les stocks ont été mis à jour."),y.value="list",g()}).catch(s=>{c.value=s.message}).finally(()=>{p.value=!1}))}function X(s){d.value=s,y.value="form",w.value=!0,c.value=null,Re(s).then(e=>{_.value=e.reception,o.value={supplier_id:e.reception.supplier_id,bl_number:e.reception.bl_number,is_from_preorder:!!e.reception.is_from_preorder,catalog_file_id:e.reception.catalog_file_id??null,lignes:(e.lignes||[]).map(a=>({product_id:a.product_id,product_nom:a.product_nom,quantite_recue:a.quantite_recue,prix_unitaire:a.prix_unitaire,prix_base:a.prix_base,comment:a.comment||""}))},W()}).catch(e=>{c.value=e.message}).finally(()=>{w.value=!1})}function ce(){!d.value||!V.value||(p.value=!0,c.value=null,we(d.value,{bl_number:o.value.bl_number.trim(),is_from_preorder:o.value.is_from_preorder,catalog_file_id:o.value.catalog_file_id??void 0,lignes:F()}).then(()=>{g(),alert("Réception mise à jour."),X(d.value)}).catch(s=>{c.value=s.message}).finally(()=>{p.value=!1}))}function pe(){!d.value||!q.value||confirm("Valider cette réception ? Les quantités en stock seront augmentées. Cette action est définitive.")&&(p.value=!0,c.value=null,E(d.value).then(()=>{alert("Réception validée. Les stocks ont été mis à jour."),y.value="list",g()}).catch(s=>{c.value=s.message}).finally(()=>{p.value=!1}))}function me(s){confirm("Valider cette réception ? Les stocks seront mis à jour.")&&(p.value=!0,E(s).then(()=>{g(),alert("Réception validée.")}).catch(e=>{c.value=e.message}).finally(()=>{p.value=!1}))}function ve(s){confirm("Supprimer ce brouillon ?")&&Ne(s).then(()=>g()).catch(e=>{c.value=e.message})}return _e(()=>{g()}),(s,e)=>{var a,A,Y;return n(),i("div",Le,[t("div",Se,[e[13]||(e[13]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-truck me-2"}),u("Réceptions de commandes")],-1)),t("div",qe,[e[11]||(e[11]=t("a",{href:"/caisse/accueil",class:"btn btn-outline-secondary"},[t("i",{class:"bi bi-arrow-left me-1"}),u("Retour ")],-1)),e[12]||(e[12]=t("a",{href:"/caisse/inventaire",class:"btn btn-outline-primary"},"Inventaire",-1)),y.value==="list"?(n(),i("button",{key:0,type:"button",class:"btn btn-primary",onClick:se},[...e[9]||(e[9]=[t("i",{class:"bi bi-plus-circle me-1"},null,-1),u("Nouvelle réception ",-1)])])):(n(),i("button",{key:1,type:"button",class:"btn btn-outline-secondary",onClick:e[0]||(e[0]=l=>{y.value="list",g()})},[...e[10]||(e[10]=[t("i",{class:"bi bi-list me-1"},null,-1),u("Liste ",-1)])]))])]),c.value?(n(),i("div",Ae,[u(r(c.value)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[1]||(e[1]=l=>c.value=null)})])):v("",!0),y.value==="list"?(n(),i(b,{key:1},[w.value?(n(),i("div",$e,[...e[14]||(e[14]=[t("div",{class:"spinner-border text-primary"},null,-1)])])):$.value.length===0?(n(),i("div",je,[...e[15]||(e[15]=[u(" Aucune réception. Cliquez sur ",-1),t("strong",null,"Nouvelle réception",-1),u(" pour en créer une. ",-1)])])):(n(),i("div",Be,[t("div",Ue,[t("div",Fe,[t("table",Te,[e[20]||(e[20]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"BL"),t("th",null,"Fournisseur"),t("th",null,"Précommande"),t("th",null,"Date"),t("th",null,"Statut"),t("th",null,"Actions")])],-1)),t("tbody",null,[(n(!0),i(b,null,P($.value,l=>(n(),i("tr",{key:l.id},[t("td",null,[t("code",null,r(l.bl_number),1)]),t("td",null,r(l.supplier_nom),1),t("td",null,[l.is_from_preorder?(n(),i("span",Ee,[e[16]||(e[16]=u(" Oui",-1)),l.catalog_file_id?(n(),i("span",Me," — #"+r(l.catalog_file_id),1)):v("",!0)])):(n(),i("span",ze,"Non"))]),t("td",null,r(O(l.created_at)),1),t("td",null,[t("span",{class:T(["badge",l.statut==="validated"?"bg-success":"bg-secondary"])},r(l.statut==="validated"?"Validée":"Brouillon"),3)]),t("td",null,[t("button",{type:"button",class:"btn btn-sm btn-outline-primary me-1",onClick:k=>X(l.id)},[...e[17]||(e[17]=[t("i",{class:"bi bi-eye"},null,-1)])],8,Oe),l.statut==="draft"?(n(),i(b,{key:0},[t("button",{type:"button",class:"btn btn-sm btn-success me-1",onClick:k=>me(l.id)},[...e[18]||(e[18]=[t("i",{class:"bi bi-check-lg"},null,-1),u(" Valider ",-1)])],8,Qe),t("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:k=>ve(l.id)},[...e[19]||(e[19]=[t("i",{class:"bi bi-trash"},null,-1)])],8,We)],64)):v("",!0)])]))),128))])])])])]))],64)):(n(),i(b,{key:2},[t("div",Xe,[t("div",Ye,[t("h5",Ze,r(d.value?"Détail / Modifier la réception":"Nouvelle réception"),1)]),t("div",Ge,[t("div",He,[t("div",Ie,[e[22]||(e[22]=t("label",{class:"form-label"},[u("Fournisseur "),t("span",{class:"text-danger"},"*")],-1)),x(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>o.value.supplier_id=l),class:"form-select",disabled:!!d.value,onChange:le},[e[21]||(e[21]=t("option",{value:""},"Sélectionner un fournisseur",-1)),(n(!0),i(b,null,P(M.value,l=>(n(),i("option",{key:l.id,value:l.id},r(l.nom),9,Ke))),128))],40,Je),[[fe,o.value.supplier_id]])]),t("div",et,[e[23]||(e[23]=t("label",{class:"form-label"},[u("N° Bon de livraison (BL) "),t("span",{class:"text-danger"},"*")],-1)),x(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>o.value.bl_number=l),type:"text",class:"form-control",placeholder:"Ex: BL-2024-001"},null,512),[[D,o.value.bl_number]])]),t("div",tt,[t("div",lt,[x(t("input",{id:"from_preorder","onUpdate:modelValue":e[4]||(e[4]=l=>o.value.is_from_preorder=l),type:"checkbox",class:"form-check-input",disabled:!!d.value},null,8,st),[[ge,o.value.is_from_preorder]]),e[24]||(e[24]=t("label",{class:"form-check-label",for:"from_preorder"},"Réception issue d'une précommande",-1))])])]),!d.value&&o.value.supplier_id&&o.value.is_from_preorder?(n(),i("div",nt,[e[29]||(e[29]=t("h6",{class:"text-muted mb-2"},"Catalogues / Précommandes concernés",-1)),B.value?(n(),i("div",it,[...e[25]||(e[25]=[t("span",{class:"spinner-border spinner-border-sm me-1"},null,-1),u("Chargement…",-1)])])):f.value.length>0?(n(),i("div",ot,[t("div",at,[(n(!0),i(b,null,P(f.value,l=>(n(),i("div",{key:l.id,class:"d-flex align-items-center gap-1 flex-wrap"},[t("span",rt,"#"+r(l.id)+" — "+r(l.originalname||l.description||"Catalogue "+l.id),1),l.date_livraison?(n(),i("span",ut,"(livr. "+r(te(l.date_livraison))+")",1)):v("",!0),t("button",{type:"button",class:"btn btn-sm btn-outline-primary",disabled:L.value!==null,onClick:k=>ie(l.id)},[L.value===l.id?(n(),i("span",ct)):(n(),i(b,{key:1},[u("Préremplir")],64))],8,dt)]))),128))])])):(n(),i("p",pt,"Aucun catalogue (date de livraison à ce jour ou passée) pour ce fournisseur.")),e[30]||(e[30]=t("h6",{class:"text-muted mb-2 mt-3"},"Dernières précommandes livrées",-1)),j.value?(n(),i("div",mt,[...e[26]||(e[26]=[t("span",{class:"spinner-border spinner-border-sm me-1"},null,-1),u("Chargement…",-1)])])):C.value.length>0?(n(),i("div",vt,[t("table",bt,[e[27]||(e[27]=t("thead",{class:"table-light sticky-top"},[t("tr",null,[t("th",null,"BL"),t("th",null,"Date livraison"),t("th",null,"Lignes")])],-1)),t("tbody",null,[(n(!0),i(b,null,P(C.value,l=>(n(),i("tr",{key:l.id},[t("td",null,[t("code",null,r(l.bl_number),1)]),t("td",null,r(O(l.validated_at)),1),t("td",null,r(l.nb_lignes),1)]))),128))])])])):(n(),i("p",_t,"Aucune réception validée (précommande) pour ce fournisseur.")),o.value.catalog_file_id?(n(),i("p",ft,[e[28]||(e[28]=t("i",{class:"bi bi-check-circle me-1"},null,-1)),u("Précommande utilisée : #"+r(o.value.catalog_file_id)+" ",1),f.value.find(l=>l.id===o.value.catalog_file_id)?(n(),i("span",gt,r(f.value.find(l=>l.id===o.value.catalog_file_id).originalname||f.value.find(l=>l.id===o.value.catalog_file_id).description),1)):(a=_.value)!=null&&a.catalog_originalname?(n(),i("span",yt,r(_.value.catalog_originalname),1)):v("",!0)])):v("",!0)])):v("",!0),e[43]||(e[43]=t("h6",{class:"mt-4"},"Lignes de réception",-1)),!d.value&&o.value.supplier_id?(n(),i("div",ht,[t("button",{type:"button",class:"btn btn-sm btn-outline-secondary",onClick:e[5]||(e[5]=l=>S.value=!0)},[...e[31]||(e[31]=[t("i",{class:"bi bi-plus me-1"},null,-1),u("Ajouter un produit ",-1)])])])):v("",!0),t("div",kt,[t("table",xt,[t("thead",Ct,[t("tr",null,[e[32]||(e[32]=t("th",null,"Produit",-1)),e[33]||(e[33]=t("th",{class:"text-end",style:{width:"100px"}},"Qté reçue",-1)),e[34]||(e[34]=t("th",{class:"text-end",style:{width:"100px"}},"Prix unit. réception",-1)),e[35]||(e[35]=t("th",{class:"text-end",style:{width:"90px"}},"Prix base",-1)),e[36]||(e[36]=t("th",null,"Commentaire",-1)),!d.value||((A=_.value)==null?void 0:A.statut)==="draft"?(n(),i("th",Rt)):v("",!0)])]),t("tbody",null,[(n(!0),i(b,null,P(o.value.lignes,(l,k)=>{var Z,G,H,I;return n(),i("tr",{key:l.product_id+"-"+k,class:T({"table-warning":Q(l)})},[t("td",null,r(l.product_nom),1),t("td",Nt,[!d.value||((Z=_.value)==null?void 0:Z.statut)==="draft"?x((n(),i("input",{key:0,"onUpdate:modelValue":N=>l.quantite_recue=N,type:"number",class:"form-control form-control-sm text-end",min:"0.001",step:"0.001"},null,8,Pt)),[[D,l.quantite_recue,void 0,{number:!0}]]):(n(),i("span",wt,r(l.quantite_recue),1))]),t("td",Vt,[!d.value||((G=_.value)==null?void 0:G.statut)==="draft"?x((n(),i("input",{key:0,"onUpdate:modelValue":N=>l.prix_unitaire=N,type:"number",class:"form-control form-control-sm text-end",min:"0",step:"0.01"},null,8,Dt)),[[D,l.prix_unitaire,void 0,{number:!0}]]):(n(),i("span",Lt,r((Number(l.prix_unitaire)||0).toFixed(2))+" €",1))]),t("td",St,[t("span",{class:T({"text-danger fw-bold":Q(l)})},r(l.prix_base!=null?Number(l.prix_base).toFixed(2):"-")+" € ",3)]),t("td",null,[!d.value||((H=_.value)==null?void 0:H.statut)==="draft"?x((n(),i("input",{key:0,"onUpdate:modelValue":N=>l.comment=N,type:"text",class:"form-control form-control-sm",placeholder:"Commentaire"},null,8,qt)),[[D,l.comment]]):(n(),i("span",At,r(l.comment||"-"),1))]),!d.value||((I=_.value)==null?void 0:I.statut)==="draft"?(n(),i("td",$t,[t("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:N=>o.value.lignes.splice(k,1)},[...e[37]||(e[37]=[t("i",{class:"bi bi-trash"},null,-1)])],8,jt)])):v("",!0)],2)}),128))])])]),o.value.lignes.length===0?(n(),i("div",Bt,"Aucune ligne. Préremplir depuis une précommande ou ajouter des produits.")):v("",!0),t("div",Ut,[d.value?((Y=_.value)==null?void 0:Y.statut)==="draft"?(n(),i(b,{key:1},[t("button",{type:"button",class:"btn btn-primary",disabled:p.value||!V.value,onClick:ce},[p.value?(n(),i("span",Qt)):v("",!0),e[41]||(e[41]=u(" Enregistrer ",-1))],8,Ot),t("button",{type:"button",class:"btn btn-success",disabled:p.value||!q.value,onClick:pe},[p.value?(n(),i("span",Xt)):v("",!0),e[42]||(e[42]=u(" Valider la réception ",-1))],8,Wt)],64)):v("",!0):(n(),i(b,{key:0},[t("button",{type:"button",class:"btn btn-primary",disabled:p.value||!V.value,onClick:ue},[p.value?(n(),i("span",Tt)):(n(),i("i",Et)),e[38]||(e[38]=u("Enregistrer le brouillon ",-1))],8,Ft),t("button",{type:"button",class:"btn btn-success",disabled:p.value||!q.value,onClick:de},[p.value?(n(),i("span",zt)):v("",!0),e[39]||(e[39]=t("i",{class:"bi bi-check-lg me-1"},null,-1)),e[40]||(e[40]=u("Enregistrer et valider ",-1))],8,Mt)],64)),t("button",{type:"button",class:"btn btn-outline-secondary",onClick:e[6]||(e[6]=l=>{y.value="list",g()})}," Annuler / Retour ")])])]),S.value?(n(),i("div",Yt,[t("div",Zt,[t("div",Gt,[t("div",Ht,[e[44]||(e[44]=t("h5",{class:"modal-title"},"Ajouter un produit",-1)),t("button",{type:"button",class:"btn-close",onClick:e[7]||(e[7]=l=>S.value=!1)})]),t("div",It,[x(t("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>R.value=l),type:"text",class:"form-control mb-3",placeholder:"Rechercher par nom...",onInput:oe},null,544),[[D,R.value]]),U.value?(n(),i("div",Jt,[...e[45]||(e[45]=[t("div",{class:"spinner-border spinner-border-sm"},null,-1)])])):(n(),i("ul",Kt,[(n(!0),i(b,null,P(h.value,l=>(n(),i("li",{key:l.id,class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",style:{cursor:"pointer"},onClick:k=>re(l)},[t("span",null,r(l.nom),1),t("span",tl,r((Number(l.prix)||0).toFixed(2))+" €",1)],8,el))),128)),h.value.length===0&&R.value.length>=2?(n(),i("li",ll,"Aucun produit trouvé")):v("",!0)]))])])])])):v("",!0)],64))])}}},ee=ye(sl);ee.use(he());ee.mount("#receptions-app");
