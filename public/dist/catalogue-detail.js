import{i as $,o as a,c as d,a as t,b,u as i,t as p,d as f,F as x,e as E,v as L,q as Q,k,p as V,n as R,r as j,h as z}from"./chunks/runtime-dom.esm-bundler-BlMAuMpH.js";import{d as B,c as M}from"./chunks/pinia-BNknc8Vm.js";import{l as K,m as G,u as H,n as J,o as W,p as X,A as Y}from"./chunks/index-BkeVkIvb.js";import{_ as Z}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const ee=B("catalogueDetail",{state:()=>({loading:!1,error:null,authRequired:!1,catalogue:null,products:[],panier:null,panierArticles:{},searchTerm:"",selectedCategory:"all",canChangeOwner:!1,users:[],selectedUserId:null,changingOwner:!1}),getters:{categories(r){const e=new Map;return(r.products||[]).forEach(n=>{n.categorie&&e.set(n.categorie,{nom:n.categorie,couleur:n.categorie_couleur,ordre:n.categorie_ordre})}),Array.from(e.values()).sort((n,l)=>n.ordre-l.ordre)},filteredProducts(r){let e=[...r.products||[]];if(r.selectedCategory!=="all"&&(e=e.filter(n=>n.categorie===r.selectedCategory)),r.searchTerm){const n=r.searchTerm.toLowerCase();e=e.filter(l=>l.produit&&l.produit.toLowerCase().includes(n)||l.description&&l.description.toLowerCase().includes(n))}return e},getProductQuantity:r=>e=>{var n;return((n=r.panierArticles[e])==null?void 0:n.quantity)??0},getProductNote:r=>e=>{var n;return((n=r.panierArticles[e])==null?void 0:n.note)??""},totalArticles(r){return Object.values(r.panierArticles||{}).reduce((e,n)=>e+(n.quantity||0),0)},totalPrice(r){let e=0;return(r.products||[]).forEach(n=>{var c,w;const l=((w=(c=r.panierArticles)==null?void 0:c[n.id])==null?void 0:w.quantity)??0;l>0&&(e+=l*(n.prix||0)*(n.unite||1))}),e},productsByCategory(r){let e=[...r.products||[]];if(r.selectedCategory!=="all"&&(e=e.filter(l=>l.categorie===r.selectedCategory)),r.searchTerm){const l=r.searchTerm.toLowerCase();e=e.filter(c=>c.produit&&c.produit.toLowerCase().includes(l)||c.description&&c.description.toLowerCase().includes(l))}const n={};return e.forEach(l=>{const c=l.categorie||"Sans catégorie";n[c]||(n[c]={name:c,color:l.categorie_couleur||"#6c757d",ordre:l.categorie_ordre??999,products:[]}),n[c].products.push(l)}),Object.values(n).sort((l,c)=>l.ordre-c.ordre)}},actions:{async loadDetail(r,e=!1){this.loading=!0,this.error=null,this.authRequired=!1,this.catalogue=null,this.products=[],this.panier=null,this.panierArticles={};try{const n=await X(r,e);if(n.success)this.catalogue=n.catalogue,this.products=n.products||[],this.panier=n.panier||null,this.panierArticles=n.panierArticles||{},this.canChangeOwner=n.canChangeOwner===!0,this.users=n.users||[],this.selectedUserId=null;else throw new Error(n.error||"Erreur chargement catalogue")}catch(n){this.error=n.message,n.code===Y&&(this.authRequired=!0),console.error("catalogueDetail loadDetail:",n)}finally{this.loading=!1}},async updateQuantity(r,e,n,l,c){const w=parseInt(e)||0,C=!this.panier&&l===!0;try{const v=await W(n,r,w,C,c);if(v.success){if(w===0){const{[r]:P,..._}=this.panierArticles;this.panierArticles=_}else this.panierArticles[r]||(this.panierArticles={...this.panierArticles,[r]:{}}),this.panierArticles[r]={...this.panierArticles[r],quantity:w};v.panier_id&&!this.panier&&(this.panier={id:v.panier_id})}else throw new Error(v.error||"Erreur mise à jour")}catch(v){throw console.error("updateQuantity:",v),v}},async updateNote(r,e,n,l){try{const c=await J(n,r,e??"",l);if(c.success)this.panierArticles[r]||(this.panierArticles={...this.panierArticles,[r]:{}}),this.panierArticles[r]={...this.panierArticles[r],note:e??""};else throw new Error(c.error||"Erreur mise à jour note")}catch(c){throw console.error("updateNote:",c),c}},async updatePanierNote(r,e){var n;if((n=this.panier)!=null&&n.id)try{const l=await H(this.panier.id,r??"",e);if(l.success)this.panier={...this.panier,note:r??""};else throw new Error(l.error||"Erreur mise à jour note panier")}catch(l){throw console.error("updatePanierNote:",l),l}},async validerPanier(r){var n;if(!((n=this.panier)!=null&&n.id))throw new Error("Aucun panier à valider");if(this.totalArticles===0)throw new Error("Votre panier est vide");const e=await G(this.panier.id,r);if(!e.success)throw new Error(e.error||"Erreur validation");typeof window<"u"&&(window.location.href="/commandes/vue")},async changeOwner(r,e){var n;if(!((n=this.panier)!=null&&n.id))throw new Error("Aucun panier");this.changingOwner=!0;try{const l=await K(this.panier.id,r,e);if(!l.success)throw new Error(l.error||"Erreur changement propriétaire");this.panier={...this.panier,user_id:r,username:(this.users.find(c=>c.id===r)||{}).username}}finally{this.changingOwner=!1}}}}),te={class:"admin-content-wrapper"},se={class:"container-fluid mt-4"},ie={key:0,class:"alert alert-danger alert-dismissible fade show"},ne={key:1,class:"text-center py-5"},re={class:"mb-4"},oe={class:"mb-1"},le={key:0,class:"text-muted mb-2"},ae={class:"d-flex flex-wrap gap-3 align-items-center small text-muted"},de={key:0},ue={key:0,class:"badge bg-danger ms-1"},ce={class:"row mb-3 catalogue-detail-row-equal"},me={class:"col-12 col-md-4 mb-3 mb-md-0 d-flex"},pe={class:"catalogue-detail-side catalogue-detail-side-left w-100 h-100"},fe={class:"input-group mb-2"},ge=["value"],be={class:"alert alert-info py-2 mb-2"},he={class:"d-block mt-1"},ye={class:"col-12 col-md-8 d-flex"},we={class:"catalogue-detail-side catalogue-detail-side-right w-100 h-100"},ve={class:"catalogue-detail-note-wrapper"},_e=["value","disabled"],xe={class:"d-grid"},ke=["disabled"],Ce={key:0,class:"row mb-3"},Ae={class:"col-12"},Ee={class:"card"},Pe={class:"card-body"},Ne={class:"card-title mb-3"},Te={key:0,class:"text-muted fw-normal"},Oe={class:"d-flex flex-column flex-md-row gap-2 align-items-md-center flex-wrap"},Qe={class:"form-label mb-0 text-nowrap"},Re=["disabled"],je=["value"],qe=["disabled"],Se={key:0,class:"spinner-border spinner-border-sm me-1"},De={key:1,class:"text-center py-5"},Ie={class:"mb-0"},Ue={class:"card-body p-0"},Fe={class:"d-none d-md-block"},$e={class:"table-responsive"},Le={class:"table table-hover mb-0"},Ve={class:"d-flex align-items-center"},ze=["src","alt"],Be={key:0},Me={key:1,class:"text-muted"},Ke={class:"text-center"},Ge={key:0},He={key:1,class:"text-muted"},Je={class:"text-center"},We={class:"d-flex align-items-center justify-content-center gap-1"},Xe=["disabled","onClick"],Ye=["value","disabled","onInput"],Ze=["disabled","onClick"],et=["value","disabled","onInput"],tt={key:1,class:"text-muted"},st={class:"d-md-none"},it={class:"d-flex align-items-start mb-2"},nt=["src","alt"],rt={class:"flex-grow-1"},ot={class:"d-block"},lt={key:0,class:"text-muted d-block"},at={class:"mb-2"},dt={class:"fs-5"},ut={key:0,class:"text-muted"},ct={class:"mb-2"},mt={class:"d-flex align-items-center gap-2"},pt=["disabled","onClick"],ft=["value","disabled","onInput"],gt=["disabled","onClick"],bt={key:0,class:"mb-2"},ht=["value","disabled","onInput"],yt={key:3,class:"alert alert-warning"},wt={__name:"CatalogueDetailPage",setup(r){const e=ee(),n=j(null),l=j(!1);let c=null,w=null,C=null;function v(){return typeof window>"u"?null:window.location.pathname.split("/")[2]||null}function P(){return typeof window>"u"?!1:new URLSearchParams(window.location.search).get("nouveau")==="1"}function _(u){return u==null?"0,00 €":new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(u)}function A(u,s){const h=e.getProductQuantity(u.id),y=Math.max(0,h+s);N(u.id,y)}function N(u,s){const h=n.value,y=typeof window<"u"?window.CSRF_TOKEN:"";h&&e.updateQuantity(u,s,h,l.value,y).catch(m=>{typeof window<"u"&&alert("Erreur lors de la mise à jour de la quantité")})}function S(u,s){const h=n.value,y=typeof window<"u"?window.CSRF_TOKEN:"";h&&e.updateNote(u,s,h,y).catch(m=>{typeof window<"u"&&alert("Erreur lors de la mise à jour de la note")})}function D(u){const s=typeof window<"u"?window.CSRF_TOKEN:"";e.updatePanierNote(u,s).catch(h=>{typeof window<"u"&&alert("Erreur lors de la mise à jour de la note du panier")})}function T(u,s){clearTimeout(c),c=setTimeout(()=>{N(u,parseInt(s)||0)},500)}function O(u,s){clearTimeout(w),w=setTimeout(()=>{S(u,s)},1e3)}function I(u){clearTimeout(C),C=setTimeout(()=>{D(u)},1e3)}function U(){const u=e.totalArticles,s=e.totalPrice;if(typeof window<"u"&&!confirm(`Confirmer la transformation du panier en commande ?

${u} article${u>1?"s":""} - Total : ${_(s)}`))return;const h=n.value,y=typeof window<"u"?window.CSRF_TOKEN:"";h&&e.validerPanier(y).catch(m=>{typeof window<"u"&&alert(m.message||"Erreur lors de la validation du panier")})}function F(){if(!e.selectedUserId||typeof window<"u"&&!confirm("Merci de confirmer le changement de propriétaire de ce panier !"))return;const u=typeof window<"u"?window.CSRF_TOKEN:"";e.changeOwner(e.selectedUserId,u).catch(s=>{typeof window<"u"&&alert(s.message||"Erreur lors du changement")})}return $(()=>{const u=v();n.value=u,l.value=P(),u&&e.loadDetail(u,l.value)}),(u,s)=>{var h,y;return a(),d("div",te,[t("div",se,[t("button",{class:"btn btn-outline-secondary d-md-none mb-3",onClick:s[0]||(s[0]=m=>u.history.back())},[...s[8]||(s[8]=[t("i",{class:"bi bi-arrow-left me-2"},null,-1),b("Retour ",-1)])]),i(e).error?(a(),d("div",ie,[s[9]||(s[9]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),s[10]||(s[10]=t("strong",null,"Erreur :",-1)),b(" "+p(i(e).error)+" ",1),t("button",{type:"button",class:"btn-close",onClick:s[1]||(s[1]=m=>i(e).error=null)})])):f("",!0),i(e).loading?(a(),d("div",ne,[...s[11]||(s[11]=[t("div",{class:"spinner-border text-primary",role:"status",style:{width:"3rem",height:"3rem"}},null,-1),t("p",{class:"mt-3 text-muted"},"Chargement du catalogue...",-1)])])):i(e).catalogue?(a(),d(x,{key:2},[t("div",re,[t("h2",oe,[s[12]||(s[12]=t("i",{class:"bi bi-book me-2"},null,-1)),b(p(i(e).catalogue.originalname),1)]),i(e).catalogue.description?(a(),d("p",le,p(i(e).catalogue.description),1)):f("",!0),t("div",ae,[t("span",null,[s[13]||(s[13]=t("i",{class:"bi bi-hash me-1",title:"ID catalogue"},null,-1)),s[14]||(s[14]=b("ID catalogue : ",-1)),t("strong",null,p(i(e).catalogue.id),1)]),i(e).catalogue.referent_username?(a(),d("span",de,[s[15]||(s[15]=t("i",{class:"bi bi-person-badge me-1",title:"Référent"},null,-1)),s[16]||(s[16]=b("Référent : ",-1)),t("strong",null,p(i(e).catalogue.referent_username),1)])):f("",!0),t("span",null,[s[17]||(s[17]=t("i",{class:"bi bi-calendar-x me-1",title:"Expiration"},null,-1)),s[18]||(s[18]=b("Expiration : ",-1)),t("strong",null,p(i(e).catalogue.expiration_formatted),1),i(e).catalogue.isExpired?(a(),d("span",ue,"Expiré")):f("",!0)]),t("span",null,[s[19]||(s[19]=t("i",{class:"bi bi-truck me-1",title:"Livraison"},null,-1)),s[20]||(s[20]=b("Livraison : ",-1)),t("strong",null,p(i(e).catalogue.livraison_formatted),1)])])]),t("div",ce,[t("div",me,[t("div",pe,[t("div",fe,[s[21]||(s[21]=t("span",{class:"input-group-text"},[t("i",{class:"bi bi-search"})],-1)),E(t("input",{"onUpdate:modelValue":s[2]||(s[2]=m=>i(e).searchTerm=m),type:"text",class:"form-control",placeholder:"Rechercher un produit..."},null,512),[[L,i(e).searchTerm]])]),i(e).categories.length>0?E((a(),d("select",{key:0,"onUpdate:modelValue":s[3]||(s[3]=m=>i(e).selectedCategory=m),class:"form-select mb-2"},[s[22]||(s[22]=t("option",{value:"all"},"Toutes les catégories",-1)),(a(!0),d(x,null,k(i(e).categories,m=>(a(),d("option",{key:m.nom,value:m.nom},p(m.nom),9,ge))),128))],512)),[[Q,i(e).selectedCategory]]):f("",!0),t("div",be,[s[24]||(s[24]=t("i",{class:"bi bi-cart3 me-2"},null,-1)),t("strong",null,p(i(e).totalArticles),1),b(" article"+p(i(e).totalArticles>1?"s":"")+" ",1),t("span",he,[s[23]||(s[23]=t("strong",null,"Total :",-1)),b(" "+p(_(i(e).totalPrice)),1)])])])]),t("div",ye,[t("div",we,[t("div",ve,[s[26]||(s[26]=t("h6",{class:"mb-2"},[t("i",{class:"bi bi-sticky me-2"}),b("Note pour ce panier "),t("small",{class:"text-muted ms-2"},"(optionnel)")],-1)),t("textarea",{value:((h=i(e).panier)==null?void 0:h.note)||"",class:"form-control mb-2",rows:"2",placeholder:"Ajoutez une note pour ce panier...",disabled:!i(e).catalogue.modifiable||i(e).totalArticles===0,onInput:s[4]||(s[4]=m=>I(m.target.value))},null,40,_e),s[27]||(s[27]=t("small",{class:"text-muted d-block mb-2"},"Cette note sera visible sur la commande après validation",-1)),t("div",xe,[i(e).catalogue.modifiable?(a(),d("button",{key:0,type:"button",class:"btn btn-success btn-lg",disabled:i(e).totalArticles===0,onClick:U},[...s[25]||(s[25]=[t("i",{class:"bi bi-check-circle me-2"},null,-1),b("Transformer en commande ",-1)])],8,ke)):f("",!0)])])])])]),i(e).canChangeOwner&&i(e).users.length>0?(a(),d("div",Ce,[t("div",Ae,[t("div",Ee,[t("div",Pe,[t("h5",Ne,[s[28]||(s[28]=b(" Changement de propriétaire ",-1)),i(e).totalArticles===0?(a(),d("span",Te,"(Ajoutez au moins un article pour activer le changement de propriétaire.)")):f("",!0)]),t("div",Oe,[t("label",Qe,[s[29]||(s[29]=b("Propriétaire actuel : ",-1)),t("strong",null,p(((y=i(e).panier)==null?void 0:y.username)||"—"),1)]),E(t("select",{"onUpdate:modelValue":s[5]||(s[5]=m=>i(e).selectedUserId=m),class:"form-select form-select-sm",style:{width:"auto","min-width":"200px"},disabled:i(e).changingOwner||i(e).totalArticles===0},[s[30]||(s[30]=t("option",{value:null},"-- Sélectionner un utilisateur --",-1)),(a(!0),d(x,null,k(i(e).users,m=>(a(),d("option",{key:m.id,value:m.id},p(m.username),9,je))),128))],8,Re),[[Q,i(e).selectedUserId]]),t("button",{type:"button",class:"btn btn-warning btn-sm",disabled:i(e).changingOwner||!i(e).selectedUserId||i(e).totalArticles===0,onClick:F},[i(e).changingOwner?(a(),d("span",Se)):f("",!0),s[31]||(s[31]=t("i",{class:"bi bi-person-fill-gear me-1"},null,-1)),s[32]||(s[32]=b("Changer le propriétaire ",-1))],8,qe)])])])])])):f("",!0),i(e).productsByCategory.length===0?(a(),d("div",De,[...s[33]||(s[33]=[t("i",{class:"bi bi-inbox fs-1 text-muted mb-3 d-block"},null,-1),t("p",{class:"text-muted"},"Aucun produit trouvé",-1)])])):(a(!0),d(x,{key:2},k(i(e).productsByCategory,m=>(a(),d("div",{key:m.name,class:"card mb-3 border-0 shadow-sm"},[t("div",{class:"card-header",style:V({backgroundColor:m.color,color:"white"})},[t("h5",Ie,p(m.name),1)],4),t("div",Ue,[t("div",Fe,[t("div",$e,[t("table",Le,[s[36]||(s[36]=t("thead",{class:"table-light"},[t("tr",null,[t("th",{style:{width:"35%"}},"Produit"),t("th",{class:"text-center",style:{width:"15%"}},"Prix"),t("th",{class:"text-center",style:{width:"20%"}},"Quantité"),t("th",{style:{width:"30%"}},"Note")])],-1)),t("tbody",null,[(a(!0),d(x,null,k(m.products,o=>(a(),d("tr",{key:o.id,class:R({"table-success":i(e).getProductQuantity(o.id)>0})},[t("td",null,[t("div",Ve,[o.image_filename?(a(),d("img",{key:0,src:`/images/products/${o.image_filename}`,alt:o.produit,class:"me-2",style:{width:"40px",height:"40px","object-fit":"cover","border-radius":"4px"},onError:s[6]||(s[6]=g=>g.target.style.display="none")},null,40,ze)):f("",!0),t("div",null,[t("strong",null,p(o.produit),1),o.description?(a(),d("br",Be)):f("",!0),o.description?(a(),d("small",Me,p(o.description),1)):f("",!0)])])]),t("td",Ke,[t("strong",null,p(_((o.prix||0)*(o.unite||1))),1),o.unite>1?(a(),d("br",Ge)):f("",!0),o.unite>1?(a(),d("small",He,"par "+p(o.unite),1)):f("",!0)]),t("td",Je,[t("div",We,[t("button",{type:"button",class:"btn btn-sm btn-outline-secondary",style:{width:"32px",height:"32px",padding:"0"},disabled:!i(e).catalogue.modifiable,onClick:g=>A(o,-1)},[...s[34]||(s[34]=[t("i",{class:"bi bi-dash"},null,-1)])],8,Xe),t("input",{type:"number",class:"form-control form-control-sm text-center quantity-input",style:{width:"60px"},value:i(e).getProductQuantity(o.id),min:"0",step:"1",disabled:!i(e).catalogue.modifiable,onInput:g=>T(o.id,g.target.value)},null,40,Ye),t("button",{type:"button",class:"btn btn-sm btn-outline-secondary",style:{width:"32px",height:"32px",padding:"0"},disabled:!i(e).catalogue.modifiable,onClick:g=>A(o,1)},[...s[35]||(s[35]=[t("i",{class:"bi bi-plus"},null,-1)])],8,Ze)])]),t("td",null,[i(e).getProductQuantity(o.id)>0?(a(),d("input",{key:0,type:"text",class:"form-control form-control-sm note-input",value:i(e).getProductNote(o.id),placeholder:"Note optionnelle",disabled:!i(e).catalogue.modifiable,onInput:g=>O(o.id,g.target.value)},null,40,et)):(a(),d("span",tt,"-"))])],2))),128))])])])]),t("div",st,[(a(!0),d(x,null,k(m.products,o=>(a(),d("div",{key:"m-"+o.id,class:R(["product-card-mobile p-3 border-bottom",{"bg-success-subtle":i(e).getProductQuantity(o.id)>0}])},[t("div",it,[o.image_filename?(a(),d("img",{key:0,src:`/images/products/${o.image_filename}`,alt:o.produit,class:"me-2",style:{width:"50px",height:"50px","object-fit":"cover","border-radius":"4px"},onError:s[7]||(s[7]=g=>g.target.style.display="none")},null,40,nt)):f("",!0),t("div",rt,[t("strong",ot,p(o.produit),1),o.description?(a(),d("small",lt,p(o.description),1)):f("",!0)])]),t("div",at,[s[37]||(s[37]=t("span",{class:"text-muted"},"Prix : ",-1)),t("strong",dt,p(_((o.prix||0)*(o.unite||1))),1),o.unite>1?(a(),d("small",ut," par "+p(o.unite),1)):f("",!0)]),t("div",ct,[s[40]||(s[40]=t("label",{class:"form-label mb-1 text-muted"},"Quantité",-1)),t("div",mt,[t("button",{type:"button",class:"btn btn-outline-secondary",style:{width:"44px",height:"44px",padding:"0"},disabled:!i(e).catalogue.modifiable,onClick:g=>A(o,-1)},[...s[38]||(s[38]=[t("i",{class:"bi bi-dash fs-5"},null,-1)])],8,pt),t("input",{type:"number",class:"form-control form-control-lg text-center quantity-input",style:{width:"80px"},value:i(e).getProductQuantity(o.id),min:"0",step:"1",disabled:!i(e).catalogue.modifiable,onInput:g=>T(o.id,g.target.value)},null,40,ft),t("button",{type:"button",class:"btn btn-outline-secondary",style:{width:"44px",height:"44px",padding:"0"},disabled:!i(e).catalogue.modifiable,onClick:g=>A(o,1)},[...s[39]||(s[39]=[t("i",{class:"bi bi-plus fs-5"},null,-1)])],8,gt)])]),i(e).getProductQuantity(o.id)>0?(a(),d("div",bt,[s[41]||(s[41]=t("label",{class:"form-label mb-1 text-muted"},"Note (optionnel)",-1)),t("input",{type:"text",class:"form-control note-input",value:i(e).getProductNote(o.id),placeholder:"Ajoutez une note...",disabled:!i(e).catalogue.modifiable,onInput:g=>O(o.id,g.target.value)},null,40,ht)])):f("",!0)],2))),128))])])]))),128)),i(e).catalogue&&!i(e).catalogue.modifiable?(a(),d("div",yt,[...s[42]||(s[42]=[t("i",{class:"bi bi-lock me-2"},null,-1),b(" Ce catalogue est expiré. Vous ne pouvez plus modifier votre panier. ",-1)])])):f("",!0)],64)):f("",!0)])])}}},vt=Z(wt,[["__scopeId","data-v-237468c6"]]),q=z(vt);q.use(M());q.mount("#catalogue-detail-app");
