import{i as S,o as u,c as d,u as n,a as r,t as m,b as f,j as k,e as w,v as T,s as $,n as c,d as b,F as h,l as C,w as v,h as x}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as D,c as L}from"./chunks/pinia-gLxYYWQL.js";import{_ as Q}from"./chunks/BackButton-DzFd1NqY.js";import{V as I}from"./chunks/index-CQL6Akic.js";const z=D("adminTrace",{state:()=>({traces:[],loading:!0,error:null,searchQuery:"",currentPage:1,pageSize:50,sortColumn:"id",sortDirection:"desc"}),getters:{filteredTraces(s){if(!s.searchQuery)return s.traces;const t=s.searchQuery.toLowerCase();return s.traces.filter(o=>o.id&&String(o.id).includes(t)||o.username&&o.username.toLowerCase().includes(t)||o.query&&o.query.toLowerCase().includes(t)||o.params&&o.params.toLowerCase().includes(t))},sortedTraces(s){const o=[...s.searchQuery?s.traces.filter(e=>e.id&&String(e.id).toLowerCase().includes(s.searchQuery.toLowerCase())||e.username&&e.username.toLowerCase().includes(s.searchQuery.toLowerCase())||e.query&&e.query.toLowerCase().includes(s.searchQuery.toLowerCase())||e.params&&e.params.toLowerCase().includes(s.searchQuery.toLowerCase())):s.traces];return o.sort((e,i)=>{let a=e[s.sortColumn],l=i[s.sortColumn];return a==null?1:l==null?-1:(s.sortColumn==="created_at"&&(a=new Date(a).getTime(),l=new Date(l).getTime()),s.sortColumn==="id"&&(a=parseInt(a),l=parseInt(l)),a<l?s.sortDirection==="asc"?-1:1:a>l?s.sortDirection==="asc"?1:-1:0)}),o},paginatedTraces(s){const t=this.sortedTraces,o=(s.currentPage-1)*s.pageSize;return t.slice(o,o+s.pageSize)},totalPages(s){const t=this.sortedTraces.length;return Math.ceil(t/s.pageSize)||1},paginationInfo(s){const t=this.sortedTraces.length,o=(s.currentPage-1)*s.pageSize+1,e=Math.min(s.currentPage*s.pageSize,t);return`${o}-${e} sur ${t}`}},actions:{async loadTraces(){this.loading=!0,this.error=null;try{const s=await I();if(s.success)this.traces=s.traces||[];else throw new Error(s.error)}catch(s){this.error=s.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},sortBy(s){this.sortColumn===s?this.sortDirection=this.sortDirection==="asc"?"desc":"asc":(this.sortColumn=s,this.sortDirection="desc")},goToPage(s){s>=1&&s<=this.totalPages&&(this.currentPage=s)},formatDate(s){if(!s)return"";const t=new Date(s);if(isNaN(t.getTime()))return s;const o=String(t.getDate()).padStart(2,"0"),e=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getFullYear()).slice(-2),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),g=String(t.getSeconds()).padStart(2,"0");return`${o}/${e}/${i} ${a}:${l}:${g}`},truncate(s,t=100){return s?s.length<=t?s:s.substring(0,t)+"...":""},getSortIcon(s){return this.sortColumn!==s?"":this.sortDirection==="asc"?"bi-arrow-up":"bi-arrow-down"},traceQueryDisplay(s){const t=String((s==null?void 0:s.query)||"").trim(),o=String((s==null?void 0:s.params)||"").trim();if(!o)return t;const e=o.split(/\s*\/\/\s*/);let i=t;for(let a=0;a<e.length;a++){const l=i.indexOf("?");if(l===-1)break;const g=e[a],y=(g||"").toString().toLowerCase();let p;y==="null"||g===""?p="NULL":y==="true"?p="1":y==="false"?p="0":/^-?\d+(\.\d+)?$/.test(String(g).trim())?p=String(g).trim():p="'"+String(g).replace(/'/g,"''")+"'",i=i.slice(0,l)+p+i.slice(l+1)}return i}}}),j={class:"container-fluid mt-4"},q={key:0,class:"text-center py-5"},M={key:1,class:"alert alert-danger"},V={key:2},A={class:"d-flex justify-content-between align-items-center mb-4"},B={class:"d-flex gap-2"},N={class:"mb-4"},U={class:"d-flex justify-content-between align-items-center mb-3"},E={class:"text-muted"},F={class:"d-flex align-items-center gap-2"},_={class:"card"},R={class:"table-responsive"},H={class:"table table-hover mb-0"},J={class:"thead-admin-site"},O={key:0},Y={class:"badge bg-primary"},G={class:"text-wrap",style:{"font-size":"0.85rem"}},K={key:0,class:"d-flex justify-content-center mt-4"},W={class:"pagination"},X=["onClick"],Z={key:1,class:"page-item disabled"},ee={__name:"AdminTracePage",setup(s){const t=z();return S(()=>{t.loadTraces()}),(o,e)=>(u(),d("div",j,[n(t).loading?(u(),d("div",q,[...e[12]||(e[12]=[r("div",{class:"spinner-border text-primary",role:"status"},null,-1),r("p",{class:"mt-3 text-muted"},"Chargement des traces...",-1)])])):n(t).error?(u(),d("div",M,m(n(t).error),1)):(u(),d("div",V,[r("div",A,[e[14]||(e[14]=r("h2",{class:"mb-0"},[r("i",{class:"bi bi-activity me-2"}),f("Traces de MAJ")],-1)),r("div",B,[k(Q),r("button",{onClick:e[0]||(e[0]=i=>n(t).loadTraces()),class:"btn btn-outline-primary"},[...e[13]||(e[13]=[r("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),f("Actualiser ",-1)])])])]),r("div",N,[w(r("input",{"onUpdate:modelValue":e[1]||(e[1]=i=>n(t).searchQuery=i),type:"text",class:"form-control",placeholder:"Rechercher par ID, utilisateur, requête ou paramètres...",onInput:e[2]||(e[2]=i=>n(t).currentPage=1)},null,544),[[T,n(t).searchQuery]])]),r("div",U,[r("div",E,m(n(t).paginationInfo)+" traces",1),r("div",F,[e[16]||(e[16]=r("label",{class:"mb-0"},"Lignes par page:",-1)),w(r("select",{"onUpdate:modelValue":e[3]||(e[3]=i=>n(t).pageSize=i),class:"form-select form-select-sm",style:{width:"auto"},onChange:e[4]||(e[4]=i=>n(t).currentPage=1)},[...e[15]||(e[15]=[r("option",{value:25},"25",-1),r("option",{value:50},"50",-1),r("option",{value:100},"100",-1),r("option",{value:200},"200",-1)])],544),[[$,n(t).pageSize,void 0,{number:!0}]])])]),r("div",_,[r("div",R,[r("table",H,[r("thead",J,[r("tr",null,[r("th",{onClick:e[5]||(e[5]=i=>n(t).sortBy("id")),style:{cursor:"pointer",width:"80px"}},[e[17]||(e[17]=f(" ID ",-1)),r("i",{class:c("bi ms-1 "+n(t).getSortIcon("id"))},null,2)]),r("th",{onClick:e[6]||(e[6]=i=>n(t).sortBy("created_at")),style:{cursor:"pointer",width:"160px"}},[e[18]||(e[18]=f(" Date Action ",-1)),r("i",{class:c("bi ms-1 "+n(t).getSortIcon("created_at"))},null,2)]),r("th",{onClick:e[7]||(e[7]=i=>n(t).sortBy("username")),style:{cursor:"pointer",width:"120px"}},[e[19]||(e[19]=f(" Username ",-1)),r("i",{class:c("bi ms-1 "+n(t).getSortIcon("username"))},null,2)]),e[20]||(e[20]=r("th",null,"Requête (avec paramètres)",-1))])]),r("tbody",null,[n(t).paginatedTraces.length===0?(u(),d("tr",O,[...e[21]||(e[21]=[r("td",{colspan:"4",class:"text-center text-muted py-4"},"Aucune trace trouvée",-1)])])):b("",!0),(u(!0),d(h,null,C(n(t).paginatedTraces,i=>(u(),d("tr",{key:i.id},[r("td",null,m(i.id),1),r("td",null,m(n(t).formatDate(i.created_at)),1),r("td",null,[r("span",Y,m(i.username||"—"),1)]),r("td",null,[r("code",G,m(n(t).traceQueryDisplay(i)),1)])]))),128))])])])]),n(t).totalPages>1?(u(),d("div",K,[r("nav",null,[r("ul",W,[r("li",{class:c(["page-item",{disabled:n(t).currentPage===1}])},[r("a",{class:"page-link",href:"javascript:void(0)",onClick:e[8]||(e[8]=v(i=>n(t).goToPage(1),["prevent"]))},[...e[22]||(e[22]=[r("i",{class:"bi bi-chevron-double-left"},null,-1)])])],2),r("li",{class:c(["page-item",{disabled:n(t).currentPage===1}])},[r("a",{class:"page-link",href:"javascript:void(0)",onClick:e[9]||(e[9]=v(i=>n(t).goToPage(n(t).currentPage-1),["prevent"]))},[...e[23]||(e[23]=[r("i",{class:"bi bi-chevron-left"},null,-1)])])],2),(u(!0),d(h,null,C(n(t).totalPages,i=>(u(),d(h,{key:i},[i===1||i===n(t).totalPages||i>=n(t).currentPage-2&&i<=n(t).currentPage+2?(u(),d("li",{key:0,class:c(["page-item",{active:i===n(t).currentPage}])},[r("a",{class:"page-link",href:"javascript:void(0)",onClick:v(a=>n(t).goToPage(i),["prevent"])},m(i),9,X)],2)):i===n(t).currentPage-3||i===n(t).currentPage+3?(u(),d("li",Z,[...e[24]||(e[24]=[r("span",{class:"page-link"},"...",-1)])])):b("",!0)],64))),128)),r("li",{class:c(["page-item",{disabled:n(t).currentPage===n(t).totalPages}])},[r("a",{class:"page-link",href:"javascript:void(0)",onClick:e[10]||(e[10]=v(i=>n(t).goToPage(n(t).currentPage+1),["prevent"]))},[...e[25]||(e[25]=[r("i",{class:"bi bi-chevron-right"},null,-1)])])],2),r("li",{class:c(["page-item",{disabled:n(t).currentPage===n(t).totalPages}])},[r("a",{class:"page-link",href:"javascript:void(0)",onClick:e[11]||(e[11]=v(i=>n(t).goToPage(n(t).totalPages),["prevent"]))},[...e[26]||(e[26]=[r("i",{class:"bi bi-chevron-double-right"},null,-1)])])],2)])])])):b("",!0)]))]))}},P=x(ee);P.use(L());P.mount("#admin-trace-app");
