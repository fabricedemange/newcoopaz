import{i as p,o as r,c as l,u as i,a as t,t as d,b as m,j as b,e as c,v as u,F as y,l as v,d as g,n as O,h as w}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as _,c as z}from"./chunks/pinia-gLxYYWQL.js";import{_ as C}from"./chunks/BackButton-DzFd1NqY.js";import{Y as k,Z as E,_ as D,$ as x,a0 as M}from"./chunks/index-fBysSQKd.js";const S=_("adminOrganizations",{state:()=>({organizations:[],loading:!0,error:null,editingOrg:null,isCreating:!1,searchQuery:"",formData:{name:"",email:""},formErrors:{},statsCache:{},showOrgModal:!1}),getters:{filteredOrganizations(a){if(!a.searchQuery)return a.organizations;const s=a.searchQuery.toLowerCase();return a.organizations.filter(o=>o.name&&o.name.toLowerCase().includes(s)||o.email&&o.email.toLowerCase().includes(s))},modalTitle(a){return a.isCreating?"Nouvelle organisation":"Modifier l'organisation"}},actions:{getStats(a){return this.statsCache[a]||{users:0,catalogues:0,commandes:0}},canDelete(a){const s=this.getStats(a);return s.users===0&&s.catalogues===0},async loadOrganizations(){this.loading=!0,this.error=null;try{const a=await M();if(a.success)this.organizations=a.organizations||[],await this.loadAllStats();else throw new Error(a.error)}catch(a){this.error=a.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},async loadAllStats(){const a=this.organizations.map(s=>this.loadStats(s.id));await Promise.all(a)},async loadStats(a){try{const s=await x(a);s.success&&(this.statsCache[a]=s.stats)}catch{this.statsCache[a]={users:0,catalogues:0,commandes:0}}},openCreateModal(){this.showOrgModal=!0,this.isCreating=!0,this.editingOrg=null,this.formData={name:"",email:""},this.formErrors={}},openEditModal(a){this.showOrgModal=!0,this.isCreating=!1,this.editingOrg=a,this.formData={name:a.name||"",email:a.email||""},this.formErrors={}},closeModal(){this.showOrgModal=!1,this.editingOrg=null,this.formErrors={}},async saveOrganization(){var a;if(this.formErrors={},!this.formData.name||this.formData.name.trim().length<2){this.formErrors.name="Le nom doit contenir au moins 2 caractères";return}try{const s={name:this.formData.name.trim(),email:((a=this.formData.email)==null?void 0:a.trim())||null};if(this.isCreating){const o=await E(s);o.success?(this.closeModal(),await this.loadOrganizations(),alert(o.message||"Organisation enregistrée avec succès")):this.formErrors.general=o.error}else{const o=await D(this.editingOrg.id,s);o.success?(this.closeModal(),await this.loadOrganizations(),alert(o.message||"Organisation modifiée avec succès")):this.formErrors.general=o.error}}catch(s){this.formErrors.general=s.message||"Erreur de connexion au serveur"}},async deleteOrganization(a){const s=this.getStats(a.id);if(s.users>0||s.catalogues>0){alert(`Impossible de supprimer : ${s.users} utilisateur(s) et ${s.catalogues} catalogue(s) associés`);return}if(confirm(`Supprimer définitivement l'organisation "${a.name}" ?`))try{const o=await k(a.id);o.success?(await this.loadOrganizations(),alert(o.message||"Organisation supprimée avec succès")):alert(o.error||"Erreur lors de la suppression")}catch(o){alert(o.message||"Erreur de connexion au serveur")}},formatDate(a){if(!a)return"—";const s=new Date(a);if(isNaN(s.getTime()))return a;const o=String(s.getDate()).padStart(2,"0"),e=String(s.getMonth()+1).padStart(2,"0"),n=s.getFullYear();return`${o}/${e}/${n}`}}}),$={class:"container-fluid mt-4"},A={key:0,class:"text-center py-5"},N={key:1,class:"alert alert-danger"},V={key:2},L={class:"d-flex justify-content-between align-items-center mb-4"},Q={class:"d-flex gap-2"},T={class:"mb-4"},U={key:0,class:"alert alert-info"},B={key:1,class:"card"},F={class:"table-responsive"},P={class:"table table-hover mb-0"},j={key:0,class:"text-muted"},Y={key:1,class:"text-muted"},q={class:"badge bg-primary"},I={class:"badge bg-info"},R={class:"badge bg-success"},Z={class:"d-flex gap-1"},G=["onClick"],H=["onClick","disabled","title"],J={class:"mt-3 text-muted"},K={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},W={class:"modal-dialog"},X={class:"modal-content"},tt={class:"modal-header"},st={class:"modal-title"},et={class:"modal-body"},at={key:0,class:"alert alert-danger"},it={class:"mb-3"},nt={key:0,class:"invalid-feedback"},ot={class:"mb-3"},rt={class:"modal-footer"},lt={__name:"AdminOrganizationsPage",setup(a){const s=S();return p(()=>{s.loadOrganizations()}),(o,e)=>(r(),l("div",$,[i(s).loading?(r(),l("div",A,[...e[8]||(e[8]=[t("div",{class:"spinner-border text-primary",role:"status"},null,-1),t("p",{class:"mt-3 text-muted"},"Chargement des organisations...",-1)])])):i(s).error?(r(),l("div",N,d(i(s).error),1)):(r(),l("div",V,[t("div",L,[e[11]||(e[11]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-building me-2"}),m("Organisations")],-1)),t("div",Q,[b(C),t("button",{onClick:e[0]||(e[0]=n=>i(s).loadOrganizations()),class:"btn btn-outline-primary"},[...e[9]||(e[9]=[t("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),m("Actualiser ",-1)])]),t("button",{onClick:e[1]||(e[1]=n=>i(s).openCreateModal()),class:"btn btn-primary"},[...e[10]||(e[10]=[t("i",{class:"bi bi-plus-circle me-2"},null,-1),m("Nouvelle organisation ",-1)])])])]),t("div",T,[c(t("input",{"onUpdate:modelValue":e[2]||(e[2]=n=>i(s).searchQuery=n),type:"text",class:"form-control",placeholder:"Rechercher par nom ou email..."},null,512),[[u,i(s).searchQuery]])]),i(s).filteredOrganizations.length===0?(r(),l("div",U,"Aucune organisation trouvée")):(r(),l("div",B,[t("div",F,[t("table",P,[e[15]||(e[15]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"5%"}},"ID"),t("th",{style:{width:"25%"}},"Nom"),t("th",{style:{width:"20%"}},"Email"),t("th",{style:{width:"10%"}},"Utilisateurs"),t("th",{style:{width:"10%"}},"Catalogues"),t("th",{style:{width:"10%"}},"Commandes"),t("th",{style:{width:"10%"}},"Créée le"),t("th",{style:{width:"10%"}},"Actions")])],-1)),t("tbody",null,[(r(!0),l(y,null,v(i(s).filteredOrganizations,n=>(r(),l("tr",{key:n.id},[t("td",null,d(n.id),1),t("td",null,[t("strong",null,d(n.name),1)]),t("td",null,[n.email?(r(),l("span",j,[e[12]||(e[12]=t("i",{class:"bi bi-envelope me-1"},null,-1)),m(d(n.email),1)])):(r(),l("span",Y,"—"))]),t("td",null,[t("span",q,d(i(s).getStats(n.id).users),1)]),t("td",null,[t("span",I,d(i(s).getStats(n.id).catalogues),1)]),t("td",null,[t("span",R,d(i(s).getStats(n.id).commandes),1)]),t("td",null,d(i(s).formatDate(n.created_at)),1),t("td",null,[t("div",Z,[t("button",{onClick:f=>i(s).openEditModal(n),class:"btn btn-sm btn-outline-primary",title:"Modifier"},[...e[13]||(e[13]=[t("i",{class:"bi bi-pencil"},null,-1)])],8,G),t("button",{onClick:f=>i(s).deleteOrganization(n),class:"btn btn-sm btn-outline-danger",disabled:!i(s).canDelete(n.id),title:i(s).canDelete(n.id)?"Supprimer":"Impossible de supprimer (données associées)"},[...e[14]||(e[14]=[t("i",{class:"bi bi-trash"},null,-1)])],8,H)])])]))),128))])])])])),t("div",J,[e[16]||(e[16]=t("i",{class:"bi bi-info-circle me-1"},null,-1)),m(d(i(s).filteredOrganizations.length)+" organisation(s) affichée(s) ",1)])])),i(s).showOrgModal?(r(),l("div",K,[t("div",W,[t("div",X,[t("div",tt,[t("h5",st,d(i(s).modalTitle),1),t("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=n=>i(s).closeModal())})]),t("div",et,[i(s).formErrors.general?(r(),l("div",at,d(i(s).formErrors.general),1)):g("",!0),t("div",it,[e[17]||(e[17]=t("label",{class:"form-label"},"Nom de l'organisation *",-1)),c(t("input",{"onUpdate:modelValue":e[4]||(e[4]=n=>i(s).formData.name=n),type:"text",class:O(["form-control",{"is-invalid":i(s).formErrors.name}]),placeholder:"Nom de l'organisation..."},null,2),[[u,i(s).formData.name]]),i(s).formErrors.name?(r(),l("div",nt,d(i(s).formErrors.name),1)):g("",!0)]),t("div",ot,[e[18]||(e[18]=t("label",{class:"form-label"},"Email de contact (optionnel)",-1)),c(t("input",{"onUpdate:modelValue":e[5]||(e[5]=n=>i(s).formData.email=n),type:"email",class:"form-control",placeholder:"contact@organization.com"},null,512),[[u,i(s).formData.email]]),e[19]||(e[19]=t("small",{class:"text-muted"},"Email principal de l'organisation (optionnel)",-1))])]),t("div",rt,[t("button",{type:"button",class:"btn btn-secondary",onClick:e[6]||(e[6]=n=>i(s).closeModal())},"Annuler"),t("button",{type:"button",onClick:e[7]||(e[7]=n=>i(s).saveOrganization()),class:"btn btn-primary"},[...e[20]||(e[20]=[t("i",{class:"bi bi-check-lg me-2"},null,-1),m("Enregistrer ",-1)])])])])])])):g("",!0)]))}},h=w(lt);h.use(z());h.mount("#admin-organizations-app");
