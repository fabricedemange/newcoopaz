import{i as D,o as n,c as d,a as t,f as V,u as i,t as a,d as r,b as c,e as _,v as f,F as m,k as h,n as u,h as w}from"./chunks/runtime-dom.esm-bundler-CYnru-If.js";import{d as F,c as C}from"./chunks/pinia-B_riBLOF.js";import{b as P,y as S,z as T}from"./chunks/index-BOkuCSO3.js";const M=F("caisseHistorique",{state:()=>({ventes:[],stats:null,loading:!1,selectedVente:null,showDetailModal:!1,dateDebut:"",dateFin:"",numeroTicket:"",caissier_id:null,total:0,limit:50,offset:0,error:null}),getters:{nbPages(o){return Math.ceil(o.total/o.limit)||1},currentPage(o){return Math.floor(o.offset/o.limit)+1}},actions:{async chargerVentes(){this.loading=!0,this.error=null;try{const o={limit:this.limit,offset:this.offset};this.dateDebut&&(o.date_debut=this.dateDebut),this.dateFin&&(o.date_fin=this.dateFin),this.numeroTicket&&(o.numero_ticket=this.numeroTicket),this.caissier_id!=null&&(o.caissier_id=this.caissier_id);const e=await T(o);if(e.success)this.ventes=e.ventes,this.total=e.total;else throw new Error(e.error)}catch(o){throw this.error=o.message,o}finally{this.loading=!1}},async chargerStats(){try{const o={};this.dateDebut&&(o.date_debut=this.dateDebut),this.dateFin&&(o.date_fin=this.dateFin);const e=await S(o);e.success&&(this.stats=e.stats)}catch(o){console.error("Erreur chargement stats:",o)}},async ouvrirDetail(o){try{const e=await P(o);if(e.success)this.selectedVente=e,this.showDetailModal=!0;else throw new Error(e.error)}catch(e){this.error=e.message}},fermerDetail(){this.showDetailModal=!1,this.selectedVente=null},rechercher(){return this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},resetFiltres(){return this.dateDebut="",this.dateFin="",this.numeroTicket="",this.caissier_id=null,this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},pageSuivante(){if(this.offset+this.limit<this.total)return this.offset+=this.limit,this.chargerVentes()},pagePrecedente(){if(this.offset>0)return this.offset=Math.max(0,this.offset-this.limit),this.chargerVentes()},allerPage(o){return this.offset=(o-1)*this.limit,this.chargerVentes()},formatDate(o){return o?new Date(o).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"}}}),$={class:"container-fluid mt-4"},q={class:"row mb-4"},H={class:"col-12"},A={key:0,class:"row g-3"},N={class:"col-md-3"},E={class:"card card-caisse"},R={class:"card-body"},I={class:"mb-0"},z={class:"col-md-3"},B={class:"card card-caisse"},O={class:"card-body"},U={class:"mb-0"},j={class:"col-md-3"},L={class:"card bg-info text-white"},Q={class:"card-body"},G={class:"mb-0"},J={class:"col-md-3"},K={class:"card bg-warning text-dark"},W={class:"card-body"},X={class:"mb-0"},Y={class:"card mb-4"},Z={class:"card-body"},tt={class:"row g-3"},st={class:"col-md-3"},et={class:"col-md-3"},it={class:"col-md-4"},lt={class:"col-md-2 d-flex align-items-end gap-2"},ot={key:0,class:"alert alert-danger alert-dismissible fade show"},at={key:1,class:"text-center py-5"},nt={key:2,class:"card"},dt={class:"card-header card-header-caisse"},rt={class:"mb-0"},ct={class:"card-body p-0"},ut={key:0,class:"text-center py-5 text-muted"},mt={key:1,class:"table-responsive"},ht={class:"table table-hover mb-0"},bt={class:"text-primary"},_t={key:0,class:"badge bg-secondary"},ft={key:1,class:"text-muted"},vt=["onClick"],gt={key:0,class:"card-footer"},pt={class:"pagination mb-0 justify-content-center"},yt=["onClick"],kt={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},xt={class:"modal-dialog modal-xl"},Dt={class:"modal-content"},Vt={class:"modal-header card-header-caisse"},wt={class:"modal-title"},Ft={class:"modal-body"},Ct={class:"row mb-4"},Pt={class:"col-md-6"},St={class:"row"},Tt={class:"col-sm-8"},Mt={class:"col-sm-8"},$t={class:"col-sm-8"},qt={class:"col-sm-8"},Ht={class:"text-primary"},At={class:"table-responsive mb-4"},Nt={class:"table table-sm table-bordered"},Et={key:0,class:"badge bg-info ms-2"},Rt={key:1,class:"badge bg-warning text-dark ms-2"},It={class:"text-end"},zt={class:"text-end"},Bt={class:"text-end"},Ot={class:"table-light"},Ut={class:"text-end"},jt={class:"text-primary"},Lt={key:0},Qt={key:1,class:"table-responsive"},Gt={class:"table table-sm"},Jt={class:"text-end"},Kt={class:"modal-footer"},Wt=["href"],Xt={__name:"CaisseHistoriquePage",setup(o){const e=M();return D(async()=>{const b=new Date().toISOString().split("T")[0];e.dateDebut=b,e.dateFin=b,await e.chargerVentes(),await e.chargerStats()}),(b,s)=>{var v,g,p,y;return n(),d("div",$,[t("div",q,[t("div",H,[s[14]||(s[14]=V('<div class="d-flex justify-content-between align-items-center mb-3"><h2 class="text-caisse"><i class="bi bi-clock-history me-2"></i>Historique des ventes</h2><a href="/caisse" class="btn btn-outline-caisse"><i class="bi bi-arrow-left me-2"></i>Retour à la caisse </a></div>',1)),i(e).stats?(n(),d("div",A,[t("div",N,[t("div",E,[t("div",R,[s[10]||(s[10]=t("h6",{class:"card-title"},"Nombre de ventes",-1)),t("h3",I,a(i(e).stats.nb_ventes),1)])])]),t("div",z,[t("div",B,[t("div",O,[s[11]||(s[11]=t("h6",{class:"card-title"},"CA Total",-1)),t("h3",U,a(i(e).stats.ca_total.toFixed(2))+" €",1)])])]),t("div",j,[t("div",L,[t("div",Q,[s[12]||(s[12]=t("h6",{class:"card-title"},"Ticket moyen",-1)),t("h3",G,a(i(e).stats.ticket_moyen.toFixed(2))+" €",1)])])]),t("div",J,[t("div",K,[t("div",W,[s[13]||(s[13]=t("h6",{class:"card-title"},"Ticket max",-1)),t("h3",X,a(i(e).stats.ticket_max.toFixed(2))+" €",1)])])])])):r("",!0)])]),t("div",Y,[s[20]||(s[20]=t("div",{class:"card-header card-header-caisse"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-funnel me-2"}),c("Filtres de recherche")])],-1)),t("div",Z,[t("div",tt,[t("div",st,[s[15]||(s[15]=t("label",{class:"form-label"},"Date début",-1)),_(t("input",{type:"date",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=l=>i(e).dateDebut=l)},null,512),[[f,i(e).dateDebut]])]),t("div",et,[s[16]||(s[16]=t("label",{class:"form-label"},"Date fin",-1)),_(t("input",{type:"date",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=l=>i(e).dateFin=l)},null,512),[[f,i(e).dateFin]])]),t("div",it,[s[17]||(s[17]=t("label",{class:"form-label"},"Numéro ticket",-1)),_(t("input",{type:"text",class:"form-control","onUpdate:modelValue":s[2]||(s[2]=l=>i(e).numeroTicket=l),placeholder:"Ex: CAISSE-1738272840"},null,512),[[f,i(e).numeroTicket]])]),t("div",lt,[t("button",{class:"btn btn-caisse",onClick:s[3]||(s[3]=l=>i(e).rechercher())},[...s[18]||(s[18]=[t("i",{class:"bi bi-search me-1"},null,-1),c("Rechercher ",-1)])]),t("button",{class:"btn btn-outline-secondary",onClick:s[4]||(s[4]=l=>i(e).resetFiltres())},[...s[19]||(s[19]=[t("i",{class:"bi bi-x-circle me-1"},null,-1),c("Réinitialiser ",-1)])])])])])]),i(e).error?(n(),d("div",ot,[s[21]||(s[21]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),c(a(i(e).error)+" ",1),t("button",{type:"button",class:"btn-close",onClick:s[5]||(s[5]=l=>i(e).error=null)})])):r("",!0),i(e).loading?(n(),d("div",at,[...s[22]||(s[22]=[t("div",{class:"spinner-border text-caisse"},null,-1)])])):(n(),d("div",nt,[t("div",dt,[t("h5",rt," Résultats ("+a(i(e).total)+" vente"+a(i(e).total>1?"s":"")+") ",1)]),t("div",ct,[i(e).ventes.length===0?(n(),d("div",ut,[...s[23]||(s[23]=[t("i",{class:"bi bi-inbox",style:{"font-size":"3rem"}},null,-1),t("p",{class:"mt-2"},"Aucune vente trouvée",-1)])])):(n(),d("div",mt,[t("table",ht,[s[25]||(s[25]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Ticket"),t("th",null,"Date/Heure"),t("th",null,"Caissier"),t("th",null,"Client"),t("th",null,"Nb articles"),t("th",null,"Montant"),t("th",null,"PréCde"),t("th",null,"Statut"),t("th",null,"Actions")])],-1)),t("tbody",null,[(n(!0),d(m,null,h(i(e).ventes,l=>(n(),d("tr",{key:l.id},[t("td",null,[t("code",null,a(l.numero_ticket),1)]),t("td",null,a(i(e).formatDate(l.created_at)),1),t("td",null,a(l.caissier_nom||"-"),1),t("td",null,a(l.client_nom||l.nom_client||"Anonyme"),1),t("td",null,a(l.nb_lignes),1),t("td",null,[t("strong",bt,a(l.montant_ttc.toFixed(2))+" €",1)]),t("td",null,[l.catalogues_oui?(n(),d("span",_t,"Oui")):(n(),d("span",ft,"—"))]),t("td",null,[t("span",{class:u(["badge",l.statut==="complete"?"bg-success":"bg-warning"])},a(l.statut),3)]),t("td",null,[t("button",{class:"btn btn-sm btn-outline-caisse",onClick:x=>i(e).ouvrirDetail(l.id)},[...s[24]||(s[24]=[t("i",{class:"bi bi-eye me-1"},null,-1),c("Détails ",-1)])],8,vt)])]))),128))])])]))]),i(e).nbPages>1?(n(),d("div",gt,[t("nav",null,[t("ul",pt,[t("li",{class:u(["page-item",{disabled:i(e).currentPage===1}])},[t("button",{class:"page-link",onClick:s[6]||(s[6]=l=>i(e).pagePrecedente())},"Précédent")],2),(n(!0),d(m,null,h(i(e).nbPages,l=>(n(),d("li",{key:l,class:u(["page-item",{active:l===i(e).currentPage}])},[t("button",{class:"page-link",onClick:x=>i(e).allerPage(l)},a(l),9,yt)],2))),128)),t("li",{class:u(["page-item",{disabled:i(e).currentPage===i(e).nbPages}])},[t("button",{class:"page-link",onClick:s[7]||(s[7]=l=>i(e).pageSuivante())},"Suivant")],2)])])])):r("",!0)])),i(e).showDetailModal&&i(e).selectedVente?(n(),d("div",kt,[t("div",xt,[t("div",Dt,[t("div",Vt,[t("h5",wt,[s[26]||(s[26]=t("i",{class:"bi bi-receipt me-2"},null,-1)),c(" Détail vente "+a(i(e).selectedVente.vente.numero_ticket),1)]),t("button",{type:"button",class:"btn-close",onClick:s[8]||(s[8]=l=>i(e).fermerDetail())})]),t("div",Ft,[t("div",Ct,[t("div",Pt,[s[31]||(s[31]=t("h6",null,"Informations générales",-1)),t("dl",St,[s[27]||(s[27]=t("dt",{class:"col-sm-4"},"Date/Heure",-1)),t("dd",Tt,a(i(e).formatDate(i(e).selectedVente.vente.created_at)),1),s[28]||(s[28]=t("dt",{class:"col-sm-4"},"Caissier",-1)),t("dd",Mt,a(i(e).selectedVente.vente.caissier_nom),1),s[29]||(s[29]=t("dt",{class:"col-sm-4"},"Client",-1)),t("dd",$t,a(i(e).selectedVente.vente.client_nom||i(e).selectedVente.vente.nom_client),1),s[30]||(s[30]=t("dt",{class:"col-sm-4"},"Montant total",-1)),t("dd",qt,[t("strong",Ht,a(i(e).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])])]),s[35]||(s[35]=t("h6",null,"Produits vendus",-1)),t("div",At,[t("table",Nt,[s[33]||(s[33]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Quantité"),t("th",{class:"text-end"},"Prix unitaire"),t("th",{class:"text-end"},"Total")])],-1)),t("tbody",null,[(n(!0),d(m,null,h(i(e).selectedVente.lignes,l=>(n(),d("tr",{key:l.id,class:u({"table-warning":l.is_avoir,"table-info":l.is_cotisation})},[t("td",null,[c(a(l.nom_produit||l.product_nom_actuel)+" ",1),l.is_cotisation?(n(),d("span",Et,"Cotisation")):r("",!0),l.is_avoir?(n(),d("span",Rt,"AVOIR")):r("",!0)]),t("td",It,a(l.quantite.toFixed(3)),1),t("td",zt,a(l.prix_unitaire.toFixed(2))+" €",1),t("td",Bt,[t("strong",{class:u(l.is_cotisation?"text-info":l.is_avoir?"text-warning":"text-primary")},a(l.montant_ttc.toFixed(2))+" € ",3)])],2))),128))]),t("tfoot",Ot,[t("tr",null,[s[32]||(s[32]=t("td",{colspan:"3",class:"text-end"},[t("strong",null,"Total")],-1)),t("td",Ut,[t("strong",jt,a(i(e).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])])])]),((v=i(e).selectedVente.paiements)==null?void 0:v.length)>0?(n(),d("h6",Lt,"Paiements")):r("",!0),((g=i(e).selectedVente.paiements)==null?void 0:g.length)>0?(n(),d("div",Qt,[t("table",Gt,[s[34]||(s[34]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Mode de paiement"),t("th",{class:"text-end"},"Montant"),t("th",null,"Date")])],-1)),t("tbody",null,[(n(!0),d(m,null,h(i(e).selectedVente.paiements,l=>(n(),d("tr",{key:l.id},[t("td",null,a(l.mode_paiement_nom),1),t("td",Jt,[t("strong",null,a(l.montant.toFixed(2))+" €",1)]),t("td",null,a(i(e).formatDate(l.date_paiement)),1)]))),128))])])])):r("",!0)]),t("div",Kt,[t("a",{href:`/api/caisse/ventes-historique/${(y=(p=i(e).selectedVente)==null?void 0:p.vente)==null?void 0:y.id}/pdf`,class:"btn btn-outline-caisse",download:"",target:"_blank",rel:"noopener noreferrer"},[...s[36]||(s[36]=[t("i",{class:"bi bi-file-earmark-pdf me-1"},null,-1),c("Télécharger PDF ",-1)])],8,Wt),t("button",{type:"button",class:"btn btn-secondary",onClick:s[9]||(s[9]=l=>i(e).fermerDetail())},"Fermer")])])])])):r("",!0)])}}},k=w(Xt);k.use(C());k.mount("#historique-ventes-app");
