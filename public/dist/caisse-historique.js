import{i as F,o as a,c as r,a as t,b as d,j as P,u as n,t as o,d as c,e as v,v as p,F as f,l as g,n as m,h as A}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as S,c as $}from"./chunks/pinia-gLxYYWQL.js";import{_ as M}from"./chunks/BackButton-DzFd1NqY.js";import{z as q,b as T,B as H,C as R}from"./chunks/index-CQL6Akic.js";const E=S("caisseHistorique",{state:()=>({ventes:[],stats:null,loading:!1,selectedVente:null,showDetailModal:!1,dateDebut:"",dateFin:"",recherche:"",caissier_id:null,total:0,limit:50,offset:0,error:null}),getters:{nbPages(l){return Math.ceil(l.total/l.limit)||1},currentPage(l){return Math.floor(l.offset/l.limit)+1}},actions:{async chargerVentes(){this.loading=!0,this.error=null;try{const l={limit:this.limit,offset:this.offset};this.dateDebut&&(l.date_debut=this.dateDebut),this.dateFin&&(l.date_fin=this.dateFin),this.recherche&&(l.recherche=this.recherche),this.caissier_id!=null&&(l.caissier_id=this.caissier_id);const s=await R(l);if(s.success)this.ventes=s.ventes,this.total=s.total;else throw new Error(s.error)}catch(l){throw this.error=l.message,l}finally{this.loading=!1}},async chargerStats(){try{const l={};this.dateDebut&&(l.date_debut=this.dateDebut),this.dateFin&&(l.date_fin=this.dateFin);const s=await H(l);s.success&&(this.stats=s.stats)}catch(l){console.error("Erreur chargement stats:",l)}},async ouvrirDetail(l){try{const s=await T(l);if(s.success)this.selectedVente=s,this.showDetailModal=!0;else throw new Error(s.error)}catch(s){this.error=s.message}},fermerDetail(){this.showDetailModal=!1,this.selectedVente=null},async annulerVente(l){this.error=null;try{const s=await q(l);if(s.success)return this.fermerDetail(),await Promise.all([this.chargerVentes(),this.chargerStats()]),!0;throw new Error(s.error)}catch(s){throw this.error=s.message,s}},rechercher(){return this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},resetFiltres(){return this.dateDebut="",this.dateFin="",this.recherche="",this.caissier_id=null,this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},pageSuivante(){if(this.offset+this.limit<this.total)return this.offset+=this.limit,this.chargerVentes()},pagePrecedente(){if(this.offset>0)return this.offset=Math.max(0,this.offset-this.limit),this.chargerVentes()},allerPage(l){return this.offset=(l-1)*this.limit,this.chargerVentes()},formatDate(l){return l?new Date(l).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"}}}),N={class:"container-fluid mt-4"},L={class:"row mb-4"},B={class:"col-12"},j={class:"d-flex justify-content-between align-items-center mb-3"},z={class:"d-flex gap-2 flex-wrap"},I={key:0,class:"row g-3"},U={class:"col-md-3"},O={class:"card card-caisse"},Q={class:"card-body"},G={class:"mb-0"},J={class:"col-md-3"},K={class:"card card-caisse"},W={class:"card-body"},X={class:"mb-0"},Y={class:"col-md-3"},Z={class:"card bg-info text-white"},tt={class:"card-body"},et={class:"mb-0"},st={class:"col-md-3"},it={class:"card bg-warning text-dark"},nt={class:"card-body"},lt={class:"mb-0"},ot={class:"card mb-4"},at={class:"card-body"},rt={class:"row g-3"},dt={class:"col-md-3"},ct={class:"col-md-3"},ut={class:"col-md-4"},mt={class:"col-12 col-md-2 d-flex align-items-end gap-2 flex-wrap"},ht={key:0,class:"alert alert-danger alert-dismissible fade show"},bt={key:1,class:"text-center py-5"},_t={key:2,class:"card"},ft={class:"card-header card-header-caisse"},gt={class:"mb-0"},vt={class:"card-body p-0"},pt={key:0,class:"text-center py-5 text-muted"},yt={key:1,class:"table-responsive"},kt={class:"table table-hover mb-0"},xt={class:"text-primary"},wt={key:0,class:"badge bg-secondary me-1",title:"Précommande"},Vt={key:1,class:"badge bg-info me-1",title:"Cotisation"},Dt={key:2,class:"badge bg-warning text-dark me-1",title:"Avoir"},Ct={key:3,class:"text-muted"},Ft={class:"d-flex gap-1 flex-wrap"},Pt=["onClick"],At=["onClick"],St={key:0,class:"card-footer"},$t={class:"pagination mb-0 justify-content-center"},Mt=["onClick"],qt={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},Tt={class:"modal-dialog modal-xl"},Ht={class:"modal-content"},Rt={class:"modal-header card-header-caisse"},Et={class:"modal-title"},Nt={class:"modal-body"},Lt={class:"row mb-4"},Bt={class:"col-md-6"},jt={class:"row"},zt={class:"col-sm-8"},It={class:"col-sm-8"},Ut={class:"col-sm-8"},Ot={class:"col-sm-8"},Qt={class:"text-primary"},Gt={class:"table-responsive mb-4"},Jt={class:"table table-sm table-bordered"},Kt={key:0,class:"badge bg-info ms-2"},Wt={key:1,class:"badge bg-warning text-dark ms-2"},Xt={class:"text-end"},Yt={class:"text-end"},Zt={class:"text-end"},te={class:"table-light"},ee={class:"text-end"},se={class:"text-primary"},ie={key:0},ne={key:1,class:"table-responsive"},le={class:"table table-sm"},oe={class:"text-end"},ae={class:"modal-footer"},re=["href"],de={__name:"CaisseHistoriquePage",setup(l){const s=E();async function y(u,e){if(!u)return;const b=e?`Annuler la vente ${e} ? Les quantités seront remises en stock. Cette action est irréversible.`:"Annuler cette vente ? Les quantités seront remises en stock. Cette action est irréversible.";if(confirm(b))try{await s.annulerVente(u),alert("Vente annulée. Les quantités ont été remises en stock.")}catch(_){alert("Erreur : "+(_.message||"Impossible d'annuler la vente."))}}return F(async()=>{const u=new Date().toISOString().split("T")[0];s.dateDebut=u,s.dateFin=u,await s.chargerVentes(),await s.chargerStats()}),(u,e)=>{var b,_,k,x;return a(),r("div",N,[t("div",L,[t("div",B,[t("div",j,[e[12]||(e[12]=t("h2",{class:"text-caisse mb-0"},[t("i",{class:"bi bi-clock-history me-2"}),d("Historique des ventes")],-1)),t("div",z,[P(M),e[11]||(e[11]=t("a",{href:"/caisse",class:"btn btn-outline-caisse"},[t("i",{class:"bi bi-arrow-left me-2"}),d("Retour à la caisse ")],-1))])]),n(s).stats?(a(),r("div",I,[t("div",U,[t("div",O,[t("div",Q,[e[13]||(e[13]=t("h6",{class:"card-title"},"Nombre de ventes",-1)),t("h3",G,o(n(s).stats.nb_ventes),1)])])]),t("div",J,[t("div",K,[t("div",W,[e[14]||(e[14]=t("h6",{class:"card-title"},"CA Total",-1)),t("h3",X,o(n(s).stats.ca_total.toFixed(2))+" €",1)])])]),t("div",Y,[t("div",Z,[t("div",tt,[e[15]||(e[15]=t("h6",{class:"card-title"},"Ticket moyen",-1)),t("h3",et,o(n(s).stats.ticket_moyen.toFixed(2))+" €",1)])])]),t("div",st,[t("div",it,[t("div",nt,[e[16]||(e[16]=t("h6",{class:"card-title"},"Ticket max",-1)),t("h3",lt,o(n(s).stats.ticket_max.toFixed(2))+" €",1)])])])])):c("",!0)])]),t("div",ot,[e[22]||(e[22]=t("div",{class:"card-header card-header-caisse"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-funnel me-2"}),d("Filtres de recherche")])],-1)),t("div",at,[t("div",rt,[t("div",dt,[e[17]||(e[17]=t("label",{class:"form-label"},"Date début",-1)),v(t("input",{type:"date",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=i=>n(s).dateDebut=i)},null,512),[[p,n(s).dateDebut]])]),t("div",ct,[e[18]||(e[18]=t("label",{class:"form-label"},"Date fin",-1)),v(t("input",{type:"date",class:"form-control","onUpdate:modelValue":e[1]||(e[1]=i=>n(s).dateFin=i)},null,512),[[p,n(s).dateFin]])]),t("div",ut,[e[19]||(e[19]=t("label",{class:"form-label"},"Recherche",-1)),v(t("input",{type:"text",class:"form-control","onUpdate:modelValue":e[2]||(e[2]=i=>n(s).recherche=i),placeholder:"Ticket, date, caissier, client, montant..."},null,512),[[p,n(s).recherche]])]),t("div",mt,[t("button",{type:"button",class:"btn btn-sm btn-caisse",onClick:e[3]||(e[3]=i=>n(s).rechercher())},[...e[20]||(e[20]=[t("i",{class:"bi bi-search me-1"},null,-1),d("Rechercher ",-1)])]),t("button",{type:"button",class:"btn btn-sm btn-outline-secondary",onClick:e[4]||(e[4]=i=>n(s).resetFiltres())},[...e[21]||(e[21]=[t("i",{class:"bi bi-x-circle me-1"},null,-1),d("Réinitialiser ",-1)])])])])])]),n(s).error?(a(),r("div",ht,[e[23]||(e[23]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),d(o(n(s).error)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[5]||(e[5]=i=>n(s).error=null)})])):c("",!0),n(s).loading?(a(),r("div",bt,[...e[24]||(e[24]=[t("div",{class:"spinner-border text-caisse"},null,-1)])])):(a(),r("div",_t,[t("div",ft,[t("h5",gt," Résultats ("+o(n(s).total)+" vente"+o(n(s).total>1?"s":"")+") ",1)]),t("div",vt,[n(s).ventes.length===0?(a(),r("div",pt,[...e[25]||(e[25]=[t("i",{class:"bi bi-inbox",style:{"font-size":"3rem"}},null,-1),t("p",{class:"mt-2"},"Aucune vente trouvée",-1)])])):(a(),r("div",yt,[t("table",kt,[e[28]||(e[28]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Ticket"),t("th",null,"Date/Heure"),t("th",null,"Caissier"),t("th",null,"Client"),t("th",null,"Nb articles"),t("th",null,"Montant"),t("th",null,"Détails"),t("th",null,"Statut"),t("th",null,"Actions")])],-1)),t("tbody",null,[(a(!0),r(f,null,g(n(s).ventes,i=>(a(),r("tr",{key:i.id},[t("td",null,[t("code",null,o(i.numero_ticket),1)]),t("td",null,o(n(s).formatDate(i.created_at)),1),t("td",null,o(i.caissier_nom||"-"),1),t("td",null,o(i.client_nom||i.nom_client||"Anonyme"),1),t("td",null,o(i.nb_lignes),1),t("td",null,[t("strong",xt,o(i.montant_ttc.toFixed(2))+" €",1)]),t("td",null,[i.catalogues_oui?(a(),r("span",wt,"PC")):c("",!0),i.cotisation_oui?(a(),r("span",Vt,"CT")):c("",!0),i.avoir_oui?(a(),r("span",Dt,"AV")):c("",!0),!i.catalogues_oui&&!i.cotisation_oui&&!i.avoir_oui?(a(),r("span",Ct,"—")):c("",!0)]),t("td",null,[t("span",{class:m(["badge",i.statut==="complete"?"bg-success":"bg-warning"])},o(i.statut),3)]),t("td",null,[t("div",Ft,[t("button",{class:"btn btn-sm btn-outline-caisse",onClick:h=>n(s).ouvrirDetail(i.id)},[...e[26]||(e[26]=[t("i",{class:"bi bi-eye me-1"},null,-1),d("Détails ",-1)])],8,Pt),t("button",{class:"btn btn-sm btn-outline-danger",title:"Annuler la vente (remet le stock)",onClick:h=>y(i.id,i.numero_ticket)},[...e[27]||(e[27]=[t("i",{class:"bi bi-x-circle me-1"},null,-1),d("Annuler ",-1)])],8,At)])])]))),128))])])]))]),n(s).nbPages>1?(a(),r("div",St,[t("nav",null,[t("ul",$t,[t("li",{class:m(["page-item",{disabled:n(s).currentPage===1}])},[t("button",{class:"page-link",onClick:e[6]||(e[6]=i=>n(s).pagePrecedente())},"Précédent")],2),(a(!0),r(f,null,g(n(s).nbPages,i=>(a(),r("li",{key:i,class:m(["page-item",{active:i===n(s).currentPage}])},[t("button",{class:"page-link",onClick:h=>n(s).allerPage(i)},o(i),9,Mt)],2))),128)),t("li",{class:m(["page-item",{disabled:n(s).currentPage===n(s).nbPages}])},[t("button",{class:"page-link",onClick:e[7]||(e[7]=i=>n(s).pageSuivante())},"Suivant")],2)])])])):c("",!0)])),n(s).showDetailModal&&n(s).selectedVente?(a(),r("div",qt,[t("div",Tt,[t("div",Ht,[t("div",Rt,[t("h5",Et,[e[29]||(e[29]=t("i",{class:"bi bi-receipt me-2"},null,-1)),d(" Détail vente "+o(n(s).selectedVente.vente.numero_ticket),1)]),t("button",{type:"button",class:"btn-close",onClick:e[8]||(e[8]=i=>n(s).fermerDetail())})]),t("div",Nt,[t("div",Lt,[t("div",Bt,[e[34]||(e[34]=t("h6",null,"Informations générales",-1)),t("dl",jt,[e[30]||(e[30]=t("dt",{class:"col-sm-4"},"Date/Heure",-1)),t("dd",zt,o(n(s).formatDate(n(s).selectedVente.vente.created_at)),1),e[31]||(e[31]=t("dt",{class:"col-sm-4"},"Caissier",-1)),t("dd",It,o(n(s).selectedVente.vente.caissier_nom),1),e[32]||(e[32]=t("dt",{class:"col-sm-4"},"Client",-1)),t("dd",Ut,o(n(s).selectedVente.vente.client_nom||n(s).selectedVente.vente.nom_client),1),e[33]||(e[33]=t("dt",{class:"col-sm-4"},"Montant total",-1)),t("dd",Ot,[t("strong",Qt,o(n(s).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])])]),e[38]||(e[38]=t("h6",null,"Produits vendus",-1)),t("div",Gt,[t("table",Jt,[e[36]||(e[36]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Quantité"),t("th",{class:"text-end"},"Prix unitaire"),t("th",{class:"text-end"},"Total")])],-1)),t("tbody",null,[(a(!0),r(f,null,g(n(s).selectedVente.lignes,i=>(a(),r("tr",{key:i.id,class:m({"table-warning":i.is_avoir,"table-info":i.is_cotisation})},[t("td",null,[d(o(i.nom_produit||i.product_nom_actuel)+" ",1),i.is_cotisation?(a(),r("span",Kt,"Cotisation")):c("",!0),i.is_avoir?(a(),r("span",Wt,"AVOIR")):c("",!0)]),t("td",Xt,o(i.quantite.toFixed(3)),1),t("td",Yt,o(i.prix_unitaire.toFixed(2))+" €",1),t("td",Zt,[t("strong",{class:m(i.is_cotisation?"text-info":i.is_avoir?"text-warning":"text-primary")},o(i.montant_ttc.toFixed(2))+" € ",3)])],2))),128))]),t("tfoot",te,[t("tr",null,[e[35]||(e[35]=t("td",{colspan:"3",class:"text-end"},[t("strong",null,"Total")],-1)),t("td",ee,[t("strong",se,o(n(s).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])])])]),((b=n(s).selectedVente.paiements)==null?void 0:b.length)>0?(a(),r("h6",ie,"Paiements")):c("",!0),((_=n(s).selectedVente.paiements)==null?void 0:_.length)>0?(a(),r("div",ne,[t("table",le,[e[37]||(e[37]=t("thead",{class:"thead-caisse"},[t("tr",null,[t("th",null,"Mode de paiement"),t("th",{class:"text-end"},"Montant")])],-1)),t("tbody",null,[(a(!0),r(f,null,g(n(s).selectedVente.paiements,i=>(a(),r("tr",{key:i.id},[t("td",null,o(i.mode_paiement_nom),1),t("td",oe,[t("strong",null,o(i.montant.toFixed(2))+" €",1)])]))),128))])])])):c("",!0)]),t("div",ae,[t("a",{href:`/api/caisse/ventes-historique/${(x=(k=n(s).selectedVente)==null?void 0:k.vente)==null?void 0:x.id}/pdf`,class:"btn btn-outline-caisse",download:"",target:"_blank",rel:"noopener noreferrer"},[...e[39]||(e[39]=[t("i",{class:"bi bi-file-earmark-pdf me-1"},null,-1),d("Télécharger PDF ",-1)])],8,re),t("button",{type:"button",class:"btn btn-outline-danger",title:"Annuler la vente (remet le stock)",onClick:e[9]||(e[9]=i=>{var h,w,V,D;return y((w=(h=n(s).selectedVente)==null?void 0:h.vente)==null?void 0:w.id,(D=(V=n(s).selectedVente)==null?void 0:V.vente)==null?void 0:D.numero_ticket)})},[...e[40]||(e[40]=[t("i",{class:"bi bi-x-circle me-1"},null,-1),d("Annuler la vente ",-1)])]),t("button",{type:"button",class:"btn btn-secondary",onClick:e[10]||(e[10]=i=>n(s).fermerDetail())},"Fermer")])])])])):c("",!0)])}}},C=A(de);C.use($());C.mount("#historique-ventes-app");
