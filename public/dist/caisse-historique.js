import{i as k,o as a,c as d,a as t,b as r,u as i,t as n,d as c,e as _,v as g,F as m,k as b,n as u,h as x}from"./chunks/runtime-dom.esm-bundler-BlMAuMpH.js";import{d as D,c as w}from"./chunks/pinia-BNknc8Vm.js";import{b as V,w as F,x as C}from"./chunks/index-BkeVkIvb.js";const P=D("caisseHistorique",{state:()=>({ventes:[],stats:null,loading:!1,selectedVente:null,showDetailModal:!1,dateDebut:"",dateFin:"",numeroTicket:"",caissier_id:null,total:0,limit:50,offset:0,error:null}),getters:{nbPages(o){return Math.ceil(o.total/o.limit)||1},currentPage(o){return Math.floor(o.offset/o.limit)+1}},actions:{async chargerVentes(){this.loading=!0,this.error=null;try{const o={limit:this.limit,offset:this.offset};this.dateDebut&&(o.date_debut=this.dateDebut),this.dateFin&&(o.date_fin=this.dateFin),this.numeroTicket&&(o.numero_ticket=this.numeroTicket),this.caissier_id!=null&&(o.caissier_id=this.caissier_id);const e=await C(o);if(e.success)this.ventes=e.ventes,this.total=e.total;else throw new Error(e.error)}catch(o){throw this.error=o.message,o}finally{this.loading=!1}},async chargerStats(){try{const o={};this.dateDebut&&(o.date_debut=this.dateDebut),this.dateFin&&(o.date_fin=this.dateFin);const e=await F(o);e.success&&(this.stats=e.stats)}catch(o){console.error("Erreur chargement stats:",o)}},async ouvrirDetail(o){try{const e=await V(o);if(e.success)this.selectedVente=e,this.showDetailModal=!0;else throw new Error(e.error)}catch(e){this.error=e.message}},fermerDetail(){this.showDetailModal=!1,this.selectedVente=null},rechercher(){return this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},resetFiltres(){return this.dateDebut="",this.dateFin="",this.numeroTicket="",this.caissier_id=null,this.offset=0,Promise.all([this.chargerVentes(),this.chargerStats()])},pageSuivante(){if(this.offset+this.limit<this.total)return this.offset+=this.limit,this.chargerVentes()},pagePrecedente(){if(this.offset>0)return this.offset=Math.max(0,this.offset-this.limit),this.chargerVentes()},allerPage(o){return this.offset=(o-1)*this.limit,this.chargerVentes()},formatDate(o){return o?new Date(o).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"}}}),S={class:"container-fluid mt-4"},T={class:"row mb-4"},M={class:"col-12"},$={key:0,class:"row g-3"},q={class:"col-md-3"},H={class:"card bg-primary text-white"},A={class:"card-body"},E={class:"mb-0"},N={class:"col-md-3"},R={class:"card bg-success text-white"},I={class:"card-body"},B={class:"mb-0"},U={class:"col-md-3"},j={class:"card bg-info text-white"},z={class:"card-body"},L={class:"mb-0"},O={class:"col-md-3"},Q={class:"card bg-warning text-dark"},G={class:"card-body"},J={class:"mb-0"},K={class:"card mb-4"},W={class:"card-body"},X={class:"row g-3"},Y={class:"col-md-3"},Z={class:"col-md-3"},tt={class:"col-md-4"},st={class:"col-md-2 d-flex align-items-end gap-2"},et={key:0,class:"alert alert-danger alert-dismissible fade show"},it={key:1,class:"text-center py-5"},lt={key:2,class:"card"},nt={class:"card-header"},ot={class:"mb-0"},at={class:"card-body p-0"},dt={key:0,class:"text-center py-5 text-muted"},rt={key:1,class:"table-responsive"},ct={class:"table table-hover mb-0"},ut={class:"text-primary"},mt={key:0,class:"badge bg-info"},bt={key:1,class:"badge bg-secondary"},ht={key:2,class:"badge bg-light text-dark"},_t=["onClick"],gt={key:0,class:"card-footer"},ft={class:"pagination mb-0 justify-content-center"},vt=["onClick"],pt={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},yt={class:"modal-dialog modal-xl"},kt={class:"modal-content"},xt={class:"modal-header"},Dt={class:"modal-title"},wt={class:"modal-body"},Vt={class:"row mb-4"},Ft={class:"col-md-6"},Ct={class:"row"},Pt={class:"col-sm-8"},St={class:"col-sm-8"},Tt={class:"col-sm-8"},Mt={class:"col-sm-8"},$t={class:"text-primary"},qt={key:0,class:"col-md-6"},Ht={class:"row"},At={class:"col-sm-8"},Et={class:"col-sm-8"},Nt={class:"table-responsive mb-4"},Rt={class:"table table-sm table-bordered"},It={key:0,class:"badge bg-warning text-dark ms-2"},Bt={class:"text-end"},Ut={class:"text-end"},jt={class:"text-end"},zt={class:"table-light"},Lt={class:"text-end"},Ot={class:"text-primary"},Qt={key:0},Gt={key:1,class:"table-responsive"},Jt={class:"table table-sm"},Kt={class:"text-end"},Wt={class:"modal-footer"},Xt={__name:"CaisseHistoriquePage",setup(o){const e=P();return k(async()=>{const h=new Date().toISOString().split("T")[0];e.dateDebut=h,e.dateFin=h,await e.chargerVentes(),await e.chargerStats()}),(h,s)=>{var f,v;return a(),d("div",S,[t("div",T,[t("div",M,[s[14]||(s[14]=t("div",{class:"d-flex justify-content-between align-items-center mb-3"},[t("h2",null,[t("i",{class:"bi bi-clock-history me-2"}),r("Historique des ventes")]),t("a",{href:"/caisse",class:"btn btn-outline-primary"},[t("i",{class:"bi bi-arrow-left me-2"}),r("Retour à la caisse ")])],-1)),i(e).stats?(a(),d("div",$,[t("div",q,[t("div",H,[t("div",A,[s[10]||(s[10]=t("h6",{class:"card-title"},"Nombre de ventes",-1)),t("h3",E,n(i(e).stats.nb_ventes),1)])])]),t("div",N,[t("div",R,[t("div",I,[s[11]||(s[11]=t("h6",{class:"card-title"},"CA Total",-1)),t("h3",B,n(i(e).stats.ca_total.toFixed(2))+" €",1)])])]),t("div",U,[t("div",j,[t("div",z,[s[12]||(s[12]=t("h6",{class:"card-title"},"Ticket moyen",-1)),t("h3",L,n(i(e).stats.ticket_moyen.toFixed(2))+" €",1)])])]),t("div",O,[t("div",Q,[t("div",G,[s[13]||(s[13]=t("h6",{class:"card-title"},"Ticket max",-1)),t("h3",J,n(i(e).stats.ticket_max.toFixed(2))+" €",1)])])])])):c("",!0)])]),t("div",K,[s[20]||(s[20]=t("div",{class:"card-header bg-light"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-funnel me-2"}),r("Filtres de recherche")])],-1)),t("div",W,[t("div",X,[t("div",Y,[s[15]||(s[15]=t("label",{class:"form-label"},"Date début",-1)),_(t("input",{type:"date",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=l=>i(e).dateDebut=l)},null,512),[[g,i(e).dateDebut]])]),t("div",Z,[s[16]||(s[16]=t("label",{class:"form-label"},"Date fin",-1)),_(t("input",{type:"date",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=l=>i(e).dateFin=l)},null,512),[[g,i(e).dateFin]])]),t("div",tt,[s[17]||(s[17]=t("label",{class:"form-label"},"Numéro ticket",-1)),_(t("input",{type:"text",class:"form-control","onUpdate:modelValue":s[2]||(s[2]=l=>i(e).numeroTicket=l),placeholder:"Ex: CAISSE-1738272840"},null,512),[[g,i(e).numeroTicket]])]),t("div",st,[t("button",{class:"btn btn-primary",onClick:s[3]||(s[3]=l=>i(e).rechercher())},[...s[18]||(s[18]=[t("i",{class:"bi bi-search me-1"},null,-1),r("Rechercher ",-1)])]),t("button",{class:"btn btn-outline-secondary",onClick:s[4]||(s[4]=l=>i(e).resetFiltres())},[...s[19]||(s[19]=[t("i",{class:"bi bi-x-circle me-1"},null,-1),r("Réinitialiser ",-1)])])])])])]),i(e).error?(a(),d("div",et,[s[21]||(s[21]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),r(n(i(e).error)+" ",1),t("button",{type:"button",class:"btn-close",onClick:s[5]||(s[5]=l=>i(e).error=null)})])):c("",!0),i(e).loading?(a(),d("div",it,[...s[22]||(s[22]=[t("div",{class:"spinner-border text-primary"},null,-1)])])):(a(),d("div",lt,[t("div",nt,[t("h5",ot," Résultats ("+n(i(e).total)+" vente"+n(i(e).total>1?"s":"")+") ",1)]),t("div",at,[i(e).ventes.length===0?(a(),d("div",dt,[...s[23]||(s[23]=[t("i",{class:"bi bi-inbox",style:{"font-size":"3rem"}},null,-1),t("p",{class:"mt-2"},"Aucune vente trouvée",-1)])])):(a(),d("div",rt,[t("table",ct,[s[28]||(s[28]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Ticket"),t("th",null,"Date/Heure"),t("th",null,"Caissier"),t("th",null,"Client"),t("th",null,"Nb articles"),t("th",null,"Montant"),t("th",null,"Source"),t("th",null,"Statut"),t("th",null,"Actions")])],-1)),t("tbody",null,[(a(!0),d(m,null,b(i(e).ventes,l=>(a(),d("tr",{key:l.id},[t("td",null,[t("code",null,n(l.numero_ticket),1)]),t("td",null,n(i(e).formatDate(l.created_at)),1),t("td",null,n(l.caissier_nom||"-"),1),t("td",null,n(l.client_nom||l.nom_client||"Anonyme"),1),t("td",null,n(l.nb_lignes),1),t("td",null,[t("strong",ut,n(l.montant_ttc.toFixed(2))+" €",1)]),t("td",null,[l.panier_source==="caisse"?(a(),d("span",mt,[...s[24]||(s[24]=[t("i",{class:"bi bi-cart me-1"},null,-1),r("Panier caisse ",-1)])])):l.panier_source==="catalogue"?(a(),d("span",bt,[...s[25]||(s[25]=[t("i",{class:"bi bi-book me-1"},null,-1),r("Catalogue ",-1)])])):(a(),d("span",ht,[...s[26]||(s[26]=[t("i",{class:"bi bi-lightning me-1"},null,-1),r("Direct ",-1)])]))]),t("td",null,[t("span",{class:u(["badge",l.statut==="complete"?"bg-success":"bg-warning"])},n(l.statut),3)]),t("td",null,[t("button",{class:"btn btn-sm btn-outline-primary",onClick:y=>i(e).ouvrirDetail(l.id)},[...s[27]||(s[27]=[t("i",{class:"bi bi-eye me-1"},null,-1),r("Détails ",-1)])],8,_t)])]))),128))])])]))]),i(e).nbPages>1?(a(),d("div",gt,[t("nav",null,[t("ul",ft,[t("li",{class:u(["page-item",{disabled:i(e).currentPage===1}])},[t("button",{class:"page-link",onClick:s[6]||(s[6]=l=>i(e).pagePrecedente())},"Précédent")],2),(a(!0),d(m,null,b(i(e).nbPages,l=>(a(),d("li",{key:l,class:u(["page-item",{active:l===i(e).currentPage}])},[t("button",{class:"page-link",onClick:y=>i(e).allerPage(l)},n(l),9,vt)],2))),128)),t("li",{class:u(["page-item",{disabled:i(e).currentPage===i(e).nbPages}])},[t("button",{class:"page-link",onClick:s[7]||(s[7]=l=>i(e).pageSuivante())},"Suivant")],2)])])])):c("",!0)])),i(e).showDetailModal&&i(e).selectedVente?(a(),d("div",pt,[t("div",yt,[t("div",kt,[t("div",xt,[t("h5",Dt,[s[29]||(s[29]=t("i",{class:"bi bi-receipt me-2"},null,-1)),r(" Détail vente "+n(i(e).selectedVente.vente.numero_ticket),1)]),t("button",{type:"button",class:"btn-close",onClick:s[8]||(s[8]=l=>i(e).fermerDetail())})]),t("div",wt,[t("div",Vt,[t("div",Ft,[s[34]||(s[34]=t("h6",null,"Informations générales",-1)),t("dl",Ct,[s[30]||(s[30]=t("dt",{class:"col-sm-4"},"Date/Heure",-1)),t("dd",Pt,n(i(e).formatDate(i(e).selectedVente.vente.created_at)),1),s[31]||(s[31]=t("dt",{class:"col-sm-4"},"Caissier",-1)),t("dd",St,n(i(e).selectedVente.vente.caissier_nom),1),s[32]||(s[32]=t("dt",{class:"col-sm-4"},"Client",-1)),t("dd",Tt,n(i(e).selectedVente.vente.client_nom||i(e).selectedVente.vente.nom_client),1),s[33]||(s[33]=t("dt",{class:"col-sm-4"},"Montant total",-1)),t("dd",Mt,[t("strong",$t,n(i(e).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])]),i(e).selectedVente.vente.panier_id?(a(),d("div",qt,[s[37]||(s[37]=t("h6",null,"Informations panier",-1)),t("dl",Ht,[s[35]||(s[35]=t("dt",{class:"col-sm-4"},"Source",-1)),t("dd",At,[t("span",{class:u(["badge",i(e).selectedVente.vente.panier_source==="caisse"?"bg-info":"bg-secondary"])},n(i(e).selectedVente.vente.panier_source),3)]),s[36]||(s[36]=t("dt",{class:"col-sm-4"},"Sauvegardé le",-1)),t("dd",Et,n(i(e).formatDate(i(e).selectedVente.vente.panier_saved_at)),1)])])):c("",!0)]),s[41]||(s[41]=t("h6",null,"Produits vendus",-1)),t("div",Nt,[t("table",Rt,[s[39]||(s[39]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Quantité"),t("th",{class:"text-end"},"Prix unitaire"),t("th",{class:"text-end"},"Total")])],-1)),t("tbody",null,[(a(!0),d(m,null,b(i(e).selectedVente.lignes,l=>(a(),d("tr",{key:l.id,class:u({"table-warning":l.is_avoir})},[t("td",null,[r(n(l.nom_produit||l.product_nom_actuel)+" ",1),l.is_avoir?(a(),d("span",It,"AVOIR")):c("",!0)]),t("td",Bt,n(l.quantite.toFixed(3)),1),t("td",Ut,n(l.prix_unitaire.toFixed(2))+" €",1),t("td",jt,[t("strong",{class:u(l.is_avoir?"text-warning":"text-primary")},n(l.montant_ttc.toFixed(2))+" € ",3)])],2))),128))]),t("tfoot",zt,[t("tr",null,[s[38]||(s[38]=t("td",{colspan:"3",class:"text-end"},[t("strong",null,"Total")],-1)),t("td",Lt,[t("strong",Ot,n(i(e).selectedVente.vente.montant_ttc.toFixed(2))+" €",1)])])])])]),((f=i(e).selectedVente.paiements)==null?void 0:f.length)>0?(a(),d("h6",Qt,"Paiements")):c("",!0),((v=i(e).selectedVente.paiements)==null?void 0:v.length)>0?(a(),d("div",Gt,[t("table",Jt,[s[40]||(s[40]=t("thead",{class:"table-light"},[t("tr",null,[t("th",null,"Mode de paiement"),t("th",{class:"text-end"},"Montant"),t("th",null,"Date")])],-1)),t("tbody",null,[(a(!0),d(m,null,b(i(e).selectedVente.paiements,l=>(a(),d("tr",{key:l.id},[t("td",null,n(l.mode_paiement_nom),1),t("td",Kt,[t("strong",null,n(l.montant.toFixed(2))+" €",1)]),t("td",null,n(i(e).formatDate(l.date_paiement)),1)]))),128))])])])):c("",!0)]),t("div",Wt,[t("button",{type:"button",class:"btn btn-secondary",onClick:s[9]||(s[9]=l=>i(e).fermerDetail())},"Fermer")])])])])):c("",!0)])}}},p=x(Xt);p.use(w());p.mount("#historique-ventes-app");
