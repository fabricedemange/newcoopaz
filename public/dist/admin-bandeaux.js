import{i as _,o as r,c as n,u as i,a as s,t as d,b as m,j as B,e as p,v as g,s as b,F as y,l as v,n as f,d as u,h as k}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as E,c as D}from"./chunks/pinia-gLxYYWQL.js";import{_ as w}from"./chunks/BackButton-DzFd1NqY.js";import{a5 as z,a6 as C,a7 as S,a8 as M,a9 as A}from"./chunks/index-CY5spq3H.js";const T=E("adminBandeaux",{state:()=>({bandeaux:[],organizations:[],loading:!0,error:null,userRole:"",organizationId:null,editingBandeau:null,isCreating:!1,showBandeauModal:!1,searchQuery:"",filterType:"",formData:{message:"",type:"info",page_cible:"",expiration_date:"",organization_id:""},formErrors:{}}),getters:{filteredBandeaux(a){let t=[...a.bandeaux];if(a.searchQuery){const l=a.searchQuery.toLowerCase();t=t.filter(e=>e.message&&e.message.toLowerCase().includes(l)||e.organization_name&&e.organization_name.toLowerCase().includes(l))}return a.filterType&&(t=t.filter(l=>l.type===a.filterType)),t},isSuperAdmin(a){return a.userRole==="SuperAdmin"},modalTitle(a){return a.isCreating?"Nouveau bandeau":"Modifier le bandeau"}},actions:{async loadBandeaux(){this.loading=!0,this.error=null;try{const a=await A();if(a.success)this.bandeaux=a.bandeaux||[],this.userRole=a.userRole||"",this.organizationId=a.organizationId??null;else throw new Error(a.error)}catch(a){this.error=a.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},async loadOrganizations(){if(this.userRole==="SuperAdmin")try{const a=await M();a.success&&(this.organizations=a.organizations||[])}catch(a){console.error("Error loading organizations:",a)}},openCreateModal(){this.showBandeauModal=!0,this.isCreating=!0,this.editingBandeau=null,this.formData={message:"",type:"info",page_cible:"",expiration_date:"",organization_id:this.userRole==="SuperAdmin"?"":String(this.organizationId||"")},this.formErrors={},this.userRole==="SuperAdmin"&&this.loadOrganizations()},openEditModal(a){this.showBandeauModal=!0,this.isCreating=!1,this.editingBandeau=a;let t="";if(a.expiration_date){const l=new Date(a.expiration_date);isNaN(l.getTime())||(t=l.toISOString().slice(0,16))}this.formData={message:a.message||"",type:a.type||"info",page_cible:a.page_cible||"",expiration_date:t,organization_id:a.organization_id?String(a.organization_id):""},this.formErrors={},this.userRole==="SuperAdmin"&&this.loadOrganizations()},closeModal(){this.showBandeauModal=!1,this.editingBandeau=null,this.isCreating=!1,this.formErrors={}},async saveBandeau(){var a;if(this.formErrors={},!this.formData.message||!this.formData.message.trim()){this.formErrors.message="Le message est obligatoire";return}if(!this.formData.type){this.formErrors.type="Le type est obligatoire";return}try{const t={message:this.formData.message.trim(),type:this.formData.type,page_cible:((a=this.formData.page_cible)==null?void 0:a.trim())||null,expiration_date:this.formData.expiration_date||null,organization_id:this.formData.organization_id||null};if(this.isCreating){const l=await C(t);l.success?(this.closeModal(),await this.loadBandeaux(),alert(l.message||"Bandeau enregistré avec succès")):this.formErrors.general=l.error}else{const l=await S(this.editingBandeau.id,t);l.success?(this.closeModal(),await this.loadBandeaux(),alert(l.message||"Bandeau enregistré avec succès")):this.formErrors.general=l.error}}catch(t){this.formErrors.general=t.message||"Erreur de connexion au serveur"}},async deleteBandeau(a){if(confirm(`Supprimer le bandeau "${(a.message||"").substring(0,50)}..." ?`))try{const t=await z(a.id);t.success?(await this.loadBandeaux(),alert(t.message||"Bandeau supprimé avec succès")):alert(t.error||"Erreur lors de la suppression")}catch(t){alert(t.message||"Erreur de connexion au serveur")}},formatDate(a){if(!a)return"—";const t=new Date(a);if(isNaN(t.getTime()))return a;const l=String(t.getDate()).padStart(2,"0"),e=String(t.getMonth()+1).padStart(2,"0"),o=t.getFullYear(),c=String(t.getHours()).padStart(2,"0"),h=String(t.getMinutes()).padStart(2,"0");return`${l}/${e}/${o} ${c}:${h}`},isExpired(a){return a?new Date(a)<new Date:!1},truncate(a,t=100){return a?a.length<=t?a:a.substring(0,t)+"...":""},getTypeBadgeClass(a){return a==="important"?"bg-danger":"bg-info"},getTypeLabel(a){return a==="important"?"Important":"Info"}}}),$={class:"container-fluid mt-4"},I={key:0,class:"text-center py-5"},V={key:1,class:"alert alert-danger"},N={key:2},R={class:"d-flex justify-content-between align-items-center mb-4"},L={class:"d-flex gap-2"},O={class:"row mb-4"},U={class:"col-md-8"},Q={class:"col-md-4"},j={key:0,class:"alert alert-info"},P={key:1,class:"row"},F={class:"card-body"},q={class:"d-flex justify-content-between align-items-start mb-2"},H={key:0,class:"badge bg-secondary"},Y={class:"card-text"},G={class:"small text-muted mb-2"},J={key:0},K={key:1},W={key:2},X={class:"card-footer bg-transparent border-0"},Z={class:"d-flex gap-2"},ee=["onClick"],te=["onClick"],se={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},ae={class:"modal-dialog modal-lg"},ie={class:"modal-content"},oe={class:"modal-header"},re={class:"modal-title"},ne={class:"modal-body"},le={key:0,class:"alert alert-danger"},de={class:"mb-3"},ue={key:0,class:"invalid-feedback"},me={class:"mb-3"},pe={key:0,class:"invalid-feedback"},ge={class:"mb-3"},fe={class:"mb-3"},ce={key:1,class:"mb-3"},be=["value"],ye={class:"modal-footer"},ve={__name:"AdminBandeauxPage",setup(a){const t=T();return _(()=>{t.loadBandeaux()}),(l,e)=>(r(),n("div",$,[i(t).loading?(r(),n("div",I,[...e[12]||(e[12]=[s("div",{class:"spinner-border text-primary",role:"status"},null,-1),s("p",{class:"mt-3 text-muted"},"Chargement des bandeaux...",-1)])])):i(t).error?(r(),n("div",V,d(i(t).error),1)):(r(),n("div",N,[s("div",R,[e[15]||(e[15]=s("h2",{class:"mb-0"},[s("i",{class:"bi bi-megaphone me-2"}),m("Bandeaux d'information")],-1)),s("div",L,[B(w),s("button",{onClick:e[0]||(e[0]=o=>i(t).loadBandeaux()),class:"btn btn-outline-primary"},[...e[13]||(e[13]=[s("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),m("Actualiser ",-1)])]),s("button",{onClick:e[1]||(e[1]=o=>i(t).openCreateModal()),class:"btn btn-primary"},[...e[14]||(e[14]=[s("i",{class:"bi bi-plus-circle me-2"},null,-1),m("Nouveau bandeau ",-1)])])])]),s("div",O,[s("div",U,[p(s("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>i(t).searchQuery=o),type:"text",class:"form-control",placeholder:"Rechercher par message ou organisation..."},null,512),[[g,i(t).searchQuery]])]),s("div",Q,[p(s("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>i(t).filterType=o),class:"form-select"},[...e[16]||(e[16]=[s("option",{value:""},"Tous les types",-1),s("option",{value:"info"},"Info",-1),s("option",{value:"important"},"Important",-1)])],512),[[b,i(t).filterType]])])]),i(t).filteredBandeaux.length===0?(r(),n("div",j,"Aucun bandeau trouvé")):(r(),n("div",P,[(r(!0),n(y,null,v(i(t).filteredBandeaux,o=>(r(),n("div",{key:o.id,class:"col-md-6 col-lg-4 mb-3"},[s("div",{class:f(["card h-100",{"border-danger":i(t).isExpired(o.expiration_date)}])},[s("div",F,[s("div",q,[s("span",{class:f(["badge",i(t).getTypeBadgeClass(o.type)])},d(i(t).getTypeLabel(o.type)),3),i(t).isExpired(o.expiration_date)?(r(),n("span",H,"Expiré")):u("",!0)]),s("p",Y,d(i(t).truncate(o.message,150)),1),s("div",G,[o.page_cible?(r(),n("div",J,[e[17]||(e[17]=s("i",{class:"bi bi-link-45deg me-1"},null,-1)),e[18]||(e[18]=s("strong",null,"Page:",-1)),m(" "+d(o.page_cible),1)])):u("",!0),o.expiration_date?(r(),n("div",K,[e[19]||(e[19]=s("i",{class:"bi bi-calendar-x me-1"},null,-1)),e[20]||(e[20]=s("strong",null,"Expire:",-1)),m(" "+d(i(t).formatDate(o.expiration_date)),1)])):u("",!0),i(t).isSuperAdmin&&o.organization_name?(r(),n("div",W,[e[21]||(e[21]=s("i",{class:"bi bi-building me-1"},null,-1)),e[22]||(e[22]=s("strong",null,"Organisation:",-1)),m(" "+d(o.organization_name||"(Toutes)"),1)])):u("",!0)])]),s("div",X,[s("div",Z,[s("button",{onClick:c=>i(t).openEditModal(o),class:"btn btn-sm btn-outline-primary flex-fill"},[...e[23]||(e[23]=[s("i",{class:"bi bi-pencil"},null,-1),m(" Modifier ",-1)])],8,ee),s("button",{onClick:c=>i(t).deleteBandeau(o),class:"btn btn-sm btn-outline-danger"},[...e[24]||(e[24]=[s("i",{class:"bi bi-trash"},null,-1)])],8,te)])])],2)]))),128))]))])),i(t).showBandeauModal?(r(),n("div",se,[s("div",ae,[s("div",ie,[s("div",oe,[s("h5",re,d(i(t).modalTitle),1),s("button",{type:"button",class:"btn-close",onClick:e[4]||(e[4]=o=>i(t).closeModal())})]),s("div",ne,[i(t).formErrors.general?(r(),n("div",le,d(i(t).formErrors.general),1)):u("",!0),s("div",de,[e[25]||(e[25]=s("label",{class:"form-label"},"Message *",-1)),p(s("textarea",{"onUpdate:modelValue":e[5]||(e[5]=o=>i(t).formData.message=o),class:f(["form-control",{"is-invalid":i(t).formErrors.message}]),rows:"3",placeholder:"Message du bandeau..."},null,2),[[g,i(t).formData.message]]),i(t).formErrors.message?(r(),n("div",ue,d(i(t).formErrors.message),1)):u("",!0)]),s("div",me,[e[27]||(e[27]=s("label",{class:"form-label"},"Type *",-1)),p(s("select",{"onUpdate:modelValue":e[6]||(e[6]=o=>i(t).formData.type=o),class:f(["form-select",{"is-invalid":i(t).formErrors.type}])},[...e[26]||(e[26]=[s("option",{value:"info"},"Info (bleu)",-1),s("option",{value:"important"},"Important (rouge)",-1)])],2),[[b,i(t).formData.type]]),i(t).formErrors.type?(r(),n("div",pe,d(i(t).formErrors.type),1)):u("",!0)]),s("div",ge,[e[28]||(e[28]=s("label",{class:"form-label"},"Page cible (optionnel)",-1)),p(s("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>i(t).formData.page_cible=o),type:"text",class:"form-control",placeholder:"/chemin/vers/page (laissez vide pour toutes les pages)"},null,512),[[g,i(t).formData.page_cible]]),e[29]||(e[29]=s("small",{class:"text-muted"},"Si vide, le bandeau sera affiché sur toutes les pages",-1))]),s("div",fe,[e[30]||(e[30]=s("label",{class:"form-label"},"Date d'expiration (optionnel)",-1)),p(s("input",{"onUpdate:modelValue":e[8]||(e[8]=o=>i(t).formData.expiration_date=o),type:"datetime-local",class:"form-control"},null,512),[[g,i(t).formData.expiration_date]]),e[31]||(e[31]=s("small",{class:"text-muted"},"Si vide, le bandeau n'expirera jamais",-1))]),i(t).isSuperAdmin?(r(),n("div",ce,[e[33]||(e[33]=s("label",{class:"form-label"},"Organisation",-1)),p(s("select",{"onUpdate:modelValue":e[9]||(e[9]=o=>i(t).formData.organization_id=o),class:"form-select"},[e[32]||(e[32]=s("option",{value:""},"Toutes les organisations",-1)),(r(!0),n(y,null,v(i(t).organizations,o=>(r(),n("option",{key:o.id,value:o.id},d(o.name),9,be))),128))],512),[[b,i(t).formData.organization_id]])])):u("",!0)]),s("div",ye,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[10]||(e[10]=o=>i(t).closeModal())},"Annuler"),s("button",{type:"button",onClick:e[11]||(e[11]=o=>i(t).saveBandeau()),class:"btn btn-primary"},[...e[34]||(e[34]=[s("i",{class:"bi bi-check-lg me-2"},null,-1),m("Enregistrer ",-1)])])])])])])):u("",!0)]))}},x=k(ve);x.use(D());x.mount("#admin-bandeaux-app");
