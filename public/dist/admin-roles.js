import{i as R,o as r,c as a,u as n,a as s,t as m,b as u,j as w,e as b,v as y,d as _,F as p,l as h,n as g,w as C,h as k}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as x,c as P}from"./chunks/pinia-gLxYYWQL.js";import{_ as S}from"./chunks/BackButton-DzFd1NqY.js";import{ae as L,af as E,ag as $,ah as A,ai as Q,a4 as F}from"./chunks/index-nogkb2JM.js";const I=x("adminRoles",{state:()=>({roles:[],permissions:{},modules:[],loading:!0,error:null,expandedRole:null,rolePermissions:{},savingRoleId:null,savedRoleId:null,searchQuery:"",showCreateForm:!1,newRole:{name:"",display_name:"",description:""}}),getters:{systemRoles(i){return i.roles.filter(e=>e.is_system===1)},customRoles(i){return i.roles.filter(e=>e.is_system===0)},filteredRoles(i){if(!i.searchQuery)return i.roles;const e=i.searchQuery.toLowerCase();return i.roles.filter(l=>l.display_name&&l.display_name.toLowerCase().includes(e)||l.name&&l.name.toLowerCase().includes(e)||l.description&&l.description.toLowerCase().includes(e))},filteredSystemRoles(i){return i.searchQuery?i.roles.filter(l=>l.is_system===1&&(l.display_name&&l.display_name.toLowerCase().includes(i.searchQuery.toLowerCase())||l.name&&l.name.toLowerCase().includes(i.searchQuery.toLowerCase())||l.description&&l.description.toLowerCase().includes(i.searchQuery.toLowerCase()))):i.roles.filter(l=>l.is_system===1)},filteredCustomRoles(i){return i.searchQuery?i.roles.filter(l=>l.is_system===0&&(l.display_name&&l.display_name.toLowerCase().includes(i.searchQuery.toLowerCase())||l.name&&l.name.toLowerCase().includes(i.searchQuery.toLowerCase())||l.description&&l.description.toLowerCase().includes(i.searchQuery.toLowerCase()))):i.roles.filter(l=>l.is_system===0)}},actions:{async loadRoles(){try{const i=await F();if(i.success){this.roles=i.roles||[];for(const e of this.roles)await this.loadRolePermissions(e.id)}else this.error=i.error||"Erreur lors du chargement des rôles"}catch(i){console.error("Error loading roles:",i),this.error=i.message||"Erreur de connexion au serveur"}},async loadRolePermissions(i){try{const e=await Q(i);e.success&&(this.rolePermissions={...this.rolePermissions,[i]:e.permission_ids||[]})}catch(e){console.error("Error loading role permissions:",e)}},async loadPermissions(){try{const i=await A();i.success?(this.permissions=i.permissions||{},this.modules=i.modules||[]):this.error=i.error||"Erreur lors du chargement des permissions"}catch(i){console.error("Error loading permissions:",i),this.error=i.message||"Erreur de connexion au serveur"}},toggleRole(i){this.expandedRole=this.expandedRole===i?null:i},isRoleExpanded(i){return this.expandedRole===i},togglePermission(i,e){const l=[...this.rolePermissions[i]||[]],t=l.indexOf(e);t>-1?l.splice(t,1):l.push(e),this.rolePermissions={...this.rolePermissions,[i]:l}},hasPermission(i,e){return(this.rolePermissions[i]||[]).includes(e)},selectAllModulePermissions(i,e){const l=this.permissions[e]||[],t=[...this.rolePermissions[i]||[]],o=l.every(d=>t.includes(d.id)),c=l.map(d=>d.id);if(o){const d=t.filter(v=>!c.includes(v));this.rolePermissions={...this.rolePermissions,[i]:d}}else{const d=[...new Set([...t,...c])];this.rolePermissions={...this.rolePermissions,[i]:d}}},isModuleFullySelected(i,e){const l=this.permissions[e]||[],t=this.rolePermissions[i]||[];return l.length>0&&l.every(o=>t.includes(o.id))},async saveRolePermissions(i){this.savingRoleId=i.id;try{await $(i.id,{name:i.name,display_name:i.display_name,description:i.description,permission_ids:this.rolePermissions[i.id]||[]}),this.savedRoleId=i.id,setTimeout(()=>{this.savedRoleId=null},2e3),await this.loadRoles()}catch(e){alert(e.message||"Erreur lors de la sauvegarde")}finally{this.savingRoleId=null}},async createRole(){if(!this.newRole.name||!this.newRole.display_name){alert("Le nom et le nom d'affichage sont requis");return}try{await E({name:this.newRole.name,display_name:this.newRole.display_name,description:this.newRole.description,permission_ids:[]}),this.showCreateForm=!1,this.newRole={name:"",display_name:"",description:""},await this.loadRoles()}catch(i){alert(i.message||"Erreur lors de la création")}},async deleteRole(i){if(i.user_count>0){alert(`Impossible de supprimer ce rôle : ${i.user_count} utilisateur(s) l'utilisent encore`);return}if(confirm(`Êtes-vous sûr de vouloir supprimer le rôle "${i.display_name}" ?`))try{await L(i.id),await this.loadRoles()}catch(e){alert(e.message||"Erreur lors de la suppression")}},cancelCreate(){this.showCreateForm=!1,this.newRole={name:"",display_name:"",description:""}},async loadData(){this.loading=!0,this.error=null;try{await Promise.all([this.loadRoles(),this.loadPermissions()])}catch(i){this.error=i.message||"Erreur d'initialisation"}finally{this.loading=!1}}}}),M={class:"container-fluid mt-4"},V={key:0,class:"text-center py-5"},N={key:1,class:"alert alert-danger"},T={key:2},D={class:"d-flex justify-content-between align-items-center mb-4"},j={class:"d-flex gap-2"},q={key:0,class:"card mb-4"},U={class:"card-body"},z={class:"row"},B={class:"col-md-4"},G={class:"mb-3"},O={class:"col-md-4"},H={class:"mb-3"},J={class:"col-md-4"},K={class:"mb-3"},W={class:"d-flex gap-2"},X={class:"mb-4"},Y={class:"card mb-4"},Z={class:"card-body p-0"},ss=["onClick"],es={class:"flex-grow-1"},is={class:"mb-1"},ts={class:"mb-0 text-muted small"},os={class:"d-flex align-items-center gap-3"},ns={class:"badge bg-info"},ls={class:"badge bg-secondary"},rs={key:0,class:"p-3 bg-light"},as={class:"row"},ds={class:"card"},cs={class:"card-header d-flex justify-content-between align-items-center"},ms=["onClick"],us={class:"card-body",style:{"max-height":"300px","overflow-y":"auto"}},ps=["id","checked","onChange"],hs=["for"],bs={class:"text-muted"},ys={class:"mt-3"},_s=["disabled","onClick"],gs={key:0},vs={key:1},fs={key:2},Rs={class:"card"},ws={class:"card-body p-0"},Cs={key:0,class:"text-center text-muted py-4"},ks=["onClick"],xs={class:"flex-grow-1"},Ps={class:"mb-1"},Ss={class:"mb-0 text-muted small"},Ls={class:"d-flex align-items-center gap-3"},Es={class:"badge bg-info"},$s={class:"badge bg-secondary"},As=["disabled","onClick"],Qs={key:0,class:"p-3 bg-light"},Fs={class:"row"},Is={class:"card"},Ms={class:"card-header d-flex justify-content-between align-items-center"},Vs=["onClick"],Ns={class:"card-body",style:{"max-height":"300px","overflow-y":"auto"}},Ts=["id","checked","onChange"],Ds=["for"],js={class:"text-muted"},qs={class:"mt-3"},Us=["disabled","onClick"],zs={key:0},Bs={key:1},Gs={key:2},Os={__name:"AdminRolesPage",setup(i){const e=I();return R(()=>{e.loadData()}),(l,t)=>(r(),a("div",M,[n(e).loading?(r(),a("div",V,[...t[7]||(t[7]=[s("div",{class:"spinner-border text-admin-site",role:"status"},[s("span",{class:"visually-hidden"},"Chargement...")],-1),s("p",{class:"mt-3 text-muted"},"Chargement des rôles...",-1)])])):n(e).error?(r(),a("div",N,m(n(e).error),1)):(r(),a("div",T,[s("div",D,[t[9]||(t[9]=s("h2",{class:"text-admin-site mb-0"},[s("i",{class:"bi bi-shield-lock me-2"}),u("Gestion des Rôles")],-1)),s("div",j,[w(S),s("button",{type:"button",class:"btn btn-admin-site",onClick:t[0]||(t[0]=o=>n(e).showCreateForm=!n(e).showCreateForm)},[...t[8]||(t[8]=[s("i",{class:"bi bi-plus-lg me-2"},null,-1),u("Nouveau rôle ",-1)])])])]),n(e).showCreateForm?(r(),a("div",q,[t[16]||(t[16]=s("div",{class:"card-header card-header-admin-site"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-plus-circle me-2"}),u("Créer un nouveau rôle")])],-1)),s("div",U,[s("div",z,[s("div",B,[s("div",G,[t[10]||(t[10]=s("label",{class:"form-label"},"Nom technique *",-1)),b(s("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>n(e).newRole.name=o),type:"text",class:"form-control",placeholder:"ex: catalog_viewer",pattern:"[a-z_]+"},null,512),[[y,n(e).newRole.name]]),t[11]||(t[11]=s("small",{class:"form-text text-muted"},"Minuscules et underscores uniquement",-1))])]),s("div",O,[s("div",H,[t[12]||(t[12]=s("label",{class:"form-label"},"Nom d'affichage *",-1)),b(s("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>n(e).newRole.display_name=o),type:"text",class:"form-control",placeholder:"ex: Visualisateur de Catalogues"},null,512),[[y,n(e).newRole.display_name]])])]),s("div",J,[s("div",K,[t[13]||(t[13]=s("label",{class:"form-label"},"Description",-1)),b(s("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>n(e).newRole.description=o),type:"text",class:"form-control",placeholder:"Description du rôle"},null,512),[[y,n(e).newRole.description]])])])]),s("div",W,[s("button",{type:"button",class:"btn btn-admin-site",onClick:t[4]||(t[4]=o=>n(e).createRole())},[...t[14]||(t[14]=[s("i",{class:"bi bi-check-lg me-2"},null,-1),u("Créer ",-1)])]),s("button",{type:"button",class:"btn btn-secondary",onClick:t[5]||(t[5]=o=>n(e).cancelCreate())},[...t[15]||(t[15]=[s("i",{class:"bi bi-x-lg me-2"},null,-1),u("Annuler ",-1)])])])])])):_("",!0),s("div",X,[b(s("input",{"onUpdate:modelValue":t[6]||(t[6]=o=>n(e).searchQuery=o),type:"text",class:"form-control",placeholder:"Rechercher un rôle..."},null,512),[[y,n(e).searchQuery]])]),s("div",Y,[t[22]||(t[22]=s("div",{class:"card-header card-header-admin-site"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-shield-fill me-2"}),u("Rôles Système")])],-1)),s("div",Z,[(r(!0),a(p,null,h(n(e).filteredSystemRoles,o=>(r(),a("div",{key:o.id,class:"border-bottom"},[s("div",{class:"p-3 d-flex align-items-center",style:{cursor:"pointer"},onClick:c=>n(e).toggleRole(o.id)},[s("div",es,[s("h6",is,[t[17]||(t[17]=s("span",{class:"badge bg-primary me-2"},"Système",-1)),s("strong",null,m(o.display_name),1)]),s("p",ts,m(o.description),1)]),s("div",os,[s("span",ns,m(o.permission_count)+" permissions",1),s("span",ls,m(o.user_count)+" utilisateurs",1),s("i",{class:g("bi bi-chevron-"+(n(e).isRoleExpanded(o.id)?"up":"down"))},null,2)])],8,ss),n(e).isRoleExpanded(o.id)?(r(),a("div",rs,[s("div",as,[(r(!0),a(p,null,h(n(e).modules,c=>(r(),a("div",{key:c.name,class:"col-md-6 col-lg-4 mb-3"},[s("div",ds,[s("div",cs,[s("strong",null,m(c.display_name),1),s("button",{type:"button",class:"btn btn-sm btn-link p-0",onClick:d=>n(e).selectAllModulePermissions(o.id,c.name)},m(n(e).isModuleFullySelected(o.id,c.name)?"Tout décocher":"Tout cocher"),9,ms)]),s("div",us,[(r(!0),a(p,null,h(n(e).permissions[c.name]||[],d=>(r(),a("div",{key:d.id,class:"form-check mb-2"},[s("input",{id:"perm-"+o.id+"-"+d.id,type:"checkbox",class:"form-check-input",checked:n(e).hasPermission(o.id,d.id),onChange:v=>n(e).togglePermission(o.id,d.id)},null,40,ps),s("label",{for:"perm-"+o.id+"-"+d.id,class:"form-check-label"},[s("strong",null,m(d.display_name),1),t[18]||(t[18]=s("br",null,null,-1)),s("small",bs,m(d.description),1)],8,hs)]))),128))])])]))),128))]),s("div",ys,[s("button",{type:"button",class:g("btn "+(n(e).savedRoleId===o.id?"btn-success":"btn-admin-site")),disabled:n(e).savingRoleId===o.id,onClick:c=>n(e).saveRolePermissions(o)},[n(e).savingRoleId===o.id?(r(),a("span",gs,[...t[19]||(t[19]=[s("span",{class:"spinner-border spinner-border-sm me-2"},null,-1),u(" Sauvegarde... ",-1)])])):n(e).savedRoleId===o.id?(r(),a("span",vs,[...t[20]||(t[20]=[s("i",{class:"bi bi-check-lg me-2"},null,-1),u("Sauvegardé ",-1)])])):(r(),a("span",fs,[...t[21]||(t[21]=[s("i",{class:"bi bi-save me-2"},null,-1),u("Sauvegarder les permissions ",-1)])]))],10,_s)])])):_("",!0)]))),128))])]),s("div",Rs,[t[29]||(t[29]=s("div",{class:"card-header card-header-admin-site"},[s("h5",{class:"mb-0"},[s("i",{class:"bi bi-gear-fill me-2"}),u("Rôles Personnalisés")])],-1)),s("div",ws,[n(e).filteredCustomRoles.length===0?(r(),a("div",Cs," Aucun rôle personnalisé. Créez-en un pour commencer ! ")):_("",!0),(r(!0),a(p,null,h(n(e).filteredCustomRoles,o=>(r(),a("div",{key:o.id,class:"border-bottom"},[s("div",{class:"p-3 d-flex align-items-center",style:{cursor:"pointer"},onClick:c=>n(e).toggleRole(o.id)},[s("div",xs,[s("h6",Ps,[t[23]||(t[23]=s("span",{class:"badge bg-success me-2"},"Custom",-1)),s("strong",null,m(o.display_name),1)]),s("p",Ss,m(o.description),1)]),s("div",Ls,[s("span",Es,m(o.permission_count)+" permissions",1),s("span",$s,m(o.user_count)+" utilisateurs",1),s("button",{type:"button",class:"btn btn-sm btn-outline-danger",disabled:o.user_count>0,title:"Supprimer le rôle",onClick:C(c=>n(e).deleteRole(o),["stop"])},[...t[24]||(t[24]=[s("i",{class:"bi bi-trash"},null,-1)])],8,As),s("i",{class:g("bi bi-chevron-"+(n(e).isRoleExpanded(o.id)?"up":"down"))},null,2)])],8,ks),n(e).isRoleExpanded(o.id)?(r(),a("div",Qs,[s("div",Fs,[(r(!0),a(p,null,h(n(e).modules,c=>(r(),a("div",{key:c.name,class:"col-md-6 col-lg-4 mb-3"},[s("div",Is,[s("div",Ms,[s("strong",null,m(c.display_name),1),s("button",{type:"button",class:"btn btn-sm btn-link p-0",onClick:d=>n(e).selectAllModulePermissions(o.id,c.name)},m(n(e).isModuleFullySelected(o.id,c.name)?"Tout décocher":"Tout cocher"),9,Vs)]),s("div",Ns,[(r(!0),a(p,null,h(n(e).permissions[c.name]||[],d=>(r(),a("div",{key:d.id,class:"form-check mb-2"},[s("input",{id:"perm-"+o.id+"-"+d.id,type:"checkbox",class:"form-check-input",checked:n(e).hasPermission(o.id,d.id),onChange:v=>n(e).togglePermission(o.id,d.id)},null,40,Ts),s("label",{for:"perm-"+o.id+"-"+d.id,class:"form-check-label"},[s("strong",null,m(d.display_name),1),t[25]||(t[25]=s("br",null,null,-1)),s("small",js,m(d.description),1)],8,Ds)]))),128))])])]))),128))]),s("div",qs,[s("button",{type:"button",class:g("btn "+(n(e).savedRoleId===o.id?"btn-success":"btn-admin-site")),disabled:n(e).savingRoleId===o.id,onClick:c=>n(e).saveRolePermissions(o)},[n(e).savingRoleId===o.id?(r(),a("span",zs,[...t[26]||(t[26]=[s("span",{class:"spinner-border spinner-border-sm me-2"},null,-1),u(" Sauvegarde... ",-1)])])):n(e).savedRoleId===o.id?(r(),a("span",Bs,[...t[27]||(t[27]=[s("i",{class:"bi bi-check-lg me-2"},null,-1),u("Sauvegardé ",-1)])])):(r(),a("span",Gs,[...t[28]||(t[28]=[s("i",{class:"bi bi-save me-2"},null,-1),u("Sauvegarder les permissions ",-1)])]))],10,Us)])])):_("",!0)]))),128))])])]))]))}},f=k(Os);f.use(P());f.mount("#admin-roles-app");
