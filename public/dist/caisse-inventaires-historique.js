import{i as A,o as n,c as i,a as e,b as m,j as B,t as l,d as S,F as _,l as L,n as D,r as d,h as M}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as P}from"./chunks/pinia-gLxYYWQL.js";import{_ as T}from"./chunks/BackButton-DzFd1NqY.js";import{M as V,R,T as j,S as H}from"./chunks/index-CQL6Akic.js";const z={class:"container-fluid px-3 mt-4"},Q={class:"row mb-3"},G={class:"col-12"},J={class:"d-flex justify-content-between align-items-center flex-wrap gap-2"},K={class:"d-flex gap-2"},O={key:0,class:"alert alert-danger alert-dismissible show"},U={key:1,class:"text-center py-5"},W={key:2,class:"card"},X={class:"card-header"},Y={class:"mb-0"},Z={class:"card-body p-0"},ee={key:0,class:"p-4 text-center text-muted"},te={key:1,class:"table-responsive"},se={class:"table table-hover mb-0"},ae={class:"text-nowrap"},le=["onClick"],ne=["disabled","onClick"],ie={key:0,class:"spinner-border spinner-border-sm","aria-hidden":"true"},re={key:3,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},oe={class:"modal-dialog modal-lg"},de={class:"modal-content"},ue={class:"modal-header"},ce={class:"modal-title"},me={class:"modal-body"},ve={key:0,class:"text-muted"},pe={class:"small text-muted"},be={class:"table-responsive"},_e={class:"table table-sm"},he={class:"text-end"},ye={class:"text-end"},fe={class:"small text-muted"},ge={class:"text-end text-nowrap",style:{"min-width":"100px"}},ke=["disabled","onClick"],xe={key:0,class:"spinner-border spinner-border-sm","aria-hidden":"true"},Se={__name:"InventaireHistoriquePage",setup(we){const b=d([]),h=d(0),g=d(!1),u=d(""),v=d(!1),r=d(null),k=d(!1),y=d(null),f=d(null);function x(a){if(!a)return"—";const t=new Date(a);return isNaN(t.getTime())?a:t.toLocaleString("fr-FR",{dateStyle:"short",timeStyle:"short"})}async function w(){g.value=!0,u.value="";try{const a=await V({limit:100,offset:0});b.value=a.inventaires||[],h.value=a.total??0}catch(a){u.value=a.message||"Erreur chargement"}finally{g.value=!1}}async function q(a){v.value=!0,r.value=null,k.value=!0;try{const t=await R(a);r.value=t}catch(t){u.value=t.message||"Erreur détail"}finally{k.value=!1}}async function E(a){var c,o;const t=a.statut==="complete"?`Supprimer l'inventaire #${a.id} ? Les stocks seront remis à leur état initial.`:`Supprimer le brouillon #${a.id} ?`;if(confirm(t)){f.value=a.id;try{await j(a.id),b.value=b.value.filter(p=>p.id!==a.id),h.value=Math.max(0,h.value-1),v.value&&((o=(c=r.value)==null?void 0:c.inventaire)==null?void 0:o.id)===a.id&&(v.value=!1)}catch(p){u.value=p.message||"Erreur suppression"}finally{f.value=null}}}async function F(a){var t,c;if((c=(t=r.value)==null?void 0:t.inventaire)!=null&&c.id&&confirm(`Supprimer la ligne « ${a.product_nom} » ? Le stock sera remis à ${a.stock_theorique}.`)){y.value=a.product_id;try{await H(r.value.inventaire.id,a.product_id),r.value.lignes=(r.value.lignes||[]).filter(o=>o.product_id!==a.product_id),r.value.lignes.length===0&&(v.value=!1,await w())}catch(o){u.value=o.message||"Erreur suppression"}finally{y.value=null}}}return A(()=>{w()}),(a,t)=>{var c,o,p,C,$;return n(),i("div",z,[e("div",Q,[e("div",G,[e("div",J,[t[4]||(t[4]=e("h2",{class:"mb-0"},[e("i",{class:"bi bi-clipboard-data me-2"}),m("Historique des inventaires")],-1)),e("div",K,[B(T),t[2]||(t[2]=e("a",{href:"/caisse/inventaire",class:"btn btn-primary"},[e("i",{class:"bi bi-plus me-2"}),m("Nouvel inventaire ")],-1)),t[3]||(t[3]=e("a",{href:"/caisse",class:"btn btn-outline-primary"},[e("i",{class:"bi bi-arrow-left me-2"}),m("Retour caisse ")],-1))])]),t[5]||(t[5]=e("p",{class:"text-muted small mb-0 mt-2"}," Liste des sessions d'inventaire (draft ou complétées). ",-1))])]),u.value?(n(),i("div",O,[m(l(u.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:t[0]||(t[0]=s=>u.value=null),"aria-label":"Fermer"})])):S("",!0),g.value?(n(),i("div",U,[...t[6]||(t[6]=[e("div",{class:"spinner-border text-primary"},null,-1)])])):(n(),i("div",W,[e("div",X,[e("h5",Y,"Sessions ("+l(h.value)+")",1)]),e("div",Z,[b.value.length===0?(n(),i("div",ee," Aucune session d'inventaire. ")):(n(),i("div",te,[e("table",se,[t[10]||(t[10]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"Statut"),e("th",null,"Créé le"),e("th",null,"Par"),e("th",null,"Nb lignes"),e("th",null,"Clôturé le"),e("th",null,"Actions")])],-1)),e("tbody",null,[(n(!0),i(_,null,L(b.value,s=>(n(),i("tr",{key:s.id},[e("td",null,"#"+l(s.id),1),e("td",null,[e("span",{class:D(["badge",s.statut==="complete"?"bg-success":"bg-secondary"])},l(s.statut==="complete"?"Terminé":"Brouillon"),3)]),e("td",null,l(x(s.created_at)),1),e("td",null,l(s.created_by_username||"—"),1),e("td",null,l(s.nb_lignes??0),1),e("td",null,l(s.completed_at?x(s.completed_at):"—"),1),e("td",ae,[e("button",{type:"button",class:"btn btn-outline-primary btn-sm me-1",onClick:I=>q(s.id)},[...t[7]||(t[7]=[e("i",{class:"bi bi-eye me-1"},null,-1),m("Détail ",-1)])],8,le),e("button",{type:"button",class:"btn btn-outline-danger btn-sm",title:"Supprimer l'inventaire entier et remettre les stocks à l'état initial",disabled:f.value===s.id,onClick:I=>E(s)},[f.value===s.id?(n(),i("span",ie)):(n(),i(_,{key:1},[t[8]||(t[8]=e("i",{class:"bi bi-trash me-1","aria-hidden":"true"},null,-1)),t[9]||(t[9]=m("Supprimer ",-1))],64))],8,ne)])]))),128))])])]))])])),v.value?(n(),i("div",re,[e("div",oe,[e("div",de,[e("div",ue,[e("h5",ce,"Inventaire #"+l((o=(c=r.value)==null?void 0:c.inventaire)==null?void 0:o.id),1),e("button",{type:"button",class:"btn-close",onClick:t[1]||(t[1]=s=>v.value=!1),"aria-label":"Fermer"})]),e("div",me,[k.value?(n(),i("p",ve,"Chargement...")):r.value?(n(),i(_,{key:1},[e("p",pe," Statut: "+l((p=r.value.inventaire)==null?void 0:p.statut)+" — Créé le "+l(x((C=r.value.inventaire)==null?void 0:C.created_at))+" par "+l(($=r.value.inventaire)==null?void 0:$.created_by_username),1),e("div",be,[e("table",_e,[t[13]||(t[13]=e("thead",null,[e("tr",null,[e("th",null,"Produit"),e("th",{class:"text-end"},"Qté comptée"),e("th",{class:"text-end"},"Stock théorique"),e("th",{class:"text-end"},"Écart"),e("th",null,"Commentaire (écart)"),e("th",{class:"text-end"},"Actions")])],-1)),e("tbody",null,[(n(!0),i(_,null,L(r.value.lignes||[],s=>(n(),i("tr",{key:s.product_id},[e("td",null,l(s.product_nom),1),e("td",he,l(s.quantite_comptee),1),e("td",ye,l(s.stock_theorique),1),e("td",{class:D(["text-end",s.ecart>0?"text-success":s.ecart<0?"text-danger":""])},l(s.ecart>0?"+":"")+l(s.ecart),3),e("td",fe,l(s.comment||"—"),1),e("td",ge,[e("button",{type:"button",class:"btn btn-outline-danger btn-sm",title:"Supprimer la ligne et remettre le stock à l'état initial",disabled:y.value===s.product_id,onClick:I=>F(s)},[y.value===s.product_id?(n(),i("span",xe)):(n(),i(_,{key:1},[t[11]||(t[11]=e("i",{class:"bi bi-trash me-1","aria-hidden":"true"},null,-1)),t[12]||(t[12]=m("Supprimer ",-1))],64))],8,ke)])]))),128))])])])],64)):S("",!0)])])])])):S("",!0)])}}},N=M(Se);N.use(P());N.mount("#inventaires-historique-app");
