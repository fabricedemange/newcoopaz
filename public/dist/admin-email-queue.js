import{i as j,o as d,c as r,u as n,a as t,t as a,b,j as k,w as v,n as _,e as f,v as E,s as S,d as c,F as p,l as h,h as C}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as Q,c as T}from"./chunks/pinia-gLxYYWQL.js";import{_ as L}from"./chunks/BackButton-DzFd1NqY.js";import{a1 as F}from"./chunks/index-nogkb2JM.js";const D=Q("adminEmailQueue",{state:()=>({entries:[],subjectSummary:[],loading:!0,error:null,searchQuery:"",currentTab:"notifications",limit:500,statusFilter:"all"}),getters:{filteredSummary(i){if(!i.searchQuery)return i.subjectSummary;const s=i.searchQuery.toLowerCase();return i.subjectSummary.filter(o=>o.subject&&o.subject.toLowerCase().includes(s)||o.initiated_by_display&&o.initiated_by_display.toLowerCase().includes(s))},filteredEntries(i){let s=[...i.entries];if(i.searchQuery){const o=i.searchQuery.toLowerCase();s=s.filter(e=>e.subject&&e.subject.toLowerCase().includes(o)||e.to_display&&e.to_display.toLowerCase().includes(o)||e.initiated_by_display&&e.initiated_by_display.toLowerCase().includes(o))}return i.statusFilter!=="all"&&(i.statusFilter==="pending"?s=s.filter(o=>o.status==="pending"||o.status==="sending"):i.statusFilter==="failed"?s=s.filter(o=>o.status==="failed"):s=s.filter(o=>o.status===i.statusFilter)),s},stats(i){const s=i.subjectSummary.reduce((u,m)=>u+(m.total_count||0),0),o=i.subjectSummary.reduce((u,m)=>u+(m.sent_count||0),0),e=i.subjectSummary.reduce((u,m)=>u+(m.pending_count||0),0),l=i.entries.length,y=i.entries.filter(u=>u.status==="sent").length,x=i.entries.filter(u=>u.status==="pending"||u.status==="sending").length,w=i.entries.filter(u=>u.status==="failed").length;return{notifications:{total:s,sent:o,pending:e},individual:{total:l,sent:y,pending:x,failed:w}}}},actions:{async loadEmailQueue(){this.loading=!0,this.error=null;try{const i=await F(this.limit);if(i.success)this.entries=i.entries||[],this.subjectSummary=i.subjectSummary||[];else throw new Error(i.error)}catch(i){this.error=i.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},formatDate(i){return!i||i==="—"?"—":i},getStatusBadgeClass(i){return{sent:"bg-success",pending:"bg-warning text-dark",sending:"bg-info text-dark",failed:"bg-danger"}[i]||"bg-secondary"},getStatusLabel(i){return{sent:"Envoyé",pending:"En attente",sending:"Envoi en cours",failed:"Échec"}[i]||i},truncate(i,s=60){return i?i.length<=s?i:i.substring(0,s)+"...":""}}}),N={class:"container-fluid mt-4"},A={key:0,class:"text-center py-5"},I={key:1,class:"alert alert-danger"},V={key:2},z={class:"d-flex justify-content-between align-items-center mb-4"},B={class:"d-flex gap-2"},M={class:"row g-3 mb-4"},$={class:"col-md-3"},q={class:"card"},P={class:"card-body"},U={class:"d-flex justify-content-between align-items-center"},J={class:"mb-0"},R={class:"text-success"},G={class:"text-warning"},H={class:"col-md-3"},K={class:"card"},O={class:"card-body"},W={class:"d-flex justify-content-between align-items-center"},X={class:"mb-0"},Y={class:"text-success"},Z={class:"col-md-3"},tt={class:"card"},st={class:"card-body"},et={class:"d-flex justify-content-between align-items-center"},it={class:"mb-0"},nt={class:"col-md-3"},lt={class:"card"},at={class:"card-body"},ot={class:"d-flex justify-content-between align-items-center"},dt={class:"mb-0"},rt={class:"nav nav-tabs mb-3"},ut={class:"nav-item"},ct={class:"nav-item"},mt={class:"row g-3 mb-4"},bt={class:"col-md-8"},_t={key:0,class:"col-md-4"},vt={key:0,class:"card"},ft={class:"table-responsive"},pt={class:"table table-hover mb-0"},ht={key:0},gt={class:"text-center"},yt={class:"badge bg-success"},xt={class:"text-center"},wt={class:"badge bg-warning text-dark"},jt={class:"text-center"},kt={class:"text-muted"},Et={key:1,class:"card"},St={class:"table-responsive"},Ct={class:"table table-hover mb-0"},Qt={key:0},Tt={key:0,class:"text-danger"},Lt={class:"text-muted"},Ft={class:"text-center"},Dt={key:1,class:"text-muted"},Nt={class:"text-muted"},At={class:"mt-3 text-muted text-center"},It={__name:"AdminEmailQueuePage",setup(i){const s=D();return j(()=>{s.loadEmailQueue()}),(o,e)=>(d(),r("div",N,[n(s).loading?(d(),r("div",A,[...e[5]||(e[5]=[t("div",{class:"spinner-border text-primary",role:"status"},null,-1),t("p",{class:"mt-3 text-muted"},"Chargement de la file d'attente...",-1)])])):n(s).error?(d(),r("div",I,a(n(s).error),1)):(d(),r("div",V,[t("div",z,[e[7]||(e[7]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-envelope-paper me-2"}),b("File d'attente email")],-1)),t("div",B,[k(L),t("button",{onClick:e[0]||(e[0]=l=>n(s).loadEmailQueue()),class:"btn btn-outline-primary"},[...e[6]||(e[6]=[t("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),b("Actualiser ",-1)])])])]),t("div",M,[t("div",$,[t("div",q,[t("div",P,[t("div",U,[t("div",null,[e[8]||(e[8]=t("h6",{class:"text-muted mb-1"},"Notifications",-1)),t("h3",J,a(n(s).stats.notifications.total),1)]),e[9]||(e[9]=t("i",{class:"bi bi-bell text-primary",style:{"font-size":"2rem"}},null,-1))]),t("small",R,a(n(s).stats.notifications.sent)+" envoyées",1),e[10]||(e[10]=t("span",{class:"text-muted mx-1"},"·",-1)),t("small",G,a(n(s).stats.notifications.pending)+" en attente",1)])])]),t("div",H,[t("div",K,[t("div",O,[t("div",W,[t("div",null,[e[11]||(e[11]=t("h6",{class:"text-muted mb-1"},"Emails individuels",-1)),t("h3",X,a(n(s).stats.individual.total),1)]),e[12]||(e[12]=t("i",{class:"bi bi-envelope text-info",style:{"font-size":"2rem"}},null,-1))]),t("small",Y,a(n(s).stats.individual.sent)+" envoyés",1)])])]),t("div",Z,[t("div",tt,[t("div",st,[t("div",et,[t("div",null,[e[13]||(e[13]=t("h6",{class:"text-muted mb-1"},"En attente",-1)),t("h3",it,a(n(s).stats.individual.pending),1)]),e[14]||(e[14]=t("i",{class:"bi bi-hourglass-split text-warning",style:{"font-size":"2rem"}},null,-1))])])])]),t("div",nt,[t("div",lt,[t("div",at,[t("div",ot,[t("div",null,[e[15]||(e[15]=t("h6",{class:"text-muted mb-1"},"Échecs",-1)),t("h3",dt,a(n(s).stats.individual.failed),1)]),e[16]||(e[16]=t("i",{class:"bi bi-exclamation-triangle text-danger",style:{"font-size":"2rem"}},null,-1))])])])])]),t("ul",rt,[t("li",ut,[t("a",{class:_(["nav-link",{active:n(s).currentTab==="notifications"}]),href:"javascript:void(0)",onClick:e[1]||(e[1]=v(l=>n(s).currentTab="notifications",["prevent"]))},[e[17]||(e[17]=t("i",{class:"bi bi-bell me-1"},null,-1)),b("Notifications groupées ("+a(n(s).stats.notifications.total)+") ",1)],2)]),t("li",ct,[t("a",{class:_(["nav-link",{active:n(s).currentTab==="individual"}]),href:"javascript:void(0)",onClick:e[2]||(e[2]=v(l=>n(s).currentTab="individual",["prevent"]))},[e[18]||(e[18]=t("i",{class:"bi bi-envelope me-1"},null,-1)),b("Emails individuels ("+a(n(s).stats.individual.total)+") ",1)],2)])]),t("div",mt,[t("div",bt,[f(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>n(s).searchQuery=l),type:"text",class:"form-control",placeholder:"Rechercher par sujet, destinataire ou expéditeur..."},null,512),[[E,n(s).searchQuery]])]),n(s).currentTab==="individual"?(d(),r("div",_t,[f(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>n(s).statusFilter=l),class:"form-select"},[...e[19]||(e[19]=[t("option",{value:"all"},"Tous les statuts",-1),t("option",{value:"sent"},"Envoyés",-1),t("option",{value:"pending"},"En attente",-1),t("option",{value:"failed"},"Échecs",-1)])],512),[[S,n(s).statusFilter]])])):c("",!0)]),n(s).currentTab==="notifications"?(d(),r("div",vt,[t("div",ft,[t("table",pt,[e[21]||(e[21]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"45%"}},"Sujet"),t("th",{style:{width:"20%"}},"Initié par"),t("th",{class:"text-center"},"Envoyés"),t("th",{class:"text-center"},"En attente"),t("th",{class:"text-center"},"Total"),t("th",{style:{width:"15%"}},"Dernière activité")])],-1)),t("tbody",null,[n(s).filteredSummary.length===0?(d(),r("tr",ht,[...e[20]||(e[20]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucune notification trouvée",-1)])])):c("",!0),(d(!0),r(p,null,h(n(s).filteredSummary,l=>(d(),r("tr",{key:l.subject},[t("td",null,a(n(s).truncate(l.subject,80)),1),t("td",null,a(l.initiated_by_display),1),t("td",gt,[t("span",yt,a(l.sent_count),1)]),t("td",xt,[t("span",wt,a(l.pending_count),1)]),t("td",jt,[t("strong",null,a(l.total_count),1)]),t("td",null,[t("small",kt,a(n(s).formatDate(l.last_activity)),1)])]))),128))])])])])):c("",!0),n(s).currentTab==="individual"?(d(),r("div",Et,[t("div",St,[t("table",Ct,[e[23]||(e[23]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"60px"}},"ID"),t("th",null,"Statut"),t("th",{style:{width:"30%"}},"Sujet"),t("th",{style:{width:"20%"}},"Destinataires"),t("th",null,"Tentatives"),t("th",null,"Dernière MAJ")])],-1)),t("tbody",null,[n(s).filteredEntries.length===0?(d(),r("tr",Qt,[...e[22]||(e[22]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucun email trouvé",-1)])])):c("",!0),(d(!0),r(p,null,h(n(s).filteredEntries,l=>(d(),r("tr",{key:l.id},[t("td",null,a(l.id),1),t("td",null,[t("span",{class:_(["badge",n(s).getStatusBadgeClass(l.status)])},a(n(s).getStatusLabel(l.status)),3)]),t("td",null,[t("div",null,a(n(s).truncate(l.subject,50)),1),l.last_error?(d(),r("small",Tt,a(n(s).truncate(l.last_error,60)),1)):c("",!0)]),t("td",null,[t("small",Lt,a(n(s).truncate(l.to_display,40)),1)]),t("td",Ft,[l.attempt_count>0?(d(),r("span",{key:0,class:_(["badge",l.attempt_count>1?"bg-warning text-dark":"bg-secondary"])},a(l.attempt_count),3)):(d(),r("span",Dt,"—"))]),t("td",null,[t("small",Nt,a(n(s).formatDate(l.updated_at_formatted)),1)])]))),128))])])])])):c("",!0),t("div",At,[t("small",null,"Limite: "+a(n(s).limit)+" emails · Les notifications de catalogues et commandes sont groupées",1)])]))]))}},g=C(It);g.use(T());g.mount("#admin-email-queue-app");
