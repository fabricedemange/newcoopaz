import{i as S,o as r,c as u,u as n,a as t,t as l,b,d as m,e as f,k as v,j as k,w as h,n as p,v as Q,s as j,F as _,l as y,h as C}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as L,c as R}from"./chunks/pinia-gLxYYWQL.js";import{_ as T}from"./chunks/BackButton-DzFd1NqY.js";import{a3 as O,a4 as F,a5 as D}from"./chunks/index-CLmjs_4-.js";const N=L("adminEmailQueue",{state:()=>({entries:[],subjectSummary:[],loading:!0,error:null,searchQuery:"",currentTab:"notifications",limit:500,statusFilter:"all",settings:{mailQueueSendEnabled:!1,catalogueOrderReminderEnabled:!1},settingsLoading:!1,settingsError:null}),getters:{filteredSummary(i){if(!i.searchQuery)return i.subjectSummary;const e=i.searchQuery.toLowerCase();return i.subjectSummary.filter(o=>o.subject&&o.subject.toLowerCase().includes(e)||o.initiated_by_display&&o.initiated_by_display.toLowerCase().includes(e))},filteredEntries(i){let e=[...i.entries];if(i.searchQuery){const o=i.searchQuery.toLowerCase();e=e.filter(d=>d.subject&&d.subject.toLowerCase().includes(o)||d.to_display&&d.to_display.toLowerCase().includes(o)||d.initiated_by_display&&d.initiated_by_display.toLowerCase().includes(o))}return i.statusFilter!=="all"&&(i.statusFilter==="pending"?e=e.filter(o=>o.status==="pending"||o.status==="sending"):i.statusFilter==="failed"?e=e.filter(o=>o.status==="failed"):e=e.filter(o=>o.status===i.statusFilter)),e},stats(i){const e=i.subjectSummary.reduce((c,g)=>c+(g.total_count||0),0),o=i.subjectSummary.reduce((c,g)=>c+(g.sent_count||0),0),d=i.subjectSummary.reduce((c,g)=>c+(g.pending_count||0),0),s=i.entries.length,a=i.entries.filter(c=>c.status==="sent").length,x=i.entries.filter(c=>c.status==="pending"||c.status==="sending").length,w=i.entries.filter(c=>c.status==="failed").length;return{notifications:{total:e,sent:o,pending:d},individual:{total:s,sent:a,pending:x,failed:w}}}},actions:{async loadEmailQueue(){this.loading=!0,this.error=null;try{const i=await D(this.limit);if(i.success)this.entries=i.entries||[],this.subjectSummary=i.subjectSummary||[];else throw new Error(i.error)}catch(i){this.error=i.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},async loadSettings(){this.settingsLoading=!0,this.settingsError=null;try{const i=await F();if(i.success)this.settings.mailQueueSendEnabled=!!i.mailQueueSendEnabled,this.settings.catalogueOrderReminderEnabled=!!i.catalogueOrderReminderEnabled;else throw new Error(i.error)}catch(i){this.settingsError=i.message||"Erreur chargement réglages"}finally{this.settingsLoading=!1}},async updateSetting(i,e){const o=i==="mailQueueSendEnabled"?{mailQueueSendEnabled:e}:{catalogueOrderReminderEnabled:e};try{const d=await O(o);if(d.success)this.settings.mailQueueSendEnabled=!!d.mailQueueSendEnabled,this.settings.catalogueOrderReminderEnabled=!!d.catalogueOrderReminderEnabled;else throw new Error(d.error)}catch(d){throw this.settingsError=d.message||"Erreur mise à jour",d}},formatDate(i){return!i||i==="—"?"—":i},getStatusBadgeClass(i){return{sent:"bg-success",pending:"bg-warning text-dark",sending:"bg-info text-dark",failed:"bg-danger"}[i]||"bg-secondary"},getStatusLabel(i){return{sent:"Envoyé",pending:"En attente",sending:"Envoi en cours",failed:"Échec"}[i]||i},truncate(i,e=60){return i?i.length<=e?i:i.substring(0,e)+"...":""}}}),A={class:"container-fluid mt-4"},M={key:0,class:"text-center py-5"},$={key:1,class:"alert alert-danger"},I={key:2},V={key:0,class:"alert alert-warning alert-dismissible fade show"},z={class:"d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2"},B={class:"d-flex flex-wrap gap-3 align-items-center"},U={class:"d-flex gap-3"},q={class:"form-check form-switch mb-0"},P=["disabled"],J={class:"form-check form-switch mb-0"},G=["disabled"],H={class:"d-flex gap-2"},K={class:"row g-3 mb-4"},W={class:"col-md-3"},X={class:"card"},Y={class:"card-body"},Z={class:"d-flex justify-content-between align-items-center"},tt={class:"mb-0"},et={class:"text-success"},st={class:"text-warning"},it={class:"col-md-3"},nt={class:"card"},at={class:"card-body"},lt={class:"d-flex justify-content-between align-items-center"},ot={class:"mb-0"},dt={class:"text-success"},rt={class:"col-md-3"},ut={class:"card"},ct={class:"card-body"},mt={class:"d-flex justify-content-between align-items-center"},gt={class:"mb-0"},bt={class:"col-md-3"},ft={class:"card"},pt={class:"card-body"},vt={class:"d-flex justify-content-between align-items-center"},ht={class:"mb-0"},_t={class:"nav nav-tabs mb-3"},yt={class:"nav-item"},Et={class:"nav-item"},xt={class:"row g-3 mb-4"},wt={class:"col-md-8"},St={key:0,class:"col-md-4"},kt={key:1,class:"card"},Qt={class:"table-responsive"},jt={class:"table table-hover mb-0"},Ct={key:0},Lt={class:"text-center"},Rt={class:"badge bg-success"},Tt={class:"text-center"},Ot={class:"badge bg-warning text-dark"},Ft={class:"text-center"},Dt={class:"text-muted"},Nt={key:2,class:"card"},At={class:"table-responsive"},Mt={class:"table table-hover mb-0"},$t={key:0},It={key:0,class:"text-danger"},Vt={class:"text-muted"},zt={class:"text-center"},Bt={key:1,class:"text-muted"},Ut={class:"text-muted"},qt={class:"mt-3 text-muted text-center"},Pt={__name:"AdminEmailQueuePage",setup(i){const e=N();async function o(d,s){try{await e.updateSetting(d,s)}catch{d==="mailQueueSendEnabled"?e.settings.mailQueueSendEnabled=!s:e.settings.catalogueOrderReminderEnabled=!s}}return S(()=>{e.loadEmailQueue(),e.loadSettings()}),(d,s)=>(r(),u("div",A,[n(e).loading?(r(),u("div",M,[...s[10]||(s[10]=[t("div",{class:"spinner-border text-primary",role:"status"},null,-1),t("p",{class:"mt-3 text-muted"},"Chargement de la file d'attente...",-1)])])):n(e).error?(r(),u("div",$,l(n(e).error),1)):(r(),u("div",I,[n(e).settingsError?(r(),u("div",V,[s[11]||(s[11]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),b(l(n(e).settingsError)+" ",1),t("button",{type:"button",class:"btn-close",onClick:s[0]||(s[0]=a=>n(e).settingsError=null)})])):m("",!0),t("div",z,[s[15]||(s[15]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-envelope-paper me-2"}),b("File d'attente email")],-1)),t("div",B,[t("div",U,[t("div",q,[f(t("input",{id:"toggleMailQueueSend","onUpdate:modelValue":s[1]||(s[1]=a=>n(e).settings.mailQueueSendEnabled=a),class:"form-check-input",type:"checkbox",disabled:n(e).settingsLoading,onChange:s[2]||(s[2]=a=>o("mailQueueSendEnabled",n(e).settings.mailQueueSendEnabled))},null,40,P),[[v,n(e).settings.mailQueueSendEnabled]]),s[12]||(s[12]=t("label",{class:"form-check-label",for:"toggleMailQueueSend"},"Envoi des emails (file)",-1))]),t("div",J,[f(t("input",{id:"toggleCatalogueReminder","onUpdate:modelValue":s[3]||(s[3]=a=>n(e).settings.catalogueOrderReminderEnabled=a),class:"form-check-input",type:"checkbox",disabled:n(e).settingsLoading,onChange:s[4]||(s[4]=a=>o("catalogueOrderReminderEnabled",n(e).settings.catalogueOrderReminderEnabled))},null,40,G),[[v,n(e).settings.catalogueOrderReminderEnabled]]),s[13]||(s[13]=t("label",{class:"form-check-label",for:"toggleCatalogueReminder"},"Rappels catalogue (expiration + 8h)",-1))])]),t("div",H,[k(T),t("button",{onClick:s[5]||(s[5]=a=>n(e).loadEmailQueue()),class:"btn btn-outline-primary"},[...s[14]||(s[14]=[t("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),b("Actualiser ",-1)])])])])]),t("div",K,[t("div",W,[t("div",X,[t("div",Y,[t("div",Z,[t("div",null,[s[16]||(s[16]=t("h6",{class:"text-muted mb-1"},"Notifications",-1)),t("h3",tt,l(n(e).stats.notifications.total),1)]),s[17]||(s[17]=t("i",{class:"bi bi-bell text-primary",style:{"font-size":"2rem"}},null,-1))]),t("small",et,l(n(e).stats.notifications.sent)+" envoyées",1),s[18]||(s[18]=t("span",{class:"text-muted mx-1"},"·",-1)),t("small",st,l(n(e).stats.notifications.pending)+" en attente",1)])])]),t("div",it,[t("div",nt,[t("div",at,[t("div",lt,[t("div",null,[s[19]||(s[19]=t("h6",{class:"text-muted mb-1"},"Emails individuels",-1)),t("h3",ot,l(n(e).stats.individual.total),1)]),s[20]||(s[20]=t("i",{class:"bi bi-envelope text-info",style:{"font-size":"2rem"}},null,-1))]),t("small",dt,l(n(e).stats.individual.sent)+" envoyés",1)])])]),t("div",rt,[t("div",ut,[t("div",ct,[t("div",mt,[t("div",null,[s[21]||(s[21]=t("h6",{class:"text-muted mb-1"},"En attente",-1)),t("h3",gt,l(n(e).stats.individual.pending),1)]),s[22]||(s[22]=t("i",{class:"bi bi-hourglass-split text-warning",style:{"font-size":"2rem"}},null,-1))])])])]),t("div",bt,[t("div",ft,[t("div",pt,[t("div",vt,[t("div",null,[s[23]||(s[23]=t("h6",{class:"text-muted mb-1"},"Échecs",-1)),t("h3",ht,l(n(e).stats.individual.failed),1)]),s[24]||(s[24]=t("i",{class:"bi bi-exclamation-triangle text-danger",style:{"font-size":"2rem"}},null,-1))])])])])]),t("ul",_t,[t("li",yt,[t("a",{class:p(["nav-link",{active:n(e).currentTab==="notifications"}]),href:"javascript:void(0)",onClick:s[6]||(s[6]=h(a=>n(e).currentTab="notifications",["prevent"]))},[s[25]||(s[25]=t("i",{class:"bi bi-bell me-1"},null,-1)),b("Notifications groupées ("+l(n(e).stats.notifications.total)+") ",1)],2)]),t("li",Et,[t("a",{class:p(["nav-link",{active:n(e).currentTab==="individual"}]),href:"javascript:void(0)",onClick:s[7]||(s[7]=h(a=>n(e).currentTab="individual",["prevent"]))},[s[26]||(s[26]=t("i",{class:"bi bi-envelope me-1"},null,-1)),b("Emails individuels ("+l(n(e).stats.individual.total)+") ",1)],2)])]),t("div",xt,[t("div",wt,[f(t("input",{"onUpdate:modelValue":s[8]||(s[8]=a=>n(e).searchQuery=a),type:"text",class:"form-control",placeholder:"Rechercher par sujet, destinataire ou expéditeur..."},null,512),[[Q,n(e).searchQuery]])]),n(e).currentTab==="individual"?(r(),u("div",St,[f(t("select",{"onUpdate:modelValue":s[9]||(s[9]=a=>n(e).statusFilter=a),class:"form-select"},[...s[27]||(s[27]=[t("option",{value:"all"},"Tous les statuts",-1),t("option",{value:"sent"},"Envoyés",-1),t("option",{value:"pending"},"En attente",-1),t("option",{value:"failed"},"Échecs",-1)])],512),[[j,n(e).statusFilter]])])):m("",!0)]),n(e).currentTab==="notifications"?(r(),u("div",kt,[t("div",Qt,[t("table",jt,[s[29]||(s[29]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"45%"}},"Sujet"),t("th",{style:{width:"20%"}},"Initié par"),t("th",{class:"text-center"},"Envoyés"),t("th",{class:"text-center"},"En attente"),t("th",{class:"text-center"},"Total"),t("th",{style:{width:"15%"}},"Dernière activité")])],-1)),t("tbody",null,[n(e).filteredSummary.length===0?(r(),u("tr",Ct,[...s[28]||(s[28]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucune notification trouvée",-1)])])):m("",!0),(r(!0),u(_,null,y(n(e).filteredSummary,a=>(r(),u("tr",{key:a.subject},[t("td",null,l(n(e).truncate(a.subject,80)),1),t("td",null,l(a.initiated_by_display),1),t("td",Lt,[t("span",Rt,l(a.sent_count),1)]),t("td",Tt,[t("span",Ot,l(a.pending_count),1)]),t("td",Ft,[t("strong",null,l(a.total_count),1)]),t("td",null,[t("small",Dt,l(n(e).formatDate(a.last_activity)),1)])]))),128))])])])])):m("",!0),n(e).currentTab==="individual"?(r(),u("div",Nt,[t("div",At,[t("table",Mt,[s[31]||(s[31]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"60px"}},"ID"),t("th",null,"Statut"),t("th",{style:{width:"30%"}},"Sujet"),t("th",{style:{width:"20%"}},"Destinataires"),t("th",null,"Tentatives"),t("th",null,"Dernière MAJ")])],-1)),t("tbody",null,[n(e).filteredEntries.length===0?(r(),u("tr",$t,[...s[30]||(s[30]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucun email trouvé",-1)])])):m("",!0),(r(!0),u(_,null,y(n(e).filteredEntries,a=>(r(),u("tr",{key:a.id},[t("td",null,l(a.id),1),t("td",null,[t("span",{class:p(["badge",n(e).getStatusBadgeClass(a.status)])},l(n(e).getStatusLabel(a.status)),3)]),t("td",null,[t("div",null,l(n(e).truncate(a.subject,50)),1),a.last_error?(r(),u("small",It,l(n(e).truncate(a.last_error,60)),1)):m("",!0)]),t("td",null,[t("small",Vt,l(n(e).truncate(a.to_display,40)),1)]),t("td",zt,[a.attempt_count>0?(r(),u("span",{key:0,class:p(["badge",a.attempt_count>1?"bg-warning text-dark":"bg-secondary"])},l(a.attempt_count),3)):(r(),u("span",Bt,"—"))]),t("td",null,[t("small",Ut,l(n(e).formatDate(a.updated_at_formatted)),1)])]))),128))])])])])):m("",!0),t("div",qt,[t("small",null,"Limite: "+l(n(e).limit)+" emails · Les notifications de catalogues et commandes sont groupées",1)])]))]))}},E=C(Pt);E.use(R());E.mount("#admin-email-queue-app");
