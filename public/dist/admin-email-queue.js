import{i as k,o as d,c as r,u as n,a as t,t as a,b,w as v,n as _,e as f,v as j,q as E,d as c,F as p,k as h,h as S}from"./chunks/runtime-dom.esm-bundler-C8CGTSXe.js";import{d as C,c as Q}from"./chunks/pinia-DIU_KYYh.js";import{$ as T}from"./chunks/index-zlPV8JO4.js";const L=C("adminEmailQueue",{state:()=>({entries:[],subjectSummary:[],loading:!0,error:null,searchQuery:"",currentTab:"notifications",limit:500,statusFilter:"all"}),getters:{filteredSummary(i){if(!i.searchQuery)return i.subjectSummary;const s=i.searchQuery.toLowerCase();return i.subjectSummary.filter(o=>o.subject&&o.subject.toLowerCase().includes(s)||o.initiated_by_display&&o.initiated_by_display.toLowerCase().includes(s))},filteredEntries(i){let s=[...i.entries];if(i.searchQuery){const o=i.searchQuery.toLowerCase();s=s.filter(e=>e.subject&&e.subject.toLowerCase().includes(o)||e.to_display&&e.to_display.toLowerCase().includes(o)||e.initiated_by_display&&e.initiated_by_display.toLowerCase().includes(o))}return i.statusFilter!=="all"&&(i.statusFilter==="pending"?s=s.filter(o=>o.status==="pending"||o.status==="sending"):i.statusFilter==="failed"?s=s.filter(o=>o.status==="failed"):s=s.filter(o=>o.status===i.statusFilter)),s},stats(i){const s=i.subjectSummary.reduce((u,m)=>u+(m.total_count||0),0),o=i.subjectSummary.reduce((u,m)=>u+(m.sent_count||0),0),e=i.subjectSummary.reduce((u,m)=>u+(m.pending_count||0),0),l=i.entries.length,y=i.entries.filter(u=>u.status==="sent").length,x=i.entries.filter(u=>u.status==="pending"||u.status==="sending").length,w=i.entries.filter(u=>u.status==="failed").length;return{notifications:{total:s,sent:o,pending:e},individual:{total:l,sent:y,pending:x,failed:w}}}},actions:{async loadEmailQueue(){this.loading=!0,this.error=null;try{const i=await T(this.limit);if(i.success)this.entries=i.entries||[],this.subjectSummary=i.subjectSummary||[];else throw new Error(i.error)}catch(i){this.error=i.message||"Erreur de connexion au serveur"}finally{this.loading=!1}},formatDate(i){return!i||i==="—"?"—":i},getStatusBadgeClass(i){return{sent:"bg-success",pending:"bg-warning text-dark",sending:"bg-info text-dark",failed:"bg-danger"}[i]||"bg-secondary"},getStatusLabel(i){return{sent:"Envoyé",pending:"En attente",sending:"Envoi en cours",failed:"Échec"}[i]||i},truncate(i,s=60){return i?i.length<=s?i:i.substring(0,s)+"...":""}}}),F={class:"container-fluid mt-4"},D={key:0,class:"text-center py-5"},A={key:1,class:"alert alert-danger"},N={key:2},I={class:"d-flex justify-content-between align-items-center mb-4"},z={class:"row g-3 mb-4"},B={class:"col-md-3"},M={class:"card"},V={class:"card-body"},q={class:"d-flex justify-content-between align-items-center"},$={class:"mb-0"},P={class:"text-success"},U={class:"text-warning"},J={class:"col-md-3"},R={class:"card"},G={class:"card-body"},H={class:"d-flex justify-content-between align-items-center"},K={class:"mb-0"},O={class:"text-success"},W={class:"col-md-3"},X={class:"card"},Y={class:"card-body"},Z={class:"d-flex justify-content-between align-items-center"},tt={class:"mb-0"},st={class:"col-md-3"},et={class:"card"},it={class:"card-body"},nt={class:"d-flex justify-content-between align-items-center"},lt={class:"mb-0"},at={class:"nav nav-tabs mb-3"},ot={class:"nav-item"},dt={class:"nav-item"},rt={class:"row g-3 mb-4"},ut={class:"col-md-8"},ct={key:0,class:"col-md-4"},mt={key:0,class:"card"},bt={class:"table-responsive"},_t={class:"table table-hover mb-0"},vt={key:0},ft={class:"text-center"},pt={class:"badge bg-success"},ht={class:"text-center"},gt={class:"badge bg-warning text-dark"},yt={class:"text-center"},xt={class:"text-muted"},wt={key:1,class:"card"},kt={class:"table-responsive"},jt={class:"table table-hover mb-0"},Et={key:0},St={key:0,class:"text-danger"},Ct={class:"text-muted"},Qt={class:"text-center"},Tt={key:1,class:"text-muted"},Lt={class:"text-muted"},Ft={class:"mt-3 text-muted text-center"},Dt={__name:"AdminEmailQueuePage",setup(i){const s=L();return k(()=>{s.loadEmailQueue()}),(o,e)=>(d(),r("div",F,[n(s).loading?(d(),r("div",D,[...e[5]||(e[5]=[t("div",{class:"spinner-border text-primary",role:"status"},null,-1),t("p",{class:"mt-3 text-muted"},"Chargement de la file d'attente...",-1)])])):n(s).error?(d(),r("div",A,a(n(s).error),1)):(d(),r("div",N,[t("div",I,[e[7]||(e[7]=t("h2",null,[t("i",{class:"bi bi-envelope-paper me-2"}),b("File d'attente email")],-1)),t("button",{onClick:e[0]||(e[0]=l=>n(s).loadEmailQueue()),class:"btn btn-outline-primary"},[...e[6]||(e[6]=[t("i",{class:"bi bi-arrow-clockwise me-2"},null,-1),b("Actualiser ",-1)])])]),t("div",z,[t("div",B,[t("div",M,[t("div",V,[t("div",q,[t("div",null,[e[8]||(e[8]=t("h6",{class:"text-muted mb-1"},"Notifications",-1)),t("h3",$,a(n(s).stats.notifications.total),1)]),e[9]||(e[9]=t("i",{class:"bi bi-bell text-primary",style:{"font-size":"2rem"}},null,-1))]),t("small",P,a(n(s).stats.notifications.sent)+" envoyées",1),e[10]||(e[10]=t("span",{class:"text-muted mx-1"},"·",-1)),t("small",U,a(n(s).stats.notifications.pending)+" en attente",1)])])]),t("div",J,[t("div",R,[t("div",G,[t("div",H,[t("div",null,[e[11]||(e[11]=t("h6",{class:"text-muted mb-1"},"Emails individuels",-1)),t("h3",K,a(n(s).stats.individual.total),1)]),e[12]||(e[12]=t("i",{class:"bi bi-envelope text-info",style:{"font-size":"2rem"}},null,-1))]),t("small",O,a(n(s).stats.individual.sent)+" envoyés",1)])])]),t("div",W,[t("div",X,[t("div",Y,[t("div",Z,[t("div",null,[e[13]||(e[13]=t("h6",{class:"text-muted mb-1"},"En attente",-1)),t("h3",tt,a(n(s).stats.individual.pending),1)]),e[14]||(e[14]=t("i",{class:"bi bi-hourglass-split text-warning",style:{"font-size":"2rem"}},null,-1))])])])]),t("div",st,[t("div",et,[t("div",it,[t("div",nt,[t("div",null,[e[15]||(e[15]=t("h6",{class:"text-muted mb-1"},"Échecs",-1)),t("h3",lt,a(n(s).stats.individual.failed),1)]),e[16]||(e[16]=t("i",{class:"bi bi-exclamation-triangle text-danger",style:{"font-size":"2rem"}},null,-1))])])])])]),t("ul",at,[t("li",ot,[t("a",{class:_(["nav-link",{active:n(s).currentTab==="notifications"}]),href:"javascript:void(0)",onClick:e[1]||(e[1]=v(l=>n(s).currentTab="notifications",["prevent"]))},[e[17]||(e[17]=t("i",{class:"bi bi-bell me-1"},null,-1)),b("Notifications groupées ("+a(n(s).stats.notifications.total)+") ",1)],2)]),t("li",dt,[t("a",{class:_(["nav-link",{active:n(s).currentTab==="individual"}]),href:"javascript:void(0)",onClick:e[2]||(e[2]=v(l=>n(s).currentTab="individual",["prevent"]))},[e[18]||(e[18]=t("i",{class:"bi bi-envelope me-1"},null,-1)),b("Emails individuels ("+a(n(s).stats.individual.total)+") ",1)],2)])]),t("div",rt,[t("div",ut,[f(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>n(s).searchQuery=l),type:"text",class:"form-control",placeholder:"Rechercher par sujet, destinataire ou expéditeur..."},null,512),[[j,n(s).searchQuery]])]),n(s).currentTab==="individual"?(d(),r("div",ct,[f(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>n(s).statusFilter=l),class:"form-select"},[...e[19]||(e[19]=[t("option",{value:"all"},"Tous les statuts",-1),t("option",{value:"sent"},"Envoyés",-1),t("option",{value:"pending"},"En attente",-1),t("option",{value:"failed"},"Échecs",-1)])],512),[[E,n(s).statusFilter]])])):c("",!0)]),n(s).currentTab==="notifications"?(d(),r("div",mt,[t("div",bt,[t("table",_t,[e[21]||(e[21]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"45%"}},"Sujet"),t("th",{style:{width:"20%"}},"Initié par"),t("th",{class:"text-center"},"Envoyés"),t("th",{class:"text-center"},"En attente"),t("th",{class:"text-center"},"Total"),t("th",{style:{width:"15%"}},"Dernière activité")])],-1)),t("tbody",null,[n(s).filteredSummary.length===0?(d(),r("tr",vt,[...e[20]||(e[20]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucune notification trouvée",-1)])])):c("",!0),(d(!0),r(p,null,h(n(s).filteredSummary,l=>(d(),r("tr",{key:l.subject},[t("td",null,a(n(s).truncate(l.subject,80)),1),t("td",null,a(l.initiated_by_display),1),t("td",ft,[t("span",pt,a(l.sent_count),1)]),t("td",ht,[t("span",gt,a(l.pending_count),1)]),t("td",yt,[t("strong",null,a(l.total_count),1)]),t("td",null,[t("small",xt,a(n(s).formatDate(l.last_activity)),1)])]))),128))])])])])):c("",!0),n(s).currentTab==="individual"?(d(),r("div",wt,[t("div",kt,[t("table",jt,[e[23]||(e[23]=t("thead",{class:"thead-admin-site"},[t("tr",null,[t("th",{style:{width:"60px"}},"ID"),t("th",null,"Statut"),t("th",{style:{width:"30%"}},"Sujet"),t("th",{style:{width:"20%"}},"Destinataires"),t("th",null,"Tentatives"),t("th",null,"Dernière MAJ")])],-1)),t("tbody",null,[n(s).filteredEntries.length===0?(d(),r("tr",Et,[...e[22]||(e[22]=[t("td",{colspan:"6",class:"text-center text-muted py-4"},"Aucun email trouvé",-1)])])):c("",!0),(d(!0),r(p,null,h(n(s).filteredEntries,l=>(d(),r("tr",{key:l.id},[t("td",null,a(l.id),1),t("td",null,[t("span",{class:_(["badge",n(s).getStatusBadgeClass(l.status)])},a(n(s).getStatusLabel(l.status)),3)]),t("td",null,[t("div",null,a(n(s).truncate(l.subject,50)),1),l.last_error?(d(),r("small",St,a(n(s).truncate(l.last_error,60)),1)):c("",!0)]),t("td",null,[t("small",Ct,a(n(s).truncate(l.to_display,40)),1)]),t("td",Qt,[l.attempt_count>0?(d(),r("span",{key:0,class:_(["badge",l.attempt_count>1?"bg-warning text-dark":"bg-secondary"])},a(l.attempt_count),3)):(d(),r("span",Tt,"—"))]),t("td",null,[t("small",Lt,a(n(s).formatDate(l.updated_at_formatted)),1)])]))),128))])])])])):c("",!0),t("div",Ft,[t("small",null,"Limite: "+a(n(s).limit)+" emails · Les notifications de catalogues et commandes sont groupées",1)])]))]))}},g=S(Dt);g.use(Q());g.mount("#admin-email-queue-app");
