import{i as A,o as r,c as l,u as a,a as e,b as v,t as o,F as p,j as S,d as m,e as _,v as y,l as b,n as f,w as g,h as x}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as $,c as D}from"./chunks/pinia-gLxYYWQL.js";import{_ as E}from"./chunks/BackButton-DzFd1NqY.js";import{aw as V,ax as R}from"./chunks/index-fBysSQKd.js";function C(i,t){if(!t)return i;const u=t.toLowerCase();return i.filter(h=>h.originalname&&h.originalname.toLowerCase().includes(u)||h.username&&h.username.toLowerCase().includes(u)||h.organization_name&&h.organization_name.toLowerCase().includes(u)||h.description&&h.description.toLowerCase().includes(u))}function w(i,t,u){return!i||i.length===0?i:[...i].sort((c,n)=>{let s=c[t],d=n[t];return t==="expiration_date"||t==="livraison_date"?(s=s?new Date(s).getTime():0,d=d?new Date(d).getTime():0):t==="id"||t==="nb_paniers"||t==="is_archived"?(s=Number(s)||0,d=Number(d)||0):(s=(s||"").toString().toLowerCase(),d=(d||"").toString().toLowerCase()),s<d?u==="asc"?-1:1:s>d?u==="asc"?1:-1:0})}const N=$("adminCatalogues",{state:()=>({catalogues:[],archivedCatalogues:[],loading:!0,error:null,role:null,referentScopeActive:!1,showAllScope:!0,searchActive:"",searchArchived:"",sortColumnActive:"id",sortDirectionActive:"desc",sortColumnArchived:"id",sortDirectionArchived:"desc"}),getters:{activeCataloguesSorted(i){const t=C(i.catalogues,i.searchActive);return w(t,i.sortColumnActive,i.sortDirectionActive)},archivedCataloguesSorted(i){const t=C(i.archivedCatalogues,i.searchArchived);return w(t,i.sortColumnArchived,i.sortDirectionArchived)},isSuperAdmin(i){return i.role==="SuperAdmin"}},actions:{async loadCatalogues(i){this.loading=!0,this.error=null;try{const t=await R(i);if(t.success)this.catalogues=t.catalogues||[],this.archivedCatalogues=t.archivedCatalogues||[],this.role=t.role,this.referentScopeActive=t.referentScopeActive,this.showAllScope=t.showAllScope;else throw new Error(t.error||"Erreur lors du chargement des catalogues")}catch(t){this.error=t.message||"Erreur lors du chargement"}finally{this.loading=!1}},handleSort(i,t){t?this.sortColumnArchived===i?this.sortDirectionArchived=this.sortDirectionArchived==="asc"?"desc":"asc":(this.sortColumnArchived=i,this.sortDirectionArchived="asc"):this.sortColumnActive===i?this.sortDirectionActive=this.sortDirectionActive==="asc"?"desc":"asc":(this.sortColumnActive=i,this.sortDirectionActive="asc")},getVisibilityBadge(i){const t={0:{label:"Visible",class:"bg-success"},2:{label:"Référents seulement",class:"bg-warning"},3:{label:"Masqué",class:"bg-secondary"}};return t[i]??t[0]},async changeVisibility(i,t){const u=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/visibility`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":u},credentials:"include",body:JSON.stringify({is_archived:t})})).ok)throw new Error("Erreur lors du changement de visibilité");const c=new URLSearchParams(window.location.search);await this.loadCatalogues(c.get("scope"))},async archiveCatalogue(i){confirm("Confirmer l'archivage de ce catalogue ?")&&await this.changeVisibility(i,3)},async unarchiveCatalogue(i){confirm("Confirmer la désarchivage de ce catalogue ?")&&await this.changeVisibility(i,0)},async deleteCatalogue(i){confirm("Masquer complètement ce catalogue ? Il restera accessible dans l'historique des commandes mais ne sera plus visible dans les listes.")&&await this.changeVisibility(i,3)},async sendAlerteMail(i){let t=null;try{const c=await V(i);c.success&&c.count!=null&&(t=Number(c.count))}catch{t=null}if(t===0){alert("Aucun destinataire : aucune personne n'a commandé ce catalogue (avec compte validé et email). L'envoi d'alerte n'est pas possible.");return}if(t===null){if(!confirm("Impossible de récupérer le nombre de destinataires. Envoyer l'alerte quand même ?"))return}else if(!confirm(`Envoyer une alerte par mail à ${t} personne(s) ayant commandé ce catalogue ?`))return;const u=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/alerte`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":u},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail d'alerte envoyé avec succès !")},async sendRappelMail(i){if(!confirm("Envoyer un rappel par mail à tous les utilisateurs ?"))return;const t=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/rappel`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":t},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail de rappel envoyé avec succès !")},async loadData(){const t=new URLSearchParams(window.location.search).get("scope")||(this.referentScopeActive?"all":null);await this.loadCatalogues(t)}}}),M={class:"container-fluid mt-4"},T={key:0,class:"text-center py-5"},O={key:1,class:"alert alert-danger"},L={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},P={class:"d-flex gap-2 align-items-center"},F={class:"card mb-4"},q={class:"card-body"},B={class:"mb-3"},K={key:0,class:"alert alert-info"},j={key:1,class:"table-responsive d-none d-lg-block"},z={class:"table table-hover"},U={class:"thead-administration"},I={key:0},G={key:0},J={class:"text-muted"},H={key:0,class:"text-muted"},Q={key:0},W={key:1},X={class:"badge bg-primary"},Y={class:"text-end"},Z=["href"],ee=["href"],te=["href"],se={class:"btn-group btn-group-sm d-inline"},ne={class:"dropdown-menu dropdown-menu-end"},ie=["onClick"],ae=["onClick"],oe=["onClick"],re=["onClick"],le=["onClick"],de={class:"d-lg-none"},ce={class:"card-body"},ue={class:"card-title"},he={class:"text-muted small mb-2"},me={class:"d-flex gap-2 flex-wrap"},pe=["href"],ge=["href"],be=["href"],ve=["onClick"],fe={class:"card"},_e={class:"card-body"},ye={class:"mb-3"},Ce={key:0,class:"alert alert-info"},we={key:1,class:"table-responsive d-none d-lg-block"},ke={class:"table table-hover"},Ae={class:"thead-administration"},Se={key:0},xe={key:0},$e={class:"text-muted"},De={class:"badge bg-primary"},Ee={class:"text-end"},Ve=["href"],Re=["href"],Ne=["onClick"],Me=["onClick"],Te={class:"d-lg-none"},Oe={class:"card-body"},Le={class:"card-title"},Pe={class:"text-muted small mb-2"},Fe={class:"d-flex gap-2 flex-wrap"},qe=["href"],Be=["href"],Ke=["onClick"],je=["onClick"],ze={__name:"AdminCataloguesPage",setup(i){const t=N();function u(c,n=200){return c?c.length>n?c.substring(0,n)+"...":c:""}function h(){const c=t.showAllScope?"referent":"all";window.location.href=`/admin/catalogues/vue?scope=${c}`}return A(()=>{t.loadData()}),(c,n)=>(r(),l("div",M,[a(t).loading?(r(),l("div",T,[...n[10]||(n[10]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Chargement...")],-1),e("p",{class:"mt-3 text-muted"},"Chargement des catalogues...",-1)])])):a(t).error?(r(),l("div",O,[v(o(a(t).error)+" ",1),e("button",{type:"button",class:"btn btn-primary ms-2",onClick:n[0]||(n[0]=s=>a(t).loadData())},"Réessayer")])):(r(),l(p,{key:2},[e("div",L,[n[12]||(n[12]=e("h2",null,"Gestion des catalogues",-1)),e("div",P,[S(E),n[11]||(n[11]=e("a",{href:"/admin/catalogues/new",class:"btn btn-success"},[e("i",{class:"bi bi-plus-circle me-1"}),v("Nouveau catalogue ")],-1)),a(t).referentScopeActive?(r(),l("button",{key:0,type:"button",class:"btn btn-outline-primary",onClick:h},o(a(t).showAllScope?"Voir mes catalogues uniquement":"Voir tous les catalogues"),1)):m("",!0)])]),e("div",F,[n[18]||(n[18]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues actifs")],-1)),e("div",q,[e("div",B,[_(e("input",{"onUpdate:modelValue":n[1]||(n[1]=s=>a(t).searchActive=s),type:"text",class:"form-control",placeholder:"Rechercher (nom, référent, org...)"},null,512),[[y,a(t).searchActive]])]),a(t).activeCataloguesSorted.length===0?(r(),l("div",K," Aucun catalogue actif ")):(r(),l("div",j,[e("table",z,[e("thead",U,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[2]||(n[2]=s=>a(t).handleSort("id",!1))},"ID"),a(t).isSuperAdmin?(r(),l("th",I,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[3]||(n[3]=s=>a(t).handleSort("originalname",!1))},"Catalogue"),e("th",{style:{cursor:"pointer"},onClick:n[4]||(n[4]=s=>a(t).handleSort("username",!1))},"Référent"),e("th",{style:{cursor:"pointer"},onClick:n[5]||(n[5]=s=>a(t).handleSort("expiration_date",!1))},"Expiration"),e("th",{style:{cursor:"pointer"},onClick:n[6]||(n[6]=s=>a(t).handleSort("nb_paniers",!1))},"Commandes"),n[13]||(n[13]=e("th",null,"Visibilité",-1)),n[14]||(n[14]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(a(t).activeCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,o(s.id),1)]),a(t).isSuperAdmin?(r(),l("td",G,[e("small",J,o(s.organization_name||"-"),1)])):m("",!0),e("td",null,[e("div",null,o(s.originalname),1),s.description?(r(),l("small",H,o(u(s.description,80)),1)):m("",!0)]),e("td",null,o(s.username),1),e("td",{class:f(s.isExpired?"text-danger fw-bold":"")},[v(o(s.expiration_formatted||"-")+" ",1),s.expiration_day?(r(),l("br",Q)):m("",!0),s.expiration_day?(r(),l("small",W,o(s.expiration_day),1)):m("",!0)],2),e("td",null,[e("span",X,o(s.nb_paniers||0),1)]),e("td",null,[e("span",{class:f("badge "+a(t).getVisibilityBadge(s.is_archived).class)},o(a(t).getVisibilityBadge(s.is_archived).label),3)]),e("td",Y,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,Z),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,ee),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,te),e("div",se,[n[17]||(n[17]=e("button",{type:"button",class:"btn btn-outline-secondary dropdown-toggle","data-bs-toggle":"dropdown"},"Actions",-1)),e("ul",ne,[e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).changeVisibility(s.id,0),["prevent"])},"Visible de tous",8,ie)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).changeVisibility(s.id,2),["prevent"])},"Référents seulement",8,ae)]),n[15]||(n[15]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).sendAlerteMail(s.id),["prevent"])},"Notifier dispo",8,oe)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).sendRappelMail(s.id),["prevent"])},"Rappel commande",8,re)]),n[16]||(n[16]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item text-warning",href:"#",onClick:g(d=>a(t).archiveCatalogue(s.id),["prevent"])},"Archiver",8,le)])])])])]))),128))])])])),e("div",de,[(r(!0),l(p,null,b(a(t).activeCataloguesSorted,s=>(r(),l("div",{key:"a-"+s.id,class:"card mb-3 shadow-sm"},[e("div",ce,[e("h6",ue,"#"+o(s.id)+" - "+o(s.originalname),1),e("p",he,o(s.username)+" · "+o(s.nb_paniers||0)+" commandes",1),e("p",{class:f(s.isExpired?"text-danger":"")},o(s.expiration_formatted||"-"),3),e("div",me,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-primary"},"Modifier",8,pe),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,ge),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,be),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>a(t).archiveCatalogue(s.id)},"Archiver",8,ve)])])]))),128))])])]),e("div",fe,[n[23]||(n[23]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues archivés")],-1)),e("div",_e,[e("div",ye,[_(e("input",{"onUpdate:modelValue":n[7]||(n[7]=s=>a(t).searchArchived=s),type:"text",class:"form-control",placeholder:"Rechercher..."},null,512),[[y,a(t).searchArchived]])]),a(t).archivedCataloguesSorted.length===0?(r(),l("div",Ce," Aucun catalogue archivé ")):(r(),l("div",we,[e("table",ke,[e("thead",Ae,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[8]||(n[8]=s=>a(t).handleSort("id",!0))},"ID"),a(t).isSuperAdmin?(r(),l("th",Se,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[9]||(n[9]=s=>a(t).handleSort("originalname",!0))},"Catalogue"),n[19]||(n[19]=e("th",null,"Référent",-1)),n[20]||(n[20]=e("th",null,"Expiration",-1)),n[21]||(n[21]=e("th",null,"Commandes",-1)),n[22]||(n[22]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(a(t).archivedCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,o(s.id),1)]),a(t).isSuperAdmin?(r(),l("td",xe,[e("small",$e,o(s.organization_name||"-"),1)])):m("",!0),e("td",null,o(s.originalname),1),e("td",null,o(s.username),1),e("td",null,o(s.expiration_formatted||"-"),1),e("td",null,[e("span",De,o(s.nb_paniers||0),1)]),e("td",Ee,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,Ve),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,Re),e("button",{type:"button",class:"btn btn-sm btn-outline-warning me-1",onClick:d=>a(t).unarchiveCatalogue(s.id)},"Désarchiver",8,Ne),e("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:d=>a(t).deleteCatalogue(s.id)},"Masquer",8,Me)])]))),128))])])])),e("div",Te,[(r(!0),l(p,null,b(a(t).archivedCataloguesSorted,s=>(r(),l("div",{key:"ar-"+s.id,class:"card mb-3 shadow-sm"},[e("div",Oe,[e("h6",Le,"#"+o(s.id)+" - "+o(s.originalname),1),e("p",Pe,o(s.username)+" · "+o(s.nb_paniers||0)+" commandes",1),e("div",Fe,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,qe),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,Be),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>a(t).unarchiveCatalogue(s.id)},"Désarchiver",8,Ke),e("button",{type:"button",class:"btn btn-sm btn-danger",onClick:d=>a(t).deleteCatalogue(s.id)},"Masquer",8,je)])])]))),128))])])])],64))]))}},k=x(ze);k.use(D());k.mount("#admin-catalogues-app");
