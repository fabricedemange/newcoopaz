import{i as A,o as r,c as l,u as a,a as e,b as v,t as o,F as p,d as m,e as _,v as y,k as b,n as f,w as g,h as S}from"./chunks/runtime-dom.esm-bundler-C8CGTSXe.js";import{d as x,c as $}from"./chunks/pinia-DIU_KYYh.js";import{as as D,at as E}from"./chunks/index-zlPV8JO4.js";function C(i,t){if(!t)return i;const u=t.toLowerCase();return i.filter(h=>h.originalname&&h.originalname.toLowerCase().includes(u)||h.username&&h.username.toLowerCase().includes(u)||h.organization_name&&h.organization_name.toLowerCase().includes(u)||h.description&&h.description.toLowerCase().includes(u))}function w(i,t,u){return!i||i.length===0?i:[...i].sort((c,n)=>{let s=c[t],d=n[t];return t==="expiration_date"||t==="livraison_date"?(s=s?new Date(s).getTime():0,d=d?new Date(d).getTime():0):t==="id"||t==="nb_paniers"||t==="is_archived"?(s=Number(s)||0,d=Number(d)||0):(s=(s||"").toString().toLowerCase(),d=(d||"").toString().toLowerCase()),s<d?u==="asc"?-1:1:s>d?u==="asc"?1:-1:0})}const V=x("adminCatalogues",{state:()=>({catalogues:[],archivedCatalogues:[],loading:!0,error:null,role:null,referentScopeActive:!1,showAllScope:!0,searchActive:"",searchArchived:"",sortColumnActive:"id",sortDirectionActive:"desc",sortColumnArchived:"id",sortDirectionArchived:"desc"}),getters:{activeCataloguesSorted(i){const t=C(i.catalogues,i.searchActive);return w(t,i.sortColumnActive,i.sortDirectionActive)},archivedCataloguesSorted(i){const t=C(i.archivedCatalogues,i.searchArchived);return w(t,i.sortColumnArchived,i.sortDirectionArchived)},isSuperAdmin(i){return i.role==="SuperAdmin"}},actions:{async loadCatalogues(i){this.loading=!0,this.error=null;try{const t=await E(i);if(t.success)this.catalogues=t.catalogues||[],this.archivedCatalogues=t.archivedCatalogues||[],this.role=t.role,this.referentScopeActive=t.referentScopeActive,this.showAllScope=t.showAllScope;else throw new Error(t.error||"Erreur lors du chargement des catalogues")}catch(t){this.error=t.message||"Erreur lors du chargement"}finally{this.loading=!1}},handleSort(i,t){t?this.sortColumnArchived===i?this.sortDirectionArchived=this.sortDirectionArchived==="asc"?"desc":"asc":(this.sortColumnArchived=i,this.sortDirectionArchived="asc"):this.sortColumnActive===i?this.sortDirectionActive=this.sortDirectionActive==="asc"?"desc":"asc":(this.sortColumnActive=i,this.sortDirectionActive="asc")},getVisibilityBadge(i){const t={0:{label:"Visible",class:"bg-success"},2:{label:"Référents seulement",class:"bg-warning"},3:{label:"Masqué",class:"bg-secondary"}};return t[i]??t[0]},async changeVisibility(i,t){const u=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/visibility`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":u},credentials:"include",body:JSON.stringify({is_archived:t})})).ok)throw new Error("Erreur lors du changement de visibilité");const c=new URLSearchParams(window.location.search);await this.loadCatalogues(c.get("scope"))},async archiveCatalogue(i){confirm("Confirmer l'archivage de ce catalogue ?")&&await this.changeVisibility(i,3)},async unarchiveCatalogue(i){confirm("Confirmer la désarchivage de ce catalogue ?")&&await this.changeVisibility(i,0)},async deleteCatalogue(i){confirm("Masquer complètement ce catalogue ? Il restera accessible dans l'historique des commandes mais ne sera plus visible dans les listes.")&&await this.changeVisibility(i,3)},async sendAlerteMail(i){let t=null;try{const c=await D(i);c.success&&c.count!=null&&(t=Number(c.count))}catch{t=null}if(t===0){alert("Aucun destinataire : aucune personne n'a commandé ce catalogue (avec compte validé et email). L'envoi d'alerte n'est pas possible.");return}if(t===null){if(!confirm("Impossible de récupérer le nombre de destinataires. Envoyer l'alerte quand même ?"))return}else if(!confirm(`Envoyer une alerte par mail à ${t} personne(s) ayant commandé ce catalogue ?`))return;const u=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/alerte`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":u},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail d'alerte envoyé avec succès !")},async sendRappelMail(i){if(!confirm("Envoyer un rappel par mail à tous les utilisateurs ?"))return;const t=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/rappel`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":t},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail de rappel envoyé avec succès !")},async loadData(){const t=new URLSearchParams(window.location.search).get("scope")||(this.referentScopeActive?"all":null);await this.loadCatalogues(t)}}}),R={class:"container-fluid mt-4"},M={key:0,class:"text-center py-5"},N={key:1,class:"alert alert-danger"},T={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},O={class:"d-flex gap-2 align-items-center"},L={class:"card mb-4"},P={class:"card-body"},F={class:"mb-3"},q={key:0,class:"alert alert-info"},B={key:1,class:"table-responsive d-none d-lg-block"},K={class:"table table-hover"},z={class:"thead-administration"},j={key:0},U={key:0},I={class:"text-muted"},G={key:0,class:"text-muted"},J={key:0},H={key:1},Q={class:"badge bg-primary"},W={class:"text-end"},X=["href"],Y=["href"],Z=["href"],ee={class:"btn-group btn-group-sm d-inline"},te={class:"dropdown-menu dropdown-menu-end"},se=["onClick"],ne=["onClick"],ie=["onClick"],ae=["onClick"],oe=["onClick"],re={class:"d-lg-none"},le={class:"card-body"},de={class:"card-title"},ce={class:"text-muted small mb-2"},ue={class:"d-flex gap-2 flex-wrap"},he=["href"],me=["href"],pe=["href"],ge=["onClick"],be={class:"card"},ve={class:"card-body"},fe={class:"mb-3"},_e={key:0,class:"alert alert-info"},ye={key:1,class:"table-responsive d-none d-lg-block"},Ce={class:"table table-hover"},we={class:"thead-administration"},ke={key:0},Ae={key:0},Se={class:"text-muted"},xe={class:"badge bg-primary"},$e={class:"text-end"},De=["href"],Ee=["href"],Ve=["onClick"],Re=["onClick"],Me={class:"d-lg-none"},Ne={class:"card-body"},Te={class:"card-title"},Oe={class:"text-muted small mb-2"},Le={class:"d-flex gap-2 flex-wrap"},Pe=["href"],Fe=["href"],qe=["onClick"],Be=["onClick"],Ke={__name:"AdminCataloguesPage",setup(i){const t=V();function u(c,n=200){return c?c.length>n?c.substring(0,n)+"...":c:""}function h(){const c=t.showAllScope?"referent":"all";window.location.href=`/admin/catalogues/vue?scope=${c}`}return A(()=>{t.loadData()}),(c,n)=>(r(),l("div",R,[a(t).loading?(r(),l("div",M,[...n[10]||(n[10]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Chargement...")],-1),e("p",{class:"mt-3 text-muted"},"Chargement des catalogues...",-1)])])):a(t).error?(r(),l("div",N,[v(o(a(t).error)+" ",1),e("button",{type:"button",class:"btn btn-primary ms-2",onClick:n[0]||(n[0]=s=>a(t).loadData())},"Réessayer")])):(r(),l(p,{key:2},[e("div",T,[n[12]||(n[12]=e("h2",null,"Gestion des catalogues",-1)),e("div",O,[n[11]||(n[11]=e("a",{href:"/admin/catalogues/new",class:"btn btn-success"},[e("i",{class:"bi bi-plus-circle me-1"}),v("Nouveau catalogue ")],-1)),a(t).referentScopeActive?(r(),l("button",{key:0,type:"button",class:"btn btn-outline-primary",onClick:h},o(a(t).showAllScope?"Voir mes catalogues uniquement":"Voir tous les catalogues"),1)):m("",!0)])]),e("div",L,[n[18]||(n[18]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues actifs")],-1)),e("div",P,[e("div",F,[_(e("input",{"onUpdate:modelValue":n[1]||(n[1]=s=>a(t).searchActive=s),type:"text",class:"form-control",placeholder:"Rechercher (nom, référent, org...)"},null,512),[[y,a(t).searchActive]])]),a(t).activeCataloguesSorted.length===0?(r(),l("div",q," Aucun catalogue actif ")):(r(),l("div",B,[e("table",K,[e("thead",z,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[2]||(n[2]=s=>a(t).handleSort("id",!1))},"ID"),a(t).isSuperAdmin?(r(),l("th",j,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[3]||(n[3]=s=>a(t).handleSort("originalname",!1))},"Catalogue"),e("th",{style:{cursor:"pointer"},onClick:n[4]||(n[4]=s=>a(t).handleSort("username",!1))},"Référent"),e("th",{style:{cursor:"pointer"},onClick:n[5]||(n[5]=s=>a(t).handleSort("expiration_date",!1))},"Expiration"),e("th",{style:{cursor:"pointer"},onClick:n[6]||(n[6]=s=>a(t).handleSort("nb_paniers",!1))},"Commandes"),n[13]||(n[13]=e("th",null,"Visibilité",-1)),n[14]||(n[14]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(a(t).activeCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,o(s.id),1)]),a(t).isSuperAdmin?(r(),l("td",U,[e("small",I,o(s.organization_name||"-"),1)])):m("",!0),e("td",null,[e("div",null,o(s.originalname),1),s.description?(r(),l("small",G,o(u(s.description,80)),1)):m("",!0)]),e("td",null,o(s.username),1),e("td",{class:f(s.isExpired?"text-danger fw-bold":"")},[v(o(s.expiration_formatted||"-")+" ",1),s.expiration_day?(r(),l("br",J)):m("",!0),s.expiration_day?(r(),l("small",H,o(s.expiration_day),1)):m("",!0)],2),e("td",null,[e("span",Q,o(s.nb_paniers||0),1)]),e("td",null,[e("span",{class:f("badge "+a(t).getVisibilityBadge(s.is_archived).class)},o(a(t).getVisibilityBadge(s.is_archived).label),3)]),e("td",W,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,X),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,Y),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,Z),e("div",ee,[n[17]||(n[17]=e("button",{type:"button",class:"btn btn-outline-secondary dropdown-toggle","data-bs-toggle":"dropdown"},"Actions",-1)),e("ul",te,[e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).changeVisibility(s.id,0),["prevent"])},"Visible de tous",8,se)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).changeVisibility(s.id,2),["prevent"])},"Référents seulement",8,ne)]),n[15]||(n[15]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).sendAlerteMail(s.id),["prevent"])},"Notifier dispo",8,ie)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>a(t).sendRappelMail(s.id),["prevent"])},"Rappel commande",8,ae)]),n[16]||(n[16]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item text-warning",href:"#",onClick:g(d=>a(t).archiveCatalogue(s.id),["prevent"])},"Archiver",8,oe)])])])])]))),128))])])])),e("div",re,[(r(!0),l(p,null,b(a(t).activeCataloguesSorted,s=>(r(),l("div",{key:"a-"+s.id,class:"card mb-3 shadow-sm"},[e("div",le,[e("h6",de,"#"+o(s.id)+" - "+o(s.originalname),1),e("p",ce,o(s.username)+" · "+o(s.nb_paniers||0)+" commandes",1),e("p",{class:f(s.isExpired?"text-danger":"")},o(s.expiration_formatted||"-"),3),e("div",ue,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-primary"},"Modifier",8,he),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,me),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,pe),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>a(t).archiveCatalogue(s.id)},"Archiver",8,ge)])])]))),128))])])]),e("div",be,[n[23]||(n[23]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues archivés")],-1)),e("div",ve,[e("div",fe,[_(e("input",{"onUpdate:modelValue":n[7]||(n[7]=s=>a(t).searchArchived=s),type:"text",class:"form-control",placeholder:"Rechercher..."},null,512),[[y,a(t).searchArchived]])]),a(t).archivedCataloguesSorted.length===0?(r(),l("div",_e," Aucun catalogue archivé ")):(r(),l("div",ye,[e("table",Ce,[e("thead",we,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[8]||(n[8]=s=>a(t).handleSort("id",!0))},"ID"),a(t).isSuperAdmin?(r(),l("th",ke,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[9]||(n[9]=s=>a(t).handleSort("originalname",!0))},"Catalogue"),n[19]||(n[19]=e("th",null,"Référent",-1)),n[20]||(n[20]=e("th",null,"Expiration",-1)),n[21]||(n[21]=e("th",null,"Commandes",-1)),n[22]||(n[22]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(a(t).archivedCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,o(s.id),1)]),a(t).isSuperAdmin?(r(),l("td",Ae,[e("small",Se,o(s.organization_name||"-"),1)])):m("",!0),e("td",null,o(s.originalname),1),e("td",null,o(s.username),1),e("td",null,o(s.expiration_formatted||"-"),1),e("td",null,[e("span",xe,o(s.nb_paniers||0),1)]),e("td",$e,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,De),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,Ee),e("button",{type:"button",class:"btn btn-sm btn-outline-warning me-1",onClick:d=>a(t).unarchiveCatalogue(s.id)},"Désarchiver",8,Ve),e("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:d=>a(t).deleteCatalogue(s.id)},"Masquer",8,Re)])]))),128))])])])),e("div",Me,[(r(!0),l(p,null,b(a(t).archivedCataloguesSorted,s=>(r(),l("div",{key:"ar-"+s.id,class:"card mb-3 shadow-sm"},[e("div",Ne,[e("h6",Te,"#"+o(s.id)+" - "+o(s.originalname),1),e("p",Oe,o(s.username)+" · "+o(s.nb_paniers||0)+" commandes",1),e("div",Le,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,Pe),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,Fe),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>a(t).unarchiveCatalogue(s.id)},"Désarchiver",8,qe),e("button",{type:"button",class:"btn btn-sm btn-danger",onClick:d=>a(t).deleteCatalogue(s.id)},"Masquer",8,Be)])])]))),128))])])])],64))]))}},k=S(Ke);k.use($());k.mount("#admin-catalogues-app");
