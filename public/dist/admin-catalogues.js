import{i as A,o as r,c as l,u as o,a as e,b as f,t as a,F as p,d as m,e as _,v as y,k as b,n as v,w as g,h as S}from"./chunks/runtime-dom.esm-bundler-BlMAuMpH.js";import{d as x,c as $}from"./chunks/pinia-BNknc8Vm.js";import{ai as D}from"./chunks/index-BkeVkIvb.js";function C(i,t){if(!t)return i;const c=t.toLowerCase();return i.filter(u=>u.originalname&&u.originalname.toLowerCase().includes(c)||u.username&&u.username.toLowerCase().includes(c)||u.organization_name&&u.organization_name.toLowerCase().includes(c)||u.description&&u.description.toLowerCase().includes(c))}function w(i,t,c){return!i||i.length===0?i:[...i].sort((h,n)=>{let s=h[t],d=n[t];return t==="expiration_date"||t==="livraison_date"?(s=s?new Date(s).getTime():0,d=d?new Date(d).getTime():0):t==="id"||t==="nb_paniers"||t==="is_archived"?(s=Number(s)||0,d=Number(d)||0):(s=(s||"").toString().toLowerCase(),d=(d||"").toString().toLowerCase()),s<d?c==="asc"?-1:1:s>d?c==="asc"?1:-1:0})}const E=x("adminCatalogues",{state:()=>({catalogues:[],archivedCatalogues:[],loading:!0,error:null,role:null,referentScopeActive:!1,showAllScope:!0,searchActive:"",searchArchived:"",sortColumnActive:"id",sortDirectionActive:"desc",sortColumnArchived:"id",sortDirectionArchived:"desc"}),getters:{activeCataloguesSorted(i){const t=C(i.catalogues,i.searchActive);return w(t,i.sortColumnActive,i.sortDirectionActive)},archivedCataloguesSorted(i){const t=C(i.archivedCatalogues,i.searchArchived);return w(t,i.sortColumnArchived,i.sortDirectionArchived)},isSuperAdmin(i){return i.role==="SuperAdmin"}},actions:{async loadCatalogues(i){this.loading=!0,this.error=null;try{const t=await D(i);if(t.success)this.catalogues=t.catalogues||[],this.archivedCatalogues=t.archivedCatalogues||[],this.role=t.role,this.referentScopeActive=t.referentScopeActive,this.showAllScope=t.showAllScope;else throw new Error(t.error||"Erreur lors du chargement des catalogues")}catch(t){this.error=t.message||"Erreur lors du chargement"}finally{this.loading=!1}},handleSort(i,t){t?this.sortColumnArchived===i?this.sortDirectionArchived=this.sortDirectionArchived==="asc"?"desc":"asc":(this.sortColumnArchived=i,this.sortDirectionArchived="asc"):this.sortColumnActive===i?this.sortDirectionActive=this.sortDirectionActive==="asc"?"desc":"asc":(this.sortColumnActive=i,this.sortDirectionActive="asc")},getVisibilityBadge(i){const t={0:{label:"Visible",class:"bg-success"},2:{label:"Référents seulement",class:"bg-warning"},3:{label:"Masqué",class:"bg-secondary"}};return t[i]??t[0]},async changeVisibility(i,t){const c=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/visibility`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":c},credentials:"include",body:JSON.stringify({is_archived:t})})).ok)throw new Error("Erreur lors du changement de visibilité");const h=new URLSearchParams(window.location.search);await this.loadCatalogues(h.get("scope"))},async archiveCatalogue(i){confirm("Confirmer l'archivage de ce catalogue ?")&&await this.changeVisibility(i,3)},async unarchiveCatalogue(i){confirm("Confirmer la désarchivage de ce catalogue ?")&&await this.changeVisibility(i,0)},async deleteCatalogue(i){confirm("Masquer complètement ce catalogue ? Il restera accessible dans l'historique des commandes mais ne sera plus visible dans les listes.")&&await this.changeVisibility(i,3)},async sendAlerteMail(i){if(!confirm("Envoyer une alerte par mail à tous les utilisateurs ?"))return;const t=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/alerte`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":t},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail d'alerte envoyé avec succès !")},async sendRappelMail(i){if(!confirm("Envoyer un rappel par mail à tous les utilisateurs ?"))return;const t=typeof window<"u"&&window.CSRF_TOKEN?window.CSRF_TOKEN:"";if(!(await fetch(`/admin/catalogues/${i}/rappel`,{method:"POST",headers:{"Content-Type":"application/json","csrf-token":t},credentials:"include"})).ok)throw new Error("Erreur lors de l'envoi du mail");alert("Mail de rappel envoyé avec succès !")},async loadData(){const t=new URLSearchParams(window.location.search).get("scope")||(this.referentScopeActive?"all":null);await this.loadCatalogues(t)}}}),V={class:"container-fluid mt-4"},R={key:0,class:"text-center py-5"},M={key:1,class:"alert alert-danger"},T={class:"d-flex justify-content-between align-items-center mb-4"},N={class:"card mb-4"},O={class:"card-body"},P={class:"mb-3"},L={key:0,class:"alert alert-info"},F={key:1,class:"table-responsive d-none d-lg-block"},q={class:"table table-hover"},B={class:"table-dark"},K={key:0},z={key:0},j={class:"text-muted"},U={key:0,class:"text-muted"},I={key:0},G={key:1},J={class:"badge bg-primary"},H={class:"text-end"},Q=["href"],W=["href"],X=["href"],Y={class:"btn-group btn-group-sm d-inline"},Z={class:"dropdown-menu dropdown-menu-end"},ee=["onClick"],te=["onClick"],se=["onClick"],ne=["onClick"],ie=["onClick"],oe={class:"d-lg-none"},ae={class:"card-body"},re={class:"card-title"},le={class:"text-muted small mb-2"},de={class:"d-flex gap-2 flex-wrap"},ce=["href"],ue=["href"],he=["href"],me=["onClick"],pe={class:"card"},ge={class:"card-body"},be={class:"mb-3"},ve={key:0,class:"alert alert-info"},fe={key:1,class:"table-responsive d-none d-lg-block"},_e={class:"table table-hover"},ye={class:"table-dark"},Ce={key:0},we={key:0},ke={class:"text-muted"},Ae={class:"badge bg-primary"},Se={class:"text-end"},xe=["href"],$e=["href"],De=["onClick"],Ee=["onClick"],Ve={class:"d-lg-none"},Re={class:"card-body"},Me={class:"card-title"},Te={class:"text-muted small mb-2"},Ne={class:"d-flex gap-2 flex-wrap"},Oe=["href"],Pe=["href"],Le=["onClick"],Fe=["onClick"],qe={__name:"AdminCataloguesPage",setup(i){const t=E();function c(h,n=200){return h?h.length>n?h.substring(0,n)+"...":h:""}function u(){const h=t.showAllScope?"referent":"all";window.location.href=`/admin/catalogues/vue?scope=${h}`}return A(()=>{t.loadData()}),(h,n)=>(r(),l("div",V,[o(t).loading?(r(),l("div",R,[...n[10]||(n[10]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Chargement...")],-1),e("p",{class:"mt-3 text-muted"},"Chargement des catalogues...",-1)])])):o(t).error?(r(),l("div",M,[f(a(o(t).error)+" ",1),e("button",{type:"button",class:"btn btn-primary ms-2",onClick:n[0]||(n[0]=s=>o(t).loadData())},"Réessayer")])):(r(),l(p,{key:2},[e("div",T,[n[11]||(n[11]=e("h2",null,"Gestion des catalogues",-1)),o(t).referentScopeActive?(r(),l("button",{key:0,type:"button",class:"btn btn-outline-primary",onClick:u},a(o(t).showAllScope?"Voir mes catalogues uniquement":"Voir tous les catalogues"),1)):m("",!0)]),e("div",N,[n[17]||(n[17]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues actifs")],-1)),e("div",O,[e("div",P,[_(e("input",{"onUpdate:modelValue":n[1]||(n[1]=s=>o(t).searchActive=s),type:"text",class:"form-control",placeholder:"Rechercher (nom, référent, org...)"},null,512),[[y,o(t).searchActive]])]),o(t).activeCataloguesSorted.length===0?(r(),l("div",L," Aucun catalogue actif ")):(r(),l("div",F,[e("table",q,[e("thead",B,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[2]||(n[2]=s=>o(t).handleSort("id",!1))},"ID"),o(t).isSuperAdmin?(r(),l("th",K,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[3]||(n[3]=s=>o(t).handleSort("originalname",!1))},"Catalogue"),e("th",{style:{cursor:"pointer"},onClick:n[4]||(n[4]=s=>o(t).handleSort("username",!1))},"Référent"),e("th",{style:{cursor:"pointer"},onClick:n[5]||(n[5]=s=>o(t).handleSort("expiration_date",!1))},"Expiration"),e("th",{style:{cursor:"pointer"},onClick:n[6]||(n[6]=s=>o(t).handleSort("nb_paniers",!1))},"Commandes"),n[12]||(n[12]=e("th",null,"Visibilité",-1)),n[13]||(n[13]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(o(t).activeCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,a(s.id),1)]),o(t).isSuperAdmin?(r(),l("td",z,[e("small",j,a(s.organization_name||"-"),1)])):m("",!0),e("td",null,[e("div",null,a(s.originalname),1),s.description?(r(),l("small",U,a(c(s.description,80)),1)):m("",!0)]),e("td",null,a(s.username),1),e("td",{class:v(s.isExpired?"text-danger fw-bold":"")},[f(a(s.expiration_formatted||"-")+" ",1),s.expiration_day?(r(),l("br",I)):m("",!0),s.expiration_day?(r(),l("small",G,a(s.expiration_day),1)):m("",!0)],2),e("td",null,[e("span",J,a(s.nb_paniers||0),1)]),e("td",null,[e("span",{class:v("badge "+o(t).getVisibilityBadge(s.is_archived).class)},a(o(t).getVisibilityBadge(s.is_archived).label),3)]),e("td",H,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,Q),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,W),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,X),e("div",Y,[n[16]||(n[16]=e("button",{type:"button",class:"btn btn-outline-secondary dropdown-toggle","data-bs-toggle":"dropdown"},"Actions",-1)),e("ul",Z,[e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>o(t).changeVisibility(s.id,0),["prevent"])},"Visible de tous",8,ee)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>o(t).changeVisibility(s.id,2),["prevent"])},"Référents seulement",8,te)]),n[14]||(n[14]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>o(t).sendAlerteMail(s.id),["prevent"])},"Notifier dispo",8,se)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:g(d=>o(t).sendRappelMail(s.id),["prevent"])},"Rappel commande",8,ne)]),n[15]||(n[15]=e("li",null,[e("hr",{class:"dropdown-divider"})],-1)),e("li",null,[e("a",{class:"dropdown-item text-warning",href:"#",onClick:g(d=>o(t).archiveCatalogue(s.id),["prevent"])},"Archiver",8,ie)])])])])]))),128))])])])),e("div",oe,[(r(!0),l(p,null,b(o(t).activeCataloguesSorted,s=>(r(),l("div",{key:"a-"+s.id,class:"card mb-3 shadow-sm"},[e("div",ae,[e("h6",re,"#"+a(s.id)+" - "+a(s.originalname),1),e("p",le,a(s.username)+" · "+a(s.nb_paniers||0)+" commandes",1),e("p",{class:v(s.isExpired?"text-danger":"")},a(s.expiration_formatted||"-"),3),e("div",de,[e("a",{href:`/admin/catalogues/${s.id}/edit`,class:"btn btn-sm btn-primary"},"Modifier",8,ce),e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,ue),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,he),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>o(t).archiveCatalogue(s.id)},"Archiver",8,me)])])]))),128))])])]),e("div",pe,[n[22]||(n[22]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},"Catalogues archivés")],-1)),e("div",ge,[e("div",be,[_(e("input",{"onUpdate:modelValue":n[7]||(n[7]=s=>o(t).searchArchived=s),type:"text",class:"form-control",placeholder:"Rechercher..."},null,512),[[y,o(t).searchArchived]])]),o(t).archivedCataloguesSorted.length===0?(r(),l("div",ve," Aucun catalogue archivé ")):(r(),l("div",fe,[e("table",_e,[e("thead",ye,[e("tr",null,[e("th",{style:{cursor:"pointer"},onClick:n[8]||(n[8]=s=>o(t).handleSort("id",!0))},"ID"),o(t).isSuperAdmin?(r(),l("th",Ce,"Org")):m("",!0),e("th",{style:{cursor:"pointer"},onClick:n[9]||(n[9]=s=>o(t).handleSort("originalname",!0))},"Catalogue"),n[18]||(n[18]=e("th",null,"Référent",-1)),n[19]||(n[19]=e("th",null,"Expiration",-1)),n[20]||(n[20]=e("th",null,"Commandes",-1)),n[21]||(n[21]=e("th",{class:"text-end"},"Actions",-1))])]),e("tbody",null,[(r(!0),l(p,null,b(o(t).archivedCataloguesSorted,s=>(r(),l("tr",{key:s.id},[e("td",null,[e("strong",null,a(s.id),1)]),o(t).isSuperAdmin?(r(),l("td",we,[e("small",ke,a(s.organization_name||"-"),1)])):m("",!0),e("td",null,a(s.originalname),1),e("td",null,a(s.username),1),e("td",null,a(s.expiration_formatted||"-"),1),e("td",null,[e("span",Ae,a(s.nb_paniers||0),1)]),e("td",Se,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-outline-info me-1"},"Synthèse",8,xe),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-outline-success me-1"},"Détail",8,$e),e("button",{type:"button",class:"btn btn-sm btn-outline-warning me-1",onClick:d=>o(t).unarchiveCatalogue(s.id)},"Désarchiver",8,De),e("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:d=>o(t).deleteCatalogue(s.id)},"Masquer",8,Ee)])]))),128))])])])),e("div",Ve,[(r(!0),l(p,null,b(o(t).archivedCataloguesSorted,s=>(r(),l("div",{key:"ar-"+s.id,class:"card mb-3 shadow-sm"},[e("div",Re,[e("h6",Me,"#"+a(s.id)+" - "+a(s.originalname),1),e("p",Te,a(s.username)+" · "+a(s.nb_paniers||0)+" commandes",1),e("div",Ne,[e("a",{href:`/admin/catalogues/${s.id}/synthese/vue`,class:"btn btn-sm btn-info"},"Synthèse",8,Oe),e("a",{href:`/admin/catalogues/${s.id}/synthese-detaillee/vue`,class:"btn btn-sm btn-success"},"Détail",8,Pe),e("button",{type:"button",class:"btn btn-sm btn-warning",onClick:d=>o(t).unarchiveCatalogue(s.id)},"Désarchiver",8,Le),e("button",{type:"button",class:"btn btn-sm btn-danger",onClick:d=>o(t).deleteCatalogue(s.id)},"Masquer",8,Fe)])])]))),128))])])])],64))]))}},k=S(qe);k.use($());k.mount("#admin-catalogues-app");
