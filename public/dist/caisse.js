import{i as G,s as L,x as H,l as X,o as l,c as d,a as s,b as m,f as Y,u as o,t as c,d as g,y as W,z as Z,n as F,T as tt,e as x,v as U,F as w,k as $,q,r as E,g as V,h as et}from"./chunks/runtime-dom.esm-bundler-CPobOing.js";import{d as st,c as it}from"./chunks/pinia-8wUEIqj_.js";import{B as nt,C as ot,D as at,E as rt,F as lt,G as N,H as dt,I as ut,J as ct}from"./chunks/index-zlPV8JO4.js";import{_ as mt}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const B="caisse_paniers_sauvegardes";function M(){try{const n=localStorage.getItem(B);return n?JSON.parse(n):[]}catch{return[]}}function D(n){try{localStorage.setItem(B,JSON.stringify(n))}catch(t){console.error("Erreur écriture localStorage:",t)}}function _(n){return Math.round(n*100)/100}function R(n){const t=n.filter(b=>!b.is_avoir).reduce((b,v)=>b+_(v.quantite*v.prix_unitaire),0),a=n.filter(b=>b.is_avoir);if(a.reduce((b,v)=>b+Math.abs(_(v.prix_unitaire)),0)<=t)return;let p=t;for(const b of a){const v=Math.abs(_(b.prix_unitaire)),h=_(Math.min(v,p));b.prix_unitaire=-h,p-=h}}const bt=st("caisse",{state:()=>({produits:[],categories:[],searchQuery:"",selectedCategorie:null,produitsLoading:!1,utilisateurs:[],selectedUtilisateur:null,lignes:[],currentPanierId:null,savedPaniers:M(),showPaniersModal:!1,showAvoirModal:!1,avoirMontant:0,avoirCommentaire:"",showPaiementModal:!1,montantPaiement:0,modePaiementId:null,modesPaiement:[],error:null,commandesUtilisateur:[],loadingCommandes:!1,commandeSelectionnee:null,showModalChargerCommande:!1,commandeACharger:null,selectedCommandeId:null,cotisationCheck:null,emailFactureAnonyme:""}),getters:{produitsFiltrés(n){let t=[...n.produits];if(n.searchQuery){const a=n.searchQuery.toLowerCase();t=t.filter(r=>r.nom.toLowerCase().includes(a))}return n.selectedCategorie&&(t=t.filter(a=>a.category_id===n.selectedCategorie)),t},total(n){const t=n.lignes.reduce((a,r)=>a+_(r.quantite*r.prix_unitaire),0);return _(t)},nombreArticles(n){return n.lignes.length},categoriesFiltrées(n){let t=[...n.produits];if(n.searchQuery){const r=n.searchQuery.toLowerCase();t=t.filter(p=>p.nom.toLowerCase().includes(r))}const a=new Set(t.filter(r=>r.category_id).map(r=>r.category_id));return n.categories.filter(r=>a.has(r.id))},aPanierCotisation(n){return n.lignes.some(t=>t.is_cotisation===!0)}},actions:{async chargerProduits(){this.produitsLoading=!0,this.error=null;try{const n=await ct();n.success&&(this.produits=n.produits||[],this.categories=n.categories||[])}catch(n){this.error=n.message}finally{this.produitsLoading=!1}},async chargerUtilisateurs(){var n,t;try{const a=await ut();if(a.success&&((n=a.utilisateurs)!=null&&n.length)){this.utilisateurs=a.utilisateurs;const r=a.utilisateurs.find(p=>(p.username||"").toLowerCase()==="anonyme");this.selectedUtilisateur=r?r.id:((t=a.utilisateurs[0])==null?void 0:t.id)??null}}catch(a){console.error("Erreur chargement utilisateurs:",a)}},async chargerModesPaiement(){try{const n=await dt();n.success&&(this.modesPaiement=n.modes||[])}catch(n){console.error("Erreur chargement modes paiement:",n)}},ajouterProduit(n){const t=this.lignes.find(a=>a.produit_id===n.id);t?t.quantite+=parseFloat(n.quantite_min)||1:this.lignes.push({produit_id:n.id,nom_produit:n.nom,quantite:parseFloat(n.quantite_min)||1,prix_unitaire:parseFloat(n.prix)||0,unite:n.unite||"Pièce",quantite_min:parseFloat(n.quantite_min)||1,is_avoir:!1})},ajouterProduitParEan(n){const t=String(n||"").trim().replace(/\s/g,"");if(!t)return{found:!1};const a=this.produits.find(r=>r.code_ean&&String(r.code_ean).trim().replace(/\s/g,"")===t);return a?(this.ajouterProduit(a),{found:!0,produit:a}):{found:!1}},modifierQuantite(n,t){const a=this.lignes[n];a&&t>0&&(a.quantite=parseFloat(t),a.is_avoir||R(this.lignes))},supprimerLigne(n){const t=this.lignes[n],a=(t==null?void 0:t.is_avoir)===!0;this.lignes.splice(n,1),a||R(this.lignes)},viderPanier(){this.lignes=[],this.currentPanierId=null,this.commandeSelectionnee=null},sauvegarderPanier(){if(this.lignes.length===0)return;const n={id:this.currentPanierId||Date.now(),lignes:JSON.parse(JSON.stringify(this.lignes)),selectedUtilisateur:this.selectedUtilisateur,saved_at:new Date().toISOString(),total:this.total};let t=M();const a=t.findIndex(r=>r.id===n.id);a>=0?t[a]=n:t.push(n),D(t),this.savedPaniers=M(),this.currentPanierId=n.id},chargerPanier(n){const a=M().find(r=>r.id===n);a&&(this.lignes=JSON.parse(JSON.stringify(a.lignes)),this.selectedUtilisateur=a.selectedUtilisateur,this.currentPanierId=a.id,this.showPaniersModal=!1)},supprimerPanier(n){let t=M().filter(a=>a.id!==n);D(t),this.savedPaniers=t,this.currentPanierId===n&&this.viderPanier()},nouveauPanier(){this.lignes.length>0&&!confirm("Effacer le panier actuel ?")||this.viderPanier()},ajouterAvoir(){const n=parseFloat(this.avoirMontant);if(!n||n<=0)return;const t=this.lignes.filter(f=>!f.is_avoir).reduce((f,C)=>f+_(C.quantite*C.prix_unitaire),0),a=this.lignes.filter(f=>f.is_avoir).reduce((f,C)=>f+Math.abs(_(C.prix_unitaire)),0),r=_(t-a);if(r<=0)return;const p=_(n),b=_(Math.min(p,r)),v=this.avoirCommentaire||"Remboursement",h=b<p?`Avoir: ${v} (initial: ${p.toFixed(2)} €, limité à: ${b.toFixed(2)} €)`:`Avoir: ${v} (initial: ${b.toFixed(2)} €)`;this.lignes.push({produit_id:null,nom_produit:h,quantite:1,prix_unitaire:-b,unite:"",quantite_min:1,is_avoir:!0}),this.showAvoirModal=!1,this.avoirMontant=0,this.avoirCommentaire=""},async ouvrirPaiement(){this.montantPaiement=this.total,this.showPaiementModal=!0,this.cotisationCheck=null,this.emailFactureAnonyme="";const n=this.utilisateurs.find(a=>a.id===this.selectedUtilisateur),t=n&&(n.username||"").toLowerCase()==="anonyme";if(this.selectedUtilisateur&&!t)try{const a=await N(this.selectedUtilisateur);a.success&&(this.cotisationCheck=a)}catch(a){console.error("Erreur vérification cotisation:",a)}},async checkCotisation(){if(this.cotisationCheck=null,!!this.selectedUtilisateur)try{const n=await N(this.selectedUtilisateur);n.success&&(this.cotisationCheck=n)}catch(n){console.error("Erreur vérification cotisation:",n)}},ajouterCotisation(n){const t=parseFloat(n);Number.isNaN(t)||t<5||t>15||this.lignes.some(a=>a.is_cotisation)||(this.lignes.push({produit_id:null,nom_produit:"Cotisation mensuelle",quantite:1,prix_unitaire:_(t),is_avoir:!1,is_cotisation:!0}),this.montantPaiement=this.total)},fermerPaiement(){this.showPaiementModal=!1,this.modePaiementId=null},async chargerCommandesUtilisateur(){if(!this.selectedUtilisateur){this.commandesUtilisateur=[],this.commandeSelectionnee=null;return}this.loadingCommandes=!0;try{const n=await lt(this.selectedUtilisateur);this.commandesUtilisateur=Array.isArray(n)?n:[]}catch(n){console.error("Erreur chargement commandes:",n),this.commandesUtilisateur=[]}finally{this.loadingCommandes=!1}},async chargerCommandeDansPanier(n){this.showModalChargerCommande=!1,this.commandeACharger=null;try{const t=this.commandesUtilisateur.find(h=>h.id===n),a=(t==null?void 0:t.catalog_id)!=null?t.catalog_id:null,r=a!=null?` (cde #${n}, cat #${a})`:"",p=await rt(n),b=Array.isArray(p)?p:[];let v=0;for(const h of b){if(!h.product_id_caisse)continue;const f=this.produits.find(A=>A.id===h.product_id_caisse);if(!f)continue;const C=parseFloat(h.quantity)||1,P=this.lignes.find(A=>A.produit_id===f.id&&!A.is_avoir);P?(P.quantite+=C,r&&!(P.nom_produit||"").includes("(cde ")&&(P.nom_produit=(P.nom_produit||"").trimEnd()+r)):this.lignes.push({produit_id:f.id,nom_produit:(f.nom||"").trimEnd()+r,quantite:C,prix_unitaire:parseFloat(f.prix)||0,unite:f.unite||"Pièce",quantite_min:parseFloat(f.quantite_min)||1,is_avoir:!1}),v++}this.commandeSelectionnee=n,this.selectedCommandeId=null,v>0&&alert(`Commande #${n} ajoutée au panier (${v} articles)`)}catch(t){console.error("Erreur chargement commande:",t),alert(t.message||"Erreur lors du chargement de la commande")}},confirmerChargerCommande(n){n&&this.chargerCommandeDansPanier(n.id)},annulerChargerCommande(){this.showModalChargerCommande=!1,this.commandeACharger=null},async validerVente(){if(!this.modePaiementId){this.error="Veuillez sélectionner un mode de paiement";return}this.error=null;try{const n=this.utilisateurs.find(b=>b.id===this.selectedUtilisateur),t=(n==null?void 0:n.username)||"Anonyme",a=n&&(n.username||"").toLowerCase()==="anonyme",r=await nt({adherent_id:a?null:this.selectedUtilisateur||null,nom_client:t,lignes:this.lignes,montant_ttc:this.total});if(!r.success)throw new Error(r.error);await ot({vente_id:r.vente.id,mode_paiement_id:this.modePaiementId,montant:this.montantPaiement}),this.currentPanierId&&this.supprimerPanier(this.currentPanierId),this.viderPanier(),this.fermerPaiement();const p=(this.emailFactureAnonyme||"").trim();if(p){try{await at(r.vente.id,p),alert(`Vente enregistrée ! Ticket n°${r.vente.numero_ticket}. Facture envoyée par email.`)}catch(b){alert(`Vente enregistrée (Ticket n°${r.vente.numero_ticket}). Envoi de la facture par email a échoué : ${b.message}`)}this.emailFactureAnonyme=""}else alert(`Vente enregistrée ! Ticket n°${r.vente.numero_ticket}`)}catch(n){this.error=n.message,alert("Erreur : "+n.message)}}}}),pt={class:"admin-content-wrapper"},ft={class:"container-fluid px-3 mt-4"},vt={key:0,class:"alert alert-danger alert-dismissible fade show"},gt={class:"row"},ht={class:"col-lg-7 col-md-7 mb-4"},yt={class:"mb-3"},_t={class:"mb-3"},Ct={class:"badge bg-secondary fs-6 py-2 px-3"},kt={key:0,class:"mb-3"},xt={class:"d-flex flex-wrap gap-2"},wt=["onClick"],Pt={key:1,class:"text-center py-5"},At={key:2,class:"alert alert-info text-center"},Ft={key:3,class:"row g-3"},$t=["onClick"],Ut=["src","alt"],Mt={class:"card-body p-2 d-flex flex-column"},St={class:"card-title mb-1",style:{"font-size":"0.9rem"}},qt={class:"mt-auto pt-1 d-flex justify-content-between align-items-center"},Et={class:"text-primary fw-bold"},Tt={class:"small text-muted"},jt={class:"col-lg-5 col-md-5"},It={class:"card",style:{"min-height":"calc(100vh - 120px)",display:"flex","flex-direction":"column"}},Lt={class:"card-header bg-primary text-white"},Vt={class:"d-flex gap-2 flex-wrap mt-2"},Nt=["disabled"],Dt={class:"badge bg-white text-info ms-1"},Rt={class:"mt-3"},Qt=["value"],Bt={class:"card-body",style:{flex:"1"}},Ot={key:0,class:"mb-3 border-bottom pb-3"},zt={class:"form-label fw-bold small mb-2 d-flex align-items-center gap-1"},Jt=["disabled"],Kt=["disabled"],Gt=["value"],Ht={key:0,class:"text-muted d-block mt-1"},Xt={key:1,class:"alert alert-info py-2 px-3 mb-3",style:{"font-size":"0.85rem"}},Yt={key:3,class:"text-center py-4 text-muted"},Wt={class:"mb-3"},Zt={class:"d-flex justify-content-between align-items-start mb-1"},te={key:0,class:"bi bi-coin me-1"},ee={key:1,class:"bi bi-receipt me-1"},se=["onClick"],ie={key:0,class:"d-flex justify-content-end"},ne={key:1,class:"d-flex justify-content-between align-items-center"},oe={class:"d-flex align-items-center gap-1"},ae=["onClick"],re=["value","onChange"],le=["onClick"],de={class:"text-muted small"},ue={class:"text-muted"},ce={class:"text-primary"},me={class:"border-top pt-3 mb-3"},be={class:"d-flex justify-content-between align-items-center mb-2"},pe={class:"d-flex justify-content-between align-items-center"},fe={class:"mb-0 text-primary"},ve={class:"d-grid gap-2"},ge=["disabled"],he={key:0,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},ye={class:"modal-dialog modal-lg"},_e={class:"modal-content"},Ce={class:"modal-header"},ke={class:"modal-body"},xe={key:0,class:"alert alert-info"},we={key:1},Pe={class:"card-body"},Ae={class:"row align-items-center"},Fe={class:"col-md-6"},$e={class:"text-muted"},Ue={class:"col-md-3 text-end"},Me={class:"mb-0 text-primary"},Se={class:"col-md-3 text-end"},qe=["onClick"],Ee=["onClick"],Te={class:"modal-footer"},je={key:1,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},Ie={class:"modal-dialog"},Le={class:"modal-content"},Ve={class:"modal-header"},Ne={class:"modal-body"},De={key:0,class:"alert alert-warning mb-3"},Re={class:"mb-2 small"},Qe={class:"d-flex gap-2 flex-wrap"},Be={key:1,class:"alert alert-info mb-3"},Oe={class:"alert alert-success"},ze={class:"mb-3"},Je=["value"],Ke={class:"mb-3"},Ge={key:2,class:"alert alert-info"},He={class:"modal-footer"},Xe=["disabled"],Ye={key:2,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},We={class:"modal-dialog"},Ze={class:"modal-content"},ts={class:"modal-header"},es={class:"modal-footer"},ss={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},is={class:"modal-dialog"},ns={class:"modal-content"},os={class:"modal-header"},as={class:"modal-body"},rs={class:"alert alert-info"},ls={class:"mb-3"},ds={class:"mb-3"},us={class:"modal-footer"},T=4,cs=200,Q="Règles d'affichage : sont listées uniquement les commandes dont le catalogue a une date d'expiration dépassée et dont le catalogue est masqué (invisible) pour l'utilisateur. Les commandes déjà transformées en vente caisse n'apparaissent pas.",ms={__name:"CaissePage",setup(n){const t=bt(),a=E(null),r=E(""),p=E("success");let b=null;function v(u,e="success"){r.value=u,p.value=e,clearTimeout(b),b=setTimeout(()=>{r.value=""},2500)}let h="",f=null;function C(){h=""}function P(){const u=h.trim().replace(/\s/g,"");if(C(),u.length>=T&&/^\d+$/.test(u)){const e=t.ajouterProduitParEan(u);e.found?v(`Ajouté : ${e.produit.nom}`,"success"):v("Code non reconnu","warning")}}function A(u){const e=u.target&&(u.target.tagName==="INPUT"||u.target.tagName==="TEXTAREA"||u.target.isContentEditable);if(u.key==="Enter"){if(e){const k=(u.target.value||"").trim().replace(/\s/g,"");if(k.length>=T&&/^\d+$/.test(k)){u.preventDefault();const i=t.ajouterProduitParEan(k);i.found?v(`Ajouté : ${i.produit.nom}`,"success"):v("Code non reconnu","warning"),u.target.value=""}}else h.length>=T&&/^\d+$/.test(h)?(u.preventDefault(),P()):C();return}!e&&u.key.length===1&&!u.ctrlKey&&!u.metaKey&&!u.altKey&&(h+=u.key,clearTimeout(f),f=setTimeout(C,cs))}const z=V(()=>t.lignes.filter(u=>!u.is_avoir).reduce((u,e)=>u+e.quantite*e.prix_unitaire,0)),j=V(()=>{const u=t.utilisateurs.find(e=>e.id===t.selectedUtilisateur);return u&&(u.username||"").toLowerCase()==="anonyme"});function J(u){confirm("Supprimer ce panier sauvegardé ?")&&t.supprimerPanier(u)}function K(){const u=t.commandesUtilisateur.find(e=>e.id===t.selectedCommandeId);u&&t.confirmerChargerCommande(u)}G(()=>{t.chargerProduits(),t.chargerUtilisateurs(),t.chargerModesPaiement(),L(()=>I()),document.addEventListener("keydown",A)}),H(()=>{document.removeEventListener("keydown",A),f&&clearTimeout(f),b&&clearTimeout(b)}),X(()=>t.selectedUtilisateur,u=>{u?(t.chargerCommandesUtilisateur(),L(()=>I())):(t.commandesUtilisateur=[],t.commandeSelectionnee=null,t.selectedCommandeId=null)});function I(){setTimeout(()=>{var e;const u=a.value;if(!(!u||typeof window>"u")&&(e=window.bootstrap)!=null&&e.Tooltip)try{const k=window.bootstrap.Tooltip.getInstance(u);k&&k.dispose(),new window.bootstrap.Tooltip(u,{trigger:"hover focus",placement:"top"})}catch{}},150)}return(u,e)=>{var k;return l(),d("div",pt,[s("div",ft,[s("button",{class:"btn btn-outline-secondary d-md-none mb-3",onClick:e[0]||(e[0]=i=>u.history.back())},[...e[31]||(e[31]=[s("i",{class:"bi bi-arrow-left me-2"},null,-1),m("Retour ",-1)])]),e[56]||(e[56]=Y('<div class="row mb-4" data-v-c3196c0e><div class="col-12" data-v-c3196c0e><div class="d-flex justify-content-between align-items-center" data-v-c3196c0e><h2 class="mb-0" data-v-c3196c0e><i class="bi bi-cart-fill me-2" data-v-c3196c0e></i>Caisse</h2><a href="/caisse/historique" class="btn btn-outline-primary" data-v-c3196c0e><i class="bi bi-clock-history me-2" data-v-c3196c0e></i>Historique des ventes </a></div></div></div>',1)),o(t).error?(l(),d("div",vt,[m(c(o(t).error)+" ",1),s("button",{type:"button",class:"btn-close",onClick:e[1]||(e[1]=i=>o(t).error=null)})])):g("",!0),W(tt,{name:"scan-toast"},{default:Z(()=>[r.value?(l(),d("div",{key:0,class:F(["alert mb-2 py-2",p.value==="success"?"alert-success":"alert-warning"]),role:"status"},[s("i",{class:F(p.value==="success"?"bi bi-check-circle me-2":"bi bi-upc-scan me-2")},null,2),m(" "+c(r.value),1)],2)):g("",!0)]),_:1}),s("div",gt,[s("div",ht,[s("div",yt,[x(s("input",{"onUpdate:modelValue":e[2]||(e[2]=i=>o(t).searchQuery=i),type:"text",class:"form-control",placeholder:"Rechercher un produit...",style:{"max-width":"500px"}},null,512),[[U,o(t).searchQuery]])]),s("div",_t,[s("span",Ct,[e[32]||(e[32]=s("i",{class:"bi bi-box-seam me-1"},null,-1)),m(c(o(t).produitsFiltrés.length)+" produits disponibles ",1)])]),o(t).searchQuery&&o(t).categoriesFiltrées.length>0?(l(),d("div",kt,[s("div",xt,[(l(!0),d(w,null,$(o(t).categoriesFiltrées,i=>(l(),d("button",{key:i.id,class:F(["btn btn-sm",o(t).selectedCategorie===i.id?"btn-primary":"btn-outline-primary"]),onClick:y=>o(t).selectedCategorie=o(t).selectedCategorie===i.id?null:i.id},[m(c(i.nom)+" ",1),s("span",{class:F(["badge ms-2",o(t).selectedCategorie===i.id?"bg-light text-primary":"bg-primary"])},c(o(t).produitsFiltrés.filter(y=>y.category_id===i.id).length),3)],10,wt))),128))])])):g("",!0),o(t).produitsLoading?(l(),d("div",Pt,[...e[33]||(e[33]=[s("div",{class:"spinner-border text-primary"},null,-1)])])):o(t).produitsFiltrés.length===0?(l(),d("div",At," Aucun produit disponible ")):(l(),d("div",Ft,[(l(!0),d(w,null,$(o(t).produitsFiltrés,i=>(l(),d("div",{key:i.id,class:"col-lg-4 col-md-6 col-sm-4 col-6"},[s("div",{class:"card h-100 produit-card",onClick:y=>o(t).ajouterProduit(i)},[i.image_url?(l(),d("img",{key:0,src:i.image_url,class:"card-img-top",alt:i.nom,style:{height:"120px","object-fit":"cover"}},null,8,Ut)):g("",!0),s("div",Mt,[s("h6",St,c(i.nom),1),s("div",qt,[s("span",Et,c((parseFloat(i.prix)||0).toFixed(2))+" €",1),s("span",Tt,"Stock : "+c(i.stock??0)+" "+c(i.unite||"pièce"),1)])])],8,$t)]))),128))]))]),s("div",jt,[s("div",It,[s("div",Lt,[e[39]||(e[39]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-cart3 me-2"}),m("Panier")],-1)),s("div",Vt,[s("button",{class:"btn btn-sm btn-outline-light",onClick:e[3]||(e[3]=i=>o(t).nouveauPanier())},[...e[34]||(e[34]=[s("i",{class:"bi bi-file-earmark-plus me-1"},null,-1),m("Nouveau ",-1)])]),s("button",{class:"btn btn-sm btn-light",disabled:o(t).lignes.length===0,onClick:e[4]||(e[4]=i=>o(t).sauvegarderPanier())},[...e[35]||(e[35]=[s("i",{class:"bi bi-save me-1"},null,-1),m("Sauvegarder ",-1)])],8,Nt),s("button",{class:"btn btn-sm btn-info",onClick:e[5]||(e[5]=i=>o(t).showPaniersModal=!0)},[e[36]||(e[36]=s("i",{class:"bi bi-folder2-open me-1"},null,-1)),e[37]||(e[37]=m("Charger ",-1)),s("span",Dt,c(o(t).savedPaniers.length),1)])]),s("div",Rt,[e[38]||(e[38]=s("label",{class:"form-label mb-1 small"},[s("i",{class:"bi bi-person me-1"}),m("Utilisateur")],-1)),x(s("select",{"onUpdate:modelValue":e[6]||(e[6]=i=>o(t).selectedUtilisateur=i),class:"form-select form-select-sm"},[(l(!0),d(w,null,$(o(t).utilisateurs,i=>(l(),d("option",{key:i.id,value:i.id},c(i.username),9,Qt))),128))],512),[[q,o(t).selectedUtilisateur]])])]),s("div",Bt,[o(t).selectedUtilisateur?(l(),d("div",Ot,[s("label",zt,[e[41]||(e[41]=s("i",{class:"bi bi-basket me-1"},null,-1)),e[42]||(e[42]=m("Charger une commande catalogue ",-1)),s("span",{ref_key:"infobulleCommandesRef",ref:a,class:"d-inline-flex align-items-center text-muted ms-1",style:{cursor:"help"},title:Q,"data-bs-toggle":"tooltip","data-bs-placement":"top","data-bs-trigger":"hover focus","data-bs-title":Q},[...e[40]||(e[40]=[s("i",{class:"bi bi-info-circle",style:{"font-size":"1rem"}},null,-1)])],512)]),s("button",{type:"button",class:"btn btn-sm btn-outline-primary w-100 mb-2",disabled:o(t).loadingCommandes,onClick:e[7]||(e[7]=i=>o(t).chargerCommandesUtilisateur())},[e[43]||(e[43]=s("i",{class:"bi bi-arrow-clockwise me-1"},null,-1)),m(" "+c(o(t).loadingCommandes?"Chargement...":"Actualiser commandes"),1)],8,Jt),x(s("select",{"onUpdate:modelValue":e[8]||(e[8]=i=>o(t).selectedCommandeId=i),class:"form-select form-select-sm",disabled:!o(t).commandesUtilisateur.length},[e[44]||(e[44]=s("option",{value:null},"-- Sélectionner une commande --",-1)),(l(!0),d(w,null,$(o(t).commandesUtilisateur,i=>(l(),d("option",{key:i.id,value:i.id}," Cde #"+c(i.id)+" - "+c(i.catalogue_nom||"Catalogue")+" (Cat #"+c(i.catalog_id)+") | "+c(i.nb_articles)+" articles | "+c((parseFloat(i.total)||0).toFixed(2))+" € ",9,Gt))),128))],8,Kt),[[q,o(t).selectedCommandeId]]),o(t).commandesUtilisateur.length===0&&!o(t).loadingCommandes?(l(),d("small",Ht," Aucune commande en attente pour cet utilisateur ")):g("",!0),o(t).selectedCommandeId?(l(),d("button",{key:1,type:"button",class:"btn btn-sm btn-primary w-100 mt-2",onClick:K},[...e[45]||(e[45]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),m("Charger cette commande ",-1)])])):g("",!0)])):g("",!0),o(t).commandeSelectionnee?(l(),d("div",Xt,[e[46]||(e[46]=s("i",{class:"bi bi-info-circle me-1"},null,-1)),m(" Ce panier provient de la commande catalogue #"+c(o(t).commandeSelectionnee),1)])):g("",!0),o(t).lignes.length>0?(l(),d("button",{key:2,class:"btn btn-sm btn-warning w-100 mb-2",onClick:e[9]||(e[9]=i=>o(t).showAvoirModal=!0)},[...e[47]||(e[47]=[s("i",{class:"bi bi-receipt me-1"},null,-1),m("Ajouter un avoir ",-1)])])):g("",!0),o(t).lignes.length===0?(l(),d("div",Yt,[...e[48]||(e[48]=[s("i",{class:"bi bi-cart-x",style:{"font-size":"3rem"}},null,-1),s("p",{class:"mt-2 mb-0"},"Panier vide",-1)])])):(l(),d(w,{key:4},[s("div",Wt,[(l(!0),d(w,null,$(o(t).lignes,(i,y)=>(l(),d("div",{key:y,class:F(["border-bottom pb-2 mb-2",i.is_cotisation?"bg-info bg-opacity-10":i.is_avoir||!i.produit_id?"bg-warning bg-opacity-10":""])},[s("div",Zt,[s("strong",{class:F([i.is_cotisation?"text-info":i.is_avoir||!i.produit_id?"text-warning":""]),style:{"font-size":"0.9rem"}},[i.is_cotisation?(l(),d("i",te)):i.is_avoir||!i.produit_id?(l(),d("i",ee)):g("",!0),m(" "+c(i.nom_produit),1)],2),s("button",{class:"btn btn-sm btn-outline-danger",onClick:S=>o(t).supprimerLigne(y)},[...e[49]||(e[49]=[s("i",{class:"bi bi-x-lg"},null,-1)])],8,se)]),i.is_cotisation||i.is_avoir||!i.produit_id?(l(),d("div",ie,[s("strong",{class:F(i.is_cotisation?"text-info":"text-warning")},c(i.prix_unitaire.toFixed(2))+" €",3)])):(l(),d("div",ne,[s("div",oe,[s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:S=>o(t).modifierQuantite(y,Math.max(.001,i.quantite-(i.quantite_min||.001)))},[...e[50]||(e[50]=[s("i",{class:"bi bi-dash"},null,-1)])],8,ae),s("input",{type:"number",class:"form-control form-control-sm text-center quantite-input",value:i.quantite,min:"0.001",step:"0.001",style:{width:"60px"},onChange:S=>o(t).modifierQuantite(y,parseFloat(S.target.value)||.001)},null,40,re),s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:S=>o(t).modifierQuantite(y,i.quantite+(i.quantite_min||.001))},[...e[51]||(e[51]=[s("i",{class:"bi bi-plus"},null,-1)])],8,le),s("span",de,c(i.unite||"Pièce"),1)]),s("span",ue,[m(c(i.quantite.toFixed(3))+" × "+c(i.prix_unitaire.toFixed(2))+"€ = ",1),s("strong",ce,c((i.quantite*i.prix_unitaire).toFixed(2))+" €",1)])]))],2))),128))]),s("div",me,[s("div",be,[e[52]||(e[52]=s("span",{class:"text-muted"},"Articles:",-1)),s("span",null,c(o(t).nombreArticles),1)]),s("div",pe,[e[53]||(e[53]=s("h5",{class:"mb-0"},"Total:",-1)),s("h5",fe,c(o(t).total.toFixed(2))+" €",1)])]),s("div",ve,[s("button",{class:"btn btn-success btn-lg",disabled:o(t).lignes.length===0,onClick:e[10]||(e[10]=i=>o(t).ouvrirPaiement())},[...e[54]||(e[54]=[s("i",{class:"bi bi-check-circle me-2"},null,-1),m("Valider la vente ",-1)])],8,ge),s("button",{class:"btn btn-outline-danger",onClick:e[11]||(e[11]=i=>o(t).viderPanier())},[...e[55]||(e[55]=[s("i",{class:"bi bi-trash me-2"},null,-1),m("Vider le panier ",-1)])])])],64))])])])])]),o(t).showPaniersModal?(l(),d("div",he,[s("div",ye,[s("div",_e,[s("div",Ce,[e[57]||(e[57]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-folder2-open me-2"}),m("Paniers sauvegardés")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[12]||(e[12]=i=>o(t).showPaniersModal=!1)})]),s("div",ke,[o(t).savedPaniers.length===0?(l(),d("div",xe,"Aucun panier sauvegardé")):(l(),d("div",we,[(l(!0),d(w,null,$(o(t).savedPaniers,i=>(l(),d("div",{key:i.id,class:"card mb-2"},[s("div",Pe,[s("div",Ae,[s("div",Fe,[s("strong",null,c((i.lignes||[]).length)+" article(s)",1),e[59]||(e[59]=s("br",null,null,-1)),s("small",$e,[e[58]||(e[58]=s("i",{class:"bi bi-clock me-1"},null,-1)),m(c(new Date(i.saved_at).toLocaleString("fr-FR")),1)])]),s("div",Ue,[s("h5",Me,c((i.total||0).toFixed(2))+" €",1)]),s("div",Se,[s("button",{class:"btn btn-sm btn-primary me-2",onClick:y=>o(t).chargerPanier(i.id)},[...e[60]||(e[60]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),m("Charger ",-1)])],8,qe),s("button",{class:"btn btn-sm btn-outline-danger",onClick:y=>J(i.id)},[...e[61]||(e[61]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Ee)])])])]))),128))]))]),s("div",Te,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[13]||(e[13]=i=>o(t).showPaniersModal=!1)},"Fermer")])])])])):g("",!0),o(t).showPaiementModal?(l(),d("div",je,[s("div",Ie,[s("div",Le,[s("div",Ve,[e[62]||(e[62]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-credit-card me-2"}),m("Valider la vente")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[14]||(e[14]=i=>o(t).fermerPaiement())})]),s("div",Ne,[!j.value&&((k=o(t).cotisationCheck)!=null&&k.doit_cotiser)&&!o(t).aPanierCotisation?(l(),d("div",De,[e[63]||(e[63]=s("strong",null,[s("i",{class:"bi bi-info-circle me-1"}),m("Cotisation mensuelle")],-1)),s("p",Re,"Pour ce mois ("+c(o(t).cotisationCheck.mois_courant)+"), une cotisation entre 5 et 15 € est requise. Choisissez le montant :",1),s("div",Qe,[s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[15]||(e[15]=i=>o(t).ajouterCotisation(5))},"5 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[16]||(e[16]=i=>o(t).ajouterCotisation(10))},"10 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[17]||(e[17]=i=>o(t).ajouterCotisation(15))},"15 €")])])):g("",!0),j.value?(l(),d("div",Be,[e[64]||(e[64]=s("label",{class:"form-label small mb-1"},[s("i",{class:"bi bi-envelope me-1"}),m("Email pour recevoir la facture en PDF (optionnel) ")],-1)),x(s("input",{"onUpdate:modelValue":e[18]||(e[18]=i=>o(t).emailFactureAnonyme=i),type:"email",class:"form-control form-control-sm",placeholder:"exemple@email.com"},null,512),[[U,o(t).emailFactureAnonyme]])])):g("",!0),s("div",Oe,[e[65]||(e[65]=m(" Total à payer: ",-1)),s("strong",null,c(o(t).total.toFixed(2))+" €",1)]),s("div",ze,[e[67]||(e[67]=s("label",{class:"form-label"},"Mode de paiement *",-1)),x(s("select",{"onUpdate:modelValue":e[19]||(e[19]=i=>o(t).modePaiementId=i),class:"form-select"},[e[66]||(e[66]=s("option",{value:null},"-- Sélectionner --",-1)),(l(!0),d(w,null,$(o(t).modesPaiement,i=>(l(),d("option",{key:i.id,value:i.id},c(i.nom),9,Je))),128))],512),[[q,o(t).modePaiementId]])]),s("div",Ke,[e[68]||(e[68]=s("label",{class:"form-label"},"Montant reçu",-1)),x(s("input",{"onUpdate:modelValue":e[20]||(e[20]=i=>o(t).montantPaiement=i),type:"number",class:"form-control",step:"0.01",min:"0.01"},null,512),[[U,o(t).montantPaiement,void 0,{number:!0}]])]),o(t).montantPaiement>o(t).total?(l(),d("div",Ge,[e[69]||(e[69]=m(" Rendu monnaie: ",-1)),s("strong",null,c((o(t).montantPaiement-o(t).total).toFixed(2))+" €",1)])):g("",!0)]),s("div",He,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[21]||(e[21]=i=>o(t).fermerPaiement())},"Annuler"),s("button",{type:"button",class:"btn btn-success",disabled:!o(t).modePaiementId,onClick:e[22]||(e[22]=i=>o(t).validerVente())},[...e[70]||(e[70]=[s("i",{class:"bi bi-check-circle me-1"},null,-1),m("Valider la vente ",-1)])],8,Xe)])])])])):g("",!0),o(t).showModalChargerCommande?(l(),d("div",Ye,[s("div",We,[s("div",Ze,[s("div",ts,[e[71]||(e[71]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-cart-plus me-2"}),m("Ajouter la commande au panier")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[23]||(e[23]=i=>o(t).annulerChargerCommande())})]),e[72]||(e[72]=s("div",{class:"modal-body"},[s("p",null,"Le panier actuel contient déjà des articles."),s("p",null,[s("strong",null,"Les articles de la commande catalogue seront ajoutés au panier (les quantités des mêmes produits seront fusionnées).")])],-1)),s("div",es,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[24]||(e[24]=i=>o(t).annulerChargerCommande())},"Annuler"),s("button",{type:"button",class:"btn btn-primary",onClick:e[25]||(e[25]=i=>{var y;return o(t).chargerCommandeDansPanier((y=o(t).commandeACharger)==null?void 0:y.id)})}," Ajouter au panier ")])])])])):g("",!0),o(t).showAvoirModal?(l(),d("div",ss,[s("div",is,[s("div",ns,[s("div",os,[e[73]||(e[73]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-receipt me-2"}),m("Ajouter un avoir")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[26]||(e[26]=i=>o(t).showAvoirModal=!1)})]),s("div",as,[s("div",rs,[e[74]||(e[74]=m(" Total panier: ",-1)),s("strong",null,c(z.value.toFixed(2))+" €",1)]),s("div",ls,[e[75]||(e[75]=s("label",{class:"form-label"},"Montant de l'avoir *",-1)),x(s("input",{"onUpdate:modelValue":e[27]||(e[27]=i=>o(t).avoirMontant=i),type:"number",class:"form-control",step:"0.01",min:"0.01"},null,512),[[U,o(t).avoirMontant,void 0,{number:!0}]])]),s("div",ds,[e[76]||(e[76]=s("label",{class:"form-label"},"Commentaire",-1)),x(s("input",{"onUpdate:modelValue":e[28]||(e[28]=i=>o(t).avoirCommentaire=i),type:"text",class:"form-control",placeholder:"Ex: Remboursement"},null,512),[[U,o(t).avoirCommentaire]])])]),s("div",us,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[29]||(e[29]=i=>o(t).showAvoirModal=!1)},"Annuler"),s("button",{type:"button",class:"btn btn-warning",onClick:e[30]||(e[30]=i=>o(t).ajouterAvoir())},[...e[77]||(e[77]=[s("i",{class:"bi bi-check me-1"},null,-1),m("Ajouter l'avoir ",-1)])])])])])])):g("",!0)])}}},bs=mt(ms,[["__scopeId","data-v-c3196c0e"]]),O=et(bs);O.use(it());O.mount("#caisse-app");
