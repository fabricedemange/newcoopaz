import{i as te,x as L,y as se,m as B,o as u,c,a as s,b as f,j as O,u as o,t as b,d as P,z as ie,n as A,T as ne,e as $,v as U,F,l as M,s as E,r as T,g as z,h as oe}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as ae,c as re}from"./chunks/pinia-gLxYYWQL.js";import{_ as le}from"./chunks/BackButton-DzFd1NqY.js";import{D as de,E as ue,F as ce,G as me,H as pe,I as J,J as be,K as fe,L as he}from"./chunks/index-CY5spq3H.js";import{_ as ge}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const H="caisse_paniers_sauvegardes";function q(){try{const i=localStorage.getItem(H);return i?JSON.parse(i):[]}catch{return[]}}function K(i){try{localStorage.setItem(H,JSON.stringify(i))}catch(e){console.error("Erreur écriture localStorage:",e)}}function h(i){return Math.round(i*100)/100}function I(i){const e=i.filter(m=>!m.is_avoir).reduce((m,p)=>{const g=h(p.quantite*p.prix_unitaire),v=parseFloat(p.remise_pourcent)||0,x=h(g*(v/100));return m+h(g-x)},0),a=i.filter(m=>m.is_avoir);if(a.reduce((m,p)=>m+Math.abs(h(p.prix_unitaire)),0)<=e)return;let d=e;for(const m of a){const p=Math.abs(h(m.prix_unitaire)),g=h(Math.min(p,d));m.prix_unitaire=-g,d-=g}}const ve=ae("caisse",{state:()=>({produits:[],categories:[],searchQuery:"",selectedCategorie:null,produitsLoading:!1,utilisateurs:[],selectedUtilisateur:null,lignes:[],currentPanierId:null,savedPaniers:q(),showPaniersModal:!1,showAvoirModal:!1,avoirMontant:0,avoirCommentaire:"",showPaiementModal:!1,lignesPaiement:[],modesPaiement:[],error:null,commandesUtilisateur:[],loadingCommandes:!1,commandeSelectionnee:null,showModalChargerCommande:!1,commandeACharger:null,selectedCommandeId:null,cotisationCheck:null,emailFactureAnonyme:""}),getters:{produitsFiltresParRecherche(i){let e=[...i.produits];if(i.searchQuery){const a=i.searchQuery.trim();if(a){const r=a.toLowerCase().split(/\s+/).filter(d=>d.length>0);e=e.filter(d=>{const m=(d.nom||"").toLowerCase();return r.every(p=>m.includes(p))})}}return e},produitsFiltrés(i,e){let r=[...(e==null?void 0:e.produitsFiltresParRecherche)??(()=>{let d=[...i.produits];if(i.searchQuery){const m=i.searchQuery.trim();if(m){const p=m.toLowerCase().split(/\s+/).filter(g=>g.length>0);d=d.filter(g=>{const v=(g.nom||"").toLowerCase();return p.every(x=>v.includes(x))})}}return d})()];return i.selectedCategorie&&(r=r.filter(d=>d.category_id===i.selectedCategorie)),r.sort((d,m)=>{const p=Number(d.stock)??0;return(Number(m.stock)??0)-p})},total(i){const e=i.lignes.reduce((a,r)=>{const d=h(r.quantite*r.prix_unitaire),m=parseFloat(r.remise_pourcent)||0,p=h(d*(m/100));return a+h(d-p)},0);return h(e)},nombreArticles(i){return i.lignes.length},categoriesFiltrées(i,e){const a=(e==null?void 0:e.produitsFiltresParRecherche)??(()=>{let d=[...i.produits];if(i.searchQuery){const m=i.searchQuery.toLowerCase();d=d.filter(p=>p.nom.toLowerCase().includes(m))}return d})(),r=new Set(a.filter(d=>d.category_id).map(d=>d.category_id));return i.categories.filter(d=>r.has(d.id))},aPanierCotisation(i){return i.lignes.some(e=>e.is_cotisation===!0)},totalPaye(i){return h((i.lignesPaiement||[]).reduce((e,a)=>e+(parseFloat(a.montant)||0),0))},resteAPayer(i,e){const a=(e==null?void 0:e.total)??h(i.lignes.reduce((d,m)=>{const p=h(m.quantite*m.prix_unitaire),g=parseFloat(m.remise_pourcent)||0,v=h(p*(g/100));return d+h(p-v)},0)),r=(e==null?void 0:e.totalPaye)??h((i.lignesPaiement||[]).reduce((d,m)=>d+(parseFloat(m.montant)||0),0));return h(a-r)},peutValiderPaiement(i,e){const a=(e==null?void 0:e.total)??h(i.lignes.reduce((p,g)=>{const v=h(g.quantite*g.prix_unitaire),x=parseFloat(g.remise_pourcent)||0,k=h(v*(x/100));return p+h(v-k)},0)),r=(e==null?void 0:e.totalPaye)??h((i.lignesPaiement||[]).reduce((p,g)=>p+(parseFloat(g.montant)||0),0));return r<=0||r<a?!1:!(i.lignesPaiement||[]).some(p=>(parseFloat(p.montant)||0)>0&&!p.mode_paiement_id)}},actions:{async chargerProduits(){this.produitsLoading=!0,this.error=null;try{const i=await he();i.success&&(this.produits=i.produits||[],this.categories=i.categories||[])}catch(i){this.error=i.message}finally{this.produitsLoading=!1}},async chargerUtilisateurs(){var i,e;try{const a=await fe();if(a.success&&((i=a.utilisateurs)!=null&&i.length)){this.utilisateurs=a.utilisateurs;const r=a.utilisateurs.find(d=>(d.username||"").toLowerCase()==="anonyme");this.selectedUtilisateur=r?r.id:((e=a.utilisateurs[0])==null?void 0:e.id)??null}}catch(a){console.error("Erreur chargement utilisateurs:",a)}},async chargerModesPaiement(){try{const i=await be();i.success&&(this.modesPaiement=i.modes||[])}catch(i){console.error("Erreur chargement modes paiement:",i)}},ajouterProduit(i){const e=this.lignes.findIndex(a=>a.produit_id===i.id);if(e>=0){const a=this.lignes[e];return a.quantite+=parseFloat(i.quantite_min)||1,e}return this.lignes.push({produit_id:i.id,nom_produit:i.nom,quantite:parseFloat(i.quantite_min)||1,prix_unitaire:parseFloat(i.prix)||0,unite:i.unite||"Pièce",quantite_min:parseFloat(i.quantite_min)||1,is_avoir:!1,remise_pourcent:0}),this.lignes.length-1},ajouterProduitParEan(i){const e=String(i||"").trim().replace(/\s/g,"");if(!e)return{found:!1};const a=this.produits.find(r=>r.code_ean&&String(r.code_ean).trim().replace(/\s/g,"")===e);if(a){const r=this.ajouterProduit(a);return{found:!0,produit:a,lineIndex:r}}return{found:!1}},modifierQuantite(i,e){const a=this.lignes[i];a&&e>0&&(a.quantite=parseFloat(e),a.is_avoir||I(this.lignes))},modifierRemise(i,e){const a=this.lignes[i];if(a&&!a.is_avoir&&!a.is_cotisation){const r=parseFloat(e)||0;a.remise_pourcent=Math.max(0,Math.min(100,r)),a.is_avoir||I(this.lignes)}},supprimerLigne(i){const e=this.lignes[i],a=(e==null?void 0:e.is_avoir)===!0;this.lignes.splice(i,1),a||I(this.lignes)},viderPanier(){this.lignes=[],this.currentPanierId=null,this.commandeSelectionnee=null},sauvegarderPanier(){if(this.lignes.length===0)return;const i={id:this.currentPanierId||Date.now(),lignes:JSON.parse(JSON.stringify(this.lignes)),selectedUtilisateur:this.selectedUtilisateur,saved_at:new Date().toISOString(),total:this.total};let e=q();const a=e.findIndex(r=>r.id===i.id);a>=0?e[a]=i:e.push(i),K(e),this.savedPaniers=q(),this.currentPanierId=i.id},chargerPanier(i){const a=q().find(r=>r.id===i);a&&(this.lignes=JSON.parse(JSON.stringify(a.lignes)),this.selectedUtilisateur=a.selectedUtilisateur,this.currentPanierId=a.id,this.showPaniersModal=!1)},supprimerPanier(i){let e=q().filter(a=>a.id!==i);K(e),this.savedPaniers=e,this.currentPanierId===i&&this.viderPanier()},nouveauPanier(){this.lignes.length>0&&!confirm("Effacer le panier actuel ?")||this.viderPanier()},ajouterAvoir(){const i=parseFloat(this.avoirMontant);if(!i||i<=0)return;const e=this.lignes.filter(v=>!v.is_avoir).reduce((v,x)=>{const k=h(x.quantite*x.prix_unitaire),w=parseFloat(x.remise_pourcent)||0,S=h(k*(w/100));return v+h(k-S)},0),a=this.lignes.filter(v=>v.is_avoir).reduce((v,x)=>v+Math.abs(h(x.prix_unitaire)),0),r=h(e-a);if(r<=0)return;const d=h(i),m=h(Math.min(d,r)),p=this.avoirCommentaire||"Remboursement",g=m<d?`Avoir: ${p} (initial: ${d.toFixed(2)} €, limité à: ${m.toFixed(2)} €)`:`Avoir: ${p} (initial: ${m.toFixed(2)} €)`;this.lignes.push({produit_id:null,nom_produit:g,quantite:1,prix_unitaire:-m,unite:"",quantite_min:1,is_avoir:!0,remise_pourcent:0}),this.showAvoirModal=!1,this.avoirMontant=0,this.avoirCommentaire=""},async ouvrirPaiement(){this.lignesPaiement=[{mode_paiement_id:null,montant:h(this.total)}],this.showPaiementModal=!0,this.cotisationCheck=null,this.emailFactureAnonyme="";const i=this.utilisateurs.find(a=>a.id===this.selectedUtilisateur),e=i&&(i.username||"").toLowerCase()==="anonyme";if(this.selectedUtilisateur&&!e)try{const a=await J(this.selectedUtilisateur);a.success&&(this.cotisationCheck=a)}catch(a){console.error("Erreur vérification cotisation:",a)}},ajouterLignePaiement(){this.lignesPaiement.push({mode_paiement_id:null,montant:0})},supprimerLignePaiement(i){this.lignesPaiement.splice(i,1)},async checkCotisation(){if(this.cotisationCheck=null,!!this.selectedUtilisateur)try{const i=await J(this.selectedUtilisateur);i.success&&(this.cotisationCheck=i)}catch(i){console.error("Erreur vérification cotisation:",i)}},ajouterCotisation(i){const e=parseFloat(i);Number.isNaN(e)||e<5||e>15||this.lignes.some(a=>a.is_cotisation)||(this.lignes.push({produit_id:null,nom_produit:"Cotisation mensuelle",quantite:1,prix_unitaire:h(e),is_avoir:!1,is_cotisation:!0,remise_pourcent:0}),this.lignesPaiement.length&&(this.lignesPaiement[0].montant=h(this.total)))},fermerPaiement(){this.showPaiementModal=!1,this.lignesPaiement=[]},async chargerCommandesUtilisateur(){if(!this.selectedUtilisateur){this.commandesUtilisateur=[],this.commandeSelectionnee=null;return}this.loadingCommandes=!0;try{const i=await pe(this.selectedUtilisateur);this.commandesUtilisateur=Array.isArray(i)?i:[]}catch(i){console.error("Erreur chargement commandes:",i),this.commandesUtilisateur=[]}finally{this.loadingCommandes=!1}},async chargerCommandeDansPanier(i){this.showModalChargerCommande=!1,this.commandeACharger=null;try{const e=this.commandesUtilisateur.find(g=>g.id===i),a=(e==null?void 0:e.catalog_id)!=null?e.catalog_id:null,r=a!=null?` (cde #${i}, cat #${a})`:"",d=await me(i),m=Array.isArray(d)?d:[];let p=0;for(const g of m){if(!g.product_id_caisse)continue;const v=this.produits.find(w=>w.id===g.product_id_caisse);if(!v)continue;const x=parseFloat(g.quantity)||1,k=this.lignes.find(w=>w.produit_id===v.id&&!w.is_avoir);k?(k.quantite+=x,r&&!(k.nom_produit||"").includes("(cde ")&&(k.nom_produit=(k.nom_produit||"").trimEnd()+r)):this.lignes.push({produit_id:v.id,nom_produit:(v.nom||"").trimEnd()+r,quantite:x,prix_unitaire:parseFloat(v.prix)||0,unite:v.unite||"Pièce",quantite_min:parseFloat(v.quantite_min)||1,is_avoir:!1,remise_pourcent:0}),p++}this.commandeSelectionnee=i,this.selectedCommandeId=null,p>0&&alert(`Commande #${i} ajoutée au panier (${p} articles)`)}catch(e){console.error("Erreur chargement commande:",e),alert(e.message||"Erreur lors du chargement de la commande")}},confirmerChargerCommande(i){i&&this.chargerCommandeDansPanier(i.id)},annulerChargerCommande(){this.showModalChargerCommande=!1,this.commandeACharger=null},async validerVente(){if(!this.peutValiderPaiement){this.error=this.totalPaye<this.total?"Le total des paiements doit couvrir le montant à payer.":"Veuillez renseigner le mode de paiement pour chaque montant.";return}this.error=null;try{const i=this.utilisateurs.find(m=>m.id===this.selectedUtilisateur),e=(i==null?void 0:i.username)||"Anonyme",a=i&&(i.username||"").toLowerCase()==="anonyme",r=await de({adherent_id:a?null:this.selectedUtilisateur||null,nom_client:e,lignes:this.lignes,montant_ttc:this.total});if(!r.success)throw new Error(r.error);for(const m of this.lignesPaiement){const p=h(parseFloat(m.montant)||0);p<=0||!m.mode_paiement_id||await ue({vente_id:r.vente.id,mode_paiement_id:m.mode_paiement_id,montant:p})}this.currentPanierId&&this.supprimerPanier(this.currentPanierId),this.viderPanier(),this.fermerPaiement();const d=a?(this.emailFactureAnonyme||"").trim():((i==null?void 0:i.email)||"").trim();if(d){try{await ce(r.vente.id,d),alert(`Vente enregistrée ! Ticket n°${r.vente.numero_ticket}. Ticket envoyé par email au destinataire.`)}catch(m){alert(`Vente enregistrée (Ticket n°${r.vente.numero_ticket}). L'envoi du ticket par email a échoué : ${m.message}`)}a&&(this.emailFactureAnonyme="")}else alert(`Vente enregistrée ! Ticket n°${r.vente.numero_ticket}`)}catch(i){this.error=i.message,alert("Erreur : "+i.message)}}}}),ye={class:"admin-content-wrapper"},_e={class:"container-fluid px-3 mt-4"},Ce={class:"row mb-4"},xe={class:"col-12"},Pe={class:"d-flex justify-content-between align-items-center"},ke={class:"d-flex gap-2"},we={key:0,class:"alert alert-danger alert-dismissible fade show"},Fe={class:"row"},Ae={class:"col-lg-7 col-md-7 mb-4"},$e={class:"mb-3"},Me={class:"mb-3"},Ue={class:"badge bg-secondary fs-6 py-2 px-3"},qe={key:0,class:"mb-3"},Se={class:"d-flex flex-wrap gap-2"},Le=["onClick"],Te={key:1,class:"text-center py-5"},je={key:2,class:"alert alert-info text-center"},Ee={key:3,class:"row g-3"},Ie=["onClick"],Re=["src","alt"],Ve={class:"card-body p-2 d-flex flex-column"},Ne={class:"card-title mb-1",style:{"font-size":"0.9rem"}},De={class:"mt-auto pt-1 d-flex justify-content-between align-items-center"},Qe={class:"text-primary fw-bold"},Be={class:"col-lg-5 col-md-5"},Oe={class:"card",style:{"min-height":"calc(100vh - 120px)",display:"flex","flex-direction":"column"}},ze={class:"card-header bg-primary text-white"},Je={class:"d-flex gap-2 flex-wrap mt-2"},Ke=["disabled"],Ge={class:"badge bg-white text-info ms-1"},He={class:"mt-3"},Xe=["value"],Ye={class:"card-body",style:{flex:"1"}},We={key:0,class:"mb-3 border-bottom pb-3"},Ze={class:"form-label fw-bold small mb-2 d-flex align-items-center gap-1"},et=["disabled"],tt=["disabled"],st=["value"],it={key:0,class:"text-muted d-block mt-1"},nt={key:1,class:"alert alert-info py-2 px-3 mb-3",style:{"font-size":"0.85rem"}},ot={key:3,class:"text-center py-4 text-muted"},at={class:"mb-3"},rt={class:"d-flex justify-content-between align-items-start mb-1"},lt={key:0,class:"bi bi-coin me-1"},dt={key:1,class:"bi bi-receipt me-1"},ut=["onClick"],ct={key:0,class:"d-flex justify-content-end"},mt={key:1,class:"d-flex flex-column gap-2"},pt={class:"d-flex justify-content-between align-items-center"},bt={class:"d-flex align-items-center gap-1"},ft=["onClick"],ht=["value","onChange"],gt=["onClick"],vt={class:"text-muted small"},yt={class:"d-flex align-items-center gap-1"},_t=["value","onChange"],Ct={class:"d-flex justify-content-end"},xt={class:"text-muted"},Pt={key:0,class:"text-danger"},kt={class:"text-primary"},wt={class:"border-top pt-3 mb-3"},Ft={class:"d-flex justify-content-between align-items-center mb-2"},At={class:"d-flex justify-content-between align-items-center"},$t={class:"mb-0 text-primary"},Mt={class:"d-grid gap-2"},Ut=["disabled"],qt={key:0,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},St={class:"modal-dialog modal-lg"},Lt={class:"modal-content"},Tt={class:"modal-header"},jt={class:"modal-body"},Et={key:0,class:"alert alert-info"},It={key:1},Rt={class:"card-body"},Vt={class:"row align-items-center"},Nt={class:"col-md-6"},Dt={class:"text-primary"},Qt={class:"text-muted"},Bt={class:"col-md-3 text-end"},Ot={class:"mb-0 text-primary"},zt={class:"col-md-3 text-end"},Jt=["onClick"],Kt=["onClick"],Gt={class:"modal-footer"},Ht={key:1,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},Xt={class:"modal-dialog"},Yt={class:"modal-content"},Wt={class:"modal-header"},Zt={class:"modal-body"},es={key:0,class:"alert alert-warning mb-3"},ts={class:"mb-2 small"},ss={class:"d-flex gap-2 flex-wrap"},is={key:1,class:"alert alert-info mb-3"},ns={class:"alert alert-success mb-3"},os={class:"mb-2"},as=["onUpdate:modelValue"],rs=["value"],ls={class:"input-group",style:{"max-width":"120px"}},ds=["onUpdate:modelValue"],us=["disabled","title","onClick"],cs={class:"d-flex justify-content-between align-items-center mb-2"},ms={key:2,class:"alert alert-warning mb-2 py-2"},ps={key:3,class:"alert alert-info mb-2 py-2"},bs={class:"modal-footer"},fs=["disabled"],hs={key:2,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},gs={class:"modal-dialog"},vs={class:"modal-content"},ys={class:"modal-header"},_s={class:"modal-footer"},Cs={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},xs={class:"modal-dialog"},Ps={class:"modal-content"},ks={class:"modal-header"},ws={class:"modal-body"},Fs={class:"alert alert-info"},As={class:"mb-3"},$s={class:"mb-3"},Ms={class:"modal-footer"},R=4,Us=200,G="Règles d'affichage : sont listées uniquement les commandes dont le catalogue a une date d'expiration dépassée et dont le catalogue est masqué (invisible) pour l'utilisateur. Les commandes déjà transformées en vente caisse n'apparaissent pas.",qs={__name:"CaissePage",setup(i){const e=ve(),a=T(null),r=T({});function d(l,t){l&&(r.value[t]=l)}function m(l){const t=e.ajouterProduit(l);L(()=>{const y=r.value[t];y&&typeof y.focus=="function"&&y.focus()})}const p=T(""),g=T("success");let v=null;function x(l,t="success"){p.value=l,g.value=t,clearTimeout(v),v=setTimeout(()=>{p.value=""},2500)}let k="",w=null;function S(l){const t=()=>{var n;const y=r.value[l];y&&typeof y.focus=="function"&&(y.focus(),(n=y.select)==null||n.call(y))};L(()=>{t(),setTimeout(t,50)})}function j(){k=""}function Y(){const l=k.trim().replace(/\s/g,"");if(j(),l.length>=R&&/^\d+$/.test(l)){const t=e.ajouterProduitParEan(l);t.found?(x(`Ajouté : ${t.produit.nom}`,"success"),t.lineIndex!=null&&S(t.lineIndex)):x("Code non reconnu","warning")}}function V(l){const t=l.target&&(l.target.tagName==="INPUT"||l.target.tagName==="TEXTAREA"||l.target.isContentEditable);if(l.key==="Enter"){if(t){const y=(l.target.value||"").trim().replace(/\s/g,"");if(y.length>=R&&/^\d+$/.test(y)){l.preventDefault();const n=e.ajouterProduitParEan(y);n.found?(x(`Ajouté : ${n.produit.nom}`,"success"),n.lineIndex!=null&&S(n.lineIndex),e.searchQuery===y&&(e.searchQuery=""),l.target.value=""):x("Code non reconnu","warning")}}else k.length>=R&&/^\d+$/.test(k)?(l.preventDefault(),Y()):j();return}!t&&l.key.length===1&&!l.ctrlKey&&!l.metaKey&&!l.altKey&&(k+=l.key,clearTimeout(w),w=setTimeout(j,Us))}const W=z(()=>e.lignes.filter(l=>!l.is_avoir).reduce((l,t)=>l+t.quantite*t.prix_unitaire,0)),N=z(()=>{const l=e.utilisateurs.find(t=>t.id===e.selectedUtilisateur);return l&&(l.username||"").toLowerCase()==="anonyme"});function Z(l){confirm("Supprimer ce panier sauvegardé ?")&&e.supprimerPanier(l)}function ee(){const l=e.commandesUtilisateur.find(t=>t.id===e.selectedCommandeId);l&&e.confirmerChargerCommande(l)}function D(l){e.lignes.length>0&&(l.preventDefault(),l.returnValue="")}te(()=>{e.chargerProduits(),e.chargerUtilisateurs(),e.chargerModesPaiement(),L(()=>Q()),document.addEventListener("keydown",V),window.addEventListener("beforeunload",D)}),se(()=>{document.removeEventListener("keydown",V),window.removeEventListener("beforeunload",D),w&&clearTimeout(w),v&&clearTimeout(v)}),B(()=>e.searchQuery,()=>{e.selectedCategorie=null}),B(()=>e.selectedUtilisateur,l=>{l?(e.chargerCommandesUtilisateur(),L(()=>Q())):(e.commandesUtilisateur=[],e.commandeSelectionnee=null,e.selectedCommandeId=null)});function Q(){setTimeout(()=>{var t;const l=a.value;if(!(!l||typeof window>"u")&&(t=window.bootstrap)!=null&&t.Tooltip)try{const y=window.bootstrap.Tooltip.getInstance(l);y&&y.dispose(),new window.bootstrap.Tooltip(l,{trigger:"hover focus",placement:"top"})}catch{}},150)}return(l,t)=>{var y;return u(),c("div",ye,[s("div",_e,[s("div",Ce,[s("div",xe,[s("div",Pe,[t[30]||(t[30]=s("h2",{class:"mb-0"},[s("i",{class:"bi bi-cart-fill me-2"}),f("Caisse")],-1)),s("div",ke,[O(le),t[29]||(t[29]=s("a",{href:"/caisse/historique",class:"btn btn-outline-primary"},[s("i",{class:"bi bi-clock-history me-2"}),f("Historique des ventes ")],-1))])])])]),o(e).error?(u(),c("div",we,[f(b(o(e).error)+" ",1),s("button",{type:"button",class:"btn-close",onClick:t[0]||(t[0]=n=>o(e).error=null)})])):P("",!0),O(ne,{name:"scan-toast"},{default:ie(()=>[p.value?(u(),c("div",{key:0,class:A(["alert mb-2 py-2",g.value==="success"?"alert-success":"alert-warning"]),role:"status"},[s("i",{class:A(g.value==="success"?"bi bi-check-circle me-2":"bi bi-upc-scan me-2")},null,2),f(" "+b(p.value),1)],2)):P("",!0)]),_:1}),s("div",Fe,[s("div",Ae,[s("div",$e,[$(s("input",{"onUpdate:modelValue":t[1]||(t[1]=n=>o(e).searchQuery=n),type:"text",class:"form-control",placeholder:"Rechercher un produit...",style:{"max-width":"500px"}},null,512),[[U,o(e).searchQuery]])]),s("div",Me,[s("span",Ue,[t[31]||(t[31]=s("i",{class:"bi bi-box-seam me-1"},null,-1)),f(b(o(e).produitsFiltrés.length)+" produits disponibles ",1)])]),o(e).searchQuery&&o(e).categoriesFiltrées.length>0?(u(),c("div",qe,[s("div",Se,[(u(!0),c(F,null,M(o(e).categoriesFiltrées,n=>(u(),c("button",{key:n.id,class:A(["btn btn-sm",o(e).selectedCategorie===n.id?"btn-primary":"btn-outline-primary"]),onClick:C=>o(e).selectedCategorie=o(e).selectedCategorie===n.id?null:n.id},[f(b(n.nom)+" ",1),s("span",{class:A(["badge ms-2",o(e).selectedCategorie===n.id?"bg-light text-primary":"bg-primary"])},b(o(e).produitsFiltresParRecherche.filter(C=>C.category_id===n.id).length),3)],10,Le))),128))])])):P("",!0),o(e).produitsLoading?(u(),c("div",Te,[...t[32]||(t[32]=[s("div",{class:"spinner-border text-primary"},null,-1)])])):o(e).produitsFiltrés.length===0?(u(),c("div",je," Aucun produit disponible ")):(u(),c("div",Ee,[(u(!0),c(F,null,M(o(e).produitsFiltrés,n=>(u(),c("div",{key:n.id,class:"col-lg-4 col-md-6 col-sm-4 col-6"},[s("div",{class:"card h-100 produit-card",onClick:C=>m(n)},[n.image_url?(u(),c("img",{key:0,src:n.image_url,class:"card-img-top",alt:n.nom,style:{height:"120px","object-fit":"cover"}},null,8,Re)):P("",!0),s("div",Ve,[s("h6",Ne,b(n.nom),1),s("div",De,[s("span",Qe,b((parseFloat(n.prix)||0).toFixed(2))+" €",1),s("span",{class:A(["small",(Number(n.stock)??0)<=0?"fw-bold text-danger":"text-muted"])}," Stock : "+b((n.unite||"pièce").toLowerCase()==="pièce"?Math.floor(n.stock??0):n.stock??0)+" "+b((n.unite||"pièce").toLowerCase()==="pièce"?Math.floor(n.stock??0)<=1?"pièce":"pièces":n.unite||"pièce"),3)])])],8,Ie)]))),128))]))]),s("div",Be,[s("div",Oe,[s("div",ze,[t[38]||(t[38]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-cart3 me-2"}),f("Panier")],-1)),s("div",Je,[s("button",{class:"btn btn-sm btn-outline-light",onClick:t[2]||(t[2]=n=>o(e).nouveauPanier())},[...t[33]||(t[33]=[s("i",{class:"bi bi-file-earmark-plus me-1"},null,-1),f("Nouveau ",-1)])]),s("button",{class:"btn btn-sm btn-light",disabled:o(e).lignes.length===0,onClick:t[3]||(t[3]=n=>o(e).sauvegarderPanier())},[...t[34]||(t[34]=[s("i",{class:"bi bi-save me-1"},null,-1),f("Sauvegarder ",-1)])],8,Ke),s("button",{class:"btn btn-sm btn-info",onClick:t[4]||(t[4]=n=>o(e).showPaniersModal=!0)},[t[35]||(t[35]=s("i",{class:"bi bi-folder2-open me-1"},null,-1)),t[36]||(t[36]=f("Charger ",-1)),s("span",Ge,b(o(e).savedPaniers.length),1)])]),s("div",He,[t[37]||(t[37]=s("label",{class:"form-label mb-1 small"},[s("i",{class:"bi bi-person me-1"}),f("Utilisateur")],-1)),$(s("select",{"onUpdate:modelValue":t[5]||(t[5]=n=>o(e).selectedUtilisateur=n),class:"form-select form-select-sm"},[(u(!0),c(F,null,M(o(e).utilisateurs,n=>(u(),c("option",{key:n.id,value:n.id},b(n.username),9,Xe))),128))],512),[[E,o(e).selectedUtilisateur]])])]),s("div",Ye,[o(e).selectedUtilisateur?(u(),c("div",We,[s("label",Ze,[t[40]||(t[40]=s("i",{class:"bi bi-basket me-1"},null,-1)),t[41]||(t[41]=f("Charger une commande catalogue ",-1)),s("span",{ref_key:"infobulleCommandesRef",ref:a,class:"d-inline-flex align-items-center text-muted ms-1",style:{cursor:"help"},title:G,"data-bs-toggle":"tooltip","data-bs-placement":"top","data-bs-trigger":"hover focus","data-bs-title":G},[...t[39]||(t[39]=[s("i",{class:"bi bi-info-circle",style:{"font-size":"1rem"}},null,-1)])],512)]),s("button",{type:"button",class:"btn btn-sm btn-outline-primary w-100 mb-2",disabled:o(e).loadingCommandes,onClick:t[6]||(t[6]=n=>o(e).chargerCommandesUtilisateur())},[t[42]||(t[42]=s("i",{class:"bi bi-arrow-clockwise me-1"},null,-1)),f(" "+b(o(e).loadingCommandes?"Chargement...":"Actualiser commandes"),1)],8,et),$(s("select",{"onUpdate:modelValue":t[7]||(t[7]=n=>o(e).selectedCommandeId=n),class:"form-select form-select-sm",disabled:!o(e).commandesUtilisateur.length},[t[43]||(t[43]=s("option",{value:null},"-- Sélectionner une commande --",-1)),(u(!0),c(F,null,M(o(e).commandesUtilisateur,n=>(u(),c("option",{key:n.id,value:n.id}," Cde #"+b(n.id)+" - "+b(n.catalogue_nom||"Catalogue")+" (Cat #"+b(n.catalog_id)+") | "+b(n.nb_articles)+" articles | "+b((parseFloat(n.total)||0).toFixed(2))+" € ",9,st))),128))],8,tt),[[E,o(e).selectedCommandeId]]),o(e).commandesUtilisateur.length===0&&!o(e).loadingCommandes?(u(),c("small",it," Aucune commande en attente pour cet utilisateur ")):P("",!0),o(e).selectedCommandeId?(u(),c("button",{key:1,type:"button",class:"btn btn-sm btn-primary w-100 mt-2",onClick:ee},[...t[44]||(t[44]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),f("Charger cette commande ",-1)])])):P("",!0)])):P("",!0),o(e).commandeSelectionnee?(u(),c("div",nt,[t[45]||(t[45]=s("i",{class:"bi bi-info-circle me-1"},null,-1)),f(" Ce panier provient de la commande catalogue #"+b(o(e).commandeSelectionnee),1)])):P("",!0),o(e).lignes.length>0?(u(),c("button",{key:2,class:"btn btn-sm btn-warning w-100 mb-2",onClick:t[8]||(t[8]=n=>o(e).showAvoirModal=!0)},[...t[46]||(t[46]=[s("i",{class:"bi bi-receipt me-1"},null,-1),f("Ajouter un avoir ",-1)])])):P("",!0),o(e).lignes.length===0?(u(),c("div",ot,[...t[47]||(t[47]=[s("i",{class:"bi bi-cart-x",style:{"font-size":"3rem"}},null,-1),s("p",{class:"mt-2 mb-0"},"Panier vide",-1)])])):(u(),c(F,{key:4},[s("div",at,[(u(!0),c(F,null,M(o(e).lignes,(n,C)=>(u(),c("div",{key:C,class:A(["border-bottom pb-2 mb-2",n.is_cotisation?"bg-info bg-opacity-10":n.is_avoir||!n.produit_id?"bg-warning bg-opacity-10":""])},[s("div",rt,[s("strong",{class:A([n.is_cotisation?"text-info":n.is_avoir||!n.produit_id?"text-warning":""]),style:{"font-size":"0.9rem"}},[n.is_cotisation?(u(),c("i",lt)):n.is_avoir||!n.produit_id?(u(),c("i",dt)):P("",!0),f(" "+b(n.nom_produit),1)],2),s("button",{class:"btn btn-sm btn-outline-danger",onClick:_=>o(e).supprimerLigne(C)},[...t[48]||(t[48]=[s("i",{class:"bi bi-x-lg"},null,-1)])],8,ut)]),n.is_cotisation||n.is_avoir||!n.produit_id?(u(),c("div",ct,[s("strong",{class:A(n.is_cotisation?"text-info":"text-warning")},b(n.prix_unitaire.toFixed(2))+" €",3)])):(u(),c("div",mt,[s("div",pt,[s("div",bt,[s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:_=>o(e).modifierQuantite(C,Math.max(.001,n.quantite-(n.quantite_min||.001)))},[...t[49]||(t[49]=[s("i",{class:"bi bi-dash"},null,-1)])],8,ft),s("input",{ref_for:!0,ref:_=>d(_,C),type:"number",class:"form-control form-control-sm text-center quantite-input",value:n.quantite,min:"0.001",step:"0.001",style:{width:"60px"},onChange:_=>o(e).modifierQuantite(C,parseFloat(_.target.value)||.001)},null,40,ht),s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:_=>o(e).modifierQuantite(C,n.quantite+(n.quantite_min||.001))},[...t[50]||(t[50]=[s("i",{class:"bi bi-plus"},null,-1)])],8,gt),s("span",vt,b(n.unite||"Pièce"),1)]),s("div",yt,[t[51]||(t[51]=s("label",{class:"text-muted small mb-0"},"Remise:",-1)),s("input",{type:"number",class:"form-control form-control-sm text-center",value:n.remise_pourcent||0,min:"0",max:"100",step:"0.1",style:{width:"60px"},onChange:_=>o(e).modifierRemise(C,parseFloat(_.target.value)||0)},null,40,_t),t[52]||(t[52]=s("span",{class:"text-muted small"},"%",-1))])]),s("div",Ct,[s("span",xt,[f(b(n.quantite.toFixed(3))+" × "+b(n.prix_unitaire.toFixed(2))+"€ ",1),(n.remise_pourcent||0)>0?(u(),c("span",Pt," - "+b((n.quantite*n.prix_unitaire*(n.remise_pourcent/100)).toFixed(2))+"€ ("+b(n.remise_pourcent)+"%) ",1)):P("",!0),t[53]||(t[53]=f(" = ",-1)),s("strong",kt,b((n.quantite*n.prix_unitaire*(1-(n.remise_pourcent||0)/100)).toFixed(2))+" €",1)])])]))],2))),128))]),s("div",wt,[s("div",Ft,[t[54]||(t[54]=s("span",{class:"text-muted"},"Articles:",-1)),s("span",null,b(o(e).nombreArticles),1)]),s("div",At,[t[55]||(t[55]=s("h5",{class:"mb-0"},"Total:",-1)),s("h5",$t,b(o(e).total.toFixed(2))+" €",1)])]),s("div",Mt,[s("button",{class:"btn btn-success btn-lg",disabled:o(e).lignes.length===0,onClick:t[9]||(t[9]=n=>o(e).ouvrirPaiement())},[...t[56]||(t[56]=[s("i",{class:"bi bi-check-circle me-2"},null,-1),f("Valider la vente ",-1)])],8,Ut),s("button",{class:"btn btn-outline-danger",onClick:t[10]||(t[10]=n=>o(e).viderPanier())},[...t[57]||(t[57]=[s("i",{class:"bi bi-trash me-2"},null,-1),f("Vider le panier ",-1)])])])],64))])])])])]),o(e).showPaniersModal?(u(),c("div",qt,[s("div",St,[s("div",Lt,[s("div",Tt,[t[58]||(t[58]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-folder2-open me-2"}),f("Paniers sauvegardés")],-1)),s("button",{type:"button",class:"btn-close",onClick:t[11]||(t[11]=n=>o(e).showPaniersModal=!1)})]),s("div",jt,[o(e).savedPaniers.length===0?(u(),c("div",Et,"Aucun panier sauvegardé")):(u(),c("div",It,[(u(!0),c(F,null,M(o(e).savedPaniers,n=>{var C;return u(),c("div",{key:n.id,class:"card mb-2"},[s("div",Rt,[s("div",Vt,[s("div",Nt,[s("strong",null,b((n.lignes||[]).length)+" article(s)",1),t[61]||(t[61]=s("span",{class:"text-muted ms-2"},"—",-1)),s("span",Dt,[t[59]||(t[59]=s("i",{class:"bi bi-person me-1"},null,-1)),f(b(((C=o(e).utilisateurs.find(_=>_.id===n.selectedUtilisateur))==null?void 0:C.username)||"Non assigné"),1)]),t[62]||(t[62]=s("br",null,null,-1)),s("small",Qt,[t[60]||(t[60]=s("i",{class:"bi bi-clock me-1"},null,-1)),f(b(new Date(n.saved_at).toLocaleString("fr-FR")),1)])]),s("div",Bt,[s("h5",Ot,b((n.total||0).toFixed(2))+" €",1)]),s("div",zt,[s("button",{class:"btn btn-sm btn-primary me-2",onClick:_=>o(e).chargerPanier(n.id)},[...t[63]||(t[63]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),f("Charger ",-1)])],8,Jt),s("button",{class:"btn btn-sm btn-outline-danger",onClick:_=>Z(n.id)},[...t[64]||(t[64]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Kt)])])])])}),128))]))]),s("div",Gt,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[12]||(t[12]=n=>o(e).showPaniersModal=!1)},"Fermer")])])])])):P("",!0),o(e).showPaiementModal?(u(),c("div",Ht,[s("div",Xt,[s("div",Yt,[s("div",Wt,[t[65]||(t[65]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-credit-card me-2"}),f("Valider la vente")],-1)),s("button",{type:"button",class:"btn-close",onClick:t[13]||(t[13]=n=>o(e).fermerPaiement())})]),s("div",Zt,[!N.value&&((y=o(e).cotisationCheck)!=null&&y.doit_cotiser)&&!o(e).aPanierCotisation?(u(),c("div",es,[t[66]||(t[66]=s("strong",null,[s("i",{class:"bi bi-info-circle me-1"}),f("Cotisation mensuelle")],-1)),s("p",ts,"Pour ce mois ("+b(o(e).cotisationCheck.mois_courant)+"), une cotisation entre 5 et 15 € est requise. Choisissez le montant :",1),s("div",ss,[s("button",{type:"button",class:"btn btn-outline-primary",onClick:t[14]||(t[14]=n=>o(e).ajouterCotisation(5))},"5 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:t[15]||(t[15]=n=>o(e).ajouterCotisation(10))},"10 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:t[16]||(t[16]=n=>o(e).ajouterCotisation(15))},"15 €")])])):P("",!0),N.value?(u(),c("div",is,[t[67]||(t[67]=s("label",{class:"form-label small mb-1"},[s("i",{class:"bi bi-envelope me-1"}),f("Email pour recevoir la facture en PDF (optionnel) ")],-1)),$(s("input",{"onUpdate:modelValue":t[17]||(t[17]=n=>o(e).emailFactureAnonyme=n),type:"email",class:"form-control form-control-sm",placeholder:"exemple@email.com"},null,512),[[U,o(e).emailFactureAnonyme]])])):P("",!0),s("div",ns,[t[68]||(t[68]=f(" Total à payer: ",-1)),s("strong",null,b(o(e).total.toFixed(2))+" €",1)]),s("div",os,[t[73]||(t[73]=s("label",{class:"form-label"},"Paiements",-1)),(u(!0),c(F,null,M(o(e).lignesPaiement,(n,C)=>(u(),c("div",{key:C,class:"d-flex gap-2 align-items-start mb-2"},[$(s("select",{"onUpdate:modelValue":_=>n.mode_paiement_id=_,class:"form-select flex-grow-1",style:{"min-width":"140px"}},[t[69]||(t[69]=s("option",{value:null},"-- Mode --",-1)),(u(!0),c(F,null,M(o(e).modesPaiement,_=>(u(),c("option",{key:_.id,value:_.id},b(_.nom),9,rs))),128))],8,as),[[E,n.mode_paiement_id]]),s("div",ls,[$(s("input",{"onUpdate:modelValue":_=>n.montant=_,type:"number",class:"form-control",step:"0.01",min:"0",placeholder:"Montant"},null,8,ds),[[U,n.montant,void 0,{number:!0}]]),t[70]||(t[70]=s("span",{class:"input-group-text"},"€",-1))]),s("button",{type:"button",class:"btn btn-outline-danger btn-sm",disabled:o(e).lignesPaiement.length<=1,title:o(e).lignesPaiement.length<=1?"Garder au moins une ligne":"Supprimer",onClick:_=>o(e).supprimerLignePaiement(C)},[...t[71]||(t[71]=[s("i",{class:"bi bi-trash"},null,-1)])],8,us)]))),128)),s("button",{type:"button",class:"btn btn-outline-secondary btn-sm mt-1",onClick:t[18]||(t[18]=n=>o(e).ajouterLignePaiement())},[...t[72]||(t[72]=[s("i",{class:"bi bi-plus me-1"},null,-1),f("Ajouter un paiement ",-1)])])]),s("div",cs,[t[74]||(t[74]=s("span",null,"Total payé:",-1)),s("strong",null,b(o(e).totalPaye.toFixed(2))+" €",1)]),o(e).resteAPayer>0?(u(),c("div",ms,[t[75]||(t[75]=s("i",{class:"bi bi-exclamation-triangle me-1"},null,-1)),t[76]||(t[76]=f("Reste à payer: ",-1)),s("strong",null,b(o(e).resteAPayer.toFixed(2))+" €",1),t[77]||(t[77]=f(". La vente ne peut pas être validée tant que le montant n'est pas entièrement couvert. ",-1))])):o(e).resteAPayer<0?(u(),c("div",ps,[t[78]||(t[78]=f(" Rendu monnaie: ",-1)),s("strong",null,b((-o(e).resteAPayer).toFixed(2))+" €",1)])):P("",!0)]),s("div",bs,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[19]||(t[19]=n=>o(e).fermerPaiement())},"Annuler"),s("button",{type:"button",class:"btn btn-success",disabled:!o(e).peutValiderPaiement,onClick:t[20]||(t[20]=n=>o(e).validerVente())},[...t[79]||(t[79]=[s("i",{class:"bi bi-check-circle me-1"},null,-1),f("Valider la vente ",-1)])],8,fs)])])])])):P("",!0),o(e).showModalChargerCommande?(u(),c("div",hs,[s("div",gs,[s("div",vs,[s("div",ys,[t[80]||(t[80]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-cart-plus me-2"}),f("Ajouter la commande au panier")],-1)),s("button",{type:"button",class:"btn-close",onClick:t[21]||(t[21]=n=>o(e).annulerChargerCommande())})]),t[81]||(t[81]=s("div",{class:"modal-body"},[s("p",null,"Le panier actuel contient déjà des articles."),s("p",null,[s("strong",null,"Les articles de la commande catalogue seront ajoutés au panier (les quantités des mêmes produits seront fusionnées).")])],-1)),s("div",_s,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[22]||(t[22]=n=>o(e).annulerChargerCommande())},"Annuler"),s("button",{type:"button",class:"btn btn-primary",onClick:t[23]||(t[23]=n=>{var C;return o(e).chargerCommandeDansPanier((C=o(e).commandeACharger)==null?void 0:C.id)})}," Ajouter au panier ")])])])])):P("",!0),o(e).showAvoirModal?(u(),c("div",Cs,[s("div",xs,[s("div",Ps,[s("div",ks,[t[82]||(t[82]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-receipt me-2"}),f("Ajouter un avoir")],-1)),s("button",{type:"button",class:"btn-close",onClick:t[24]||(t[24]=n=>o(e).showAvoirModal=!1)})]),s("div",ws,[s("div",Fs,[t[83]||(t[83]=f(" Total panier: ",-1)),s("strong",null,b(W.value.toFixed(2))+" €",1)]),s("div",As,[t[84]||(t[84]=s("label",{class:"form-label"},"Montant de l'avoir *",-1)),$(s("input",{"onUpdate:modelValue":t[25]||(t[25]=n=>o(e).avoirMontant=n),type:"number",class:"form-control",step:"0.01",min:"0.01"},null,512),[[U,o(e).avoirMontant,void 0,{number:!0}]])]),s("div",$s,[t[85]||(t[85]=s("label",{class:"form-label"},"Commentaire",-1)),$(s("input",{"onUpdate:modelValue":t[26]||(t[26]=n=>o(e).avoirCommentaire=n),type:"text",class:"form-control",placeholder:"Ex: Remboursement"},null,512),[[U,o(e).avoirCommentaire]])])]),s("div",Ms,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[27]||(t[27]=n=>o(e).showAvoirModal=!1)},"Annuler"),s("button",{type:"button",class:"btn btn-warning",onClick:t[28]||(t[28]=n=>o(e).ajouterAvoir())},[...t[86]||(t[86]=[s("i",{class:"bi bi-check me-1"},null,-1),f("Ajouter l'avoir ",-1)])])])])])])):P("",!0)])}}},Ss=ge(qs,[["__scopeId","data-v-374e936a"]]),X=oe(Ss);X.use(re());X.mount("#caisse-app");
