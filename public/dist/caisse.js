import{i as W,x as M,y as Z,m as tt,o as r,c as d,a as s,b as c,j as R,u as o,t as m,d as C,z as et,n as F,T as st,e as $,v as q,F as A,l as U,s as E,r as j,g as D,h as it}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as nt,c as ot}from"./chunks/pinia-gLxYYWQL.js";import{_ as at}from"./chunks/BackButton-DzFd1NqY.js";import{D as lt,E as rt,F as dt,G as ut,H as ct,I as Q,J as mt,K as bt,L as pt}from"./chunks/index-CQL6Akic.js";import{_ as ft}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const J="caisse_paniers_sauvegardes";function S(){try{const i=localStorage.getItem(J);return i?JSON.parse(i):[]}catch{return[]}}function O(i){try{localStorage.setItem(J,JSON.stringify(i))}catch(t){console.error("Erreur écriture localStorage:",t)}}function g(i){return Math.round(i*100)/100}function z(i){const t=i.filter(b=>!b.is_avoir).reduce((b,p)=>b+g(p.quantite*p.prix_unitaire),0),a=i.filter(b=>b.is_avoir);if(a.reduce((b,p)=>b+Math.abs(g(p.prix_unitaire)),0)<=t)return;let f=t;for(const b of a){const p=Math.abs(g(b.prix_unitaire)),y=g(Math.min(p,f));b.prix_unitaire=-y,f-=y}}const gt=nt("caisse",{state:()=>({produits:[],categories:[],searchQuery:"",selectedCategorie:null,produitsLoading:!1,utilisateurs:[],selectedUtilisateur:null,lignes:[],currentPanierId:null,savedPaniers:S(),showPaniersModal:!1,showAvoirModal:!1,avoirMontant:0,avoirCommentaire:"",showPaiementModal:!1,lignesPaiement:[],modesPaiement:[],error:null,commandesUtilisateur:[],loadingCommandes:!1,commandeSelectionnee:null,showModalChargerCommande:!1,commandeACharger:null,selectedCommandeId:null,cotisationCheck:null,emailFactureAnonyme:""}),getters:{produitsFiltrés(i){let t=[...i.produits];if(i.searchQuery){const a=i.searchQuery.toLowerCase();t=t.filter(l=>l.nom.toLowerCase().includes(a))}return i.selectedCategorie&&(t=t.filter(a=>a.category_id===i.selectedCategorie)),t.sort((a,l)=>{const f=Number(a.stock)??0;return(Number(l.stock)??0)-f})},total(i){const t=i.lignes.reduce((a,l)=>a+g(l.quantite*l.prix_unitaire),0);return g(t)},nombreArticles(i){return i.lignes.length},categoriesFiltrées(i){let t=[...i.produits];if(i.searchQuery){const l=i.searchQuery.toLowerCase();t=t.filter(f=>f.nom.toLowerCase().includes(l))}const a=new Set(t.filter(l=>l.category_id).map(l=>l.category_id));return i.categories.filter(l=>a.has(l.id))},aPanierCotisation(i){return i.lignes.some(t=>t.is_cotisation===!0)},totalPaye(i){return g((i.lignesPaiement||[]).reduce((t,a)=>t+(parseFloat(a.montant)||0),0))},resteAPayer(i,t){const a=(t==null?void 0:t.total)??g(i.lignes.reduce((f,b)=>f+g(b.quantite*b.prix_unitaire),0)),l=(t==null?void 0:t.totalPaye)??g((i.lignesPaiement||[]).reduce((f,b)=>f+(parseFloat(b.montant)||0),0));return g(a-l)},peutValiderPaiement(i,t){const a=(t==null?void 0:t.total)??g(i.lignes.reduce((p,y)=>p+g(y.quantite*y.prix_unitaire),0)),l=(t==null?void 0:t.totalPaye)??g((i.lignesPaiement||[]).reduce((p,y)=>p+(parseFloat(y.montant)||0),0));return l<=0||l<a?!1:!(i.lignesPaiement||[]).some(p=>(parseFloat(p.montant)||0)>0&&!p.mode_paiement_id)}},actions:{async chargerProduits(){this.produitsLoading=!0,this.error=null;try{const i=await pt();i.success&&(this.produits=i.produits||[],this.categories=i.categories||[])}catch(i){this.error=i.message}finally{this.produitsLoading=!1}},async chargerUtilisateurs(){var i,t;try{const a=await bt();if(a.success&&((i=a.utilisateurs)!=null&&i.length)){this.utilisateurs=a.utilisateurs;const l=a.utilisateurs.find(f=>(f.username||"").toLowerCase()==="anonyme");this.selectedUtilisateur=l?l.id:((t=a.utilisateurs[0])==null?void 0:t.id)??null}}catch(a){console.error("Erreur chargement utilisateurs:",a)}},async chargerModesPaiement(){try{const i=await mt();i.success&&(this.modesPaiement=i.modes||[])}catch(i){console.error("Erreur chargement modes paiement:",i)}},ajouterProduit(i){const t=this.lignes.findIndex(a=>a.produit_id===i.id);if(t>=0){const a=this.lignes[t];return a.quantite+=parseFloat(i.quantite_min)||1,t}return this.lignes.push({produit_id:i.id,nom_produit:i.nom,quantite:parseFloat(i.quantite_min)||1,prix_unitaire:parseFloat(i.prix)||0,unite:i.unite||"Pièce",quantite_min:parseFloat(i.quantite_min)||1,is_avoir:!1}),this.lignes.length-1},ajouterProduitParEan(i){const t=String(i||"").trim().replace(/\s/g,"");if(!t)return{found:!1};const a=this.produits.find(l=>l.code_ean&&String(l.code_ean).trim().replace(/\s/g,"")===t);if(a){const l=this.ajouterProduit(a);return{found:!0,produit:a,lineIndex:l}}return{found:!1}},modifierQuantite(i,t){const a=this.lignes[i];a&&t>0&&(a.quantite=parseFloat(t),a.is_avoir||z(this.lignes))},supprimerLigne(i){const t=this.lignes[i],a=(t==null?void 0:t.is_avoir)===!0;this.lignes.splice(i,1),a||z(this.lignes)},viderPanier(){this.lignes=[],this.currentPanierId=null,this.commandeSelectionnee=null},sauvegarderPanier(){if(this.lignes.length===0)return;const i={id:this.currentPanierId||Date.now(),lignes:JSON.parse(JSON.stringify(this.lignes)),selectedUtilisateur:this.selectedUtilisateur,saved_at:new Date().toISOString(),total:this.total};let t=S();const a=t.findIndex(l=>l.id===i.id);a>=0?t[a]=i:t.push(i),O(t),this.savedPaniers=S(),this.currentPanierId=i.id},chargerPanier(i){const a=S().find(l=>l.id===i);a&&(this.lignes=JSON.parse(JSON.stringify(a.lignes)),this.selectedUtilisateur=a.selectedUtilisateur,this.currentPanierId=a.id,this.showPaniersModal=!1)},supprimerPanier(i){let t=S().filter(a=>a.id!==i);O(t),this.savedPaniers=t,this.currentPanierId===i&&this.viderPanier()},nouveauPanier(){this.lignes.length>0&&!confirm("Effacer le panier actuel ?")||this.viderPanier()},ajouterAvoir(){const i=parseFloat(this.avoirMontant);if(!i||i<=0)return;const t=this.lignes.filter(h=>!h.is_avoir).reduce((h,P)=>h+g(P.quantite*P.prix_unitaire),0),a=this.lignes.filter(h=>h.is_avoir).reduce((h,P)=>h+Math.abs(g(P.prix_unitaire)),0),l=g(t-a);if(l<=0)return;const f=g(i),b=g(Math.min(f,l)),p=this.avoirCommentaire||"Remboursement",y=b<f?`Avoir: ${p} (initial: ${f.toFixed(2)} €, limité à: ${b.toFixed(2)} €)`:`Avoir: ${p} (initial: ${b.toFixed(2)} €)`;this.lignes.push({produit_id:null,nom_produit:y,quantite:1,prix_unitaire:-b,unite:"",quantite_min:1,is_avoir:!0}),this.showAvoirModal=!1,this.avoirMontant=0,this.avoirCommentaire=""},async ouvrirPaiement(){this.lignesPaiement=[{mode_paiement_id:null,montant:g(this.total)}],this.showPaiementModal=!0,this.cotisationCheck=null,this.emailFactureAnonyme="";const i=this.utilisateurs.find(a=>a.id===this.selectedUtilisateur),t=i&&(i.username||"").toLowerCase()==="anonyme";if(this.selectedUtilisateur&&!t)try{const a=await Q(this.selectedUtilisateur);a.success&&(this.cotisationCheck=a)}catch(a){console.error("Erreur vérification cotisation:",a)}},ajouterLignePaiement(){this.lignesPaiement.push({mode_paiement_id:null,montant:0})},supprimerLignePaiement(i){this.lignesPaiement.splice(i,1)},async checkCotisation(){if(this.cotisationCheck=null,!!this.selectedUtilisateur)try{const i=await Q(this.selectedUtilisateur);i.success&&(this.cotisationCheck=i)}catch(i){console.error("Erreur vérification cotisation:",i)}},ajouterCotisation(i){const t=parseFloat(i);Number.isNaN(t)||t<5||t>15||this.lignes.some(a=>a.is_cotisation)||(this.lignes.push({produit_id:null,nom_produit:"Cotisation mensuelle",quantite:1,prix_unitaire:g(t),is_avoir:!1,is_cotisation:!0}),this.lignesPaiement.length&&(this.lignesPaiement[0].montant=g(this.total)))},fermerPaiement(){this.showPaiementModal=!1,this.lignesPaiement=[]},async chargerCommandesUtilisateur(){if(!this.selectedUtilisateur){this.commandesUtilisateur=[],this.commandeSelectionnee=null;return}this.loadingCommandes=!0;try{const i=await ct(this.selectedUtilisateur);this.commandesUtilisateur=Array.isArray(i)?i:[]}catch(i){console.error("Erreur chargement commandes:",i),this.commandesUtilisateur=[]}finally{this.loadingCommandes=!1}},async chargerCommandeDansPanier(i){this.showModalChargerCommande=!1,this.commandeACharger=null;try{const t=this.commandesUtilisateur.find(y=>y.id===i),a=(t==null?void 0:t.catalog_id)!=null?t.catalog_id:null,l=a!=null?` (cde #${i}, cat #${a})`:"",f=await ut(i),b=Array.isArray(f)?f:[];let p=0;for(const y of b){if(!y.product_id_caisse)continue;const h=this.produits.find(w=>w.id===y.product_id_caisse);if(!h)continue;const P=parseFloat(y.quantity)||1,k=this.lignes.find(w=>w.produit_id===h.id&&!w.is_avoir);k?(k.quantite+=P,l&&!(k.nom_produit||"").includes("(cde ")&&(k.nom_produit=(k.nom_produit||"").trimEnd()+l)):this.lignes.push({produit_id:h.id,nom_produit:(h.nom||"").trimEnd()+l,quantite:P,prix_unitaire:parseFloat(h.prix)||0,unite:h.unite||"Pièce",quantite_min:parseFloat(h.quantite_min)||1,is_avoir:!1}),p++}this.commandeSelectionnee=i,this.selectedCommandeId=null,p>0&&alert(`Commande #${i} ajoutée au panier (${p} articles)`)}catch(t){console.error("Erreur chargement commande:",t),alert(t.message||"Erreur lors du chargement de la commande")}},confirmerChargerCommande(i){i&&this.chargerCommandeDansPanier(i.id)},annulerChargerCommande(){this.showModalChargerCommande=!1,this.commandeACharger=null},async validerVente(){if(!this.peutValiderPaiement){this.error=this.totalPaye<this.total?"Le total des paiements doit couvrir le montant à payer.":"Veuillez renseigner le mode de paiement pour chaque montant.";return}this.error=null;try{const i=this.utilisateurs.find(b=>b.id===this.selectedUtilisateur),t=(i==null?void 0:i.username)||"Anonyme",a=i&&(i.username||"").toLowerCase()==="anonyme",l=await lt({adherent_id:a?null:this.selectedUtilisateur||null,nom_client:t,lignes:this.lignes,montant_ttc:this.total});if(!l.success)throw new Error(l.error);for(const b of this.lignesPaiement){const p=g(parseFloat(b.montant)||0);p<=0||!b.mode_paiement_id||await rt({vente_id:l.vente.id,mode_paiement_id:b.mode_paiement_id,montant:p})}this.currentPanierId&&this.supprimerPanier(this.currentPanierId),this.viderPanier(),this.fermerPaiement();const f=(this.emailFactureAnonyme||"").trim();if(f){try{await dt(l.vente.id,f),alert(`Vente enregistrée ! Ticket n°${l.vente.numero_ticket}. Facture envoyée par email.`)}catch(b){alert(`Vente enregistrée (Ticket n°${l.vente.numero_ticket}). Envoi de la facture par email a échoué : ${b.message}`)}this.emailFactureAnonyme=""}else alert(`Vente enregistrée ! Ticket n°${l.vente.numero_ticket}`)}catch(i){this.error=i.message,alert("Erreur : "+i.message)}}}}),vt={class:"admin-content-wrapper"},ht={class:"container-fluid px-3 mt-4"},yt={class:"row mb-4"},_t={class:"col-12"},Ct={class:"d-flex justify-content-between align-items-center"},xt={class:"d-flex gap-2"},Pt={key:0,class:"alert alert-danger alert-dismissible fade show"},kt={class:"row"},wt={class:"col-lg-7 col-md-7 mb-4"},At={class:"mb-3"},Ft={class:"mb-3"},$t={class:"badge bg-secondary fs-6 py-2 px-3"},Ut={key:0,class:"mb-3"},Mt={class:"d-flex flex-wrap gap-2"},qt=["onClick"],St={key:1,class:"text-center py-5"},jt={key:2,class:"alert alert-info text-center"},Tt={key:3,class:"row g-3"},Et=["onClick"],It=["src","alt"],Lt={class:"card-body p-2 d-flex flex-column"},Vt={class:"card-title mb-1",style:{"font-size":"0.9rem"}},Nt={class:"mt-auto pt-1 d-flex justify-content-between align-items-center"},Rt={class:"text-primary fw-bold"},Dt={class:"col-lg-5 col-md-5"},Qt={class:"card",style:{"min-height":"calc(100vh - 120px)",display:"flex","flex-direction":"column"}},Ot={class:"card-header bg-primary text-white"},zt={class:"d-flex gap-2 flex-wrap mt-2"},Bt=["disabled"],Jt={class:"badge bg-white text-info ms-1"},Kt={class:"mt-3"},Gt=["value"],Ht={class:"card-body",style:{flex:"1"}},Xt={key:0,class:"mb-3 border-bottom pb-3"},Yt={class:"form-label fw-bold small mb-2 d-flex align-items-center gap-1"},Wt=["disabled"],Zt=["disabled"],te=["value"],ee={key:0,class:"text-muted d-block mt-1"},se={key:1,class:"alert alert-info py-2 px-3 mb-3",style:{"font-size":"0.85rem"}},ie={key:3,class:"text-center py-4 text-muted"},ne={class:"mb-3"},oe={class:"d-flex justify-content-between align-items-start mb-1"},ae={key:0,class:"bi bi-coin me-1"},le={key:1,class:"bi bi-receipt me-1"},re=["onClick"],de={key:0,class:"d-flex justify-content-end"},ue={key:1,class:"d-flex justify-content-between align-items-center"},ce={class:"d-flex align-items-center gap-1"},me=["onClick"],be=["value","onChange"],pe=["onClick"],fe={class:"text-muted small"},ge={class:"text-muted"},ve={class:"text-primary"},he={class:"border-top pt-3 mb-3"},ye={class:"d-flex justify-content-between align-items-center mb-2"},_e={class:"d-flex justify-content-between align-items-center"},Ce={class:"mb-0 text-primary"},xe={class:"d-grid gap-2"},Pe=["disabled"],ke={key:0,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},we={class:"modal-dialog modal-lg"},Ae={class:"modal-content"},Fe={class:"modal-header"},$e={class:"modal-body"},Ue={key:0,class:"alert alert-info"},Me={key:1},qe={class:"card-body"},Se={class:"row align-items-center"},je={class:"col-md-6"},Te={class:"text-muted"},Ee={class:"col-md-3 text-end"},Ie={class:"mb-0 text-primary"},Le={class:"col-md-3 text-end"},Ve=["onClick"],Ne=["onClick"],Re={class:"modal-footer"},De={key:1,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},Qe={class:"modal-dialog"},Oe={class:"modal-content"},ze={class:"modal-header"},Be={class:"modal-body"},Je={key:0,class:"alert alert-warning mb-3"},Ke={class:"mb-2 small"},Ge={class:"d-flex gap-2 flex-wrap"},He={key:1,class:"alert alert-info mb-3"},Xe={class:"alert alert-success mb-3"},Ye={class:"mb-2"},We=["onUpdate:modelValue"],Ze=["value"],ts={class:"input-group",style:{"max-width":"120px"}},es=["onUpdate:modelValue"],ss=["disabled","title","onClick"],is={class:"d-flex justify-content-between align-items-center mb-2"},ns={key:2,class:"alert alert-warning mb-2 py-2"},os={key:3,class:"alert alert-info mb-2 py-2"},as={class:"modal-footer"},ls=["disabled"],rs={key:2,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},ds={class:"modal-dialog"},us={class:"modal-content"},cs={class:"modal-header"},ms={class:"modal-footer"},bs={key:3,class:"modal show d-block",tabindex:"-1",style:{background:"rgba(0, 0, 0, 0.5)"}},ps={class:"modal-dialog"},fs={class:"modal-content"},gs={class:"modal-header"},vs={class:"modal-body"},hs={class:"alert alert-info"},ys={class:"mb-3"},_s={class:"mb-3"},Cs={class:"modal-footer"},I=4,xs=200,B="Règles d'affichage : sont listées uniquement les commandes dont le catalogue a une date d'expiration dépassée et dont le catalogue est masqué (invisible) pour l'utilisateur. Les commandes déjà transformées en vente caisse n'apparaissent pas.",Ps={__name:"CaissePage",setup(i){const t=gt(),a=j(null),l=j({});function f(u,e){u&&(l.value[e]=u)}function b(u){const e=t.ajouterProduit(u);M(()=>{const _=l.value[e];_&&typeof _.focus=="function"&&_.focus()})}const p=j(""),y=j("success");let h=null;function P(u,e="success"){p.value=u,y.value=e,clearTimeout(h),h=setTimeout(()=>{p.value=""},2500)}let k="",w=null;function T(){k=""}function G(){const u=k.trim().replace(/\s/g,"");if(T(),u.length>=I&&/^\d+$/.test(u)){const e=t.ajouterProduitParEan(u);e.found?(P(`Ajouté : ${e.produit.nom}`,"success"),e.lineIndex!=null&&M(()=>{const _=l.value[e.lineIndex];_&&typeof _.focus=="function"&&_.focus()})):P("Code non reconnu","warning")}}function L(u){const e=u.target&&(u.target.tagName==="INPUT"||u.target.tagName==="TEXTAREA"||u.target.isContentEditable);if(u.key==="Enter"){if(e){const _=(u.target.value||"").trim().replace(/\s/g,"");if(_.length>=I&&/^\d+$/.test(_)){u.preventDefault();const n=t.ajouterProduitParEan(_);n.found?(P(`Ajouté : ${n.produit.nom}`,"success"),n.lineIndex!=null&&M(()=>{const v=l.value[n.lineIndex];v&&typeof v.focus=="function"&&v.focus()})):P("Code non reconnu","warning"),u.target.value=""}}else k.length>=I&&/^\d+$/.test(k)?(u.preventDefault(),G()):T();return}!e&&u.key.length===1&&!u.ctrlKey&&!u.metaKey&&!u.altKey&&(k+=u.key,clearTimeout(w),w=setTimeout(T,xs))}const H=D(()=>t.lignes.filter(u=>!u.is_avoir).reduce((u,e)=>u+e.quantite*e.prix_unitaire,0)),V=D(()=>{const u=t.utilisateurs.find(e=>e.id===t.selectedUtilisateur);return u&&(u.username||"").toLowerCase()==="anonyme"});function X(u){confirm("Supprimer ce panier sauvegardé ?")&&t.supprimerPanier(u)}function Y(){const u=t.commandesUtilisateur.find(e=>e.id===t.selectedCommandeId);u&&t.confirmerChargerCommande(u)}W(()=>{t.chargerProduits(),t.chargerUtilisateurs(),t.chargerModesPaiement(),M(()=>N()),document.addEventListener("keydown",L)}),Z(()=>{document.removeEventListener("keydown",L),w&&clearTimeout(w),h&&clearTimeout(h)}),tt(()=>t.selectedUtilisateur,u=>{u?(t.chargerCommandesUtilisateur(),M(()=>N())):(t.commandesUtilisateur=[],t.commandeSelectionnee=null,t.selectedCommandeId=null)});function N(){setTimeout(()=>{var e;const u=a.value;if(!(!u||typeof window>"u")&&(e=window.bootstrap)!=null&&e.Tooltip)try{const _=window.bootstrap.Tooltip.getInstance(u);_&&_.dispose(),new window.bootstrap.Tooltip(u,{trigger:"hover focus",placement:"top"})}catch{}},150)}return(u,e)=>{var _;return r(),d("div",vt,[s("div",ht,[s("div",yt,[s("div",_t,[s("div",Ct,[e[30]||(e[30]=s("h2",{class:"mb-0"},[s("i",{class:"bi bi-cart-fill me-2"}),c("Caisse")],-1)),s("div",xt,[R(at),e[29]||(e[29]=s("a",{href:"/caisse/historique",class:"btn btn-outline-primary"},[s("i",{class:"bi bi-clock-history me-2"}),c("Historique des ventes ")],-1))])])])]),o(t).error?(r(),d("div",Pt,[c(m(o(t).error)+" ",1),s("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=n=>o(t).error=null)})])):C("",!0),R(st,{name:"scan-toast"},{default:et(()=>[p.value?(r(),d("div",{key:0,class:F(["alert mb-2 py-2",y.value==="success"?"alert-success":"alert-warning"]),role:"status"},[s("i",{class:F(y.value==="success"?"bi bi-check-circle me-2":"bi bi-upc-scan me-2")},null,2),c(" "+m(p.value),1)],2)):C("",!0)]),_:1}),s("div",kt,[s("div",wt,[s("div",At,[$(s("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>o(t).searchQuery=n),type:"text",class:"form-control",placeholder:"Rechercher un produit...",style:{"max-width":"500px"}},null,512),[[q,o(t).searchQuery]])]),s("div",Ft,[s("span",$t,[e[31]||(e[31]=s("i",{class:"bi bi-box-seam me-1"},null,-1)),c(m(o(t).produitsFiltrés.length)+" produits disponibles ",1)])]),o(t).searchQuery&&o(t).categoriesFiltrées.length>0?(r(),d("div",Ut,[s("div",Mt,[(r(!0),d(A,null,U(o(t).categoriesFiltrées,n=>(r(),d("button",{key:n.id,class:F(["btn btn-sm",o(t).selectedCategorie===n.id?"btn-primary":"btn-outline-primary"]),onClick:v=>o(t).selectedCategorie=o(t).selectedCategorie===n.id?null:n.id},[c(m(n.nom)+" ",1),s("span",{class:F(["badge ms-2",o(t).selectedCategorie===n.id?"bg-light text-primary":"bg-primary"])},m(o(t).produitsFiltrés.filter(v=>v.category_id===n.id).length),3)],10,qt))),128))])])):C("",!0),o(t).produitsLoading?(r(),d("div",St,[...e[32]||(e[32]=[s("div",{class:"spinner-border text-primary"},null,-1)])])):o(t).produitsFiltrés.length===0?(r(),d("div",jt," Aucun produit disponible ")):(r(),d("div",Tt,[(r(!0),d(A,null,U(o(t).produitsFiltrés,n=>(r(),d("div",{key:n.id,class:"col-lg-4 col-md-6 col-sm-4 col-6"},[s("div",{class:"card h-100 produit-card",onClick:v=>b(n)},[n.image_url?(r(),d("img",{key:0,src:n.image_url,class:"card-img-top",alt:n.nom,style:{height:"120px","object-fit":"cover"}},null,8,It)):C("",!0),s("div",Lt,[s("h6",Vt,m(n.nom),1),s("div",Nt,[s("span",Rt,m((parseFloat(n.prix)||0).toFixed(2))+" €",1),s("span",{class:F(["small",(Number(n.stock)??0)<0?"fw-bold text-danger":"text-muted"])}," Stock : "+m(n.stock??0)+" "+m(n.unite||"pièce"),3)])])],8,Et)]))),128))]))]),s("div",Dt,[s("div",Qt,[s("div",Ot,[e[38]||(e[38]=s("h5",{class:"mb-0"},[s("i",{class:"bi bi-cart3 me-2"}),c("Panier")],-1)),s("div",zt,[s("button",{class:"btn btn-sm btn-outline-light",onClick:e[2]||(e[2]=n=>o(t).nouveauPanier())},[...e[33]||(e[33]=[s("i",{class:"bi bi-file-earmark-plus me-1"},null,-1),c("Nouveau ",-1)])]),s("button",{class:"btn btn-sm btn-light",disabled:o(t).lignes.length===0,onClick:e[3]||(e[3]=n=>o(t).sauvegarderPanier())},[...e[34]||(e[34]=[s("i",{class:"bi bi-save me-1"},null,-1),c("Sauvegarder ",-1)])],8,Bt),s("button",{class:"btn btn-sm btn-info",onClick:e[4]||(e[4]=n=>o(t).showPaniersModal=!0)},[e[35]||(e[35]=s("i",{class:"bi bi-folder2-open me-1"},null,-1)),e[36]||(e[36]=c("Charger ",-1)),s("span",Jt,m(o(t).savedPaniers.length),1)])]),s("div",Kt,[e[37]||(e[37]=s("label",{class:"form-label mb-1 small"},[s("i",{class:"bi bi-person me-1"}),c("Utilisateur")],-1)),$(s("select",{"onUpdate:modelValue":e[5]||(e[5]=n=>o(t).selectedUtilisateur=n),class:"form-select form-select-sm"},[(r(!0),d(A,null,U(o(t).utilisateurs,n=>(r(),d("option",{key:n.id,value:n.id},m(n.username),9,Gt))),128))],512),[[E,o(t).selectedUtilisateur]])])]),s("div",Ht,[o(t).selectedUtilisateur?(r(),d("div",Xt,[s("label",Yt,[e[40]||(e[40]=s("i",{class:"bi bi-basket me-1"},null,-1)),e[41]||(e[41]=c("Charger une commande catalogue ",-1)),s("span",{ref_key:"infobulleCommandesRef",ref:a,class:"d-inline-flex align-items-center text-muted ms-1",style:{cursor:"help"},title:B,"data-bs-toggle":"tooltip","data-bs-placement":"top","data-bs-trigger":"hover focus","data-bs-title":B},[...e[39]||(e[39]=[s("i",{class:"bi bi-info-circle",style:{"font-size":"1rem"}},null,-1)])],512)]),s("button",{type:"button",class:"btn btn-sm btn-outline-primary w-100 mb-2",disabled:o(t).loadingCommandes,onClick:e[6]||(e[6]=n=>o(t).chargerCommandesUtilisateur())},[e[42]||(e[42]=s("i",{class:"bi bi-arrow-clockwise me-1"},null,-1)),c(" "+m(o(t).loadingCommandes?"Chargement...":"Actualiser commandes"),1)],8,Wt),$(s("select",{"onUpdate:modelValue":e[7]||(e[7]=n=>o(t).selectedCommandeId=n),class:"form-select form-select-sm",disabled:!o(t).commandesUtilisateur.length},[e[43]||(e[43]=s("option",{value:null},"-- Sélectionner une commande --",-1)),(r(!0),d(A,null,U(o(t).commandesUtilisateur,n=>(r(),d("option",{key:n.id,value:n.id}," Cde #"+m(n.id)+" - "+m(n.catalogue_nom||"Catalogue")+" (Cat #"+m(n.catalog_id)+") | "+m(n.nb_articles)+" articles | "+m((parseFloat(n.total)||0).toFixed(2))+" € ",9,te))),128))],8,Zt),[[E,o(t).selectedCommandeId]]),o(t).commandesUtilisateur.length===0&&!o(t).loadingCommandes?(r(),d("small",ee," Aucune commande en attente pour cet utilisateur ")):C("",!0),o(t).selectedCommandeId?(r(),d("button",{key:1,type:"button",class:"btn btn-sm btn-primary w-100 mt-2",onClick:Y},[...e[44]||(e[44]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),c("Charger cette commande ",-1)])])):C("",!0)])):C("",!0),o(t).commandeSelectionnee?(r(),d("div",se,[e[45]||(e[45]=s("i",{class:"bi bi-info-circle me-1"},null,-1)),c(" Ce panier provient de la commande catalogue #"+m(o(t).commandeSelectionnee),1)])):C("",!0),o(t).lignes.length>0?(r(),d("button",{key:2,class:"btn btn-sm btn-warning w-100 mb-2",onClick:e[8]||(e[8]=n=>o(t).showAvoirModal=!0)},[...e[46]||(e[46]=[s("i",{class:"bi bi-receipt me-1"},null,-1),c("Ajouter un avoir ",-1)])])):C("",!0),o(t).lignes.length===0?(r(),d("div",ie,[...e[47]||(e[47]=[s("i",{class:"bi bi-cart-x",style:{"font-size":"3rem"}},null,-1),s("p",{class:"mt-2 mb-0"},"Panier vide",-1)])])):(r(),d(A,{key:4},[s("div",ne,[(r(!0),d(A,null,U(o(t).lignes,(n,v)=>(r(),d("div",{key:v,class:F(["border-bottom pb-2 mb-2",n.is_cotisation?"bg-info bg-opacity-10":n.is_avoir||!n.produit_id?"bg-warning bg-opacity-10":""])},[s("div",oe,[s("strong",{class:F([n.is_cotisation?"text-info":n.is_avoir||!n.produit_id?"text-warning":""]),style:{"font-size":"0.9rem"}},[n.is_cotisation?(r(),d("i",ae)):n.is_avoir||!n.produit_id?(r(),d("i",le)):C("",!0),c(" "+m(n.nom_produit),1)],2),s("button",{class:"btn btn-sm btn-outline-danger",onClick:x=>o(t).supprimerLigne(v)},[...e[48]||(e[48]=[s("i",{class:"bi bi-x-lg"},null,-1)])],8,re)]),n.is_cotisation||n.is_avoir||!n.produit_id?(r(),d("div",de,[s("strong",{class:F(n.is_cotisation?"text-info":"text-warning")},m(n.prix_unitaire.toFixed(2))+" €",3)])):(r(),d("div",ue,[s("div",ce,[s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:x=>o(t).modifierQuantite(v,Math.max(.001,n.quantite-(n.quantite_min||.001)))},[...e[49]||(e[49]=[s("i",{class:"bi bi-dash"},null,-1)])],8,me),s("input",{ref_for:!0,ref:x=>f(x,v),type:"number",class:"form-control form-control-sm text-center quantite-input",value:n.quantite,min:"0.001",step:"0.001",style:{width:"60px"},onChange:x=>o(t).modifierQuantite(v,parseFloat(x.target.value)||.001)},null,40,be),s("button",{class:"btn btn-outline-secondary btn-sm",type:"button",onClick:x=>o(t).modifierQuantite(v,n.quantite+(n.quantite_min||.001))},[...e[50]||(e[50]=[s("i",{class:"bi bi-plus"},null,-1)])],8,pe),s("span",fe,m(n.unite||"Pièce"),1)]),s("span",ge,[c(m(n.quantite.toFixed(3))+" × "+m(n.prix_unitaire.toFixed(2))+"€ = ",1),s("strong",ve,m((n.quantite*n.prix_unitaire).toFixed(2))+" €",1)])]))],2))),128))]),s("div",he,[s("div",ye,[e[51]||(e[51]=s("span",{class:"text-muted"},"Articles:",-1)),s("span",null,m(o(t).nombreArticles),1)]),s("div",_e,[e[52]||(e[52]=s("h5",{class:"mb-0"},"Total:",-1)),s("h5",Ce,m(o(t).total.toFixed(2))+" €",1)])]),s("div",xe,[s("button",{class:"btn btn-success btn-lg",disabled:o(t).lignes.length===0,onClick:e[9]||(e[9]=n=>o(t).ouvrirPaiement())},[...e[53]||(e[53]=[s("i",{class:"bi bi-check-circle me-2"},null,-1),c("Valider la vente ",-1)])],8,Pe),s("button",{class:"btn btn-outline-danger",onClick:e[10]||(e[10]=n=>o(t).viderPanier())},[...e[54]||(e[54]=[s("i",{class:"bi bi-trash me-2"},null,-1),c("Vider le panier ",-1)])])])],64))])])])])]),o(t).showPaniersModal?(r(),d("div",ke,[s("div",we,[s("div",Ae,[s("div",Fe,[e[55]||(e[55]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-folder2-open me-2"}),c("Paniers sauvegardés")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[11]||(e[11]=n=>o(t).showPaniersModal=!1)})]),s("div",$e,[o(t).savedPaniers.length===0?(r(),d("div",Ue,"Aucun panier sauvegardé")):(r(),d("div",Me,[(r(!0),d(A,null,U(o(t).savedPaniers,n=>(r(),d("div",{key:n.id,class:"card mb-2"},[s("div",qe,[s("div",Se,[s("div",je,[s("strong",null,m((n.lignes||[]).length)+" article(s)",1),e[57]||(e[57]=s("br",null,null,-1)),s("small",Te,[e[56]||(e[56]=s("i",{class:"bi bi-clock me-1"},null,-1)),c(m(new Date(n.saved_at).toLocaleString("fr-FR")),1)])]),s("div",Ee,[s("h5",Ie,m((n.total||0).toFixed(2))+" €",1)]),s("div",Le,[s("button",{class:"btn btn-sm btn-primary me-2",onClick:v=>o(t).chargerPanier(n.id)},[...e[58]||(e[58]=[s("i",{class:"bi bi-box-arrow-in-down me-1"},null,-1),c("Charger ",-1)])],8,Ve),s("button",{class:"btn btn-sm btn-outline-danger",onClick:v=>X(n.id)},[...e[59]||(e[59]=[s("i",{class:"bi bi-trash"},null,-1)])],8,Ne)])])])]))),128))]))]),s("div",Re,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[12]||(e[12]=n=>o(t).showPaniersModal=!1)},"Fermer")])])])])):C("",!0),o(t).showPaiementModal?(r(),d("div",De,[s("div",Qe,[s("div",Oe,[s("div",ze,[e[60]||(e[60]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-credit-card me-2"}),c("Valider la vente")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[13]||(e[13]=n=>o(t).fermerPaiement())})]),s("div",Be,[!V.value&&((_=o(t).cotisationCheck)!=null&&_.doit_cotiser)&&!o(t).aPanierCotisation?(r(),d("div",Je,[e[61]||(e[61]=s("strong",null,[s("i",{class:"bi bi-info-circle me-1"}),c("Cotisation mensuelle")],-1)),s("p",Ke,"Pour ce mois ("+m(o(t).cotisationCheck.mois_courant)+"), une cotisation entre 5 et 15 € est requise. Choisissez le montant :",1),s("div",Ge,[s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[14]||(e[14]=n=>o(t).ajouterCotisation(5))},"5 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[15]||(e[15]=n=>o(t).ajouterCotisation(10))},"10 €"),s("button",{type:"button",class:"btn btn-outline-primary",onClick:e[16]||(e[16]=n=>o(t).ajouterCotisation(15))},"15 €")])])):C("",!0),V.value?(r(),d("div",He,[e[62]||(e[62]=s("label",{class:"form-label small mb-1"},[s("i",{class:"bi bi-envelope me-1"}),c("Email pour recevoir la facture en PDF (optionnel) ")],-1)),$(s("input",{"onUpdate:modelValue":e[17]||(e[17]=n=>o(t).emailFactureAnonyme=n),type:"email",class:"form-control form-control-sm",placeholder:"exemple@email.com"},null,512),[[q,o(t).emailFactureAnonyme]])])):C("",!0),s("div",Xe,[e[63]||(e[63]=c(" Total à payer: ",-1)),s("strong",null,m(o(t).total.toFixed(2))+" €",1)]),s("div",Ye,[e[68]||(e[68]=s("label",{class:"form-label"},"Paiements",-1)),(r(!0),d(A,null,U(o(t).lignesPaiement,(n,v)=>(r(),d("div",{key:v,class:"d-flex gap-2 align-items-start mb-2"},[$(s("select",{"onUpdate:modelValue":x=>n.mode_paiement_id=x,class:"form-select flex-grow-1",style:{"min-width":"140px"}},[e[64]||(e[64]=s("option",{value:null},"-- Mode --",-1)),(r(!0),d(A,null,U(o(t).modesPaiement,x=>(r(),d("option",{key:x.id,value:x.id},m(x.nom),9,Ze))),128))],8,We),[[E,n.mode_paiement_id]]),s("div",ts,[$(s("input",{"onUpdate:modelValue":x=>n.montant=x,type:"number",class:"form-control",step:"0.01",min:"0",placeholder:"Montant"},null,8,es),[[q,n.montant,void 0,{number:!0}]]),e[65]||(e[65]=s("span",{class:"input-group-text"},"€",-1))]),s("button",{type:"button",class:"btn btn-outline-danger btn-sm",disabled:o(t).lignesPaiement.length<=1,title:o(t).lignesPaiement.length<=1?"Garder au moins une ligne":"Supprimer",onClick:x=>o(t).supprimerLignePaiement(v)},[...e[66]||(e[66]=[s("i",{class:"bi bi-trash"},null,-1)])],8,ss)]))),128)),s("button",{type:"button",class:"btn btn-outline-secondary btn-sm mt-1",onClick:e[18]||(e[18]=n=>o(t).ajouterLignePaiement())},[...e[67]||(e[67]=[s("i",{class:"bi bi-plus me-1"},null,-1),c("Ajouter un paiement ",-1)])])]),s("div",is,[e[69]||(e[69]=s("span",null,"Total payé:",-1)),s("strong",null,m(o(t).totalPaye.toFixed(2))+" €",1)]),o(t).resteAPayer>0?(r(),d("div",ns,[e[70]||(e[70]=s("i",{class:"bi bi-exclamation-triangle me-1"},null,-1)),e[71]||(e[71]=c("Reste à payer: ",-1)),s("strong",null,m(o(t).resteAPayer.toFixed(2))+" €",1),e[72]||(e[72]=c(". La vente ne peut pas être validée tant que le montant n'est pas entièrement couvert. ",-1))])):o(t).resteAPayer<0?(r(),d("div",os,[e[73]||(e[73]=c(" Rendu monnaie: ",-1)),s("strong",null,m((-o(t).resteAPayer).toFixed(2))+" €",1)])):C("",!0)]),s("div",as,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[19]||(e[19]=n=>o(t).fermerPaiement())},"Annuler"),s("button",{type:"button",class:"btn btn-success",disabled:!o(t).peutValiderPaiement,onClick:e[20]||(e[20]=n=>o(t).validerVente())},[...e[74]||(e[74]=[s("i",{class:"bi bi-check-circle me-1"},null,-1),c("Valider la vente ",-1)])],8,ls)])])])])):C("",!0),o(t).showModalChargerCommande?(r(),d("div",rs,[s("div",ds,[s("div",us,[s("div",cs,[e[75]||(e[75]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-cart-plus me-2"}),c("Ajouter la commande au panier")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[21]||(e[21]=n=>o(t).annulerChargerCommande())})]),e[76]||(e[76]=s("div",{class:"modal-body"},[s("p",null,"Le panier actuel contient déjà des articles."),s("p",null,[s("strong",null,"Les articles de la commande catalogue seront ajoutés au panier (les quantités des mêmes produits seront fusionnées).")])],-1)),s("div",ms,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[22]||(e[22]=n=>o(t).annulerChargerCommande())},"Annuler"),s("button",{type:"button",class:"btn btn-primary",onClick:e[23]||(e[23]=n=>{var v;return o(t).chargerCommandeDansPanier((v=o(t).commandeACharger)==null?void 0:v.id)})}," Ajouter au panier ")])])])])):C("",!0),o(t).showAvoirModal?(r(),d("div",bs,[s("div",ps,[s("div",fs,[s("div",gs,[e[77]||(e[77]=s("h5",{class:"modal-title"},[s("i",{class:"bi bi-receipt me-2"}),c("Ajouter un avoir")],-1)),s("button",{type:"button",class:"btn-close",onClick:e[24]||(e[24]=n=>o(t).showAvoirModal=!1)})]),s("div",vs,[s("div",hs,[e[78]||(e[78]=c(" Total panier: ",-1)),s("strong",null,m(H.value.toFixed(2))+" €",1)]),s("div",ys,[e[79]||(e[79]=s("label",{class:"form-label"},"Montant de l'avoir *",-1)),$(s("input",{"onUpdate:modelValue":e[25]||(e[25]=n=>o(t).avoirMontant=n),type:"number",class:"form-control",step:"0.01",min:"0.01"},null,512),[[q,o(t).avoirMontant,void 0,{number:!0}]])]),s("div",_s,[e[80]||(e[80]=s("label",{class:"form-label"},"Commentaire",-1)),$(s("input",{"onUpdate:modelValue":e[26]||(e[26]=n=>o(t).avoirCommentaire=n),type:"text",class:"form-control",placeholder:"Ex: Remboursement"},null,512),[[q,o(t).avoirCommentaire]])])]),s("div",Cs,[s("button",{type:"button",class:"btn btn-secondary",onClick:e[27]||(e[27]=n=>o(t).showAvoirModal=!1)},"Annuler"),s("button",{type:"button",class:"btn btn-warning",onClick:e[28]||(e[28]=n=>o(t).ajouterAvoir())},[...e[81]||(e[81]=[s("i",{class:"bi bi-check me-1"},null,-1),c("Ajouter l'avoir ",-1)])])])])])])):C("",!0)])}}},ks=ft(Ps,[["__scopeId","data-v-a47178c8"]]),K=it(ks);K.use(ot());K.mount("#caisse-app");
