import{i as W,o,c as i,F as _,a as e,j as X,b as m,t as r,d as T,w as Y,e as c,v as b,n as Z,k as F,P as N,l as k,q as ee,s as I,r as n,g as E,h as te}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as le}from"./chunks/pinia-gLxYYWQL.js";import{_ as se}from"./chunks/BackButton-DzFd1NqY.js";const ae={class:"container-fluid px-3 mt-4"},oe={key:0,class:"alert alert-warning"},ie={class:"row"},ne={class:"col-12"},re={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},de={key:0,class:"alert alert-danger"},ue={class:"card mb-4"},ce={class:"card-header d-flex justify-content-between align-items-center"},ve={class:"text-muted"},me={class:"card-body"},pe=["value"],be={class:"mb-3"},fe={class:"mb-3"},_e={class:"row mb-3"},ge={class:"col-md-6"},he={class:"col-md-6"},ye={class:"mb-3 border rounded p-3 bg-light"},xe={class:"row g-2 small"},we={class:"col-md-3"},ke={class:"col-md-3"},Se={class:"col-md-3"},Ce={class:"mb-3"},Pe={class:"form-check"},Ve={class:"mb-3"},Ae={class:"form-check"},Ue={class:"form-check"},je={class:"form-check"},Te=["disabled"],Ee={key:0,class:"spinner-border spinner-border-sm me-1"},De=["action"],Ne=["value"],Ie={class:"card mb-4"},$e={class:"card-header"},Re={class:"card-title mb-0"},Le={class:"card-body"},Me={key:0,class:"alert alert-info"},Oe={key:1,class:"table-responsive"},Fe={class:"table table-hover"},Be={key:1},qe=["href"],ze=["onClick"],Je={class:"card mb-4"},Ke={id:"collapseAddProducts",class:"collapse"},Qe={class:"card-body"},Ge={class:"row mb-3"},He={class:"col-md-4"},We=["value"],Xe={class:"col-md-4"},Ye=["value"],Ze={class:"col-md-4"},et={class:"small text-muted"},tt={class:"table-responsive mb-3",style:{"max-height":"400px","overflow-y":"auto"}},lt={class:"table table-sm table-hover"},st=["value"],at={style:{width:"120px"}},ot=["onUpdate:modelValue"],it={style:{width:"100px"}},nt=["onUpdate:modelValue","placeholder"],rt=["disabled"],dt={key:0,class:"spinner-border spinner-border-sm me-1"},ut={class:"card mb-4"},ct={class:"card-body"},vt={class:"row align-items-end"},mt={class:"col-md-8"},pt=["value"],bt={class:"col-md-4"},ft=["disabled"],_t={key:0,class:"spinner-border spinner-border-sm me-1"},gt={class:"mb-3"},ht=["href"],yt=["href"],xt={__name:"AdminCatalogueEditPage",setup(wt){const d=n(null),p=n([]),D=n([]),$=n([]),R=n([]),L=n([]),u=n(""),S=n(""),C=n(!1),P=n(!1),V=n(!1),a=n({originalname:"",description:"",expiration_date:"",date_livraison:"",is_archived:"0",referent_order_reminder_enabled:0}),g=n(""),h=n(""),A=n(""),f=n([]),U=n({}),j=n({}),y=n(""),x=E(()=>window.CSRF_TOKEN||"");function M(s){if(!s)return"";const t=new Date(s);return isNaN(t.getTime())?"":t.toISOString().slice(0,10)}const O=E(()=>{const s=d.value;if(!s)return"";if(!s.expiration_date)return"Permanent";const t=new Date(s.expiration_date).getTime(),l=Date.now();return t+864e5<l?"Expiré":"Actif"}),q=E(()=>{const s=O.value;return s==="Expiré"?"bg-danger":s==="Actif"?"bg-success":"bg-primary"}),z=E(()=>{let s=D.value||[];if(g.value!=null&&g.value!==""){const t=String(g.value);s=s.filter(l=>l!=null&&String(l.supplier_id??"")===t)}if(h.value!=null&&h.value!==""){const t=String(h.value);s=s.filter(l=>l!=null&&String(l.category_id??"")===t)}if(A.value){const t=A.value.toLowerCase();s=s.filter(l=>(l.nom||"").toLowerCase().includes(t))}return s});function J(s){confirm("Supprimer ce catalogue (cela supprimera tous les paniers, commandes et articles associés) ?")||s.preventDefault()}W(()=>{const s=window.INITIAL_DATA||{};if(d.value=s.catalogue||null,p.value=s.articles||[],D.value=s.allProducts||[],$.value=s.suppliers||[],R.value=s.categories||[],L.value=s.otherCatalogs||[],u.value=s.error||"",s.catalogue){const t=s.catalogue;a.value.originalname=t.originalname||"",a.value.description=t.description||"",a.value.expiration_date=M(t.expiration_date),a.value.date_livraison=M(t.date_livraison),a.value.is_archived=String(t.is_archived??0),a.value.referent_order_reminder_enabled=t.referent_order_reminder_enabled?1:0}(D.value||[]).forEach(t=>{U.value[t.id]=t.dernier_prix??"",j.value[t.id]=t.derniere_unite??1})});async function K(){if(d.value){u.value="",C.value=!0,S.value="Enregistrement...";try{const s=new URLSearchParams({_csrf:x.value,originalname:a.value.originalname,description:a.value.description||"",expiration_date:a.value.expiration_date||"",date_livraison:a.value.date_livraison||"",is_archived:a.value.is_archived,referent_order_reminder_enabled:a.value.referent_order_reminder_enabled?"1":""}),l=await(await fetch(`/admin/catalogues/${d.value.id}/edit`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success?(S.value="Enregistré",setTimeout(()=>{S.value=""},2e3)):u.value=l.error||"Erreur lors de l'enregistrement."}catch{u.value="Erreur de connexion."}finally{C.value=!1}}}async function Q(s){if(!(!d.value||!confirm("Retirer cet article du catalogue ?")))try{const t=new URLSearchParams({_csrf:x.value}),v=await(await fetch(`/admin/catalogues/${d.value.id}/articles/${s.id}/delete`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()})).json().catch(()=>({}));v.success?p.value=p.value.filter(w=>w.id!==s.id):u.value=v.error||"Erreur lors de la suppression."}catch{u.value="Erreur de connexion."}}async function G(){if(!(!d.value||f.value.length===0)){u.value="",P.value=!0;try{const s=f.value.map(w=>({product_id:w,prix:U.value[w]??0,unite:j.value[w]??1})),t=JSON.stringify({products:s}),v=await(await fetch(`/admin/catalogues/${d.value.id}/articles/add-multiple`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:t})).json().catch(()=>({}));v.success?v.added>0?window.location.reload():u.value=v.error||"Aucun produit ajouté (déjà présents).":u.value=v.error||"Erreur lors de l'ajout."}catch{u.value="Erreur de connexion."}finally{P.value=!1}}}async function H(){if(!(!d.value||!y.value)){u.value="",V.value=!0;try{const s=new URLSearchParams({_csrf:x.value,source_catalog_id:y.value}),l=await(await fetch(`/admin/catalogues/${d.value.id}/import-from-catalog`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success&&l.added>0?window.location.reload():u.value=l.error||(l.added===0?"Aucun produit à importer (déjà présents).":"Erreur.")}catch{u.value="Erreur de connexion."}finally{V.value=!1}}}return(s,t)=>(o(),i("div",ae,[d.value?(o(),i(_,{key:1},[e("div",ie,[e("div",ne,[e("div",re,[t[13]||(t[13]=e("h2",{class:"mb-0"},"Éditer le catalogue",-1)),X(se)])])]),u.value?(o(),i("div",de,[t[14]||(t[14]=e("i",{class:"bi bi-exclamation-triangle-fill me-2"},null,-1)),m(r(u.value),1)])):T("",!0),e("div",ue,[e("div",ce,[t[15]||(t[15]=e("h5",{class:"card-title mb-0"},"Informations du catalogue",-1)),e("small",ve,r(S.value),1)]),e("div",me,[e("form",{onSubmit:Y(K,["prevent"])},[e("input",{type:"hidden",name:"_csrf",value:x.value},null,8,pe),e("div",be,[t[16]||(t[16]=e("label",{for:"originalname",class:"form-label"},[m("Nom du catalogue "),e("span",{class:"text-danger"},"*")],-1)),c(e("input",{id:"originalname","onUpdate:modelValue":t[0]||(t[0]=l=>a.value.originalname=l),type:"text",class:"form-control",required:"",placeholder:"Nom du catalogue"},null,512),[[b,a.value.originalname]])]),e("div",fe,[t[17]||(t[17]=e("label",{for:"description",class:"form-label"},"Description",-1)),c(e("textarea",{id:"description","onUpdate:modelValue":t[1]||(t[1]=l=>a.value.description=l),class:"form-control",rows:"3",placeholder:"Description du catalogue"},null,512),[[b,a.value.description]])]),e("div",_e,[e("div",ge,[t[18]||(t[18]=e("label",{for:"expiration_date",class:"form-label"},"Date d'expiration",-1)),c(e("input",{id:"expiration_date","onUpdate:modelValue":t[2]||(t[2]=l=>a.value.expiration_date=l),type:"date",class:"form-control"},null,512),[[b,a.value.expiration_date]])]),e("div",he,[t[19]||(t[19]=e("label",{for:"date_livraison",class:"form-label"},"Date de livraison",-1)),c(e("input",{id:"date_livraison","onUpdate:modelValue":t[3]||(t[3]=l=>a.value.date_livraison=l),type:"date",class:"form-control"},null,512),[[b,a.value.date_livraison]])])]),e("div",ye,[e("div",xe,[e("div",we,[t[20]||(t[20]=e("span",{class:"text-muted"},"ID",-1)),t[21]||(t[21]=m()),e("strong",null,"#"+r(d.value.id),1)]),e("div",ke,[t[22]||(t[22]=e("span",{class:"text-muted"},"Produits",-1)),t[23]||(t[23]=m()),e("strong",null,r(p.value.length),1)]),e("div",Se,[t[24]||(t[24]=e("span",{class:"text-muted"},"Statut",-1)),t[25]||(t[25]=m()),e("span",{class:Z(["badge",q.value])},r(O.value),3)])])]),e("div",Ce,[t[27]||(t[27]=e("label",{class:"form-label"},"Rappel commande référent",-1)),e("div",Pe,[c(e("input",{id:"referent_order_reminder_enabled","onUpdate:modelValue":t[4]||(t[4]=l=>a.value.referent_order_reminder_enabled=l),class:"form-check-input",type:"checkbox","true-value":1,"false-value":0},null,512),[[F,a.value.referent_order_reminder_enabled]]),t[26]||(t[26]=e("label",{class:"form-check-label",for:"referent_order_reminder_enabled"},"Envoyer un mail au référent pour prévoir la commande (Expiration + 8h)",-1))])]),e("div",Ve,[t[31]||(t[31]=e("label",{class:"form-label"},"Visibilité",-1)),e("div",Ae,[c(e("input",{id:"is_archived_0","onUpdate:modelValue":t[5]||(t[5]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"0"},null,512),[[N,a.value.is_archived]]),t[28]||(t[28]=e("label",{class:"form-check-label",for:"is_archived_0"},"Visible de tous",-1))]),e("div",Ue,[c(e("input",{id:"is_archived_2","onUpdate:modelValue":t[6]||(t[6]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"2"},null,512),[[N,a.value.is_archived]]),t[29]||(t[29]=e("label",{class:"form-check-label",for:"is_archived_2"},"Invisible des utilisateurs (visible en admin)",-1))]),e("div",je,[c(e("input",{id:"is_archived_3","onUpdate:modelValue":t[7]||(t[7]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"3"},null,512),[[N,a.value.is_archived]]),t[30]||(t[30]=e("label",{class:"form-check-label",for:"is_archived_3"},"Invisible de tous, partout (archivé)",-1))])]),e("button",{type:"submit",class:"btn btn-primary",disabled:C.value},[C.value?(o(),i("span",Ee)):T("",!0),t[32]||(t[32]=m(" Enregistrer les modifications ",-1))],8,Te)],32),e("form",{method:"POST",action:`/admin/catalogues/${d.value.id}/delete`,class:"mt-3",onSubmit:J},[e("input",{type:"hidden",name:"_csrf",value:x.value},null,8,Ne),t[33]||(t[33]=e("button",{type:"submit",class:"btn btn-danger"},[e("i",{class:"bi bi-trash me-2"}),m("Supprimer le catalogue ")],-1))],40,De)])]),e("div",Ie,[e("div",$e,[e("h5",Re,[t[34]||(t[34]=e("i",{class:"bi bi-journal-text me-2"},null,-1)),m("Articles du catalogue ("+r(p.value.length)+")",1)])]),e("div",Le,[p.value.length===0?(o(),i("div",Me,"Aucun article. Ajoutez des produits ci-dessous.")):(o(),i("div",Oe,[e("table",Fe,[t[35]||(t[35]=e("thead",{class:"thead-administration"},[e("tr",null,[e("th",null,"Produit"),e("th",null,"Catégorie"),e("th",null,"Prix"),e("th",null,"Unité"),e("th",null,"Actions")])],-1)),e("tbody",null,[(o(!0),i(_,null,k(p.value,l=>(o(),i("tr",{key:l.id},[e("td",null,[e("strong",null,r(l.produit),1)]),e("td",null,[l.categorie?(o(),i("span",{key:0,class:"badge",style:ee({backgroundColor:l.categorie_couleur||"#6c757d"})},r(l.categorie),5)):(o(),i("span",Be,"-"))]),e("td",null,r(l.prix!=null?Number(l.prix).toFixed(2):"-")+" €",1),e("td",null,r(l.unite||"-"),1),e("td",null,[e("a",{href:`/admin/catalogues/${d.value.id}/articles/${l.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,qe),e("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:v=>Q(l)},"Supprimer",8,ze)])]))),128))])])]))])]),e("div",Je,[t[43]||(t[43]=e("div",{class:"card-header"},[e("button",{class:"btn btn-link text-decoration-none p-0 w-100 text-start d-flex align-items-center",type:"button","data-bs-toggle":"collapse","data-bs-target":"#collapseAddProducts","aria-expanded":"false"},[e("i",{class:"bi bi-plus-circle me-2"}),m("Ajouter des produits au catalogue ")])],-1)),e("div",Ke,[e("div",Qe,[e("div",Ge,[e("div",He,[t[37]||(t[37]=e("label",{class:"form-label"},"Fournisseur",-1)),c(e("select",{"onUpdate:modelValue":t[8]||(t[8]=l=>g.value=l),class:"form-select"},[t[36]||(t[36]=e("option",{value:""},"Tous",-1)),(o(!0),i(_,null,k($.value,l=>(o(),i("option",{key:l.id,value:String(l.id)},r(l.nom),9,We))),128))],512),[[I,g.value]])]),e("div",Xe,[t[39]||(t[39]=e("label",{class:"form-label"},"Catégorie",-1)),c(e("select",{"onUpdate:modelValue":t[9]||(t[9]=l=>h.value=l),class:"form-select"},[t[38]||(t[38]=e("option",{value:""},"Toutes",-1)),(o(!0),i(_,null,k(R.value,l=>(o(),i("option",{key:l.id,value:String(l.id)},r(l.nom),9,Ye))),128))],512),[[I,h.value]])]),e("div",Ze,[t[40]||(t[40]=e("label",{class:"form-label"},"Recherche",-1)),c(e("input",{"onUpdate:modelValue":t[10]||(t[10]=l=>A.value=l),type:"text",class:"form-control",placeholder:"Nom du produit..."},null,512),[[b,A.value]])])]),e("p",et,r(f.value.length)+" produit(s) sélectionné(s)",1),e("div",tt,[e("table",lt,[t[41]||(t[41]=e("thead",{class:"sticky-top thead-administration"},[e("tr",null,[e("th",{style:{width:"40px"}}),e("th",null,"Produit"),e("th",null,"Prix (€)"),e("th",null,"Qté mini")])],-1)),e("tbody",null,[(o(!0),i(_,null,k(z.value,l=>(o(),i("tr",{key:l.id},[e("td",null,[c(e("input",{"onUpdate:modelValue":t[11]||(t[11]=v=>f.value=v),type:"checkbox",value:l.id,class:"form-check-input"},null,8,st),[[F,f.value]])]),e("td",null,[e("strong",null,r(l.nom),1)]),e("td",at,[c(e("input",{"onUpdate:modelValue":v=>U.value[l.id]=v,type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",placeholder:"0.00"},null,8,ot),[[b,U.value[l.id],void 0,{number:!0}]])]),e("td",it,[c(e("input",{"onUpdate:modelValue":v=>j.value[l.id]=v,type:"number",step:"0.1",min:"0.1",class:"form-control form-control-sm",placeholder:l.derniere_unite||1},null,8,nt),[[b,j.value[l.id],void 0,{number:!0}]])])]))),128))])])]),e("button",{type:"button",class:"btn btn-primary",disabled:P.value||f.value.length===0,onClick:G},[P.value?(o(),i("span",dt)):T("",!0),t[42]||(t[42]=m(" Ajouter la sélection ",-1))],8,rt)])])]),e("div",ut,[t[47]||(t[47]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},[e("i",{class:"bi bi-files me-2"}),m("Importer depuis un autre catalogue")])],-1)),e("div",ct,[e("div",vt,[e("div",mt,[t[45]||(t[45]=e("label",{class:"form-label"},"Catalogue source",-1)),c(e("select",{"onUpdate:modelValue":t[12]||(t[12]=l=>y.value=l),class:"form-select"},[t[44]||(t[44]=e("option",{value:""},"-- Sélectionner un catalogue --",-1)),(o(!0),i(_,null,k(L.value,l=>(o(),i("option",{key:l.id,value:l.id}," #"+r(l.id)+" - "+r(l.originalname)+" ("+r(l.nb_produits)+" produits) ",9,pt))),128))],512),[[I,y.value]])]),e("div",bt,[e("button",{type:"button",class:"btn btn-success w-100",disabled:V.value||!y.value,onClick:H},[V.value?(o(),i("span",_t)):T("",!0),t[46]||(t[46]=m(" Importer ",-1))],8,ft)])])])]),e("div",gt,[e("a",{href:`/admin/catalogues/${d.value.id}/synthese/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse",8,ht),e("a",{href:`/admin/catalogues/${d.value.id}/synthese-detaillee/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse détaillée",8,yt),t[48]||(t[48]=e("a",{href:"/admin/catalogues/vue",class:"btn btn-outline-secondary"},"Retour à la liste",-1))])],64)):(o(),i("div",oe,"Catalogue non trouvé."))]))}},B=te(xt);B.use(le());B.mount("#admin-catalogue-edit-app");
