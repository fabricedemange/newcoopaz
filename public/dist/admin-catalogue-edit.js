import{i as W,o,c as i,F as _,a as e,b as m,t as r,d as j,w as X,e as c,v as b,n as Y,j as F,P as I,k,p as Z,q as N,r as n,g as E,h as ee}from"./chunks/runtime-dom.esm-bundler-CPobOing.js";import{c as te}from"./chunks/pinia-8wUEIqj_.js";const le={class:"container-fluid px-3 mt-4"},se={key:0,class:"alert alert-warning"},ae={key:0,class:"alert alert-danger"},oe={class:"card mb-4"},ie={class:"card-header d-flex justify-content-between align-items-center"},ne={class:"text-muted"},re={class:"card-body"},de=["value"],ue={class:"mb-3"},ce={class:"mb-3"},ve={class:"row mb-3"},me={class:"col-md-6"},pe={class:"col-md-6"},be={class:"mb-3 border rounded p-3 bg-light"},fe={class:"row g-2 small"},_e={class:"col-md-3"},ge={class:"col-md-3"},he={class:"col-md-3"},ye={class:"mb-3"},xe={class:"form-check"},we={class:"mb-3"},ke={class:"form-check"},Se={class:"form-check"},Ce={class:"form-check"},Pe=["disabled"],Ae={key:0,class:"spinner-border spinner-border-sm me-1"},Ue=["action"],Ve=["value"],Te={class:"card mb-4"},je={class:"card-header"},Ee={class:"card-title mb-0"},De={class:"card-body"},Ie={key:0,class:"alert alert-info"},Ne={key:1,class:"table-responsive"},$e={class:"table table-hover"},Re={key:1},Le=["href"],Me=["onClick"],Oe={class:"card mb-4"},Fe={id:"collapseAddProducts",class:"collapse"},Be={class:"card-body"},qe={class:"row mb-3"},ze={class:"col-md-4"},Je=["value"],Ke={class:"col-md-4"},Qe=["value"],Ge={class:"col-md-4"},He={class:"small text-muted"},We={class:"table-responsive mb-3",style:{"max-height":"400px","overflow-y":"auto"}},Xe={class:"table table-sm table-hover"},Ye=["value"],Ze={style:{width:"120px"}},et=["onUpdate:modelValue"],tt={style:{width:"100px"}},lt=["onUpdate:modelValue","placeholder"],st=["disabled"],at={key:0,class:"spinner-border spinner-border-sm me-1"},ot={class:"card mb-4"},it={class:"card-body"},nt={class:"row align-items-end"},rt={class:"col-md-8"},dt=["value"],ut={class:"col-md-4"},ct=["disabled"],vt={key:0,class:"spinner-border spinner-border-sm me-1"},mt={class:"mb-3"},pt=["href"],bt=["href"],ft={__name:"AdminCatalogueEditPage",setup(_t){const d=n(null),p=n([]),D=n([]),$=n([]),R=n([]),L=n([]),u=n(""),S=n(""),C=n(!1),P=n(!1),A=n(!1),a=n({originalname:"",description:"",expiration_date:"",date_livraison:"",is_archived:"0",referent_order_reminder_enabled:0}),g=n(""),h=n(""),U=n(""),f=n([]),V=n({}),T=n({}),y=n(""),x=E(()=>window.CSRF_TOKEN||"");function M(s){if(!s)return"";const t=new Date(s);return isNaN(t.getTime())?"":t.toISOString().slice(0,10)}const O=E(()=>{const s=d.value;if(!s)return"";if(!s.expiration_date)return"Permanent";const t=new Date(s.expiration_date).getTime(),l=Date.now();return t+864e5<l?"Expiré":"Actif"}),q=E(()=>{const s=O.value;return s==="Expiré"?"bg-danger":s==="Actif"?"bg-success":"bg-primary"}),z=E(()=>{let s=D.value||[];if(g.value!=null&&g.value!==""){const t=String(g.value);s=s.filter(l=>l!=null&&String(l.supplier_id??"")===t)}if(h.value!=null&&h.value!==""){const t=String(h.value);s=s.filter(l=>l!=null&&String(l.category_id??"")===t)}if(U.value){const t=U.value.toLowerCase();s=s.filter(l=>(l.nom||"").toLowerCase().includes(t))}return s});function J(s){confirm("Supprimer ce catalogue (cela supprimera tous les paniers, commandes et articles associés) ?")||s.preventDefault()}W(()=>{const s=window.INITIAL_DATA||{};if(d.value=s.catalogue||null,p.value=s.articles||[],D.value=s.allProducts||[],$.value=s.suppliers||[],R.value=s.categories||[],L.value=s.otherCatalogs||[],u.value=s.error||"",s.catalogue){const t=s.catalogue;a.value.originalname=t.originalname||"",a.value.description=t.description||"",a.value.expiration_date=M(t.expiration_date),a.value.date_livraison=M(t.date_livraison),a.value.is_archived=String(t.is_archived??0),a.value.referent_order_reminder_enabled=t.referent_order_reminder_enabled?1:0}(D.value||[]).forEach(t=>{V.value[t.id]=t.dernier_prix??"",T.value[t.id]=t.derniere_unite??1})});async function K(){if(d.value){u.value="",C.value=!0,S.value="Enregistrement...";try{const s=new URLSearchParams({_csrf:x.value,originalname:a.value.originalname,description:a.value.description||"",expiration_date:a.value.expiration_date||"",date_livraison:a.value.date_livraison||"",is_archived:a.value.is_archived,referent_order_reminder_enabled:a.value.referent_order_reminder_enabled?"1":""}),l=await(await fetch(`/admin/catalogues/${d.value.id}/edit`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success?(S.value="Enregistré",setTimeout(()=>{S.value=""},2e3)):u.value=l.error||"Erreur lors de l'enregistrement."}catch{u.value="Erreur de connexion."}finally{C.value=!1}}}async function Q(s){if(!(!d.value||!confirm("Retirer cet article du catalogue ?")))try{const t=new URLSearchParams({_csrf:x.value}),v=await(await fetch(`/admin/catalogues/${d.value.id}/articles/${s.id}/delete`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()})).json().catch(()=>({}));v.success?p.value=p.value.filter(w=>w.id!==s.id):u.value=v.error||"Erreur lors de la suppression."}catch{u.value="Erreur de connexion."}}async function G(){if(!(!d.value||f.value.length===0)){u.value="",P.value=!0;try{const s=f.value.map(w=>({product_id:w,prix:V.value[w]??0,unite:T.value[w]??1})),t=JSON.stringify({products:s}),v=await(await fetch(`/admin/catalogues/${d.value.id}/articles/add-multiple`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json"},body:t})).json().catch(()=>({}));v.success?v.added>0?window.location.reload():u.value=v.error||"Aucun produit ajouté (déjà présents).":u.value=v.error||"Erreur lors de l'ajout."}catch{u.value="Erreur de connexion."}finally{P.value=!1}}}async function H(){if(!(!d.value||!y.value)){u.value="",A.value=!0;try{const s=new URLSearchParams({_csrf:x.value,source_catalog_id:y.value}),l=await(await fetch(`/admin/catalogues/${d.value.id}/import-from-catalog`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success&&l.added>0?window.location.reload():u.value=l.error||(l.added===0?"Aucun produit à importer (déjà présents).":"Erreur.")}catch{u.value="Erreur de connexion."}finally{A.value=!1}}}return(s,t)=>(o(),i("div",le,[d.value?(o(),i(_,{key:1},[t[48]||(t[48]=e("div",{class:"row"},[e("div",{class:"col-12"},[e("h2",{class:"mb-4"},"Éditer le catalogue")])],-1)),u.value?(o(),i("div",ae,[t[13]||(t[13]=e("i",{class:"bi bi-exclamation-triangle-fill me-2"},null,-1)),m(r(u.value),1)])):j("",!0),e("div",oe,[e("div",ie,[t[14]||(t[14]=e("h5",{class:"card-title mb-0"},"Informations du catalogue",-1)),e("small",ne,r(S.value),1)]),e("div",re,[e("form",{onSubmit:X(K,["prevent"])},[e("input",{type:"hidden",name:"_csrf",value:x.value},null,8,de),e("div",ue,[t[15]||(t[15]=e("label",{for:"originalname",class:"form-label"},[m("Nom du catalogue "),e("span",{class:"text-danger"},"*")],-1)),c(e("input",{id:"originalname","onUpdate:modelValue":t[0]||(t[0]=l=>a.value.originalname=l),type:"text",class:"form-control",required:"",placeholder:"Nom du catalogue"},null,512),[[b,a.value.originalname]])]),e("div",ce,[t[16]||(t[16]=e("label",{for:"description",class:"form-label"},"Description",-1)),c(e("textarea",{id:"description","onUpdate:modelValue":t[1]||(t[1]=l=>a.value.description=l),class:"form-control",rows:"3",placeholder:"Description du catalogue"},null,512),[[b,a.value.description]])]),e("div",ve,[e("div",me,[t[17]||(t[17]=e("label",{for:"expiration_date",class:"form-label"},"Date d'expiration",-1)),c(e("input",{id:"expiration_date","onUpdate:modelValue":t[2]||(t[2]=l=>a.value.expiration_date=l),type:"date",class:"form-control"},null,512),[[b,a.value.expiration_date]])]),e("div",pe,[t[18]||(t[18]=e("label",{for:"date_livraison",class:"form-label"},"Date de livraison",-1)),c(e("input",{id:"date_livraison","onUpdate:modelValue":t[3]||(t[3]=l=>a.value.date_livraison=l),type:"date",class:"form-control"},null,512),[[b,a.value.date_livraison]])])]),e("div",be,[e("div",fe,[e("div",_e,[t[19]||(t[19]=e("span",{class:"text-muted"},"ID",-1)),t[20]||(t[20]=m()),e("strong",null,"#"+r(d.value.id),1)]),e("div",ge,[t[21]||(t[21]=e("span",{class:"text-muted"},"Produits",-1)),t[22]||(t[22]=m()),e("strong",null,r(p.value.length),1)]),e("div",he,[t[23]||(t[23]=e("span",{class:"text-muted"},"Statut",-1)),t[24]||(t[24]=m()),e("span",{class:Y(["badge",q.value])},r(O.value),3)])])]),e("div",ye,[t[26]||(t[26]=e("label",{class:"form-label"},"Rappel commande référent",-1)),e("div",xe,[c(e("input",{id:"referent_order_reminder_enabled","onUpdate:modelValue":t[4]||(t[4]=l=>a.value.referent_order_reminder_enabled=l),class:"form-check-input",type:"checkbox","true-value":1,"false-value":0},null,512),[[F,a.value.referent_order_reminder_enabled]]),t[25]||(t[25]=e("label",{class:"form-check-label",for:"referent_order_reminder_enabled"},"Envoyer un mail au référent pour prévoir la commande (Expiration + 8h)",-1))])]),e("div",we,[t[30]||(t[30]=e("label",{class:"form-label"},"Visibilité",-1)),e("div",ke,[c(e("input",{id:"is_archived_0","onUpdate:modelValue":t[5]||(t[5]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"0"},null,512),[[I,a.value.is_archived]]),t[27]||(t[27]=e("label",{class:"form-check-label",for:"is_archived_0"},"Visible de tous",-1))]),e("div",Se,[c(e("input",{id:"is_archived_2","onUpdate:modelValue":t[6]||(t[6]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"2"},null,512),[[I,a.value.is_archived]]),t[28]||(t[28]=e("label",{class:"form-check-label",for:"is_archived_2"},"Invisible des utilisateurs (visible en admin)",-1))]),e("div",Ce,[c(e("input",{id:"is_archived_3","onUpdate:modelValue":t[7]||(t[7]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"3"},null,512),[[I,a.value.is_archived]]),t[29]||(t[29]=e("label",{class:"form-check-label",for:"is_archived_3"},"Invisible de tous, partout (archivé)",-1))])]),e("button",{type:"submit",class:"btn btn-primary",disabled:C.value},[C.value?(o(),i("span",Ae)):j("",!0),t[31]||(t[31]=m(" Enregistrer les modifications ",-1))],8,Pe)],32),e("form",{method:"POST",action:`/admin/catalogues/${d.value.id}/delete`,class:"mt-3",onSubmit:J},[e("input",{type:"hidden",name:"_csrf",value:x.value},null,8,Ve),t[32]||(t[32]=e("button",{type:"submit",class:"btn btn-danger"},[e("i",{class:"bi bi-trash me-2"}),m("Supprimer le catalogue ")],-1))],40,Ue)])]),e("div",Te,[e("div",je,[e("h5",Ee,[t[33]||(t[33]=e("i",{class:"bi bi-journal-text me-2"},null,-1)),m("Articles du catalogue ("+r(p.value.length)+")",1)])]),e("div",De,[p.value.length===0?(o(),i("div",Ie,"Aucun article. Ajoutez des produits ci-dessous.")):(o(),i("div",Ne,[e("table",$e,[t[34]||(t[34]=e("thead",{class:"thead-administration"},[e("tr",null,[e("th",null,"Produit"),e("th",null,"Catégorie"),e("th",null,"Prix"),e("th",null,"Unité"),e("th",null,"Actions")])],-1)),e("tbody",null,[(o(!0),i(_,null,k(p.value,l=>(o(),i("tr",{key:l.id},[e("td",null,[e("strong",null,r(l.produit),1)]),e("td",null,[l.categorie?(o(),i("span",{key:0,class:"badge",style:Z({backgroundColor:l.categorie_couleur||"#6c757d"})},r(l.categorie),5)):(o(),i("span",Re,"-"))]),e("td",null,r(l.prix!=null?Number(l.prix).toFixed(2):"-")+" €",1),e("td",null,r(l.unite||"-"),1),e("td",null,[e("a",{href:`/admin/catalogues/${d.value.id}/articles/${l.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,Le),e("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:v=>Q(l)},"Supprimer",8,Me)])]))),128))])])]))])]),e("div",Oe,[t[42]||(t[42]=e("div",{class:"card-header"},[e("button",{class:"btn btn-link text-decoration-none p-0 w-100 text-start d-flex align-items-center",type:"button","data-bs-toggle":"collapse","data-bs-target":"#collapseAddProducts","aria-expanded":"false"},[e("i",{class:"bi bi-plus-circle me-2"}),m("Ajouter des produits au catalogue ")])],-1)),e("div",Fe,[e("div",Be,[e("div",qe,[e("div",ze,[t[36]||(t[36]=e("label",{class:"form-label"},"Fournisseur",-1)),c(e("select",{"onUpdate:modelValue":t[8]||(t[8]=l=>g.value=l),class:"form-select"},[t[35]||(t[35]=e("option",{value:""},"Tous",-1)),(o(!0),i(_,null,k($.value,l=>(o(),i("option",{key:l.id,value:String(l.id)},r(l.nom),9,Je))),128))],512),[[N,g.value]])]),e("div",Ke,[t[38]||(t[38]=e("label",{class:"form-label"},"Catégorie",-1)),c(e("select",{"onUpdate:modelValue":t[9]||(t[9]=l=>h.value=l),class:"form-select"},[t[37]||(t[37]=e("option",{value:""},"Toutes",-1)),(o(!0),i(_,null,k(R.value,l=>(o(),i("option",{key:l.id,value:String(l.id)},r(l.nom),9,Qe))),128))],512),[[N,h.value]])]),e("div",Ge,[t[39]||(t[39]=e("label",{class:"form-label"},"Recherche",-1)),c(e("input",{"onUpdate:modelValue":t[10]||(t[10]=l=>U.value=l),type:"text",class:"form-control",placeholder:"Nom du produit..."},null,512),[[b,U.value]])])]),e("p",He,r(f.value.length)+" produit(s) sélectionné(s)",1),e("div",We,[e("table",Xe,[t[40]||(t[40]=e("thead",{class:"sticky-top thead-administration"},[e("tr",null,[e("th",{style:{width:"40px"}}),e("th",null,"Produit"),e("th",null,"Prix (€)"),e("th",null,"Qté mini")])],-1)),e("tbody",null,[(o(!0),i(_,null,k(z.value,l=>(o(),i("tr",{key:l.id},[e("td",null,[c(e("input",{"onUpdate:modelValue":t[11]||(t[11]=v=>f.value=v),type:"checkbox",value:l.id,class:"form-check-input"},null,8,Ye),[[F,f.value]])]),e("td",null,[e("strong",null,r(l.nom),1)]),e("td",Ze,[c(e("input",{"onUpdate:modelValue":v=>V.value[l.id]=v,type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",placeholder:"0.00"},null,8,et),[[b,V.value[l.id],void 0,{number:!0}]])]),e("td",tt,[c(e("input",{"onUpdate:modelValue":v=>T.value[l.id]=v,type:"number",step:"0.1",min:"0.1",class:"form-control form-control-sm",placeholder:l.derniere_unite||1},null,8,lt),[[b,T.value[l.id],void 0,{number:!0}]])])]))),128))])])]),e("button",{type:"button",class:"btn btn-primary",disabled:P.value||f.value.length===0,onClick:G},[P.value?(o(),i("span",at)):j("",!0),t[41]||(t[41]=m(" Ajouter la sélection ",-1))],8,st)])])]),e("div",ot,[t[46]||(t[46]=e("div",{class:"card-header"},[e("h5",{class:"card-title mb-0"},[e("i",{class:"bi bi-files me-2"}),m("Importer depuis un autre catalogue")])],-1)),e("div",it,[e("div",nt,[e("div",rt,[t[44]||(t[44]=e("label",{class:"form-label"},"Catalogue source",-1)),c(e("select",{"onUpdate:modelValue":t[12]||(t[12]=l=>y.value=l),class:"form-select"},[t[43]||(t[43]=e("option",{value:""},"-- Sélectionner un catalogue --",-1)),(o(!0),i(_,null,k(L.value,l=>(o(),i("option",{key:l.id,value:l.id}," #"+r(l.id)+" - "+r(l.originalname)+" ("+r(l.nb_produits)+" produits) ",9,dt))),128))],512),[[N,y.value]])]),e("div",ut,[e("button",{type:"button",class:"btn btn-success w-100",disabled:A.value||!y.value,onClick:H},[A.value?(o(),i("span",vt)):j("",!0),t[45]||(t[45]=m(" Importer ",-1))],8,ct)])])])]),e("div",mt,[e("a",{href:`/admin/catalogues/${d.value.id}/synthese/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse",8,pt),e("a",{href:`/admin/catalogues/${d.value.id}/synthese-detaillee/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse détaillée",8,bt),t[47]||(t[47]=e("a",{href:"/admin/catalogues/vue",class:"btn btn-outline-secondary"},"Retour à la liste",-1))])],64)):(o(),i("div",se,"Catalogue non trouvé."))]))}},B=ee(ft);B.use(te());B.mount("#admin-catalogue-edit-app");
