import{i as ae,o as n,c as i,F as y,a as t,j as oe,b as m,t as u,d as D,w as ne,e as v,v as h,n as ie,k as Q,P as F,l as S,q as re,s as L,r as d,g as C,h as de}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as ue}from"./chunks/pinia-gLxYYWQL.js";import{_ as ce}from"./chunks/BackButton-DzFd1NqY.js";const ve={class:"container-fluid px-3 mt-4"},me={key:0,class:"alert alert-warning"},pe={class:"row"},be={class:"col-12"},fe={class:"d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4"},_e={key:0,class:"alert alert-danger"},ge={class:"card mb-4"},he={class:"card-header d-flex justify-content-between align-items-center"},ye={class:"text-muted"},xe={class:"card-body"},we=["value"],ke={class:"mb-3"},Se={class:"mb-3"},Ce={class:"row mb-3"},Pe={class:"col-md-6"},Te={class:"col-md-6"},Ee={class:"mb-3 border rounded p-3 bg-light"},Ae={class:"row g-2 small"},Ve={class:"col-md-3"},$e={class:"col-md-3"},Ue={class:"col-md-3"},je={class:"mb-3"},Ne={class:"form-check"},De={class:"mb-3"},Ie={class:"form-check"},Me={class:"form-check"},Re={class:"form-check"},Fe=["disabled"],Le={key:0,class:"spinner-border spinner-border-sm me-1"},Oe=["action"],Be=["value"],qe={class:"card mb-4"},ze={class:"card-header"},Je={class:"card-title mb-0"},Ke={class:"card-body"},Qe={key:0,class:"alert alert-info"},Ye={key:1,class:"table-responsive"},Ge={class:"table table-hover"},He={key:1},We=["href"],Xe=["onClick"],Ze={class:"card mb-4"},et={id:"collapseImportCatalog",class:"collapse"},tt={class:"card-body"},lt={class:"row align-items-end"},st={class:"col-md-8"},at=["value"],ot={class:"col-md-4"},nt=["disabled"],it={key:0,class:"spinner-border spinner-border-sm me-1"},rt={class:"card mb-4"},dt={id:"collapseAddProducts",class:"collapse"},ut={class:"card-body"},ct={class:"row mb-3"},vt={class:"col-md-4"},mt=["value"],pt={class:"col-md-4"},bt=["value"],ft={class:"col-md-4"},_t=["disabled"],gt={key:0,class:"spinner-border spinner-border-sm me-1"},ht={class:"small text-muted mb-3"},yt={class:"table-responsive",style:{"max-height":"400px","overflow-y":"auto"}},xt={class:"table table-sm table-hover"},wt={class:"sticky-top thead-administration"},kt={style:{width:"40px"}},St=["checked","title"],Ct=["value"],Pt={style:{width:"120px"}},Tt=["onUpdate:modelValue"],Et={style:{width:"100px"}},At=["onUpdate:modelValue","placeholder"],Vt={class:"mb-3"},$t=["href"],Ut=["href"],jt={__name:"AdminCatalogueEditPage",setup(Nt){const c=d(null),_=d([]),I=d([]),O=d([]),B=d([]),q=d([]),r=d(""),P=d(""),T=d(!1),E=d(!1),A=d(!1),a=d({originalname:"",description:"",expiration_date:"",date_livraison:"",is_archived:"0",referent_order_reminder_enabled:0}),x=d(""),w=d(""),V=d(""),p=d([]),$=d({}),U=d({}),k=d(""),g=C(()=>window.CSRF_TOKEN||"");function z(s){if(!s)return"";const e=new Date(s);if(isNaN(e.getTime()))return"";const l=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),b=String(e.getDate()).padStart(2,"0");return`${l}-${o}-${b}`}const J=C(()=>{const s=c.value;if(!s)return"";if(!s.expiration_date)return"Permanent";const e=new Date(s.expiration_date).getTime(),l=Date.now();return e+864e5<l?"Expiré":"Actif"}),G=C(()=>{const s=J.value;return s==="Expiré"?"bg-danger":s==="Actif"?"bg-success":"bg-primary"}),M=C(()=>{let s=I.value||[];if(x.value!=null&&x.value!==""){const e=String(x.value);s=s.filter(l=>l!=null&&String(l.supplier_id??"")===e)}if(w.value!=null&&w.value!==""){const e=String(w.value);s=s.filter(l=>l!=null&&String(l.category_id??"")===e)}if(V.value){const e=V.value.toLowerCase();s=s.filter(l=>(l.nom||"").toLowerCase().includes(e))}return s}),R=C(()=>{const s=M.value;return s.length===0?!1:s.every(e=>p.value.includes(e.id))});function H(){const e=M.value.map(l=>l.id);if(R.value)p.value=p.value.filter(l=>!e.includes(l));else{const l=[...new Set([...p.value,...e])];p.value=l}}function W(s){confirm("Supprimer ce catalogue (cela supprimera tous les paniers, commandes et articles associés) ?")||s.preventDefault()}ae(()=>{const s=window.INITIAL_DATA||{};if(c.value=s.catalogue||null,_.value=s.articles||[],I.value=s.allProducts||[],O.value=s.suppliers||[],B.value=s.categories||[],q.value=s.otherCatalogs||[],r.value=s.error||"",s.catalogue){const e=s.catalogue;a.value.originalname=e.originalname||"",a.value.description=e.description||"",a.value.expiration_date=z(e.expiration_date),a.value.date_livraison=z(e.date_livraison),a.value.is_archived=String(e.is_archived??0),a.value.referent_order_reminder_enabled=e.referent_order_reminder_enabled?1:0}(I.value||[]).forEach(e=>{$.value[e.id]=e.dernier_prix??"",U.value[e.id]=e.derniere_unite??1})});async function X(){if(c.value){r.value="",T.value=!0,P.value="Enregistrement...";try{const s=new URLSearchParams({_csrf:g.value,originalname:a.value.originalname,description:a.value.description||"",expiration_date:a.value.expiration_date||"",date_livraison:a.value.date_livraison||"",is_archived:a.value.is_archived,referent_order_reminder_enabled:a.value.referent_order_reminder_enabled?"1":""}),l=await(await fetch(`/admin/catalogues/${c.value.id}/edit`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success?(P.value="Enregistré",setTimeout(()=>{P.value=""},2e3)):r.value=l.error||"Erreur lors de l'enregistrement."}catch{r.value="Erreur de connexion."}finally{T.value=!1}}}async function Z(s){if(!(!c.value||!confirm("Retirer cet article du catalogue ?")))try{const e=new URLSearchParams({_csrf:g.value}),o=await(await fetch(`/admin/catalogues/${c.value.id}/articles/${s.id}/delete`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:e.toString()})).json().catch(()=>({}));o.success?_.value=_.value.filter(b=>b.id!==s.id):r.value=o.error||"Erreur lors de la suppression."}catch{r.value="Erreur de connexion."}}async function ee(){if(!(!c.value||p.value.length===0)){r.value="",E.value=!0;try{const s=p.value.map(f=>{const j=$.value[f],le=j!=null&&j!==""?Number(j):0,N=U.value[f],se=N!=null&&N!==""?Number(N):1;return{product_id:f,prix:le,unite:se}}),e=JSON.stringify({products:s}),l={"Content-Type":"application/json",Accept:"application/json"};g.value&&(l["csrf-token"]=g.value);const o=await fetch(`/admin/catalogues/${c.value.id}/articles/add-multiple`,{method:"POST",credentials:"include",headers:l,body:e});let b={};const K=o.headers.get("content-type");if(K&&K.includes("application/json"))try{b=await o.json()}catch(f){r.value=`Erreur lors de la lecture de la réponse: ${f.message}`;return}else{try{const f=await o.text();r.value=`Erreur ${o.status}: ${f||o.statusText}`}catch{r.value=`Erreur ${o.status}: ${o.statusText}`}return}if(!o.ok){r.value=b.error||b.message||`Erreur ${o.status}: ${o.statusText}`;return}b.success?b.added>0?window.location.reload():r.value=b.error||"Aucun produit ajouté (déjà présents).":r.value=b.error||"Erreur lors de l'ajout."}catch(s){console.error("Erreur addSelectedProducts:",s),r.value=`Erreur de connexion: ${s.message}`}finally{E.value=!1}}}async function te(){if(!(!c.value||!k.value)){r.value="",A.value=!0;try{const s=new URLSearchParams({_csrf:g.value,source_catalog_id:k.value}),l=await(await fetch(`/admin/catalogues/${c.value.id}/import-from-catalog`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()})).json().catch(()=>({}));l.success&&l.added>0?window.location.reload():r.value=l.error||(l.added===0?"Aucun produit à importer (déjà présents).":"Erreur.")}catch{r.value="Erreur de connexion."}finally{A.value=!1}}}return(s,e)=>(n(),i("div",ve,[c.value?(n(),i(y,{key:1},[t("div",pe,[t("div",be,[t("div",fe,[e[13]||(e[13]=t("h2",{class:"mb-0"},"Éditer le catalogue",-1)),oe(ce)])])]),r.value?(n(),i("div",_e,[e[14]||(e[14]=t("i",{class:"bi bi-exclamation-triangle-fill me-2"},null,-1)),m(u(r.value),1)])):D("",!0),t("div",ge,[t("div",he,[e[15]||(e[15]=t("h5",{class:"card-title mb-0"},"Informations du catalogue",-1)),t("small",ye,u(P.value),1)]),t("div",xe,[t("form",{onSubmit:ne(X,["prevent"])},[t("input",{type:"hidden",name:"_csrf",value:g.value},null,8,we),t("div",ke,[e[16]||(e[16]=t("label",{for:"originalname",class:"form-label"},[m("Nom du catalogue "),t("span",{class:"text-danger"},"*")],-1)),v(t("input",{id:"originalname","onUpdate:modelValue":e[0]||(e[0]=l=>a.value.originalname=l),type:"text",class:"form-control",required:"",placeholder:"Nom du catalogue"},null,512),[[h,a.value.originalname]])]),t("div",Se,[e[17]||(e[17]=t("label",{for:"description",class:"form-label"},"Description",-1)),v(t("textarea",{id:"description","onUpdate:modelValue":e[1]||(e[1]=l=>a.value.description=l),class:"form-control",rows:"3",placeholder:"Description du catalogue"},null,512),[[h,a.value.description]])]),t("div",Ce,[t("div",Pe,[e[18]||(e[18]=t("label",{for:"expiration_date",class:"form-label"},"Date d'expiration",-1)),v(t("input",{id:"expiration_date","onUpdate:modelValue":e[2]||(e[2]=l=>a.value.expiration_date=l),type:"date",class:"form-control"},null,512),[[h,a.value.expiration_date]])]),t("div",Te,[e[19]||(e[19]=t("label",{for:"date_livraison",class:"form-label"},"Date de livraison",-1)),v(t("input",{id:"date_livraison","onUpdate:modelValue":e[3]||(e[3]=l=>a.value.date_livraison=l),type:"date",class:"form-control"},null,512),[[h,a.value.date_livraison]])])]),t("div",Ee,[t("div",Ae,[t("div",Ve,[e[20]||(e[20]=t("span",{class:"text-muted"},"ID",-1)),e[21]||(e[21]=m()),t("strong",null,"#"+u(c.value.id),1)]),t("div",$e,[e[22]||(e[22]=t("span",{class:"text-muted"},"Produits",-1)),e[23]||(e[23]=m()),t("strong",null,u(_.value.length),1)]),t("div",Ue,[e[24]||(e[24]=t("span",{class:"text-muted"},"Statut",-1)),e[25]||(e[25]=m()),t("span",{class:ie(["badge",G.value])},u(J.value),3)])])]),t("div",je,[e[27]||(e[27]=t("label",{class:"form-label"},"Rappel commande référent",-1)),t("div",Ne,[v(t("input",{id:"referent_order_reminder_enabled","onUpdate:modelValue":e[4]||(e[4]=l=>a.value.referent_order_reminder_enabled=l),class:"form-check-input",type:"checkbox","true-value":1,"false-value":0},null,512),[[Q,a.value.referent_order_reminder_enabled]]),e[26]||(e[26]=t("label",{class:"form-check-label",for:"referent_order_reminder_enabled"},"Envoyer un mail au référent pour prévoir la commande (Expiration + 8h)",-1))])]),t("div",De,[e[31]||(e[31]=t("label",{class:"form-label"},"Visibilité",-1)),t("div",Ie,[v(t("input",{id:"is_archived_0","onUpdate:modelValue":e[5]||(e[5]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"0"},null,512),[[F,a.value.is_archived]]),e[28]||(e[28]=t("label",{class:"form-check-label",for:"is_archived_0"},"Visible de tous",-1))]),t("div",Me,[v(t("input",{id:"is_archived_2","onUpdate:modelValue":e[6]||(e[6]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"2"},null,512),[[F,a.value.is_archived]]),e[29]||(e[29]=t("label",{class:"form-check-label",for:"is_archived_2"},"Invisible des utilisateurs (visible en admin)",-1))]),t("div",Re,[v(t("input",{id:"is_archived_3","onUpdate:modelValue":e[7]||(e[7]=l=>a.value.is_archived=l),class:"form-check-input",type:"radio",value:"3"},null,512),[[F,a.value.is_archived]]),e[30]||(e[30]=t("label",{class:"form-check-label",for:"is_archived_3"},"Invisible de tous, partout (archivé)",-1))])]),t("button",{type:"submit",class:"btn btn-primary",disabled:T.value},[T.value?(n(),i("span",Le)):D("",!0),e[32]||(e[32]=m(" Enregistrer les modifications ",-1))],8,Fe)],32),t("form",{method:"POST",action:`/admin/catalogues/${c.value.id}/delete`,class:"mt-3",onSubmit:W},[t("input",{type:"hidden",name:"_csrf",value:g.value},null,8,Be),e[33]||(e[33]=t("button",{type:"submit",class:"btn btn-danger"},[t("i",{class:"bi bi-trash me-2"}),m("Supprimer le catalogue ")],-1))],40,Oe)])]),t("div",qe,[t("div",ze,[t("h5",Je,[e[34]||(e[34]=t("i",{class:"bi bi-journal-text me-2"},null,-1)),m("Articles du catalogue ("+u(_.value.length)+")",1)])]),t("div",Ke,[_.value.length===0?(n(),i("div",Qe,"Aucun article. Ajoutez des produits ci-dessous.")):(n(),i("div",Ye,[t("table",Ge,[e[35]||(e[35]=t("thead",{class:"thead-administration"},[t("tr",null,[t("th",null,"Produit"),t("th",null,"Catégorie"),t("th",null,"Prix"),t("th",null,"Unité"),t("th",null,"Actions")])],-1)),t("tbody",null,[(n(!0),i(y,null,S(_.value,l=>(n(),i("tr",{key:l.id},[t("td",null,[t("strong",null,u(l.produit),1)]),t("td",null,[l.categorie?(n(),i("span",{key:0,class:"badge",style:re({backgroundColor:l.categorie_couleur||"#6c757d"})},u(l.categorie),5)):(n(),i("span",He,"-"))]),t("td",null,u(l.prix!=null?Number(l.prix).toFixed(2):"-")+" €",1),t("td",null,u(l.unite||"-"),1),t("td",null,[t("a",{href:`/admin/catalogues/${c.value.id}/articles/${l.id}/edit`,class:"btn btn-sm btn-outline-primary me-1"},"Modifier",8,We),t("button",{type:"button",class:"btn btn-sm btn-outline-danger",onClick:o=>Z(l)},"Supprimer",8,Xe)])]))),128))])])]))])]),t("div",Ze,[e[39]||(e[39]=t("div",{class:"card-header"},[t("button",{class:"btn btn-link text-decoration-none p-0 w-100 text-start d-flex align-items-center",type:"button","data-bs-toggle":"collapse","data-bs-target":"#collapseImportCatalog","aria-expanded":"false"},[t("i",{class:"bi bi-files me-2"}),m("Importer depuis un autre catalogue ")])],-1)),t("div",et,[t("div",tt,[t("div",lt,[t("div",st,[e[37]||(e[37]=t("label",{class:"form-label"},"Catalogue source",-1)),v(t("select",{"onUpdate:modelValue":e[8]||(e[8]=l=>k.value=l),class:"form-select"},[e[36]||(e[36]=t("option",{value:""},"-- Sélectionner un catalogue --",-1)),(n(!0),i(y,null,S(q.value,l=>(n(),i("option",{key:l.id,value:l.id}," #"+u(l.id)+" - "+u(l.originalname)+" ("+u(l.nb_produits)+" produits) ",9,at))),128))],512),[[L,k.value]])]),t("div",ot,[t("button",{type:"button",class:"btn btn-success w-100",disabled:A.value||!k.value,onClick:te},[A.value?(n(),i("span",it)):D("",!0),e[38]||(e[38]=m(" Importer ",-1))],8,nt)])])])])]),t("div",rt,[e[49]||(e[49]=t("div",{class:"card-header"},[t("button",{class:"btn btn-link text-decoration-none p-0 w-100 text-start d-flex align-items-center",type:"button","data-bs-toggle":"collapse","data-bs-target":"#collapseAddProducts","aria-expanded":"false"},[t("i",{class:"bi bi-plus-circle me-2"}),m("Ajouter des produits au catalogue depuis la base des produits ")])],-1)),t("div",dt,[t("div",ut,[t("div",ct,[t("div",vt,[e[41]||(e[41]=t("label",{class:"form-label"},"Fournisseur",-1)),v(t("select",{"onUpdate:modelValue":e[9]||(e[9]=l=>x.value=l),class:"form-select"},[e[40]||(e[40]=t("option",{value:""},"Tous",-1)),(n(!0),i(y,null,S(O.value,l=>(n(),i("option",{key:l.id,value:String(l.id)},u(l.nom),9,mt))),128))],512),[[L,x.value]])]),t("div",pt,[e[43]||(e[43]=t("label",{class:"form-label"},"Catégorie",-1)),v(t("select",{"onUpdate:modelValue":e[10]||(e[10]=l=>w.value=l),class:"form-select"},[e[42]||(e[42]=t("option",{value:""},"Toutes",-1)),(n(!0),i(y,null,S(B.value,l=>(n(),i("option",{key:l.id,value:String(l.id)},u(l.nom),9,bt))),128))],512),[[L,w.value]])]),t("div",ft,[e[44]||(e[44]=t("label",{class:"form-label"},"Recherche",-1)),v(t("input",{"onUpdate:modelValue":e[11]||(e[11]=l=>V.value=l),type:"text",class:"form-control",placeholder:"Nom du produit..."},null,512),[[h,V.value]])])]),t("button",{type:"button",class:"btn btn-primary mb-3",disabled:E.value||p.value.length===0,onClick:ee},[E.value?(n(),i("span",gt)):D("",!0),e[45]||(e[45]=m(" Ajouter la sélection ",-1))],8,_t),t("p",ht,u(p.value.length)+" produit(s) sélectionné(s)",1),t("div",yt,[t("table",xt,[t("thead",wt,[t("tr",null,[t("th",kt,[t("input",{type:"checkbox",class:"form-check-input",checked:R.value,onChange:H,title:R.value?"Tout désélectionner":"Tout sélectionner"},null,40,St)]),e[46]||(e[46]=t("th",null,"Produit",-1)),e[47]||(e[47]=t("th",null,"Prix (€)",-1)),e[48]||(e[48]=t("th",null,"Qté mini",-1))])]),t("tbody",null,[(n(!0),i(y,null,S(M.value,l=>(n(),i("tr",{key:l.id},[t("td",null,[v(t("input",{"onUpdate:modelValue":e[12]||(e[12]=o=>p.value=o),type:"checkbox",value:l.id,class:"form-check-input"},null,8,Ct),[[Q,p.value]])]),t("td",null,[t("strong",null,u(l.nom),1)]),t("td",Pt,[v(t("input",{"onUpdate:modelValue":o=>$.value[l.id]=o,type:"number",step:"0.01",min:"0",class:"form-control form-control-sm",placeholder:"0.00"},null,8,Tt),[[h,$.value[l.id],void 0,{number:!0}]])]),t("td",Et,[v(t("input",{"onUpdate:modelValue":o=>U.value[l.id]=o,type:"number",step:"0.1",min:"0.1",class:"form-control form-control-sm",placeholder:l.derniere_unite||1},null,8,At),[[h,U.value[l.id],void 0,{number:!0}]])])]))),128))])])])])])]),t("div",Vt,[t("a",{href:`/admin/catalogues/${c.value.id}/synthese/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse",8,$t),t("a",{href:`/admin/catalogues/${c.value.id}/synthese-detaillee/vue`,class:"btn btn-outline-secondary me-2"},"Synthèse détaillée",8,Ut),e[50]||(e[50]=t("a",{href:"/admin/catalogues/vue",class:"btn btn-outline-secondary"},"Retour à la liste",-1))])],64)):(n(),i("div",me,"Catalogue non trouvé."))]))}},Y=de(jt);Y.use(ue());Y.mount("#admin-catalogue-edit-app");
