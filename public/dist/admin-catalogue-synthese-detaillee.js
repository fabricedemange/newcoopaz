import{i as y,o as d,c,u as a,a as t,b as u,t as n,F as _,d as m,e as v,v as x,k as w,h as C}from"./chunks/runtime-dom.esm-bundler-C8CGTSXe.js";import{d as k,c as E}from"./chunks/pinia-DIU_KYYh.js";import{av as L}from"./chunks/index-zlPV8JO4.js";const D=k("adminCatalogueSyntheseDetaillee",{state:()=>({catalogueId:typeof window<"u"&&window.CATALOGUE_ID||null,catalogueName:"",organizationName:"",organizationEmail:"",details:[],loading:!0,error:null,search:""}),getters:{filteredDetails(o){if(!o.search)return o.details;const e=o.search.toLowerCase();return o.details.filter(i=>i.username2&&i.username2.toLowerCase().includes(e)||i.produit&&i.produit.toLowerCase().includes(e)||i.categorie&&i.categorie.toLowerCase().includes(e)||i.note&&i.note.toLowerCase().includes(e)||i.note_article&&i.note_article.toLowerCase().includes(e))},statistics(o){const e=o.search?o.details.filter(l=>l.username2&&l.username2.toLowerCase().includes(o.search.toLowerCase())||l.produit&&l.produit.toLowerCase().includes(o.search.toLowerCase())||l.categorie&&l.categorie.toLowerCase().includes(o.search.toLowerCase())||l.note&&l.note.toLowerCase().includes(o.search.toLowerCase())||l.note_article&&l.note_article.toLowerCase().includes(o.search.toLowerCase())):o.details,i=e.length,h=new Set(e.map(l=>l.username2)).size,s=new Set(e.map(l=>l.produit)).size,r=e.reduce((l,g)=>l+parseFloat(g.quantite||0),0),p=e.reduce((l,g)=>l+parseFloat(g.montant_utilisateur||0),0),f=i>0?p/i:0;return{nbLines:i,uniqueUsers:h,uniqueProducts:s,totalQuantity:r,totalAmount:p,averageAmount:f}}},actions:{async loadData(){const o=this.catalogueId;if(!o){this.error="ID catalogue manquant",this.loading=!1;return}this.loading=!0,this.error=null;try{const e=await L(o);if(e.success)this.catalogueName=e.catalogueName||"",this.organizationName=e.organizationName||"",this.organizationEmail=e.organizationEmail||"",this.details=e.details||[];else throw new Error(e.error||"Erreur lors du chargement")}catch(e){this.error=e.message||"Erreur lors du chargement"}finally{this.loading=!1}},formatPrice(o){return parseFloat(o||0).toFixed(2)+" €"},formatQuantity(o){return parseFloat(o||0).toFixed(2)}}}),N={class:"container-fluid mt-4"},P={key:0,class:"text-center py-5"},z={key:1,class:"alert alert-danger"},A={class:"d-flex justify-content-between align-items-center mb-4"},S={class:"text-muted"},F={key:0,class:"text-muted mb-0"},q={class:"card mb-4"},I={class:"card-body"},Q={class:"row g-2"},U={class:"col-md-auto"},M=["href"],T={class:"col-md-auto"},B=["href"],V={key:0,class:"col-md-auto"},$={class:"card mb-4"},R={class:"card-body py-2"},j={class:"row text-center"},G={class:"col"},O={class:"fs-5"},H={class:"col"},J={class:"fs-5"},K={class:"col"},W={class:"fs-5"},X={class:"col"},Y={class:"fs-5"},Z={class:"col"},tt={class:"fs-5 text-success"},et={class:"card mb-4"},st={class:"card-body"},at={class:"input-group"},ot={class:"card"},lt={class:"card-body p-0"},nt={class:"table-responsive"},it={class:"table table-striped table-hover mb-0"},rt={key:0},dt={colspan:"7",class:"text-center text-muted py-4"},ct={class:"text-end"},ut={class:"text-end"},mt={class:"text-end"},ht={key:0,class:"small"},pt={key:1,class:"small text-info"},gt={key:2},_t={__name:"AdminCatalogueSyntheseDetailleePage",setup(o){const e=D();async function i(){if(confirm(`Envoyer la synthèse détaillée par email à ${e.organizationEmail} ?`))try{if((await fetch(`/admin/catalogues/${e.catalogueId}/synthese-detaillee/export/pdf/M`,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"})).ok)alert("Email envoyé avec succès !");else throw new Error("Erreur lors de l'envoi de l'email")}catch(h){alert(h.message||"Erreur lors de l'envoi de l'email")}}return y(()=>{e.loadData()}),(h,s)=>(d(),c("div",N,[a(e).loading?(d(),c("div",P,[...s[1]||(s[1]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Chargement...")],-1),t("p",{class:"mt-3 text-muted"},"Chargement de la synthèse détaillée...",-1)])])):a(e).error?(d(),c("div",z,[s[2]||(s[2]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),u(n(a(e).error)+" ",1),s[3]||(s[3]=t("a",{href:"/admin/catalogues/vue",class:"btn btn-primary ms-2"},[t("i",{class:"bi bi-arrow-left me-1"}),u("Retour")],-1))])):(d(),c(_,{key:2},[t("div",A,[t("div",null,[s[5]||(s[5]=t("h2",null,[t("i",{class:"bi bi-file-earmark-spreadsheet me-2"}),u("Synthèse détaillée du catalogue")],-1)),t("h5",S,n(a(e).catalogueName),1),a(e).organizationName?(d(),c("p",F,[s[4]||(s[4]=t("i",{class:"bi bi-building me-1"},null,-1)),u(n(a(e).organizationName),1)])):m("",!0)]),s[6]||(s[6]=t("a",{href:"/admin/catalogues/vue",class:"btn btn-outline-secondary"},[t("i",{class:"bi bi-arrow-left me-1"}),u("Retour ")],-1))]),t("div",q,[t("div",I,[t("div",Q,[t("div",U,[t("a",{href:`/admin/catalogues/${a(e).catalogueId}/synthese-detaillee/export/xlsx`,class:"btn btn-success"},[...s[7]||(s[7]=[t("i",{class:"bi bi-file-earmark-excel me-1"},null,-1),u("Export Excel ",-1)])],8,M)]),t("div",T,[t("a",{href:`/admin/catalogues/${a(e).catalogueId}/synthese-detaillee/export/pdf/S`,class:"btn btn-danger"},[...s[8]||(s[8]=[t("i",{class:"bi bi-file-earmark-pdf me-1"},null,-1),u("Export PDF ",-1)])],8,B)]),a(e).organizationEmail?(d(),c("div",V,[t("button",{type:"button",class:"btn btn-primary",onClick:i},[...s[9]||(s[9]=[t("i",{class:"bi bi-envelope me-1"},null,-1),u("Envoyer par email ",-1)])])])):m("",!0)])])]),t("div",$,[t("div",R,[t("div",j,[t("div",G,[s[10]||(s[10]=t("small",{class:"text-muted d-block"},"Lignes",-1)),t("strong",O,n(a(e).statistics.nbLines),1)]),t("div",H,[s[11]||(s[11]=t("small",{class:"text-muted d-block"},"Utilisateurs",-1)),t("strong",J,n(a(e).statistics.uniqueUsers),1)]),t("div",K,[s[12]||(s[12]=t("small",{class:"text-muted d-block"},"Produits",-1)),t("strong",W,n(a(e).statistics.uniqueProducts),1)]),t("div",X,[s[13]||(s[13]=t("small",{class:"text-muted d-block"},"Quantité totale",-1)),t("strong",Y,n(a(e).formatQuantity(a(e).statistics.totalQuantity)),1)]),t("div",Z,[s[14]||(s[14]=t("small",{class:"text-muted d-block"},"Montant total",-1)),t("strong",tt,n(a(e).formatPrice(a(e).statistics.totalAmount)),1)])])])]),t("div",et,[t("div",st,[t("div",at,[s[15]||(s[15]=t("span",{class:"input-group-text"},[t("i",{class:"bi bi-search"})],-1)),v(t("input",{"onUpdate:modelValue":s[0]||(s[0]=r=>a(e).search=r),type:"text",class:"form-control",placeholder:"Rechercher utilisateur, produit, catégorie ou note..."},null,512),[[x,a(e).search]])])])]),t("div",ot,[s[17]||(s[17]=t("div",{class:"card-header bg-primary text-white"},[t("h5",{class:"mb-0"},"Détail des commandes par utilisateur")],-1)),t("div",lt,[t("div",nt,[t("table",it,[s[16]||(s[16]=t("thead",{class:"thead-administration"},[t("tr",null,[t("th",null,"Utilisateur (panier)"),t("th",null,"Produit"),t("th",null,"Catégorie"),t("th",{class:"text-end"},"Prix"),t("th",{class:"text-end"},"Quantité"),t("th",{class:"text-end"},"Montant"),t("th",null,"Notes")])],-1)),t("tbody",null,[a(e).filteredDetails.length===0?(d(),c("tr",rt,[t("td",dt,n(a(e).search?"Aucun résultat trouvé":"Aucune donnée"),1)])):m("",!0),(d(!0),c(_,null,w(a(e).filteredDetails,(r,p)=>(d(),c("tr",{key:p},[t("td",null,n(r.username2),1),t("td",null,[t("strong",null,n(r.produit),1)]),t("td",null,n(r.categorie||"-"),1),t("td",ct,n(a(e).formatPrice(r.prix)),1),t("td",ut,n(a(e).formatQuantity(r.quantite)),1),t("td",mt,[t("strong",null,n(a(e).formatPrice(r.montant_utilisateur)),1)]),t("td",null,[r.note?(d(),c("div",ht,n(r.note),1)):m("",!0),r.note_article?(d(),c("div",pt,n(r.note_article),1)):m("",!0),!r.note&&!r.note_article?(d(),c("span",gt,"-")):m("",!0)])]))),128))])])])])])],64))]))}},b=C(_t);b.use(E());b.mount("#admin-catalogue-synthese-detaillee-app");
