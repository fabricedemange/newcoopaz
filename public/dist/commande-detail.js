import{m as D,i as F,o as l,c as a,a as e,b as u,u as n,t as o,d as f,F as v,j as R,n as w,l as _,q as x,e as I,v as M,p as B,r as k,h as S}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as q,c as $}from"./chunks/pinia-gLxYYWQL.js";import{k as T,r as K,l as V,m as A,A as O}from"./chunks/index-CQL6Akic.js";import{_ as j}from"./chunks/BackButton-DzFd1NqY.js";const L=q("commandeDetail",{state:()=>({loading:!1,error:null,authRequired:!1,commande:null,articles:[],editingNoteId:null,sendingPdf:!1,sendPdfMessage:null}),getters:{articlesByCategory(d){const s={};return(d.articles||[]).forEach(i=>{const c=i.categorie||"Sans catégorie";s[c]||(s[c]={name:c,color:i.categorie_couleur||"#6c757d",ordre:i.categorie_ordre??999,articles:[]}),s[c].articles.push(i)}),Object.values(s).sort((i,c)=>i.ordre-c.ordre)},totalCommande(d){return(d.articles||[]).reduce((s,i)=>s+(parseFloat(i.prix)||0)*(parseFloat(i.quantity)||0),0)}},actions:{async loadDetail(d){this.loading=!0,this.error=null,this.authRequired=!1,this.commande=null,this.articles=[];try{const s=await A(d);if(s.success)this.commande=s.commande,this.articles=s.articles||[];else throw new Error(s.error||"Erreur chargement")}catch(s){this.error=s.message,s.code===O&&(this.authRequired=!0),console.error("commandeDetail loadDetail:",s)}finally{this.loading=!1}},setEditingNoteId(d){this.editingNoteId=this.editingNoteId===d?null:d},async saveNote(d,s,i){await V(d,s,i);const c=this.articles.find(g=>g.id===d);c&&(c.note=s),this.editingNoteId=null},async reopenCommande(d,s){await K(d,s),typeof window<"u"&&(window.location.href=`/panier/${d}/modifier/vue`)},async sendPdfByEmail(d,s){this.sendingPdf=!0,this.sendPdfMessage=null;try{const i=await T(d,s);this.sendPdfMessage={type:"success",text:i.message||"PDF envoyé par email."}}catch(i){this.sendPdfMessage={type:"error",text:i.message||"Erreur lors de l'envoi."}}finally{this.sendingPdf=!1}}}}),z={class:"admin-content-wrapper"},U={class:"container-fluid mt-4"},Q={key:0,class:"alert alert-danger alert-dismissible fade show"},G={key:1,class:"text-center py-5"},H={class:"d-flex justify-content-between align-items-center mb-4"},J={class:"mb-0"},W={class:"d-flex gap-2 flex-wrap"},X=["disabled"],Y={key:0,class:"spinner-border spinner-border-sm me-1"},Z={key:1,class:"bi bi-envelope-paper me-1"},ee={class:"card mb-4"},te={class:"card-body"},se={class:"row"},ne={class:"col-md-6"},oe={key:0},ie={class:"col-md-6"},le={key:0,class:"badge bg-danger ms-2"},ae={key:0,class:"alert alert-info mt-3"},de={key:1,class:"mb-4"},re={class:"mb-0"},me={class:"badge bg-secondary ms-2"},ue={class:"card-body p-0"},ce={class:"table-responsive"},pe={class:"table table-hover mb-0"},fe={key:0},be={key:1,class:"text-muted"},ge={class:"text-end"},ye={class:"text-center"},ve={class:"badge bg-primary"},he={class:"text-end"},we={key:0,class:"input-group input-group-sm"},_e=["onKeyup"],xe=["onClick"],ke={key:1,class:"d-flex align-items-center gap-2"},Ce={class:"flex-grow-1"},Ne=["onClick"],Pe={class:"card bg-light"},Ee={class:"card-body"},De={class:"row"},Fe={class:"col-md-6 text-end"},Re={class:"text-primary"},Ie={__name:"CommandeDetailPage",setup(d){const s=L(),i=k(null),c=k("");function g(){return(typeof window<"u"?window.location.pathname.split("/"):[])[2]||null}function y(r){return r==null?"0,00 €":new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(r)}function N(r){s.setEditingNoteId(r.id),c.value=r.note||""}function h(r){const t=c.value;s.saveNote(r.id,t,typeof window<"u"?window.CSRF_TOKEN:"").catch(p=>{console.error("saveNote:",p),typeof window<"u"&&alert("Erreur lors de la sauvegarde de la note")})}function P(){i.value&&confirm("Confirmer la réouverture de cette commande en panier ?")&&s.reopenCommande(i.value,typeof window<"u"?window.CSRF_TOKEN:"")}function E(){i.value&&s.sendPdfByEmail(i.value,typeof window<"u"?window.CSRF_TOKEN:"")}return D(()=>s.editingNoteId,r=>{r||(c.value="")}),F(()=>{const r=g();i.value=r,r&&s.loadDetail(r)}),(r,t)=>(l(),a("div",z,[e("div",U,[e("button",{class:"btn btn-outline-secondary d-md-none mb-3",onClick:t[0]||(t[0]=p=>r.history.back())},[...t[4]||(t[4]=[e("i",{class:"bi bi-arrow-left me-2"},null,-1),u("Retour ",-1)])]),n(s).error?(l(),a("div",Q,[t[5]||(t[5]=e("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),t[6]||(t[6]=e("strong",null,"Erreur :",-1)),u(" "+o(n(s).error)+" ",1),e("button",{type:"button",class:"btn-close",onClick:t[1]||(t[1]=p=>n(s).error=null)})])):f("",!0),n(s).loading?(l(),a("div",G,[...t[7]||(t[7]=[e("div",{class:"spinner-border text-primary",role:"status",style:{width:"3rem",height:"3rem"}},null,-1),e("p",{class:"mt-3 text-muted"},"Chargement de la commande...",-1)])])):n(s).commande?(l(),a(v,{key:2},[e("div",H,[e("h2",J,[t[8]||(t[8]=e("i",{class:"bi bi-receipt me-2"},null,-1)),u("Commande #"+o(n(s).commande.id),1)]),e("div",W,[e("button",{type:"button",class:"btn btn-outline-primary",disabled:n(s).sendingPdf,onClick:E},[n(s).sendingPdf?(l(),a("span",Y)):(l(),a("i",Z)),t[9]||(t[9]=u(" Envoyer le PDF par mail ",-1))],8,X),R(j),t[10]||(t[10]=e("a",{href:"/commandes/vue",class:"btn btn-secondary"},"Liste des commandes",-1))])]),n(s).sendPdfMessage?(l(),a("div",{key:0,class:w(["alert mb-4",n(s).sendPdfMessage.type==="success"?"alert-success":"alert-danger"])},o(n(s).sendPdfMessage.text),3)):f("",!0),e("div",ee,[t[22]||(t[22]=e("div",{class:"card-header bg-primary text-white"},[e("h5",{class:"mb-0"},[e("i",{class:"bi bi-info-circle me-2"}),u("Informations")])],-1)),e("div",te,[e("div",se,[e("div",ne,[e("p",null,[t[11]||(t[11]=e("strong",null,"Demandeur :",-1)),t[12]||(t[12]=u()),t[13]||(t[13]=e("i",{class:"bi bi-person-circle"},null,-1)),u(" "+o(n(s).commande.username),1)]),e("p",null,[t[14]||(t[14]=e("strong",null,"Catalogue :",-1)),u(" "+o(n(s).commande.originalname),1)]),n(s).commande.catalog_description?(l(),a("p",oe,[t[15]||(t[15]=e("strong",null,"Description :",-1)),u(" "+o(n(s).commande.catalog_description),1)])):f("",!0),e("p",null,[t[16]||(t[16]=e("strong",null,"Date de commande :",-1)),u(" "+o(n(s).commande.created_formatted),1)])]),e("div",ie,[e("p",null,[t[17]||(t[17]=e("strong",null,"Date d'expiration :",-1)),u(" "+o(n(s).commande.expiration_formatted)+" ",1),n(s).commande.isExpired?(l(),a("span",le,"Expiré")):f("",!0)]),e("p",null,[t[18]||(t[18]=e("strong",null,"Date de livraison :",-1)),u(" "+o(n(s).commande.livraison_formatted),1)]),e("p",null,[t[19]||(t[19]=e("strong",null,"Statut :",-1)),t[20]||(t[20]=u()),e("span",{class:w(n(s).commande.modifiable?"badge bg-warning":"badge bg-secondary")},o(n(s).commande.modifiable?"Modifiable":"Non modifiable"),3)])])]),n(s).commande.note?(l(),a("div",ae,[t[21]||(t[21]=e("strong",null,"Note :",-1)),u(" "+o(n(s).commande.note),1)])):f("",!0)])]),n(s).commande.modifiable?(l(),a("div",de,[e("button",{class:"btn btn-warning",onClick:P},[...t[23]||(t[23]=[e("i",{class:"bi bi-arrow-counterclockwise me-1"},null,-1),u("Repasser en panier ",-1)])])])):f("",!0),(l(!0),a(v,null,_(n(s).articlesByCategory,p=>(l(),a("div",{key:p.name,class:"card mb-4"},[e("div",{class:"card-header",style:x({backgroundColor:p.color+"20",borderLeft:"4px solid "+p.color})},[e("h5",re,[e("i",{class:"bi bi-tag-fill me-2",style:x({color:p.color})},null,4),u(o(p.name)+" ",1),e("span",me,o(p.articles.length)+" article(s)",1)])],4),e("div",ue,[e("div",ce,[e("table",pe,[t[27]||(t[27]=e("thead",{class:"thead-precommandes"},[e("tr",null,[e("th",{style:{width:"40%"}},"Produit"),e("th",{style:{width:"10%"}},"Fournisseur"),e("th",{style:{width:"10%"},class:"text-end"},"Prix unitaire"),e("th",{style:{width:"10%"},class:"text-center"},"Quantité"),e("th",{style:{width:"10%"},class:"text-end"},"Total"),e("th",{style:{width:"20%"}},"Note")])],-1)),e("tbody",null,[(l(!0),a(v,null,_(p.articles,m=>(l(),a("tr",{key:m.id},[e("td",null,[e("strong",null,o(m.produit),1),m.description?(l(),a("br",fe)):f("",!0),m.description?(l(),a("small",be,o(m.description),1)):f("",!0)]),e("td",null,o(m.fournisseur||"-"),1),e("td",ge,o(y(m.prix))+" / "+o(m.unite),1),e("td",ye,[e("span",ve,o(m.quantity),1)]),e("td",he,[e("strong",null,o(y((parseFloat(m.prix)||0)*(parseFloat(m.quantity)||0))),1)]),e("td",null,[n(s).editingNoteId===m.id?(l(),a("div",we,[I(e("input",{"onUpdate:modelValue":t[2]||(t[2]=b=>c.value=b),type:"text",class:"form-control",placeholder:"Note optionnelle",onKeyup:B(b=>h(m),["enter"])},null,40,_e),[[M,c.value]]),e("button",{class:"btn btn-success",onClick:b=>h(m)},[...t[24]||(t[24]=[e("i",{class:"bi bi-check"},null,-1)])],8,xe),e("button",{class:"btn btn-secondary",onClick:t[3]||(t[3]=b=>n(s).setEditingNoteId(null))},[...t[25]||(t[25]=[e("i",{class:"bi bi-x"},null,-1)])])])):(l(),a("div",ke,[e("span",Ce,o(m.note||"-"),1),e("button",{class:"btn btn-sm btn-outline-primary",onClick:b=>N(m)},[...t[26]||(t[26]=[e("i",{class:"bi bi-pencil"},null,-1)])],8,Ne)]))])]))),128))])])])])]))),128)),e("div",Pe,[e("div",Ee,[e("div",De,[t[28]||(t[28]=e("div",{class:"col-md-6"},[e("h5",null,"Total de la commande")],-1)),e("div",Fe,[e("h4",Re,o(y(n(s).totalCommande)),1)])])])])],64)):f("",!0)])]))}},C=S(Ie);C.use($());C.mount("#commande-detail-app");
