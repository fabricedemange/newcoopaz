import{i as ue,x as ce,o as n,c as o,f as de,b as _,t as v,a as t,d as S,e as N,v as F,q as ve,F as A,k as M,n as me,r as l,g as O,h as be}from"./chunks/runtime-dom.esm-bundler-CPobOing.js";import{c as pe}from"./chunks/pinia-8wUEIqj_.js";import{J as fe,K as he,L as $,M as _e}from"./chunks/index-zlPV8JO4.js";import{_ as ge}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const ye="modulepreload",we=function(R){return"/dist/"+R},X={},ke=function(r,w,P){let x=Promise.resolve();if(w&&w.length>0){let b=function(c){return Promise.all(c.map(g=>Promise.resolve(g).then(k=>({status:"fulfilled",value:k}),k=>({status:"rejected",reason:k}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),u=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));x=b(w.map(c=>{if(c=we(c),c in X)return;X[c]=!0;const g=c.endsWith(".css"),k=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${k}`))return;const p=document.createElement("link");if(p.rel=g?"stylesheet":ye,g||(p.as="script"),p.crossOrigin="",p.href=c,u&&p.setAttribute("nonce",u),document.head.appendChild(p),g)return new Promise((j,E)=>{p.addEventListener("load",j),p.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${c}`)))})}))}function C(b){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=b,window.dispatchEvent(i),!i.defaultPrevented)throw b}return x.then(b=>{for(const i of b||[])i.status==="rejected"&&C(i.reason);return r().catch(C)})},xe={class:"container-fluid px-3 mt-4"},Se={key:0,class:"alert alert-danger alert-dismissible show"},Ce={key:1,class:"alert alert-info"},Ee={class:"mb-3"},qe=["disabled"],De={key:1,class:"d-flex align-items-center gap-2"},Pe={class:"badge bg-success"},je={class:"row"},Le={class:"col-lg-5 mb-4"},Ie={class:"card mb-3"},Ue={class:"card-body"},Ve={class:"mb-3"},Be={key:0,class:"alert alert-warning mt-2 mb-0"},Ne={class:"d-flex gap-2"},Re=["disabled"],Te={class:"card"},Fe={class:"card-body"},Ae={class:"mb-2"},Me={class:"mb-2"},Oe=["value"],$e={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},Qe=["disabled","onClick"],ze={class:"badge bg-secondary"},We={key:0,class:"list-group-item text-muted text-center"},He={class:"col-lg-7 mb-4"},Je={class:"card"},Ke={class:"card-header d-flex justify-content-between align-items-center"},Ge={class:"badge bg-primary"},Xe={class:"card-body p-0"},Ye={key:0,class:"p-4 text-center text-muted"},Ze={key:1,class:"table-responsive"},et={class:"table table-hover mb-0"},tt={class:"text-end"},at={class:"text-end"},st=["onUpdate:modelValue","onBlur"],nt={key:1,class:"small text-muted"},ot={key:2,class:"text-muted"},lt=["onClick"],it={key:2,class:"p-3 border-top"},rt=["disabled"],ut={key:2,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},ct={class:"modal-dialog"},dt={class:"modal-content"},vt={class:"modal-header"},mt={class:"modal-title"},bt={class:"modal-body"},pt={class:"small text-muted mb-2"},ft={class:"small text-muted mt-2 mb-0"},ht={class:"modal-footer"},Y=1500,_t={__name:"CaisseInventairePage",setup(R){const r=l(null),w=l(null),P=l(null),x=l(null),C=l(!1),b=l(0),i=l(""),u=l(""),c=l(!1),g=l(!1),k=l([]),p=l([]),j=l(""),E=l(null),d=l(null),f=l([]),U=l([]),L=l(!1),h=l(null),V=l(0),I=l(null),T=O(()=>typeof window>"u"?!1:typeof window.BarcodeDetector=="function"?!0:!!(navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia=="function")),ee=O(()=>typeof window<"u"&&typeof window.BarcodeDetector=="function"),Q=O(()=>{let a=[...k.value];const e=(j.value||"").toLowerCase();return e&&(a=a.filter(m=>(m.nom||"").toLowerCase().includes(e))),E.value!=null&&(a=a.filter(m=>m.category_id===E.value)),a.slice(0,50)});function z(a){return String(a||"").trim().replace(/\s/g,"")}function te(a){const e=z(a);return k.value.find(m=>m.code_ean&&z(m.code_ean)===e)}function W(a){const e=te(a);if(!e){U.value.unshift({code:a,productName:null,product_id:null,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})});return}U.value.unshift({code:a,productName:e.nom,product_id:e.id,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),d.value&&J(e)}async function ae(){u.value="",c.value=!0;try{const a=await he();a.success&&a.inventaire&&(d.value=a.inventaire.id,f.value=[],U.value=[])}catch(a){u.value=a.message||"Erreur création session"}finally{c.value=!1}}function H(){d.value=null,f.value=[],U.value=[]}function J(a){h.value=a,V.value=Number(a.stock)??0,L.value=!0}async function se(){if(!h.value||!d.value)return;const a=Number(V.value);if(!(a<0)){u.value="";try{await $(d.value,h.value.id,a);const e=Number(h.value.stock)||0,m=a-e,y=f.value.find(q=>q.product_id===h.value.id);y?(y.quantite_comptee=a,y.stock_theorique=e,y.ecart=m):f.value.push({product_id:h.value.id,product_nom:h.value.nom,quantite_comptee:a,stock_theorique:e,ecart:m,comment:""}),L.value=!1}catch(e){u.value=e.message||"Erreur ajout ligne"}}}function ne(a){f.value=f.value.filter(e=>e.product_id!==a),d.value&&$(d.value,a,0).catch(()=>{})}async function oe(a){if(!(!d.value||a.ecart===0)){u.value="";try{await $(d.value,a.product_id,a.quantite_comptee,a.comment||null)}catch(e){u.value=e.message||"Erreur sauvegarde commentaire"}}}async function le(){if(!(!d.value||f.value.length===0)){u.value="",g.value=!0;try{await _e(d.value),H(),u.value=null,typeof window<"u"&&window.alert("Inventaire appliqué. Les stocks ont été mis à jour.")}catch(a){u.value=a.message||"Erreur lors de l'application"}finally{g.value=!1}}}function K(){var a;if(!(!P.value||!((a=r.value)!=null&&a.srcObject)||r.value.readyState<2)){if(r.value.videoWidth===0||r.value.videoHeight===0){setTimeout(K,100);return}x.value=setInterval(ie,350)}}function ie(){var a;!P.value||!((a=r.value)!=null&&a.srcObject)||r.value.readyState<2||r.value.videoWidth===0||r.value.videoHeight===0||Date.now()-b.value<Y||C.value||(C.value=!0,P.value.detect(r.value).then(e=>{(e==null?void 0:e.length)>0&&e[0].rawValue&&(b.value=Date.now(),W(e[0].rawValue))}).catch(()=>{}).finally(()=>{C.value=!1}))}async function re(){if(i.value="",!T.value)return;const a=ee.value;try{if(a){P.value=new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","code_128","codabar"]});const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});w.value=e,r.value&&(r.value.srcObject=e,await r.value.play(),K())}else{const{BrowserMultiFormatReader:e}=await ke(async()=>{const{BrowserMultiFormatReader:s}=await import("./chunks/index-DD9CTm96.js");return{BrowserMultiFormatReader:s}},[]),m=new e,y=r.value;if(!y)throw new Error("Élément vidéo non trouvé");const q={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}},B=await m.decodeFromConstraints(q,y,(s,D)=>{D||!s||Date.now()-b.value<Y||(b.value=Date.now(),W(s.getText()))});I.value=B}}catch(e){i.value=e.message||"Impossible d'accéder à la caméra"}}function G(){if(I.value){try{I.value.stop()}catch{}I.value=null}x.value&&(clearInterval(x.value),x.value=null),w.value&&(w.value.getTracks().forEach(a=>a.stop()),w.value=null),r.value&&(r.value.srcObject=null),i.value=""}return ue(async()=>{c.value=!0,u.value="";try{const a=await fe();a.success&&a.produits&&(k.value=a.produits),a.success&&a.categories&&(p.value=a.categories||[])}catch(a){u.value=a.message||"Erreur chargement produits"}finally{c.value=!1}}),ce(()=>{G()}),(a,e)=>{var m,y,q,B;return n(),o("div",xe,[e[19]||(e[19]=de('<div class="row mb-3" data-v-395229be><div class="col-12" data-v-395229be><div class="d-flex justify-content-between align-items-center flex-wrap gap-2" data-v-395229be><h2 class="mb-0" data-v-395229be><i class="bi bi-upc-scan me-2" data-v-395229be></i>Inventaire</h2><div class="d-flex gap-2" data-v-395229be><a href="/caisse/inventaires-historique" class="btn btn-outline-secondary" data-v-395229be>Historique inventaires</a><a href="/caisse/stock-mouvements" class="btn btn-outline-secondary" data-v-395229be>Mouvements stock</a><a href="/caisse" class="btn btn-outline-primary" data-v-395229be><i class="bi bi-arrow-left me-2" data-v-395229be></i>Retour caisse </a></div></div><p class="text-muted small mb-0 mt-2" data-v-395229be> Scan caméra ou recherche produit (sans code-barres). Démarrer une session, ajouter des lignes, puis appliquer l&#39;inventaire. </p></div></div>',1)),u.value?(n(),o("div",Se,[_(v(u.value)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=s=>u.value=null),"aria-label":"Fermer"})])):S("",!0),T.value?S("",!0):(n(),o("div",Ce,[...e[6]||(e[6]=[t("i",{class:"bi bi-info-circle me-2"},null,-1),_(" Scan caméra n’est pas disponible. Utilisez la ",-1),t("strong",null,"recherche produit",-1),_(" ci-dessous (nom ou catégorie) pour ajouter des lignes à l’inventaire. ",-1)])])),t("div",Ee,[d.value?(n(),o("div",De,[t("span",Pe,"Session #"+v(d.value),1),t("button",{type:"button",class:"btn btn-outline-secondary btn-sm",onClick:H}," Nouvelle session ")])):(n(),o("button",{key:0,type:"button",class:"btn btn-primary",disabled:c.value,onClick:ae},[...e[7]||(e[7]=[t("i",{class:"bi bi-play-fill me-1"},null,-1),_("Démarrer une session d'inventaire ",-1)])],8,qe))]),t("div",je,[t("div",Le,[t("div",Ie,[e[10]||(e[10]=t("div",{class:"card-header bg-success text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-camera-video me-2"}),_("Scan code-barres")])],-1)),t("div",Ue,[t("div",Ve,[t("video",{ref_key:"videoEl",ref:r,class:"rounded border w-100",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"},playsinline:"",muted:""},null,512),i.value?(n(),o("div",Be,v(i.value),1)):S("",!0)]),t("div",Ne,[!w.value&&!I.value?(n(),o("button",{key:0,type:"button",class:"btn btn-success",disabled:!T.value||c.value,onClick:re},[...e[8]||(e[8]=[t("i",{class:"bi bi-camera-video me-1"},null,-1),_("Démarrer la caméra ",-1)])],8,Re)):(n(),o("button",{key:1,type:"button",class:"btn btn-secondary",onClick:G},[...e[9]||(e[9]=[t("i",{class:"bi bi-stop-circle me-1"},null,-1),_("Arrêter ",-1)])]))])])]),t("div",Te,[e[12]||(e[12]=t("div",{class:"card-header"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-search me-2"}),_("Recherche produit (sans code-barres)")])],-1)),t("div",Fe,[t("div",Ae,[N(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>j.value=s),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[F,j.value]])]),t("div",Me,[N(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>E.value=s),class:"form-select"},[e[11]||(e[11]=t("option",{value:null},"Toutes les catégories",-1)),(n(!0),o(A,null,M(p.value,s=>(n(),o("option",{key:s.id,value:s.id},v(s.nom),9,Oe))),128))],512),[[ve,E.value]])]),t("div",$e,[(n(!0),o(A,null,M(Q.value,s=>(n(),o("button",{key:s.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",disabled:!d.value,onClick:D=>J(s)},[t("span",null,v(s.nom),1),t("span",ze,"Stock: "+v(s.stock??0),1)],8,Qe))),128)),Q.value.length===0?(n(),o("div",We," Aucun produit ")):S("",!0)])])])]),t("div",He,[t("div",Je,[t("div",Ke,[e[13]||(e[13]=t("h5",{class:"mb-0"},[t("i",{class:"bi bi-list-ul me-2"}),_("Lignes d'inventaire")],-1)),t("span",Ge,v(f.value.length),1)]),t("div",Xe,[f.value.length===0?(n(),o("div",Ye," Scannez des codes-barres ou ajoutez des produits par recherche pour constituer les lignes. ")):(n(),o("div",Ze,[t("table",et,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Qté comptée"),t("th",{class:"text-end"},"Stock théorique"),t("th",{class:"text-end"},"Écart"),t("th",null,"Commentaire (écart)"),t("th")])],-1)),t("tbody",null,[(n(!0),o(A,null,M(f.value,s=>(n(),o("tr",{key:s.product_id},[t("td",null,v(s.product_nom),1),t("td",tt,v(s.quantite_comptee),1),t("td",at,v(s.stock_theorique),1),t("td",{class:me(["text-end",s.ecart>0?"text-success":s.ecart<0?"text-danger":""])},v(s.ecart>0?"+":"")+v(s.ecart),3),t("td",null,[s.ecart!==0&&d.value?N((n(),o("input",{key:0,"onUpdate:modelValue":D=>s.comment=D,type:"text",class:"form-control form-control-sm",placeholder:"Explication de l'écart...",onBlur:D=>oe(s)},null,40,st)),[[F,s.comment]]):s.ecart!==0&&s.comment?(n(),o("span",nt,v(s.comment),1)):(n(),o("span",ot,"—"))]),t("td",null,[d.value?(n(),o("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm","aria-label":"Retirer",onClick:D=>ne(s.product_id)},[...e[14]||(e[14]=[t("i",{class:"bi bi-trash"},null,-1)])],8,lt)):S("",!0)])]))),128))])])])),f.value.length>0&&d.value?(n(),o("div",it,[t("button",{type:"button",class:"btn btn-success",disabled:g.value,onClick:le},[...e[16]||(e[16]=[t("i",{class:"bi bi-check-lg me-1"},null,-1),_("Appliquer l'inventaire (mettre à jour les stocks) ",-1)])],8,rt)])):S("",!0)])])])]),L.value?(n(),o("div",ut,[t("div",ct,[t("div",dt,[t("div",vt,[t("h5",mt,"Quantité comptée — "+v((m=h.value)==null?void 0:m.nom),1),t("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=s=>L.value=!1),"aria-label":"Fermer"})]),t("div",bt,[t("p",pt,[e[17]||(e[17]=_(" Unité : ",-1)),t("strong",null,v(((y=h.value)==null?void 0:y.unite)||"pièce"),1)]),e[18]||(e[18]=t("label",{class:"form-label"},"Quantité comptée",-1)),N(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>V.value=s),type:"number",min:"0",step:"0.001",class:"form-control"},null,512),[[F,V.value,void 0,{number:!0}]]),t("p",ft,"Stock théorique actuel : "+v(((q=h.value)==null?void 0:q.stock)??0)+" "+v(((B=h.value)==null?void 0:B.unite)||"pièce"),1)]),t("div",ht,[t("button",{type:"button",class:"btn btn-secondary",onClick:e[5]||(e[5]=s=>L.value=!1)},"Annuler"),t("button",{type:"button",class:"btn btn-primary",onClick:se},"Ajouter")])])])])):S("",!0)])}}},gt=ge(_t,[["__scopeId","data-v-395229be"]]),Z=be(gt);Z.use(pe());Z.mount("#inventaire-app");
