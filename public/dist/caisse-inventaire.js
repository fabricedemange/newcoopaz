import{i as ve,x as me,o as l,c as o,f as fe,b as g,t as v,a as t,d as D,e as j,A as Z,v as Q,q as pe,F as M,k as $,n as be,r as n,g as ee,h as he}from"./chunks/runtime-dom.esm-bundler-C8CGTSXe.js";import{c as _e}from"./chunks/pinia-DIU_KYYh.js";import{J as ge,K as ye,L as F,M as ke}from"./chunks/index-zlPV8JO4.js";import{_ as we}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const xe="modulepreload",Se=function(T){return"/dist/"+T},te={},Ce=function(r,w,I){let S=Promise.resolve();if(w&&w.length>0){let p=function(c){return Promise.all(c.map(y=>Promise.resolve(y).then(x=>({status:"fulfilled",value:x}),x=>({status:"rejected",reason:x}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),u=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));S=p(w.map(c=>{if(c=Se(c),c in te)return;te[c]=!0;const y=c.endsWith(".css"),x=y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${x}`))return;const b=document.createElement("link");if(b.rel=y?"stylesheet":xe,y||(b.as="script"),b.crossOrigin="",b.href=c,u&&b.setAttribute("nonce",u),document.head.appendChild(b),y)return new Promise((R,P)=>{b.addEventListener("load",R),b.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${c}`)))})}))}function L(p){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=p,window.dispatchEvent(i),!i.defaultPrevented)throw p}return S.then(p=>{for(const i of p||[])i.status==="rejected"&&L(i.reason);return r().catch(L)})},qe={class:"container-fluid px-3 mt-4"},Ee={key:0,class:"alert alert-danger alert-dismissible show"},De={key:1,class:"alert alert-info"},Le={class:"mb-3"},Pe=["disabled"],je={key:1,class:"d-flex align-items-center gap-2"},Ie={class:"badge bg-success"},Re={class:"row"},Ue={class:"col-lg-5 mb-4"},Ve={class:"card mb-3"},Ne={class:"card-body"},Ae={class:"mb-3 position-relative",style:{"min-height":"200px"}},Be={key:0,class:"alert alert-warning mt-2 mb-0"},Te={class:"d-flex gap-2"},Oe=["disabled"],Qe={class:"card"},Me={class:"card-body"},$e={class:"mb-2"},Fe={class:"mb-2"},ze=["value"],He={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},We=["disabled","onClick"],Je={class:"badge bg-secondary"},Ke={key:0,class:"list-group-item text-muted text-center"},Ge={class:"col-lg-7 mb-4"},Xe={class:"card"},Ye={class:"card-header d-flex justify-content-between align-items-center"},Ze={class:"badge bg-primary"},et={class:"card-body p-0"},tt={key:0,class:"p-4 text-center text-muted"},at={key:1,class:"table-responsive"},st={class:"table table-hover mb-0"},nt={class:"text-end"},lt={class:"text-end"},ot=["onUpdate:modelValue","onBlur"],it={key:1,class:"small text-muted"},rt={key:2,class:"text-muted"},ut=["onClick"],ct={key:2,class:"p-3 border-top"},dt=["disabled"],vt={key:2,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},mt={class:"modal-dialog"},ft={class:"modal-content"},pt={class:"modal-header"},bt={class:"modal-title"},ht={class:"modal-body"},_t={class:"small text-muted mb-2"},gt={class:"small text-muted mt-2 mb-0"},yt={class:"modal-footer"},ae=1500,kt={__name:"CaisseInventairePage",setup(T){const r=n(null),w=n(null),I=n(null),S=n(null),L=n(!1),p=n(0),i=n(""),u=n(""),c=n(!1),y=n(!1),x=n([]),b=n([]),R=n(""),P=n(null),d=n(null),h=n([]),V=n([]),U=n(!1),_=n(null),N=n(0),C=n(!1),z=n(null),q=n(null),A=n(null),O=ee(()=>typeof window>"u"?!1:typeof window.BarcodeDetector=="function"?!0:!!(navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia=="function")),H=ee(()=>{let a=[...x.value];const e=(R.value||"").toLowerCase();return e&&(a=a.filter(m=>(m.nom||"").toLowerCase().includes(e))),P.value!=null&&(a=a.filter(m=>m.category_id===P.value)),a.slice(0,50)});function W(a){return String(a||"").trim().replace(/\s/g,"")}function ne(a){const e=W(a);return x.value.find(m=>m.code_ean&&W(m.code_ean)===e)}function J(a){const e=ne(a);if(!e){V.value.unshift({code:a,productName:null,product_id:null,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})});return}V.value.unshift({code:a,productName:e.nom,product_id:e.id,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),d.value&&G(e)}async function le(){u.value="",c.value=!0;try{const a=await ye();a.success&&a.inventaire&&(d.value=a.inventaire.id,h.value=[],V.value=[])}catch(a){u.value=a.message||"Erreur création session"}finally{c.value=!1}}function K(){d.value=null,h.value=[],V.value=[]}function G(a){_.value=a,N.value=Number(a.stock)??0,U.value=!0}async function oe(){if(!_.value||!d.value)return;const a=Number(N.value);if(!(a<0)){u.value="";try{await F(d.value,_.value.id,a);const e=Number(_.value.stock)||0,m=a-e,k=h.value.find(f=>f.product_id===_.value.id);k?(k.quantite_comptee=a,k.stock_theorique=e,k.ecart=m):h.value.push({product_id:_.value.id,product_nom:_.value.nom,quantite_comptee:a,stock_theorique:e,ecart:m,comment:""}),U.value=!1}catch(e){u.value=e.message||"Erreur ajout ligne"}}}function ie(a){h.value=h.value.filter(e=>e.product_id!==a),d.value&&F(d.value,a,0).catch(()=>{})}async function re(a){if(!(!d.value||a.ecart===0)){u.value="";try{await F(d.value,a.product_id,a.quantite_comptee,a.comment||null)}catch(e){u.value=e.message||"Erreur sauvegarde commentaire"}}}async function ue(){if(!(!d.value||h.value.length===0)){u.value="",y.value=!0;try{await ke(d.value),K(),u.value=null,typeof window<"u"&&window.alert("Inventaire appliqué. Les stocks ont été mis à jour.")}catch(a){u.value=a.message||"Erreur lors de l'application"}finally{y.value=!1}}}function X(){var a;if(!(!I.value||!((a=r.value)!=null&&a.srcObject)||r.value.readyState<2)){if(r.value.videoWidth===0||r.value.videoHeight===0){setTimeout(X,100);return}S.value=setInterval(ce,350)}}function ce(){var a;!I.value||!((a=r.value)!=null&&a.srcObject)||r.value.readyState<2||r.value.videoWidth===0||r.value.videoHeight===0||Date.now()-p.value<ae||L.value||(L.value=!0,I.value.detect(r.value).then(e=>{(e==null?void 0:e.length)>0&&e[0].rawValue&&(p.value=Date.now(),J(e[0].rawValue))}).catch(()=>{}).finally(()=>{L.value=!1}))}async function de(){if(i.value="",!O.value)return;const a=typeof window<"u"&&typeof window.BarcodeDetector=="function";try{if(a){I.value=new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","code_128","codabar"]});const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});w.value=e,C.value=!1,r.value&&(r.value.srcObject=e,await r.value.play(),X())}else{const e=(await Ce(async()=>{const{default:f}=await import("./chunks/quagga.min-Dxww2GuE.js").then(E=>E.q);return{default:f}},[])).default;q.value=e;const m=z.value;if(!m)throw new Error("Conteneur caméra non trouvé");const k=f=>{var E;(E=f==null?void 0:f.codeResult)!=null&&E.code&&(Date.now()-p.value<ae||(p.value=Date.now(),J(f.codeResult.code)))};A.value=k,e.onDetected(k),e.init({inputStream:{name:"Live",type:"LiveStream",target:m,constraints:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}},decoder:{readers:["ean_reader","ean_8_reader","code_128_reader","codabar_reader","upc_reader"]},locator:{patchSize:"medium",halfSample:!0}},f=>{if(f){i.value=f.message||"Impossible d'accéder à la caméra",q.value=null,A.value=null;return}C.value=!0,e.start()})}}catch(e){i.value=e.message||"Impossible d'accéder à la caméra",q.value=null,C.value=!1}}function Y(){if(q.value){try{q.value.offDetected(A.value),q.value.stop()}catch{}q.value=null,A.value=null,C.value=!1}S.value&&(clearInterval(S.value),S.value=null),w.value&&(w.value.getTracks().forEach(a=>a.stop()),w.value=null),r.value&&(r.value.srcObject=null),i.value=""}return ve(async()=>{c.value=!0,u.value="";try{const a=await ge();a.success&&a.produits&&(x.value=a.produits),a.success&&a.categories&&(b.value=a.categories||[])}catch(a){u.value=a.message||"Erreur chargement produits"}finally{c.value=!1}}),me(()=>{Y()}),(a,e)=>{var m,k,f,E;return l(),o("div",qe,[e[19]||(e[19]=fe('<div class="row mb-3" data-v-66c62df6><div class="col-12" data-v-66c62df6><div class="d-flex justify-content-between align-items-center flex-wrap gap-2" data-v-66c62df6><h2 class="mb-0" data-v-66c62df6><i class="bi bi-upc-scan me-2" data-v-66c62df6></i>Inventaire</h2><div class="d-flex gap-2" data-v-66c62df6><a href="/caisse/inventaires-historique" class="btn btn-outline-secondary" data-v-66c62df6>Historique inventaires</a><a href="/caisse/stock-mouvements" class="btn btn-outline-secondary" data-v-66c62df6>Mouvements stock</a><a href="/caisse" class="btn btn-outline-primary" data-v-66c62df6><i class="bi bi-arrow-left me-2" data-v-66c62df6></i>Retour caisse </a></div></div><p class="text-muted small mb-0 mt-2" data-v-66c62df6> Scan caméra ou recherche produit (sans code-barres). Démarrer une session, ajouter des lignes, puis appliquer l&#39;inventaire. </p></div></div>',1)),u.value?(l(),o("div",Ee,[g(v(u.value)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=s=>u.value=null),"aria-label":"Fermer"})])):D("",!0),O.value?D("",!0):(l(),o("div",De,[...e[6]||(e[6]=[t("i",{class:"bi bi-info-circle me-2"},null,-1),g(" Scan caméra n’est pas disponible. Utilisez la ",-1),t("strong",null,"recherche produit",-1),g(" ci-dessous (nom ou catégorie) pour ajouter des lignes à l’inventaire. ",-1)])])),t("div",Le,[d.value?(l(),o("div",je,[t("span",Ie,"Session #"+v(d.value),1),t("button",{type:"button",class:"btn btn-outline-secondary btn-sm",onClick:K}," Nouvelle session ")])):(l(),o("button",{key:0,type:"button",class:"btn btn-primary",disabled:c.value,onClick:le},[...e[7]||(e[7]=[t("i",{class:"bi bi-play-fill me-1"},null,-1),g("Démarrer une session d'inventaire ",-1)])],8,Pe))]),t("div",Re,[t("div",Ue,[t("div",Ve,[e[10]||(e[10]=t("div",{class:"card-header bg-success text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-camera-video me-2"}),g("Scan code-barres")])],-1)),t("div",Ne,[t("div",Ae,[j(t("video",{ref_key:"videoEl",ref:r,class:"rounded border w-100",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"},playsinline:"",muted:""},null,512),[[Z,!C.value]]),j(t("div",{ref_key:"quaggaContainerRef",ref:z,class:"rounded border overflow-hidden",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"}},null,512),[[Z,C.value]]),i.value?(l(),o("div",Be,v(i.value),1)):D("",!0)]),t("div",Te,[!w.value&&!C.value?(l(),o("button",{key:0,type:"button",class:"btn btn-success",disabled:!O.value||c.value,onClick:de},[...e[8]||(e[8]=[t("i",{class:"bi bi-camera-video me-1"},null,-1),g("Démarrer la caméra ",-1)])],8,Oe)):(l(),o("button",{key:1,type:"button",class:"btn btn-secondary",onClick:Y},[...e[9]||(e[9]=[t("i",{class:"bi bi-stop-circle me-1"},null,-1),g("Arrêter ",-1)])]))])])]),t("div",Qe,[e[12]||(e[12]=t("div",{class:"card-header"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-search me-2"}),g("Recherche produit (sans code-barres)")])],-1)),t("div",Me,[t("div",$e,[j(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>R.value=s),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[Q,R.value]])]),t("div",Fe,[j(t("select",{"onUpdate:modelValue":e[2]||(e[2]=s=>P.value=s),class:"form-select"},[e[11]||(e[11]=t("option",{value:null},"Toutes les catégories",-1)),(l(!0),o(M,null,$(b.value,s=>(l(),o("option",{key:s.id,value:s.id},v(s.nom),9,ze))),128))],512),[[pe,P.value]])]),t("div",He,[(l(!0),o(M,null,$(H.value,s=>(l(),o("button",{key:s.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",disabled:!d.value,onClick:B=>G(s)},[t("span",null,v(s.nom),1),t("span",Je,"Stock: "+v(s.stock??0),1)],8,We))),128)),H.value.length===0?(l(),o("div",Ke," Aucun produit ")):D("",!0)])])])]),t("div",Ge,[t("div",Xe,[t("div",Ye,[e[13]||(e[13]=t("h5",{class:"mb-0"},[t("i",{class:"bi bi-list-ul me-2"}),g("Lignes d'inventaire")],-1)),t("span",Ze,v(h.value.length),1)]),t("div",et,[h.value.length===0?(l(),o("div",tt," Scannez des codes-barres ou ajoutez des produits par recherche pour constituer les lignes. ")):(l(),o("div",at,[t("table",st,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Qté comptée"),t("th",{class:"text-end"},"Stock théorique"),t("th",{class:"text-end"},"Écart"),t("th",null,"Commentaire (écart)"),t("th")])],-1)),t("tbody",null,[(l(!0),o(M,null,$(h.value,s=>(l(),o("tr",{key:s.product_id},[t("td",null,v(s.product_nom),1),t("td",nt,v(s.quantite_comptee),1),t("td",lt,v(s.stock_theorique),1),t("td",{class:be(["text-end",s.ecart>0?"text-success":s.ecart<0?"text-danger":""])},v(s.ecart>0?"+":"")+v(s.ecart),3),t("td",null,[s.ecart!==0&&d.value?j((l(),o("input",{key:0,"onUpdate:modelValue":B=>s.comment=B,type:"text",class:"form-control form-control-sm",placeholder:"Explication de l'écart...",onBlur:B=>re(s)},null,40,ot)),[[Q,s.comment]]):s.ecart!==0&&s.comment?(l(),o("span",it,v(s.comment),1)):(l(),o("span",rt,"—"))]),t("td",null,[d.value?(l(),o("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm","aria-label":"Retirer",onClick:B=>ie(s.product_id)},[...e[14]||(e[14]=[t("i",{class:"bi bi-trash"},null,-1)])],8,ut)):D("",!0)])]))),128))])])])),h.value.length>0&&d.value?(l(),o("div",ct,[t("button",{type:"button",class:"btn btn-success",disabled:y.value,onClick:ue},[...e[16]||(e[16]=[t("i",{class:"bi bi-check-lg me-1"},null,-1),g("Appliquer l'inventaire (mettre à jour les stocks) ",-1)])],8,dt)])):D("",!0)])])])]),U.value?(l(),o("div",vt,[t("div",mt,[t("div",ft,[t("div",pt,[t("h5",bt,"Quantité comptée — "+v((m=_.value)==null?void 0:m.nom),1),t("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=s=>U.value=!1),"aria-label":"Fermer"})]),t("div",ht,[t("p",_t,[e[17]||(e[17]=g(" Unité : ",-1)),t("strong",null,v(((k=_.value)==null?void 0:k.unite)||"pièce"),1)]),e[18]||(e[18]=t("label",{class:"form-label"},"Quantité comptée",-1)),j(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>N.value=s),type:"number",min:"0",step:"0.001",class:"form-control"},null,512),[[Q,N.value,void 0,{number:!0}]]),t("p",gt,"Stock théorique actuel : "+v(((f=_.value)==null?void 0:f.stock)??0)+" "+v(((E=_.value)==null?void 0:E.unite)||"pièce"),1)]),t("div",yt,[t("button",{type:"button",class:"btn btn-secondary",onClick:e[5]||(e[5]=s=>U.value=!1)},"Annuler"),t("button",{type:"button",class:"btn btn-primary",onClick:oe},"Ajouter")])])])])):D("",!0)])}}},wt=we(kt,[["__scopeId","data-v-66c62df6"]]),se=he(wt);se.use(_e());se.mount("#inventaire-app");
