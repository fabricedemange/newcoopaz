import{i as ne,x as le,o as n,c as l,f as oe,b,t as r,a as e,d as f,e as E,v as B,q as ie,F as P,k as T,n as re,r as o,g as W,h as ue}from"./chunks/runtime-dom.esm-bundler-CPobOing.js";import{c as ce}from"./chunks/pinia-8wUEIqj_.js";import{I as de,J as ve,K as U,L as me}from"./chunks/index-BwM03k9W.js";import{_ as be}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"container-fluid px-3 mt-4"},fe={key:0,class:"alert alert-danger alert-dismissible show"},_e={key:1,class:"alert alert-warning"},he={class:"mb-3"},ye=["disabled"],ge={key:1,class:"d-flex align-items-center gap-2"},ke={class:"badge bg-success"},we={class:"row"},xe={class:"col-lg-5 mb-4"},Ce={class:"card mb-3"},Se={class:"card-body"},qe={class:"mb-3"},De={key:0,class:"alert alert-warning mt-2 mb-0"},Ee={class:"d-flex gap-2"},Ie=["disabled"],je={class:"card"},Le={class:"card-body"},Ne={class:"mb-2"},Ve={class:"mb-2"},Be=["value"],Pe={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},Te=["disabled","onClick"],Ue={class:"badge bg-secondary"},Fe={key:0,class:"list-group-item text-muted text-center"},Me={class:"col-lg-7 mb-4"},Qe={class:"card"},Ae={class:"card-header d-flex justify-content-between align-items-center"},Oe={class:"badge bg-primary"},Re={class:"card-body p-0"},$e={key:0,class:"p-4 text-center text-muted"},ze={key:1,class:"table-responsive"},He={class:"table table-hover mb-0"},We={class:"text-end"},Je={class:"text-end"},Ke=["onUpdate:modelValue","onBlur"],Ge={key:1,class:"small text-muted"},Xe={key:2,class:"text-muted"},Ye=["onClick"],Ze={key:2,class:"p-3 border-top"},et=["disabled"],tt={key:2,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},at={class:"modal-dialog"},st={class:"modal-content"},nt={class:"modal-header"},lt={class:"modal-title"},ot={class:"modal-body"},it={class:"small text-muted mb-2"},rt={class:"small text-muted mt-2 mb-0"},ut={class:"modal-footer"},ct=1500,dt={__name:"CaisseInventairePage",setup(mt){const u=o(null),h=o(null),y=o(null),w=o(null),I=o(!1),F=o(0),g=o(""),c=o(""),_=o(!1),j=o(!1),L=o([]),M=o([]),N=o(""),x=o(null),i=o(null),v=o([]),C=o([]),k=o(!1),m=o(null),S=o(0),V=W(()=>typeof window<"u"&&typeof window.BarcodeDetector=="function"),Q=W(()=>{let a=[...L.value];const t=(N.value||"").toLowerCase();return t&&(a=a.filter(d=>(d.nom||"").toLowerCase().includes(t))),x.value!=null&&(a=a.filter(d=>d.category_id===x.value)),a.slice(0,50)});function A(a){return String(a||"").trim().replace(/\s/g,"")}function K(a){const t=A(a);return L.value.find(d=>d.code_ean&&A(d.code_ean)===t)}function G(a){const t=K(a);if(!t){C.value.unshift({code:a,productName:null,product_id:null,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})});return}C.value.unshift({code:a,productName:t.nom,product_id:t.id,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),i.value&&R(t)}async function X(){c.value="",_.value=!0;try{const a=await ve();a.success&&a.inventaire&&(i.value=a.inventaire.id,v.value=[],C.value=[])}catch(a){c.value=a.message||"Erreur création session"}finally{_.value=!1}}function O(){i.value=null,v.value=[],C.value=[]}function R(a){m.value=a,S.value=Number(a.stock)??0,k.value=!0}async function Y(){if(!m.value||!i.value)return;const a=Number(S.value);if(!(a<0)){c.value="";try{await U(i.value,m.value.id,a);const t=Number(m.value.stock)||0,d=a-t,p=v.value.find(q=>q.product_id===m.value.id);p?(p.quantite_comptee=a,p.stock_theorique=t,p.ecart=d):v.value.push({product_id:m.value.id,product_nom:m.value.nom,quantite_comptee:a,stock_theorique:t,ecart:d,comment:""}),k.value=!1}catch(t){c.value=t.message||"Erreur ajout ligne"}}}function Z(a){v.value=v.value.filter(t=>t.product_id!==a),i.value&&U(i.value,a,0).catch(()=>{})}async function ee(a){if(!(!i.value||a.ecart===0)){c.value="";try{await U(i.value,a.product_id,a.quantite_comptee,a.comment||null)}catch(t){c.value=t.message||"Erreur sauvegarde commentaire"}}}async function te(){if(!(!i.value||v.value.length===0)){c.value="",j.value=!0;try{await me(i.value),O(),c.value=null,typeof window<"u"&&window.alert("Inventaire appliqué. Les stocks ont été mis à jour.")}catch(a){c.value=a.message||"Erreur lors de l'application"}finally{j.value=!1}}}function $(){var a;if(!(!y.value||!((a=u.value)!=null&&a.srcObject)||u.value.readyState<2)){if(u.value.videoWidth===0||u.value.videoHeight===0){setTimeout($,100);return}w.value=setInterval(ae,350)}}function ae(){var a;!y.value||!((a=u.value)!=null&&a.srcObject)||u.value.readyState<2||u.value.videoWidth===0||u.value.videoHeight===0||Date.now()-F.value<ct||I.value||(I.value=!0,y.value.detect(u.value).then(t=>{(t==null?void 0:t.length)>0&&t[0].rawValue&&(F.value=Date.now(),G(t[0].rawValue))}).catch(()=>{}).finally(()=>{I.value=!1}))}async function se(){if(g.value="",!!V.value)try{if(y.value=typeof window.BarcodeDetector<"u"?new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","code_128","codabar"]}):null,!y.value)throw new Error("BarcodeDetector non disponible");const a=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});h.value=a,u.value&&(u.value.srcObject=a,await u.value.play(),$())}catch(a){g.value=a.message||"Impossible d'accéder à la caméra"}}function z(){w.value&&(clearInterval(w.value),w.value=null),h.value&&(h.value.getTracks().forEach(a=>a.stop()),h.value=null),u.value&&(u.value.srcObject=null),g.value=""}return ne(async()=>{_.value=!0,c.value="";try{const a=await de();a.success&&a.produits&&(L.value=a.produits),a.success&&a.categories&&(M.value=a.categories||[])}catch(a){c.value=a.message||"Erreur chargement produits"}finally{_.value=!1}}),le(()=>{z()}),(a,t)=>{var d,p,q,H;return n(),l("div",pe,[t[19]||(t[19]=oe('<div class="row mb-3" data-v-04026586><div class="col-12" data-v-04026586><div class="d-flex justify-content-between align-items-center flex-wrap gap-2" data-v-04026586><h2 class="mb-0" data-v-04026586><i class="bi bi-upc-scan me-2" data-v-04026586></i>Inventaire</h2><div class="d-flex gap-2" data-v-04026586><a href="/caisse/inventaires-historique" class="btn btn-outline-secondary" data-v-04026586>Historique inventaires</a><a href="/caisse/stock-mouvements" class="btn btn-outline-secondary" data-v-04026586>Mouvements stock</a><a href="/caisse" class="btn btn-outline-primary" data-v-04026586><i class="bi bi-arrow-left me-2" data-v-04026586></i>Retour caisse </a></div></div><p class="text-muted small mb-0 mt-2" data-v-04026586> Scan caméra ou recherche produit (sans code-barres). Démarrer une session, ajouter des lignes, puis appliquer l&#39;inventaire. </p></div></div>',1)),c.value?(n(),l("div",fe,[b(r(c.value)+" ",1),e("button",{type:"button",class:"btn-close",onClick:t[0]||(t[0]=s=>c.value=null),"aria-label":"Fermer"})])):f("",!0),V.value?f("",!0):(n(),l("div",_e,[...t[6]||(t[6]=[e("i",{class:"bi bi-exclamation-triangle me-2"},null,-1),b(" Scan caméra non supporté (Chrome/Edge). Utilisez la recherche produit ci-dessous. ",-1)])])),e("div",he,[i.value?(n(),l("div",ge,[e("span",ke,"Session #"+r(i.value),1),e("button",{type:"button",class:"btn btn-outline-secondary btn-sm",onClick:O}," Nouvelle session ")])):(n(),l("button",{key:0,type:"button",class:"btn btn-primary",disabled:_.value,onClick:X},[...t[7]||(t[7]=[e("i",{class:"bi bi-play-fill me-1"},null,-1),b("Démarrer une session d'inventaire ",-1)])],8,ye))]),e("div",we,[e("div",xe,[e("div",Ce,[t[10]||(t[10]=e("div",{class:"card-header bg-success text-white"},[e("h5",{class:"mb-0"},[e("i",{class:"bi bi-camera-video me-2"}),b("Scan code-barres")])],-1)),e("div",Se,[e("div",qe,[e("video",{ref_key:"videoEl",ref:u,class:"rounded border w-100",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"},playsinline:"",muted:""},null,512),g.value?(n(),l("div",De,r(g.value),1)):f("",!0)]),e("div",Ee,[h.value?(n(),l("button",{key:1,type:"button",class:"btn btn-secondary",onClick:z},[...t[9]||(t[9]=[e("i",{class:"bi bi-stop-circle me-1"},null,-1),b("Arrêter ",-1)])])):(n(),l("button",{key:0,type:"button",class:"btn btn-success",disabled:!V.value||_.value,onClick:se},[...t[8]||(t[8]=[e("i",{class:"bi bi-camera-video me-1"},null,-1),b("Démarrer la caméra ",-1)])],8,Ie))])])]),e("div",je,[t[12]||(t[12]=e("div",{class:"card-header"},[e("h5",{class:"mb-0"},[e("i",{class:"bi bi-search me-2"}),b("Recherche produit (sans code-barres)")])],-1)),e("div",Le,[e("div",Ne,[E(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>N.value=s),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[B,N.value]])]),e("div",Ve,[E(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>x.value=s),class:"form-select"},[t[11]||(t[11]=e("option",{value:null},"Toutes les catégories",-1)),(n(!0),l(P,null,T(M.value,s=>(n(),l("option",{key:s.id,value:s.id},r(s.nom),9,Be))),128))],512),[[ie,x.value]])]),e("div",Pe,[(n(!0),l(P,null,T(Q.value,s=>(n(),l("button",{key:s.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",disabled:!i.value,onClick:D=>R(s)},[e("span",null,r(s.nom),1),e("span",Ue,"Stock: "+r(s.stock??0),1)],8,Te))),128)),Q.value.length===0?(n(),l("div",Fe," Aucun produit ")):f("",!0)])])])]),e("div",Me,[e("div",Qe,[e("div",Ae,[t[13]||(t[13]=e("h5",{class:"mb-0"},[e("i",{class:"bi bi-list-ul me-2"}),b("Lignes d'inventaire")],-1)),e("span",Oe,r(v.value.length),1)]),e("div",Re,[v.value.length===0?(n(),l("div",$e," Scannez des codes-barres ou ajoutez des produits par recherche pour constituer les lignes. ")):(n(),l("div",ze,[e("table",He,[t[15]||(t[15]=e("thead",null,[e("tr",null,[e("th",null,"Produit"),e("th",{class:"text-end"},"Qté comptée"),e("th",{class:"text-end"},"Stock théorique"),e("th",{class:"text-end"},"Écart"),e("th",null,"Commentaire (écart)"),e("th")])],-1)),e("tbody",null,[(n(!0),l(P,null,T(v.value,s=>(n(),l("tr",{key:s.product_id},[e("td",null,r(s.product_nom),1),e("td",We,r(s.quantite_comptee),1),e("td",Je,r(s.stock_theorique),1),e("td",{class:re(["text-end",s.ecart>0?"text-success":s.ecart<0?"text-danger":""])},r(s.ecart>0?"+":"")+r(s.ecart),3),e("td",null,[s.ecart!==0&&i.value?E((n(),l("input",{key:0,"onUpdate:modelValue":D=>s.comment=D,type:"text",class:"form-control form-control-sm",placeholder:"Explication de l'écart...",onBlur:D=>ee(s)},null,40,Ke)),[[B,s.comment]]):s.ecart!==0&&s.comment?(n(),l("span",Ge,r(s.comment),1)):(n(),l("span",Xe,"—"))]),e("td",null,[i.value?(n(),l("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm","aria-label":"Retirer",onClick:D=>Z(s.product_id)},[...t[14]||(t[14]=[e("i",{class:"bi bi-trash"},null,-1)])],8,Ye)):f("",!0)])]))),128))])])])),v.value.length>0&&i.value?(n(),l("div",Ze,[e("button",{type:"button",class:"btn btn-success",disabled:j.value,onClick:te},[...t[16]||(t[16]=[e("i",{class:"bi bi-check-lg me-1"},null,-1),b("Appliquer l'inventaire (mettre à jour les stocks) ",-1)])],8,et)])):f("",!0)])])])]),k.value?(n(),l("div",tt,[e("div",at,[e("div",st,[e("div",nt,[e("h5",lt,"Quantité comptée — "+r((d=m.value)==null?void 0:d.nom),1),e("button",{type:"button",class:"btn-close",onClick:t[3]||(t[3]=s=>k.value=!1),"aria-label":"Fermer"})]),e("div",ot,[e("p",it,[t[17]||(t[17]=b(" Unité : ",-1)),e("strong",null,r(((p=m.value)==null?void 0:p.unite)||"pièce"),1)]),t[18]||(t[18]=e("label",{class:"form-label"},"Quantité comptée",-1)),E(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>S.value=s),type:"number",min:"0",step:"0.001",class:"form-control"},null,512),[[B,S.value,void 0,{number:!0}]]),e("p",rt,"Stock théorique actuel : "+r(((q=m.value)==null?void 0:q.stock)??0)+" "+r(((H=m.value)==null?void 0:H.unite)||"pièce"),1)]),e("div",ut,[e("button",{type:"button",class:"btn btn-secondary",onClick:t[5]||(t[5]=s=>k.value=!1)},"Annuler"),e("button",{type:"button",class:"btn btn-primary",onClick:Y},"Ajouter")])])])])):f("",!0)])}}},vt=be(dt,[["__scopeId","data-v-04026586"]]),J=ue(vt);J.use(ce());J.mount("#inventaire-app");
