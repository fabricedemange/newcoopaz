import{i as Je,y as Ye,o as m,c as f,a as n,b as C,j as Ge,d as j,t as _,F as Y,l as G,u as Xe,e as U,v as X,s as Ze,n as qe,p as et,w as tt,r as g,g as ae,h as nt}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as at}from"./chunks/pinia-gLxYYWQL.js";import{_ as ot}from"./chunks/BackButton-DzFd1NqY.js";import{L as st,M as ve,N as me,O as Le,P as fe,Q as Ne,R as it,S as rt,T as lt}from"./chunks/index-CY5spq3H.js";import{_ as ct}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const ut="modulepreload",dt=function(r){return"/dist/"+r},Oe={},vt=function(o,l,s){let i=Promise.resolve();if(l&&l.length>0){let w=function(k){return Promise.all(k.map(D=>Promise.resolve(D).then(b=>({status:"fulfilled",value:b}),b=>({status:"rejected",reason:b}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),y=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));i=w(l.map(k=>{if(k=dt(k),k in Oe)return;Oe[k]=!0;const D=k.endsWith(".css"),b=D?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${k}"]${b}`))return;const E=document.createElement("link");if(E.rel=D?"stylesheet":ut,D||(E.as="script"),E.crossOrigin="",E.href=k,y&&E.setAttribute("nonce",y),document.head.appendChild(E),D)return new Promise((V,M)=>{E.addEventListener("load",V),E.addEventListener("error",()=>M(new Error(`Unable to preload CSS for ${k}`)))})}))}function p(w){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=w,window.dispatchEvent(d),!d.defaultPrevented)throw w}return i.then(w=>{for(const d of w||[])d.status==="rejected"&&p(d.reason);return o().catch(p)})},mt="coopaz-inventaire-offline",ft=3,A="produits",Q="categories",re="meta",P="inventaire_draft",T="sync_queue",pt="cache",le="current";function I(){return new Promise((r,o)=>{if(typeof indexedDB>"u"){o(new Error("IndexedDB non disponible"));return}const l=indexedDB.open(mt,ft);l.onerror=()=>o(l.error),l.onsuccess=()=>r(l.result),l.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(A)||i.createObjectStore(A,{keyPath:"id"}),i.objectStoreNames.contains(Q)||i.createObjectStore(Q,{keyPath:"id"}),i.objectStoreNames.contains(re)||i.createObjectStore(re),i.objectStoreNames.contains(P)||i.createObjectStore(P),i.objectStoreNames.contains(T)||i.createObjectStore(T,{keyPath:"id",autoIncrement:!0})}})}function be(r){return(r||[]).map(o=>JSON.parse(JSON.stringify(o)))}async function bt(r,o){const l=await I(),s=be(r),i=be(o);return new Promise((p,w)=>{const d=l.transaction([A,Q,re],"readwrite"),y=d.objectStore(A),k=d.objectStore(Q),D=d.objectStore(re);y.clear(),k.clear(),s.forEach(b=>y.put(b)),i.forEach(b=>k.put(b)),D.put({lastSync:Date.now()},pt),d.oncomplete=()=>{l.close(),p()},d.onerror=()=>{l.close(),w(d.error)}})}async function Re(){const r=await I();return new Promise((o,l)=>{const s=r.transaction([A,Q],"readonly"),i=s.objectStore(A).getAll(),p=s.objectStore(Q).getAll();let w=[],d=[];i.onsuccess=()=>{w=i.result||[]},p.onsuccess=()=>{d=p.result||[]},s.oncomplete=()=>{r.close(),w.length===0&&d.length===0?o(null):o({produits:w,categories:d})},s.onerror=()=>{r.close(),l(s.error)}})}function F(r){return r!=null&&String(r).startsWith("local-")}async function gt(){const r="local-"+Date.now(),o=await I();return new Promise((l,s)=>{const i=o.transaction([P],"readwrite");i.objectStore(P).put({id:r,lignes:[]},le),i.oncomplete=()=>{o.close(),l(r)},i.onerror=()=>{o.close(),s(i.error)}})}async function ge(){const r=await I();return new Promise((o,l)=>{const s=r.transaction([P],"readonly"),i=s.objectStore(P).get(le);i.onsuccess=()=>{r.close();const p=i.result;o(p&&p.id?p:null)},s.onerror=()=>{r.close(),l(s.error)}})}async function pe(r){const o=await ge();if(!o)return;const l=be(r),s=await I();return new Promise((i,p)=>{const w=s.transaction([P],"readwrite");w.objectStore(P).put({id:o.id,lignes:l},le),w.oncomplete=()=>{s.close(),i()},w.onerror=()=>{s.close(),p(w.error)}})}async function oe(){const r=await I();return new Promise((o,l)=>{const s=r.transaction([P],"readwrite");s.objectStore(P).delete(le),s.oncomplete=()=>{r.close(),o()},s.onerror=()=>{r.close(),l(s.error)}})}async function se(r,o){const l=await I();return new Promise((s,i)=>{const p=l.transaction([A],"readwrite"),w=p.objectStore(A),d=w.get(r);d.onsuccess=()=>{const y=d.result;y&&(y.code_ean=o,w.put(y)),p.oncomplete=()=>{l.close(),s()}},p.onerror=()=>{l.close(),i(p.error)}})}async function ie(r,o){const l=await I();return new Promise((s,i)=>{const p=l.transaction([T],"readwrite");p.objectStore(T).add({action:"update_code_ean",productId:r,codeEan:o||null,createdAt:Date.now()}),p.oncomplete=()=>{l.close(),s()},p.onerror=()=>{l.close(),i(p.error)}})}async function yt(){const r=await I();return new Promise((o,l)=>{const s=r.transaction([T],"readonly"),i=s.objectStore(T).getAll();i.onsuccess=()=>{r.close();const p=i.result||[];o(p.filter(w=>w.action==="update_code_ean"))},s.onerror=()=>{r.close(),l(s.error)}})}async function wt(){const r=await I();return new Promise((o,l)=>{const s=r.transaction([T],"readwrite"),i=s.objectStore(T),p=i.getAll();p.onsuccess=()=>{(p.result||[]).filter(d=>d.action==="update_code_ean").forEach(d=>i.delete(d.id)),s.oncomplete=()=>{r.close(),o()}},s.onerror=()=>{r.close(),l(s.error)}})}const ht={class:"container-fluid px-3 mt-4"},_t={class:"row mb-3"},kt={class:"col-12"},xt={class:"d-flex justify-content-between align-items-center flex-wrap gap-2"},St={class:"d-flex gap-2"},Ct={key:0,class:"alert alert-info mb-2"},Et={key:1,class:"alert alert-warning mb-2"},jt={key:0},Dt={key:1},Pt={key:2,class:"alert alert-danger alert-dismissible show"},It={key:3,class:"alert alert-info"},qt={key:4,class:"mb-3"},Lt={class:"card border-warning"},Nt={class:"card-body py-2"},Ot={class:"d-flex flex-wrap gap-2"},Rt=["onClick"],At={class:"badge bg-warning text-dark ms-1"},Tt={class:"mb-3"},Ft=["disabled"],Mt={key:1,class:"d-flex align-items-center gap-2"},Bt={class:"badge bg-success"},Ut={class:"row"},Qt={class:"col-lg-5 mb-4"},Vt={class:"card mb-3"},zt={class:"card-body"},$t={class:"mb-3"},Kt={key:0,class:"alert alert-warning mt-2 mb-0"},Wt={class:"d-flex gap-2"},Ht=["disabled"],Jt={class:"card"},Yt={class:"card-body"},Gt={class:"mb-2"},Xt={class:"mb-2"},Zt=["value"],en={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},tn=["disabled","onClick"],nn={class:"badge bg-secondary"},an={key:0,class:"list-group-item text-muted text-center"},on={class:"col-lg-7 mb-4"},sn={class:"card"},rn={class:"card-header d-flex justify-content-between align-items-center"},ln={class:"badge bg-primary"},cn={class:"card-body p-0"},un={key:0,class:"p-4 text-center text-muted"},dn={key:1,class:"table-responsive"},vn={class:"table table-hover mb-0"},mn={class:"text-end"},fn={class:"text-end"},pn=["onUpdate:modelValue","onBlur"],bn={key:1,class:"small text-muted"},gn={key:2,class:"text-muted"},yn=["onClick"],wn={key:2,class:"p-3 border-top"},hn=["disabled"],_n={key:0,class:"text-warning small mt-2 mb-0"},kn={key:5,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},xn={class:"modal-dialog"},Sn={class:"modal-content"},Cn={class:"modal-header"},En={class:"modal-title"},jn={class:"modal-body"},Dn={class:"small text-muted mb-2"},Pn={class:"small text-muted mt-2 mb-0"},In={class:"input-group"},qn=["onKeydown"],Ln={key:0,class:"text-danger small mt-1 mb-0"},Nn={class:"modal-footer"},On={key:6,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},Rn={class:"modal-dialog modal-lg"},An={class:"modal-content"},Tn={class:"modal-header"},Fn={class:"modal-title"},Mn={class:"modal-body"},Bn={class:"mb-2"},Un={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},Qn=["onClick"],Vn={class:"badge bg-secondary"},zn={key:0,class:"list-group-item text-muted text-center"},$n={key:0,class:"text-danger small mt-2 mb-0"},Ae=1500,Kn={__name:"CaisseInventairePage",setup(r){const o=g(null),l=g(null),s=g(null),i=g(null),p=g(!1),w=g(0),d=g(""),y=g(""),k=g(!1),D=g(!1),b=g([]),E=g([]),V=g(""),M=g(null),v=g(null),x=g([]),q=g([]),z=g(!1),S=g(null),Z=g(0),$=g(null),ce=g(!1),ee=g(""),K=g(""),B=g(""),te=g(""),W=g(""),L=g(!1),ne=g(!1),ue=g(!1),N=g([]),de=ae(()=>typeof window>"u"?!1:typeof window.BarcodeDetector=="function"?!0:!!(navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia=="function")),Fe=ae(()=>typeof window<"u"&&typeof window.BarcodeDetector=="function"),ye=ae(()=>{let t=[...b.value];const e=(V.value||"").toLowerCase();return e&&(t=t.filter(c=>(c.nom||"").toLowerCase().includes(e))),M.value!=null&&(t=t.filter(c=>c.category_id===M.value)),t.slice(0,50)}),we=ae(()=>{let t=[...b.value];const e=(K.value||"").toLowerCase();return e&&(t=t.filter(c=>(c.nom||"").toLowerCase().includes(e))),t.slice(0,80)});function he(t){return String(t||"").trim().replace(/\s/g,"")}function Me(t){const e=he(t);return b.value.find(c=>c.code_ean&&he(c.code_ean)===e)}function _e(t){const e=Me(t);if(!e){q.value.unshift({code:t,productName:null,product_id:null,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),ee.value=t,K.value="",B.value="",ce.value=!0;return}q.value.unshift({code:t,productName:e.nom,product_id:e.id,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),v.value&&J(e)}function H(){ce.value=!1,ee.value="",K.value="",B.value=""}function ke(t){const e=t&&t.message||"";return e.includes("fetch")||e.includes("network")||t instanceof TypeError}async function Be(t){B.value="";const e=ee.value,c=L.value||!navigator.onLine;try{if(c){await ie(t.id,e),await se(t.id,e);const u=b.value.findIndex(h=>h.id===t.id);u>=0&&(b.value[u]={...t,code_ean:e}),H(),v.value?J({...t,code_ean:e}):typeof window<"u"&&window.alert("Code-barres associé (sera synchronisé à la reconnexion).")}else try{await me(t.id,e);const u=b.value.findIndex(h=>h.id===t.id);u>=0&&(b.value[u]={...t,code_ean:e}),H(),v.value?J({...t,code_ean:e}):typeof window<"u"&&window.alert("Code-barres associé au produit « "+t.nom+" ». Vous pouvez rescanner pour l'ajouter à l'inventaire.")}catch(u){if(ke(u)){await ie(t.id,e),await se(t.id,e);const h=b.value.findIndex(O=>O.id===t.id);h>=0&&(b.value[h]={...t,code_ean:e}),H(),v.value?J({...t,code_ean:e}):typeof window<"u"&&window.alert("Code-barres associé (sera synchronisé à la reconnexion).")}else throw u}}catch(u){B.value=u.message||"Erreur lors de la mise à jour"}}async function Ue(){y.value="",k.value=!0;try{if(navigator.onLine){const t=await Le();t.success&&t.inventaire&&(v.value=t.inventaire.id,x.value=[],q.value=[])}else{const t=await gt();v.value=t,x.value=[],q.value=[]}}catch(t){y.value=t.message||"Erreur création session"}finally{k.value=!1}}async function xe(){const t=v.value&&!F(v.value);if(F(v.value)&&await oe(),v.value=null,x.value=[],q.value=[],t&&navigator.onLine)try{const e=await ve({limit:50,offset:0});N.value=(e.inventaires||[]).filter(c=>c.statut==="draft")}catch{N.value=[]}}function J(t){S.value=t,Z.value=Number(t.stock)??0,te.value=t.code_ean!=null?String(t.code_ean).trim():"",W.value="",z.value=!0}async function Se(){if(!S.value)return;W.value="";const t=(te.value||"").trim()||null,e=S.value.id,c=L.value||!navigator.onLine;try{if(c){await ie(e,t),await se(e,t);const u=b.value.findIndex(h=>h.id===e);u>=0&&(b.value[u]={...b.value[u],code_ean:t}),S.value={...S.value,code_ean:t}}else try{await me(e,t);const u=b.value.findIndex(h=>h.id===e);u>=0&&(b.value[u]={...b.value[u],code_ean:t}),S.value={...S.value,code_ean:t}}catch(u){if(ke(u)){await ie(e,t),await se(e,t);const h=b.value.findIndex(O=>O.id===e);h>=0&&(b.value[h]={...b.value[h],code_ean:t}),S.value={...S.value,code_ean:t}}else throw u}}catch(u){W.value=u.message||"Erreur lors de la mise à jour"}}async function Qe(){if(!S.value||!v.value)return;const t=Number(Z.value);if(t<0)return;y.value="";const e=Number(S.value.stock)||0,c=t-e,u=x.value.find(h=>h.product_id===S.value.id);if(u?(u.quantite_comptee=t,u.stock_theorique=e,u.ecart=c):x.value.push({product_id:S.value.id,product_nom:S.value.nom,quantite_comptee:t,stock_theorique:e,ecart:c,comment:""}),z.value=!1,F(v.value))await pe(x.value).catch(()=>{});else try{await fe(v.value,S.value.id,t)}catch(h){y.value=h.message||"Erreur ajout ligne"}}async function Ve(t){if(x.value=x.value.filter(e=>e.product_id!==t),v.value)if(F(v.value))await pe(x.value).catch(()=>{}),x.value.length===0&&(await oe(),v.value=null,q.value=[]);else try{if(await rt(v.value,t),x.value.length===0){await lt(v.value),v.value=null,q.value=[];const e=await ve({limit:50,offset:0});N.value=(e.inventaires||[]).filter(c=>c.statut==="draft")}}catch(e){y.value=e.message||"Erreur suppression ligne"}}async function ze(t){if(!(!v.value||t.ecart===0))if(y.value="",F(v.value))await pe(x.value).catch(()=>{});else try{await fe(v.value,t.product_id,t.quantite_comptee,t.comment||null)}catch(e){y.value=e.message||"Erreur sauvegarde commentaire"}}async function $e(){if(!(!v.value||x.value.length===0)&&!F(v.value)){y.value="",D.value=!0;try{await Ne(v.value),xe(),y.value=null,typeof window<"u"&&window.alert("Inventaire appliqué. Les stocks ont été mis à jour.")}catch(t){y.value=t.message||"Erreur lors de l'application"}finally{D.value=!1}}}function Ce(){var t;if(!(!s.value||!((t=o.value)!=null&&t.srcObject)||o.value.readyState<2)){if(o.value.videoWidth===0||o.value.videoHeight===0){setTimeout(Ce,100);return}i.value=setInterval(Ke,350)}}function Ke(){var t;!s.value||!((t=o.value)!=null&&t.srcObject)||o.value.readyState<2||o.value.videoWidth===0||o.value.videoHeight===0||Date.now()-w.value<Ae||p.value||(p.value=!0,s.value.detect(o.value).then(e=>{(e==null?void 0:e.length)>0&&e[0].rawValue&&(w.value=Date.now(),_e(e[0].rawValue))}).catch(()=>{}).finally(()=>{p.value=!1}))}async function We(){if(d.value="",!de.value)return;const t=Fe.value;try{if(t){s.value=new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","code_128","codabar"]});const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});l.value=e,o.value&&(o.value.srcObject=e,await o.value.play(),Ce())}else{const{BrowserMultiFormatReader:e}=await vt(async()=>{const{BrowserMultiFormatReader:a}=await import("./chunks/index-DD9CTm96.js");return{BrowserMultiFormatReader:a}},[]),c=new e,u=o.value;if(!u)throw new Error("Élément vidéo non trouvé");const h={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}},O=await c.decodeFromConstraints(h,u,(a,R)=>{R||!a||Date.now()-w.value<Ae||(w.value=Date.now(),_e(a.getText()))});$.value=O}}catch(e){d.value=e.message||"Impossible d'accéder à la caméra"}}function Ee(){if($.value){try{$.value.stop()}catch{}$.value=null}i.value&&(clearInterval(i.value),i.value=null),l.value&&(l.value.getTracks().forEach(t=>t.stop()),l.value=null),o.value&&(o.value.srcObject=null),d.value=""}async function je(){k.value=!0,y.value="",L.value=!navigator.onLine,ne.value=!1;try{if(navigator.onLine){const t=await st();t.success&&t.produits&&(b.value=t.produits),t.success&&t.categories&&(E.value=t.categories||[]),await bt(b.value,E.value)}else{const t=await Re();t?(b.value=t.produits||[],E.value=t.categories||[],ne.value=!0):y.value="Connectez-vous une première fois pour activer le mode hors ligne."}}catch(t){if(navigator.onLine)y.value=t.message||"Erreur chargement produits";else{const e=await Re();e?(b.value=e.produits||[],E.value=e.categories||[],ne.value=!0,y.value=""):y.value="Connectez-vous une première fois pour activer le mode hors ligne."}}finally{k.value=!1}if(navigator.onLine)try{const t=await ve({limit:50,offset:0});N.value=(t.inventaires||[]).filter(e=>e.statut==="draft")}catch{N.value=[]}else{const t=await ge();t&&(v.value=t.id,x.value=t.lignes||[])}}async function He(t){if(navigator.onLine){k.value=!0,y.value="";try{const e=await it(t);e.success&&e.inventaire&&e.lignes&&(v.value=e.inventaire.id,x.value=e.lignes.map(c=>({product_id:c.product_id,product_nom:c.product_nom,quantite_comptee:c.quantite_comptee,stock_theorique:c.stock_theorique,ecart:c.ecart,comment:c.comment||""})),q.value=[],N.value=N.value.filter(c=>c.id!==t))}catch(e){y.value=e.message||"Erreur reprise brouillon"}finally{k.value=!1}}}async function De(){if(navigator.onLine){ue.value=!0;try{const t=await yt();for(const c of t)try{await me(c.productId,c.codeEan)}catch(u){console.warn("Sync code EAN échoué:",u)}t.length>0&&await wt();const e=await ge();if(e&&e.lignes&&e.lignes.length>0){const c=await Le();if(c.success&&c.inventaire){const u=c.inventaire.id;for(const h of e.lignes)await fe(u,h.product_id,h.quantite_comptee,h.comment||null);await Ne(u),await oe(),v.value=null,x.value=[],q.value=[],typeof window<"u"&&window.alert("Inventaire synchronisé et appliqué. Les stocks ont été mis à jour.")}}else e&&(await oe(),v.value=null,x.value=[])}catch(t){console.warn("Sync échoué:",t)}finally{ue.value=!1}}}async function Pe(){L.value=!1,await je(),await De()}function Ie(){L.value=!0}return Je(async()=>{await je(),navigator.onLine&&await De(),window.addEventListener("online",Pe),window.addEventListener("offline",Ie)}),Ye(()=>{Ee(),window.removeEventListener("online",Pe),window.removeEventListener("offline",Ie)}),(t,e)=>{var c,u,h,O;return m(),f("div",ht,[n("div",_t,[n("div",kt,[n("div",xt,[e[11]||(e[11]=n("h2",{class:"mb-0"},[n("i",{class:"bi bi-upc-scan me-2"}),C("Inventaire")],-1)),n("div",St,[Ge(ot),e[8]||(e[8]=n("a",{href:"/caisse/inventaires-historique",class:"btn btn-outline-secondary"},"Historique inventaires",-1)),e[9]||(e[9]=n("a",{href:"/caisse/stock-mouvements",class:"btn btn-outline-secondary"},"Mouvements stock",-1)),e[10]||(e[10]=n("a",{href:"/caisse",class:"btn btn-outline-primary"},[n("i",{class:"bi bi-arrow-left me-2"}),C("Retour caisse ")],-1))])]),e[12]||(e[12]=n("p",{class:"text-muted small mb-0 mt-2"}," Scan caméra ou recherche produit (sans code-barres). Démarrer une session, ajouter des lignes, puis appliquer l'inventaire. ",-1))])]),ue.value?(m(),f("div",Ct,[...e[13]||(e[13]=[n("i",{class:"bi bi-cloud-arrow-up me-2"},null,-1),n("strong",null,"Synchronisation en cours…",-1)])])):L.value?(m(),f("div",Et,[e[14]||(e[14]=n("i",{class:"bi bi-wifi-off me-2"},null,-1)),e[15]||(e[15]=n("strong",null,"Mode hors ligne",-1)),ne.value?(m(),f("span",jt," — Données chargées depuis le cache.")):(m(),f("span",Dt," — Connectez-vous une première fois pour activer le mode hors ligne."))])):j("",!0),y.value?(m(),f("div",Pt,[C(_(y.value)+" ",1),n("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=a=>y.value=null),"aria-label":"Fermer"})])):j("",!0),de.value?j("",!0):(m(),f("div",It,[...e[16]||(e[16]=[n("i",{class:"bi bi-info-circle me-2"},null,-1),C(" Scan caméra n’est pas disponible. Utilisez la ",-1),n("strong",null,"recherche produit",-1),C(" ci-dessous (nom ou catégorie) pour ajouter des lignes à l’inventaire. ",-1)])])),!v.value&&N.value.length>0&&!k.value?(m(),f("div",qt,[n("div",Lt,[e[18]||(e[18]=n("div",{class:"card-header bg-warning bg-opacity-25"},[n("h6",{class:"mb-0"},[n("i",{class:"bi bi-file-earmark-text me-2"}),C("Brouillons en attente")])],-1)),n("div",Nt,[n("div",Ot,[(m(!0),f(Y,null,G(N.value,a=>(m(),f("button",{key:a.id,type:"button",class:"btn btn-outline-warning btn-sm",onClick:R=>He(a.id)},[e[17]||(e[17]=n("i",{class:"bi bi-arrow-repeat me-1"},null,-1)),C("Reprendre #"+_(a.id)+" ",1),n("span",At,_(a.nb_lignes??0)+" lignes",1)],8,Rt))),128))])])])])):j("",!0),n("div",Tt,[v.value?(m(),f("div",Mt,[n("span",Bt,"Session "+_(Xe(F)(v.value)?"(hors ligne)":"#"+v.value),1),n("button",{type:"button",class:"btn btn-outline-secondary btn-sm",onClick:xe}," Nouvelle session ")])):(m(),f("button",{key:0,type:"button",class:"btn btn-primary",disabled:k.value,onClick:Ue},[...e[19]||(e[19]=[n("i",{class:"bi bi-play-fill me-1"},null,-1),C("Démarrer une session d'inventaire ",-1)])],8,Ft))]),n("div",Ut,[n("div",Qt,[n("div",Vt,[e[22]||(e[22]=n("div",{class:"card-header bg-success text-white"},[n("h5",{class:"mb-0"},[n("i",{class:"bi bi-camera-video me-2"}),C("Scan code-barres")])],-1)),n("div",zt,[n("div",$t,[n("video",{ref_key:"videoEl",ref:o,class:"rounded border w-100",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"},playsinline:"",muted:""},null,512),d.value?(m(),f("div",Kt,_(d.value),1)):j("",!0)]),n("div",Wt,[!l.value&&!$.value?(m(),f("button",{key:0,type:"button",class:"btn btn-success",disabled:!de.value||k.value,onClick:We},[...e[20]||(e[20]=[n("i",{class:"bi bi-camera-video me-1"},null,-1),C("Démarrer la caméra ",-1)])],8,Ht)):(m(),f("button",{key:1,type:"button",class:"btn btn-secondary",onClick:Ee},[...e[21]||(e[21]=[n("i",{class:"bi bi-stop-circle me-1"},null,-1),C("Arrêter ",-1)])]))])])]),n("div",Jt,[e[24]||(e[24]=n("div",{class:"card-header"},[n("h5",{class:"mb-0"},[n("i",{class:"bi bi-search me-2"}),C("Recherche produit (sans code-barres)")])],-1)),n("div",Yt,[n("div",Gt,[U(n("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>V.value=a),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[X,V.value]])]),n("div",Xt,[U(n("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>M.value=a),class:"form-select"},[e[23]||(e[23]=n("option",{value:null},"Toutes les catégories",-1)),(m(!0),f(Y,null,G(E.value,a=>(m(),f("option",{key:a.id,value:a.id},_(a.nom),9,Zt))),128))],512),[[Ze,M.value]])]),n("div",en,[(m(!0),f(Y,null,G(ye.value,a=>(m(),f("button",{key:a.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",disabled:!v.value,onClick:R=>J(a)},[n("span",null,_(a.nom),1),n("span",nn,"Stock: "+_(a.stock??0),1)],8,tn))),128)),ye.value.length===0?(m(),f("div",an," Aucun produit ")):j("",!0)])])])]),n("div",on,[n("div",sn,[n("div",rn,[e[25]||(e[25]=n("h5",{class:"mb-0"},[n("i",{class:"bi bi-list-ul me-2"}),C("Lignes d'inventaire")],-1)),n("span",ln,_(x.value.length),1)]),n("div",cn,[x.value.length===0?(m(),f("div",un," Scannez des codes-barres ou ajoutez des produits par recherche pour constituer les lignes. ")):(m(),f("div",dn,[n("table",vn,[e[27]||(e[27]=n("thead",null,[n("tr",null,[n("th",null,"Produit"),n("th",{class:"text-end"},"Qté comptée"),n("th",{class:"text-end"},"Stock théorique"),n("th",{class:"text-end"},"Écart"),n("th",null,"Commentaire (écart)"),n("th")])],-1)),n("tbody",null,[(m(!0),f(Y,null,G(x.value,a=>(m(),f("tr",{key:a.product_id},[n("td",null,_(a.product_nom),1),n("td",mn,_(a.quantite_comptee),1),n("td",fn,_(a.stock_theorique),1),n("td",{class:qe(["text-end",a.ecart>0?"text-success":a.ecart<0?"text-danger":""])},_(a.ecart>0?"+":"")+_(a.ecart),3),n("td",null,[a.ecart!==0&&v.value?U((m(),f("input",{key:0,"onUpdate:modelValue":R=>a.comment=R,type:"text",class:"form-control form-control-sm",placeholder:"Explication de l'écart...",onBlur:R=>ze(a)},null,40,pn)),[[X,a.comment]]):a.ecart!==0&&a.comment?(m(),f("span",bn,_(a.comment),1)):(m(),f("span",gn,"—"))]),n("td",null,[v.value?(m(),f("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm","aria-label":"Retirer",onClick:R=>Ve(a.product_id)},[...e[26]||(e[26]=[n("i",{class:"bi bi-trash"},null,-1)])],8,yn)):j("",!0)])]))),128))])])])),x.value.length>0&&v.value?(m(),f("div",wn,[n("button",{type:"button",class:qe(["btn",D.value||L.value?"btn-secondary":"btn-success"]),disabled:D.value||L.value,onClick:$e},[...e[28]||(e[28]=[n("i",{class:"bi bi-check-lg me-1"},null,-1),C("Appliquer l'inventaire (mettre à jour les stocks) ",-1)])],10,hn),L.value&&x.value.length>0?(m(),f("p",_n,[...e[29]||(e[29]=[n("i",{class:"bi bi-wifi-off me-1"},null,-1),C("Reconnexion requise pour appliquer l'inventaire. ",-1)])])):j("",!0)])):j("",!0)])])])]),z.value?(m(),f("div",kn,[n("div",xn,[n("div",Sn,[n("div",Cn,[n("h5",En,"Quantité comptée — "+_((c=S.value)==null?void 0:c.nom),1),n("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=a=>z.value=!1),"aria-label":"Fermer"})]),n("div",jn,[n("p",Dn,[e[30]||(e[30]=C(" Unité : ",-1)),n("strong",null,_(((u=S.value)==null?void 0:u.unite)||"pièce"),1)]),e[31]||(e[31]=n("label",{class:"form-label"},"Quantité comptée",-1)),U(n("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>Z.value=a),type:"number",min:"0",step:"0.001",class:"form-control"},null,512),[[X,Z.value,void 0,{number:!0}]]),n("p",Pn,"Stock théorique actuel : "+_(((h=S.value)==null?void 0:h.stock)??0)+" "+_(((O=S.value)==null?void 0:O.unite)||"pièce"),1),e[32]||(e[32]=n("hr",{class:"my-3"},null,-1)),e[33]||(e[33]=n("label",{class:"form-label small text-muted"},"Corriger le code-barres",-1)),n("div",In,[U(n("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>te.value=a),type:"text",class:"form-control",placeholder:"Code EAN / code-barres",onKeydown:et(tt(Se,["prevent"]),["enter"])},null,40,qn),[[X,te.value]]),n("button",{type:"button",class:"btn btn-outline-secondary",title:"Mettre à jour le code-barres du produit",onClick:Se}," Mettre à jour ")]),W.value?(m(),f("p",Ln,_(W.value),1)):j("",!0)]),n("div",Nn,[n("button",{type:"button",class:"btn btn-secondary",onClick:e[6]||(e[6]=a=>z.value=!1)},"Annuler"),n("button",{type:"button",class:"btn btn-primary",onClick:Qe},"Ajouter")])])])])):j("",!0),ce.value?(m(),f("div",On,[n("div",Rn,[n("div",An,[n("div",Tn,[n("h5",Fn,"Code non trouvé : "+_(ee.value),1),n("button",{type:"button",class:"btn-close",onClick:H,"aria-label":"Fermer"})]),n("div",Mn,[e[34]||(e[34]=n("p",{class:"text-muted mb-3"}," Recherchez le produit correspondant et associez ce code-barres pour les prochains scans. ",-1)),n("div",Bn,[U(n("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>K.value=a),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[X,K.value]])]),n("div",Un,[(m(!0),f(Y,null,G(we.value,a=>(m(),f("button",{key:a.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",onClick:R=>Be(a)},[n("span",null,_(a.nom),1),n("span",Vn,"EAN : "+_(a.code_ean||"—"),1)],8,Qn))),128)),we.value.length===0?(m(),f("div",zn," Aucun produit ")):j("",!0)]),B.value?(m(),f("p",$n,_(B.value),1)):j("",!0)]),n("div",{class:"modal-footer"},[n("button",{type:"button",class:"btn btn-secondary",onClick:H},"Fermer")])])])])):j("",!0)])}}},Wn=ct(Kn,[["__scopeId","data-v-feefa774"]]),Te=nt(Wn);Te.use(at());Te.mount("#inventaire-app");
