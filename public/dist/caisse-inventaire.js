import{i as ge,y as we,o,c as n,a as t,b as f,j as ke,t as i,d as g,e as F,v as U,s as xe,F as $,l as O,n as Ce,p as Ee,w as Se,r as l,g as z,h as je}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{c as qe}from"./chunks/pinia-gLxYYWQL.js";import{_ as De}from"./chunks/BackButton-DzFd1NqY.js";import{K as Ne,L as Fe,M as X,N as Pe,O as le}from"./chunks/index-fBysSQKd.js";import{_ as Le}from"./chunks/_plugin-vue_export-helper-DlAUqK2U.js";const Ie="modulepreload",Me=function(K){return"/dist/"+K},ie={},Ve=function(c,x,P){let C=Promise.resolve();if(x&&x.length>0){let _=function(m){return Promise.all(m.map(w=>Promise.resolve(w).then(b=>({status:"fulfilled",value:b}),b=>({status:"rejected",reason:b}))))};document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),v=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));C=_(x.map(m=>{if(m=Me(m),m in ie)return;ie[m]=!0;const w=m.endsWith(".css"),b=w?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${b}`))return;const h=document.createElement("link");if(h.rel=w?"stylesheet":Ie,w||(h.as="script"),h.crossOrigin="",h.href=m,v&&h.setAttribute("nonce",v),document.head.appendChild(h),w)return new Promise((L,j)=>{h.addEventListener("load",L),h.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${m}`)))})}))}function S(_){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=_,window.dispatchEvent(u),!u.defaultPrevented)throw _}return C.then(_=>{for(const u of _||[])u.status==="rejected"&&S(u.reason);return c().catch(S)})},Ae={class:"container-fluid px-3 mt-4"},Ue={class:"row mb-3"},Re={class:"col-12"},Be={class:"d-flex justify-content-between align-items-center flex-wrap gap-2"},Qe={class:"d-flex gap-2"},Te={key:0,class:"alert alert-danger alert-dismissible show"},$e={key:1,class:"alert alert-info"},Oe={class:"mb-3"},ze=["disabled"],Ke={key:1,class:"d-flex align-items-center gap-2"},We={class:"badge bg-success"},He={class:"row"},Je={class:"col-lg-5 mb-4"},Ge={class:"card mb-3"},Xe={class:"card-body"},Ye={class:"mb-3"},Ze={key:0,class:"alert alert-warning mt-2 mb-0"},et={class:"d-flex gap-2"},tt=["disabled"],st={class:"card"},at={class:"card-body"},ot={class:"mb-2"},nt={class:"mb-2"},lt=["value"],it={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},rt=["disabled","onClick"],ut={class:"badge bg-secondary"},ct={key:0,class:"list-group-item text-muted text-center"},dt={class:"col-lg-7 mb-4"},vt={class:"card"},mt={class:"card-header d-flex justify-content-between align-items-center"},pt={class:"badge bg-primary"},bt={class:"card-body p-0"},ft={key:0,class:"p-4 text-center text-muted"},_t={key:1,class:"table-responsive"},ht={class:"table table-hover mb-0"},yt={class:"text-end"},gt={class:"text-end"},wt=["onUpdate:modelValue","onBlur"],kt={key:1,class:"small text-muted"},xt={key:2,class:"text-muted"},Ct=["onClick"],Et={key:2,class:"p-3 border-top"},St=["disabled"],jt={key:2,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},qt={class:"modal-dialog"},Dt={class:"modal-content"},Nt={class:"modal-header"},Ft={class:"modal-title"},Pt={class:"modal-body"},Lt={class:"small text-muted mb-2"},It={class:"small text-muted mt-2 mb-0"},Mt={class:"input-group"},Vt=["onKeydown"],At={key:0,class:"text-danger small mt-1 mb-0"},Ut={class:"modal-footer"},Rt={key:3,class:"modal d-block",tabindex:"-1",style:{background:"rgba(0,0,0,0.5)"}},Bt={class:"modal-dialog modal-lg"},Qt={class:"modal-content"},Tt={class:"modal-header"},$t={class:"modal-title"},Ot={class:"modal-body"},zt={class:"mb-2"},Kt={class:"list-group",style:{"max-height":"280px","overflow-y":"auto"}},Wt=["onClick"],Ht={class:"badge bg-secondary"},Jt={key:0,class:"list-group-item text-muted text-center"},Gt={key:0,class:"text-danger small mt-2 mb-0"},re=1500,Xt={__name:"CaisseInventairePage",setup(K){const c=l(null),x=l(null),P=l(null),C=l(null),S=l(!1),_=l(0),u=l(""),v=l(""),m=l(!1),w=l(!1),b=l([]),h=l([]),L=l(""),j=l(null),d=l(null),y=l([]),R=l([]),I=l(!1),p=l(null),B=l(0),M=l(null),W=l(!1),q=l(""),V=l(""),D=l(""),Q=l(""),A=l(""),H=z(()=>typeof window>"u"?!1:typeof window.BarcodeDetector=="function"?!0:!!(navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia=="function")),ce=z(()=>typeof window<"u"&&typeof window.BarcodeDetector=="function"),Y=z(()=>{let s=[...b.value];const e=(L.value||"").toLowerCase();return e&&(s=s.filter(r=>(r.nom||"").toLowerCase().includes(e))),j.value!=null&&(s=s.filter(r=>r.category_id===j.value)),s.slice(0,50)}),Z=z(()=>{let s=[...b.value];const e=(V.value||"").toLowerCase();return e&&(s=s.filter(r=>(r.nom||"").toLowerCase().includes(e))),s.slice(0,80)});function ee(s){return String(s||"").trim().replace(/\s/g,"")}function de(s){const e=ee(s);return b.value.find(r=>r.code_ean&&ee(r.code_ean)===e)}function te(s){const e=de(s);if(!e){R.value.unshift({code:s,productName:null,product_id:null,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),q.value=s,V.value="",D.value="",W.value=!0;return}R.value.unshift({code:s,productName:e.nom,product_id:e.id,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}),d.value&&G(e)}function J(){W.value=!1,q.value="",V.value="",D.value=""}async function ve(s){D.value="";try{await le(s.id,q.value);const e=b.value.findIndex(r=>r.id===s.id);e>=0&&(b.value[e]={...s,code_ean:q.value}),J(),d.value?G({...s,code_ean:q.value}):typeof window<"u"&&window.alert("Code-barres associé au produit « "+s.nom+" ». Vous pouvez rescanner pour l'ajouter à l'inventaire.")}catch(e){D.value=e.message||"Erreur lors de la mise à jour"}}async function me(){v.value="",m.value=!0;try{const s=await Fe();s.success&&s.inventaire&&(d.value=s.inventaire.id,y.value=[],R.value=[])}catch(s){v.value=s.message||"Erreur création session"}finally{m.value=!1}}function se(){d.value=null,y.value=[],R.value=[]}function G(s){p.value=s,B.value=Number(s.stock)??0,Q.value=s.code_ean!=null?String(s.code_ean).trim():"",A.value="",I.value=!0}async function ae(){if(!p.value)return;A.value="";const s=(Q.value||"").trim()||null;try{await le(p.value.id,s);const e=b.value.findIndex(r=>r.id===p.value.id);e>=0&&(b.value[e]={...b.value[e],code_ean:s}),p.value={...p.value,code_ean:s}}catch(e){A.value=e.message||"Erreur lors de la mise à jour"}}async function pe(){if(!p.value||!d.value)return;const s=Number(B.value);if(!(s<0)){v.value="";try{await X(d.value,p.value.id,s);const e=Number(p.value.stock)||0,r=s-e,k=y.value.find(N=>N.product_id===p.value.id);k?(k.quantite_comptee=s,k.stock_theorique=e,k.ecart=r):y.value.push({product_id:p.value.id,product_nom:p.value.nom,quantite_comptee:s,stock_theorique:e,ecart:r,comment:""}),I.value=!1}catch(e){v.value=e.message||"Erreur ajout ligne"}}}function be(s){y.value=y.value.filter(e=>e.product_id!==s),d.value&&X(d.value,s,0).catch(()=>{})}async function fe(s){if(!(!d.value||s.ecart===0)){v.value="";try{await X(d.value,s.product_id,s.quantite_comptee,s.comment||null)}catch(e){v.value=e.message||"Erreur sauvegarde commentaire"}}}async function _e(){if(!(!d.value||y.value.length===0)){v.value="",w.value=!0;try{await Pe(d.value),se(),v.value=null,typeof window<"u"&&window.alert("Inventaire appliqué. Les stocks ont été mis à jour.")}catch(s){v.value=s.message||"Erreur lors de l'application"}finally{w.value=!1}}}function oe(){var s;if(!(!P.value||!((s=c.value)!=null&&s.srcObject)||c.value.readyState<2)){if(c.value.videoWidth===0||c.value.videoHeight===0){setTimeout(oe,100);return}C.value=setInterval(he,350)}}function he(){var s;!P.value||!((s=c.value)!=null&&s.srcObject)||c.value.readyState<2||c.value.videoWidth===0||c.value.videoHeight===0||Date.now()-_.value<re||S.value||(S.value=!0,P.value.detect(c.value).then(e=>{(e==null?void 0:e.length)>0&&e[0].rawValue&&(_.value=Date.now(),te(e[0].rawValue))}).catch(()=>{}).finally(()=>{S.value=!1}))}async function ye(){if(u.value="",!H.value)return;const s=ce.value;try{if(s){P.value=new window.BarcodeDetector({formats:["ean_13","ean_8","upc_a","code_128","codabar"]});const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});x.value=e,c.value&&(c.value.srcObject=e,await c.value.play(),oe())}else{const{BrowserMultiFormatReader:e}=await Ve(async()=>{const{BrowserMultiFormatReader:a}=await import("./chunks/index-DD9CTm96.js");return{BrowserMultiFormatReader:a}},[]),r=new e,k=c.value;if(!k)throw new Error("Élément vidéo non trouvé");const N={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}}},T=await r.decodeFromConstraints(N,k,(a,E)=>{E||!a||Date.now()-_.value<re||(_.value=Date.now(),te(a.getText()))});M.value=T}}catch(e){u.value=e.message||"Impossible d'accéder à la caméra"}}function ne(){if(M.value){try{M.value.stop()}catch{}M.value=null}C.value&&(clearInterval(C.value),C.value=null),x.value&&(x.value.getTracks().forEach(s=>s.stop()),x.value=null),c.value&&(c.value.srcObject=null),u.value=""}return ge(async()=>{m.value=!0,v.value="";try{const s=await Ne();s.success&&s.produits&&(b.value=s.produits),s.success&&s.categories&&(h.value=s.categories||[])}catch(s){v.value=s.message||"Erreur chargement produits"}finally{m.value=!1}}),we(()=>{ne()}),(s,e)=>{var r,k,N,T;return o(),n("div",Ae,[t("div",Ue,[t("div",Re,[t("div",Be,[e[11]||(e[11]=t("h2",{class:"mb-0"},[t("i",{class:"bi bi-upc-scan me-2"}),f("Inventaire")],-1)),t("div",Qe,[ke(De),e[8]||(e[8]=t("a",{href:"/caisse/inventaires-historique",class:"btn btn-outline-secondary"},"Historique inventaires",-1)),e[9]||(e[9]=t("a",{href:"/caisse/stock-mouvements",class:"btn btn-outline-secondary"},"Mouvements stock",-1)),e[10]||(e[10]=t("a",{href:"/caisse",class:"btn btn-outline-primary"},[t("i",{class:"bi bi-arrow-left me-2"}),f("Retour caisse ")],-1))])]),e[12]||(e[12]=t("p",{class:"text-muted small mb-0 mt-2"}," Scan caméra ou recherche produit (sans code-barres). Démarrer une session, ajouter des lignes, puis appliquer l'inventaire. ",-1))])]),v.value?(o(),n("div",Te,[f(i(v.value)+" ",1),t("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=a=>v.value=null),"aria-label":"Fermer"})])):g("",!0),H.value?g("",!0):(o(),n("div",$e,[...e[13]||(e[13]=[t("i",{class:"bi bi-info-circle me-2"},null,-1),f(" Scan caméra n’est pas disponible. Utilisez la ",-1),t("strong",null,"recherche produit",-1),f(" ci-dessous (nom ou catégorie) pour ajouter des lignes à l’inventaire. ",-1)])])),t("div",Oe,[d.value?(o(),n("div",Ke,[t("span",We,"Session #"+i(d.value),1),t("button",{type:"button",class:"btn btn-outline-secondary btn-sm",onClick:se}," Nouvelle session ")])):(o(),n("button",{key:0,type:"button",class:"btn btn-primary",disabled:m.value,onClick:me},[...e[14]||(e[14]=[t("i",{class:"bi bi-play-fill me-1"},null,-1),f("Démarrer une session d'inventaire ",-1)])],8,ze))]),t("div",He,[t("div",Je,[t("div",Ge,[e[17]||(e[17]=t("div",{class:"card-header bg-success text-white"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-camera-video me-2"}),f("Scan code-barres")])],-1)),t("div",Xe,[t("div",Ye,[t("video",{ref_key:"videoEl",ref:c,class:"rounded border w-100",style:{"max-width":"100%",background:"#000","aspect-ratio":"4/3"},playsinline:"",muted:""},null,512),u.value?(o(),n("div",Ze,i(u.value),1)):g("",!0)]),t("div",et,[!x.value&&!M.value?(o(),n("button",{key:0,type:"button",class:"btn btn-success",disabled:!H.value||m.value,onClick:ye},[...e[15]||(e[15]=[t("i",{class:"bi bi-camera-video me-1"},null,-1),f("Démarrer la caméra ",-1)])],8,tt)):(o(),n("button",{key:1,type:"button",class:"btn btn-secondary",onClick:ne},[...e[16]||(e[16]=[t("i",{class:"bi bi-stop-circle me-1"},null,-1),f("Arrêter ",-1)])]))])])]),t("div",st,[e[19]||(e[19]=t("div",{class:"card-header"},[t("h5",{class:"mb-0"},[t("i",{class:"bi bi-search me-2"}),f("Recherche produit (sans code-barres)")])],-1)),t("div",at,[t("div",ot,[F(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>L.value=a),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[U,L.value]])]),t("div",nt,[F(t("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>j.value=a),class:"form-select"},[e[18]||(e[18]=t("option",{value:null},"Toutes les catégories",-1)),(o(!0),n($,null,O(h.value,a=>(o(),n("option",{key:a.id,value:a.id},i(a.nom),9,lt))),128))],512),[[xe,j.value]])]),t("div",it,[(o(!0),n($,null,O(Y.value,a=>(o(),n("button",{key:a.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",disabled:!d.value,onClick:E=>G(a)},[t("span",null,i(a.nom),1),t("span",ut,"Stock: "+i(a.stock??0),1)],8,rt))),128)),Y.value.length===0?(o(),n("div",ct," Aucun produit ")):g("",!0)])])])]),t("div",dt,[t("div",vt,[t("div",mt,[e[20]||(e[20]=t("h5",{class:"mb-0"},[t("i",{class:"bi bi-list-ul me-2"}),f("Lignes d'inventaire")],-1)),t("span",pt,i(y.value.length),1)]),t("div",bt,[y.value.length===0?(o(),n("div",ft," Scannez des codes-barres ou ajoutez des produits par recherche pour constituer les lignes. ")):(o(),n("div",_t,[t("table",ht,[e[22]||(e[22]=t("thead",null,[t("tr",null,[t("th",null,"Produit"),t("th",{class:"text-end"},"Qté comptée"),t("th",{class:"text-end"},"Stock théorique"),t("th",{class:"text-end"},"Écart"),t("th",null,"Commentaire (écart)"),t("th")])],-1)),t("tbody",null,[(o(!0),n($,null,O(y.value,a=>(o(),n("tr",{key:a.product_id},[t("td",null,i(a.product_nom),1),t("td",yt,i(a.quantite_comptee),1),t("td",gt,i(a.stock_theorique),1),t("td",{class:Ce(["text-end",a.ecart>0?"text-success":a.ecart<0?"text-danger":""])},i(a.ecart>0?"+":"")+i(a.ecart),3),t("td",null,[a.ecart!==0&&d.value?F((o(),n("input",{key:0,"onUpdate:modelValue":E=>a.comment=E,type:"text",class:"form-control form-control-sm",placeholder:"Explication de l'écart...",onBlur:E=>fe(a)},null,40,wt)),[[U,a.comment]]):a.ecart!==0&&a.comment?(o(),n("span",kt,i(a.comment),1)):(o(),n("span",xt,"—"))]),t("td",null,[d.value?(o(),n("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm","aria-label":"Retirer",onClick:E=>be(a.product_id)},[...e[21]||(e[21]=[t("i",{class:"bi bi-trash"},null,-1)])],8,Ct)):g("",!0)])]))),128))])])])),y.value.length>0&&d.value?(o(),n("div",Et,[t("button",{type:"button",class:"btn btn-success",disabled:w.value,onClick:_e},[...e[23]||(e[23]=[t("i",{class:"bi bi-check-lg me-1"},null,-1),f("Appliquer l'inventaire (mettre à jour les stocks) ",-1)])],8,St)])):g("",!0)])])])]),I.value?(o(),n("div",jt,[t("div",qt,[t("div",Dt,[t("div",Nt,[t("h5",Ft,"Quantité comptée — "+i((r=p.value)==null?void 0:r.nom),1),t("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=a=>I.value=!1),"aria-label":"Fermer"})]),t("div",Pt,[t("p",Lt,[e[24]||(e[24]=f(" Unité : ",-1)),t("strong",null,i(((k=p.value)==null?void 0:k.unite)||"pièce"),1)]),e[25]||(e[25]=t("label",{class:"form-label"},"Quantité comptée",-1)),F(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>B.value=a),type:"number",min:"0",step:"0.001",class:"form-control"},null,512),[[U,B.value,void 0,{number:!0}]]),t("p",It,"Stock théorique actuel : "+i(((N=p.value)==null?void 0:N.stock)??0)+" "+i(((T=p.value)==null?void 0:T.unite)||"pièce"),1),e[26]||(e[26]=t("hr",{class:"my-3"},null,-1)),e[27]||(e[27]=t("label",{class:"form-label small text-muted"},"Corriger le code-barres",-1)),t("div",Mt,[F(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>Q.value=a),type:"text",class:"form-control",placeholder:"Code EAN / code-barres",onKeydown:Ee(Se(ae,["prevent"]),["enter"])},null,40,Vt),[[U,Q.value]]),t("button",{type:"button",class:"btn btn-outline-secondary",title:"Mettre à jour le code-barres du produit",onClick:ae}," Mettre à jour ")]),A.value?(o(),n("p",At,i(A.value),1)):g("",!0)]),t("div",Ut,[t("button",{type:"button",class:"btn btn-secondary",onClick:e[6]||(e[6]=a=>I.value=!1)},"Annuler"),t("button",{type:"button",class:"btn btn-primary",onClick:pe},"Ajouter")])])])])):g("",!0),W.value?(o(),n("div",Rt,[t("div",Bt,[t("div",Qt,[t("div",Tt,[t("h5",$t,"Code non trouvé : "+i(q.value),1),t("button",{type:"button",class:"btn-close",onClick:J,"aria-label":"Fermer"})]),t("div",Ot,[e[28]||(e[28]=t("p",{class:"text-muted mb-3"}," Recherchez le produit correspondant et associez ce code-barres pour les prochains scans. ",-1)),t("div",zt,[F(t("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>V.value=a),type:"text",class:"form-control",placeholder:"Rechercher par nom..."},null,512),[[U,V.value]])]),t("div",Kt,[(o(!0),n($,null,O(Z.value,a=>(o(),n("button",{key:a.id,type:"button",class:"list-group-item list-group-item-action d-flex justify-content-between align-items-center",onClick:E=>ve(a)},[t("span",null,i(a.nom),1),t("span",Ht,"EAN : "+i(a.code_ean||"—"),1)],8,Wt))),128)),Z.value.length===0?(o(),n("div",Jt," Aucun produit ")):g("",!0)]),D.value?(o(),n("p",Gt,i(D.value),1)):g("",!0)]),t("div",{class:"modal-footer"},[t("button",{type:"button",class:"btn btn-secondary",onClick:J},"Fermer")])])])])):g("",!0)])}}},Yt=Le(Xt,[["__scopeId","data-v-dc81ddb0"]]),ue=je(Yt);ue.use(qe());ue.mount("#inventaire-app");
