import{i as f,o as n,c as a,a as s,u as o,t as r,b as u,j as g,F as c,l as m,n as y,e as h,s as R,v,d as x,h as A}from"./chunks/runtime-dom.esm-bundler-CuNObg1-.js";import{d as k,c as w}from"./chunks/pinia-gLxYYWQL.js";import{_ as I}from"./chunks/BackButton-DzFd1NqY.js";import{a7 as D,a8 as C,a9 as U,aa as M,ab as E}from"./chunks/index-CQL6Akic.js";const P=k("adminUserRoles",{state:()=>({userId:null,user:null,availableRoles:[],userRoles:[],effectivePermissions:{},loading:!0,error:null,showAddModal:!1,selectedRoleId:null,expiresAt:null,reason:""}),getters:{permissionCount(i){return Object.values(i.effectivePermissions).reduce((e,d)=>e+d.length,0)},userRoleIds(i){return i.userRoles.map(e=>e.id)}},actions:{setUserId(i){this.userId=i},hasRole(i){return this.userRoles.some(e=>e.id===i)},async loadData(){if(!this.userId){this.loading=!1,this.error="ID utilisateur manquant";return}this.loading=!0,this.error=null;try{const[i,e,d]=await Promise.all([U(),M(this.userId),E(this.userId)]);i.success&&(this.availableRoles=i.roles||[]),e.success&&(this.userRoles=e.roles||[]),d.success&&(this.effectivePermissions=d.permissions||{})}catch(i){this.error=i.message||"Erreur de chargement des données"}finally{this.loading=!1}},openAddModal(){this.selectedRoleId=null,this.expiresAt=null,this.reason="",this.showAddModal=!0},closeModal(){this.showAddModal=!1},async assignRole(){if(!this.selectedRoleId){alert("Veuillez sélectionner un rôle");return}try{const i=await C(this.userId,{role_id:this.selectedRoleId,expires_at:this.expiresAt||null,reason:this.reason||null});i.success?(this.closeModal(),await this.loadData()):alert("Erreur: "+i.error)}catch(i){alert(i.message||"Erreur lors de l'assignation")}},async removeRole(i){if(confirm("Êtes-vous sûr de vouloir retirer ce rôle ?"))try{const e=await D(this.userId,i);e.success?await this.loadData():alert("Erreur: "+e.error)}catch(e){alert(e.message||"Erreur lors du retrait")}}}}),S={class:"admin-content-wrapper"},V={class:"container-fluid mt-4"},j={key:0,class:"text-center py-5"},$={key:1,class:"alert alert-danger"},N={key:2},L={class:"d-flex justify-content-between align-items-center mb-4"},B={class:"d-flex gap-2"},T={class:"card mb-4"},q={class:"card-header"},z={class:"mb-0"},F={class:"card-body"},O={key:0,class:"text-muted"},G={key:1,class:"table-responsive"},H={class:"table"},J=["onClick"],K={class:"card"},Q={class:"card-header"},W={class:"mb-0"},X={class:"card-body"},Y={key:0,class:"text-muted"},Z={key:1},ss={class:"text-uppercase"},es={class:"badge bg-secondary"},ts={class:"row"},ls={class:"small"},os={class:"text-muted"},is={key:3,class:"modal show d-block",tabindex:"-1",style:{"background-color":"rgba(0,0,0,0.5)"}},ns={class:"modal-dialog"},as={class:"modal-content"},rs={class:"modal-header"},ds={class:"modal-body"},us={class:"mb-3"},cs=["value","disabled"],ms={class:"mb-3"},ps={class:"mb-3"},bs={class:"modal-footer"},hs={__name:"AdminUserRolesPage",setup(i){const e=P();return f(()=>{const d=typeof window<"u"&&window.USER_ID!=null?Number(window.USER_ID):null;e.setUserId(d),e.loadData()}),(d,t)=>(n(),a("div",S,[s("div",V,[o(e).loading?(n(),a("div",j,[...t[7]||(t[7]=[s("div",{class:"spinner-border text-primary",role:"status"},null,-1),s("p",{class:"mt-3 text-muted"},"Chargement...",-1)])])):o(e).error?(n(),a("div",$,r(o(e).error),1)):(n(),a("div",N,[s("div",L,[t[9]||(t[9]=s("h2",{class:"mb-0"},[s("i",{class:"bi bi-person-badge me-2"}),u("Rôles de l'utilisateur")],-1)),s("div",B,[g(I),s("button",{onClick:t[0]||(t[0]=l=>o(e).openAddModal()),class:"btn btn-primary"},[...t[8]||(t[8]=[s("i",{class:"bi bi-plus-lg me-2"},null,-1),u("Ajouter un rôle ",-1)])])])]),s("div",T,[s("div",q,[s("h5",z,"Rôles Actuels ("+r(o(e).userRoles.length)+")",1)]),s("div",F,[o(e).userRoles.length===0?(n(),a("div",O,"Aucun rôle assigné")):(n(),a("div",G,[s("table",H,[t[11]||(t[11]=s("thead",{class:"thead-admin-site"},[s("tr",null,[s("th",null,"Rôle"),s("th",null,"Type"),s("th",null,"Assigné le"),s("th",null,"Expire le"),s("th",null,"Actions")])],-1)),s("tbody",null,[(n(!0),a(c,null,m(o(e).userRoles,l=>(n(),a("tr",{key:l.id},[s("td",null,[s("strong",null,r(l.display_name),1)]),s("td",null,[s("span",{class:y(["badge",l.is_system?"bg-primary":"bg-success"])},r(l.is_system?"Système":"Custom"),3)]),s("td",null,r(l.assigned_at?new Date(l.assigned_at).toLocaleDateString():"—"),1),s("td",null,r(l.expires_at?new Date(l.expires_at).toLocaleDateString():"Permanent"),1),s("td",null,[s("button",{onClick:p=>o(e).removeRole(l.id),class:"btn btn-sm btn-outline-danger"},[...t[10]||(t[10]=[s("i",{class:"bi bi-trash"},null,-1)])],8,J)])]))),128))])])]))])]),s("div",K,[s("div",Q,[s("h5",W,"Permissions Effectives ("+r(o(e).permissionCount)+")",1),t[12]||(t[12]=s("small",{class:"text-muted"},"Cumul de toutes les permissions des rôles assignés",-1))]),s("div",X,[o(e).permissionCount===0?(n(),a("div",Y,"Aucune permission")):(n(),a("div",Z,[(n(!0),a(c,null,m(o(e).effectivePermissions,(l,p)=>(n(),a("div",{key:p,class:"mb-3"},[s("h6",ss,[u(r(p)+" ",1),s("span",es,r(l.length),1)]),s("div",ts,[(n(!0),a(c,null,m(l,b=>(n(),a("div",{key:b.id,class:"col-md-6 mb-2"},[s("div",ls,[t[13]||(t[13]=s("i",{class:"bi bi-check-circle text-success me-1"},null,-1)),u(" "+r(b.display_name)+" ",1),s("span",os,"("+r(b.from_roles)+")",1)])]))),128))])]))),128))]))])])])),o(e).showAddModal?(n(),a("div",is,[s("div",ns,[s("div",as,[s("div",rs,[t[14]||(t[14]=s("h5",{class:"modal-title"},"Ajouter un rôle",-1)),s("button",{type:"button",class:"btn-close",onClick:t[1]||(t[1]=l=>o(e).closeModal())})]),s("div",ds,[s("div",us,[t[16]||(t[16]=s("label",{class:"form-label"},"Rôle *",-1)),h(s("select",{"onUpdate:modelValue":t[2]||(t[2]=l=>o(e).selectedRoleId=l),class:"form-select",required:""},[t[15]||(t[15]=s("option",{value:null},"Sélectionner un rôle",-1)),(n(!0),a(c,null,m(o(e).availableRoles,l=>(n(),a("option",{key:l.id,value:l.id,disabled:o(e).hasRole(l.id)},r(l.display_name)+" "+r(o(e).hasRole(l.id)?"(déjà assigné)":""),9,cs))),128))],512),[[R,o(e).selectedRoleId]])]),s("div",ms,[t[17]||(t[17]=s("label",{class:"form-label"},"Date d'expiration (optionnel)",-1)),h(s("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>o(e).expiresAt=l),type:"datetime-local",class:"form-control"},null,512),[[v,o(e).expiresAt]]),t[18]||(t[18]=s("small",{class:"form-text text-muted"},"Laisser vide pour un rôle permanent",-1))]),s("div",ps,[t[19]||(t[19]=s("label",{class:"form-label"},"Raison (optionnel)",-1)),h(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=l=>o(e).reason=l),class:"form-control",rows:"2",placeholder:"Ex: Remplacement temporaire pendant congés"},null,512),[[v,o(e).reason]])])]),s("div",bs,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[5]||(t[5]=l=>o(e).closeModal())},"Annuler"),s("button",{type:"button",class:"btn btn-primary",onClick:t[6]||(t[6]=l=>o(e).assignRole())},"Assigner")])])])])):x("",!0)])]))}},_=A(hs);_.use(w());_.mount("#admin-user-roles-app");
