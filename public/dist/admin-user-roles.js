import{i as f,o as i,c as a,a as s,u as o,t as r,b as u,F as c,k as m,n as g,e as h,q as y,v,d as R,h as x}from"./chunks/runtime-dom.esm-bundler-C8CGTSXe.js";import{d as A,c as k}from"./chunks/pinia-DIU_KYYh.js";import{a0 as w,a1 as I,a2 as D,a3 as C,a4 as U}from"./chunks/index-zlPV8JO4.js";const M=A("adminUserRoles",{state:()=>({userId:null,user:null,availableRoles:[],userRoles:[],effectivePermissions:{},loading:!0,error:null,showAddModal:!1,selectedRoleId:null,expiresAt:null,reason:""}),getters:{permissionCount(n){return Object.values(n.effectivePermissions).reduce((e,d)=>e+d.length,0)},userRoleIds(n){return n.userRoles.map(e=>e.id)}},actions:{setUserId(n){this.userId=n},hasRole(n){return this.userRoles.some(e=>e.id===n)},async loadData(){if(!this.userId){this.loading=!1,this.error="ID utilisateur manquant";return}this.loading=!0,this.error=null;try{const[n,e,d]=await Promise.all([D(),C(this.userId),U(this.userId)]);n.success&&(this.availableRoles=n.roles||[]),e.success&&(this.userRoles=e.roles||[]),d.success&&(this.effectivePermissions=d.permissions||{})}catch(n){this.error=n.message||"Erreur de chargement des données"}finally{this.loading=!1}},openAddModal(){this.selectedRoleId=null,this.expiresAt=null,this.reason="",this.showAddModal=!0},closeModal(){this.showAddModal=!1},async assignRole(){if(!this.selectedRoleId){alert("Veuillez sélectionner un rôle");return}try{const n=await I(this.userId,{role_id:this.selectedRoleId,expires_at:this.expiresAt||null,reason:this.reason||null});n.success?(this.closeModal(),await this.loadData()):alert("Erreur: "+n.error)}catch(n){alert(n.message||"Erreur lors de l'assignation")}},async removeRole(n){if(confirm("Êtes-vous sûr de vouloir retirer ce rôle ?"))try{const e=await w(this.userId,n);e.success?await this.loadData():alert("Erreur: "+e.error)}catch(e){alert(e.message||"Erreur lors du retrait")}}}}),E={class:"admin-content-wrapper"},P={class:"container-fluid mt-4"},S={key:0,class:"text-center py-5"},V={key:1,class:"alert alert-danger"},j={key:2},$={class:"d-flex justify-content-between align-items-center mb-4"},L={class:"card mb-4"},N={class:"card-header"},q={class:"mb-0"},B={class:"card-body"},T={key:0,class:"text-muted"},z={key:1,class:"table-responsive"},F={class:"table"},O=["onClick"],G={class:"card"},H={class:"card-header"},J={class:"mb-0"},K={class:"card-body"},Q={key:0,class:"text-muted"},W={key:1},X={class:"text-uppercase"},Y={class:"badge bg-secondary"},Z={class:"row"},ss={class:"small"},es={class:"text-muted"},ts={key:3,class:"modal show d-block",tabindex:"-1",style:{"background-color":"rgba(0,0,0,0.5)"}},ls={class:"modal-dialog"},os={class:"modal-content"},ns={class:"modal-header"},is={class:"modal-body"},as={class:"mb-3"},rs=["value","disabled"],ds={class:"mb-3"},us={class:"mb-3"},cs={class:"modal-footer"},ms={__name:"AdminUserRolesPage",setup(n){const e=M();return f(()=>{const d=typeof window<"u"&&window.USER_ID!=null?Number(window.USER_ID):null;e.setUserId(d),e.loadData()}),(d,t)=>(i(),a("div",E,[s("div",P,[o(e).loading?(i(),a("div",S,[...t[7]||(t[7]=[s("div",{class:"spinner-border text-primary",role:"status"},null,-1),s("p",{class:"mt-3 text-muted"},"Chargement...",-1)])])):o(e).error?(i(),a("div",V,r(o(e).error),1)):(i(),a("div",j,[s("div",$,[t[9]||(t[9]=s("h2",null,[s("i",{class:"bi bi-person-badge me-2"}),u("Rôles de l'utilisateur")],-1)),s("button",{onClick:t[0]||(t[0]=l=>o(e).openAddModal()),class:"btn btn-primary"},[...t[8]||(t[8]=[s("i",{class:"bi bi-plus-lg me-2"},null,-1),u("Ajouter un rôle ",-1)])])]),s("div",L,[s("div",N,[s("h5",q,"Rôles Actuels ("+r(o(e).userRoles.length)+")",1)]),s("div",B,[o(e).userRoles.length===0?(i(),a("div",T,"Aucun rôle assigné")):(i(),a("div",z,[s("table",F,[t[11]||(t[11]=s("thead",{class:"thead-admin-site"},[s("tr",null,[s("th",null,"Rôle"),s("th",null,"Type"),s("th",null,"Assigné le"),s("th",null,"Expire le"),s("th",null,"Actions")])],-1)),s("tbody",null,[(i(!0),a(c,null,m(o(e).userRoles,l=>(i(),a("tr",{key:l.id},[s("td",null,[s("strong",null,r(l.display_name),1)]),s("td",null,[s("span",{class:g(["badge",l.is_system?"bg-primary":"bg-success"])},r(l.is_system?"Système":"Custom"),3)]),s("td",null,r(l.assigned_at?new Date(l.assigned_at).toLocaleDateString():"—"),1),s("td",null,r(l.expires_at?new Date(l.expires_at).toLocaleDateString():"Permanent"),1),s("td",null,[s("button",{onClick:p=>o(e).removeRole(l.id),class:"btn btn-sm btn-outline-danger"},[...t[10]||(t[10]=[s("i",{class:"bi bi-trash"},null,-1)])],8,O)])]))),128))])])]))])]),s("div",G,[s("div",H,[s("h5",J,"Permissions Effectives ("+r(o(e).permissionCount)+")",1),t[12]||(t[12]=s("small",{class:"text-muted"},"Cumul de toutes les permissions des rôles assignés",-1))]),s("div",K,[o(e).permissionCount===0?(i(),a("div",Q,"Aucune permission")):(i(),a("div",W,[(i(!0),a(c,null,m(o(e).effectivePermissions,(l,p)=>(i(),a("div",{key:p,class:"mb-3"},[s("h6",X,[u(r(p)+" ",1),s("span",Y,r(l.length),1)]),s("div",Z,[(i(!0),a(c,null,m(l,b=>(i(),a("div",{key:b.id,class:"col-md-6 mb-2"},[s("div",ss,[t[13]||(t[13]=s("i",{class:"bi bi-check-circle text-success me-1"},null,-1)),u(" "+r(b.display_name)+" ",1),s("span",es,"("+r(b.from_roles)+")",1)])]))),128))])]))),128))]))])])])),o(e).showAddModal?(i(),a("div",ts,[s("div",ls,[s("div",os,[s("div",ns,[t[14]||(t[14]=s("h5",{class:"modal-title"},"Ajouter un rôle",-1)),s("button",{type:"button",class:"btn-close",onClick:t[1]||(t[1]=l=>o(e).closeModal())})]),s("div",is,[s("div",as,[t[16]||(t[16]=s("label",{class:"form-label"},"Rôle *",-1)),h(s("select",{"onUpdate:modelValue":t[2]||(t[2]=l=>o(e).selectedRoleId=l),class:"form-select",required:""},[t[15]||(t[15]=s("option",{value:null},"Sélectionner un rôle",-1)),(i(!0),a(c,null,m(o(e).availableRoles,l=>(i(),a("option",{key:l.id,value:l.id,disabled:o(e).hasRole(l.id)},r(l.display_name)+" "+r(o(e).hasRole(l.id)?"(déjà assigné)":""),9,rs))),128))],512),[[y,o(e).selectedRoleId]])]),s("div",ds,[t[17]||(t[17]=s("label",{class:"form-label"},"Date d'expiration (optionnel)",-1)),h(s("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>o(e).expiresAt=l),type:"datetime-local",class:"form-control"},null,512),[[v,o(e).expiresAt]]),t[18]||(t[18]=s("small",{class:"form-text text-muted"},"Laisser vide pour un rôle permanent",-1))]),s("div",us,[t[19]||(t[19]=s("label",{class:"form-label"},"Raison (optionnel)",-1)),h(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=l=>o(e).reason=l),class:"form-control",rows:"2",placeholder:"Ex: Remplacement temporaire pendant congés"},null,512),[[v,o(e).reason]])])]),s("div",cs,[s("button",{type:"button",class:"btn btn-secondary",onClick:t[5]||(t[5]=l=>o(e).closeModal())},"Annuler"),s("button",{type:"button",class:"btn btn-primary",onClick:t[6]||(t[6]=l=>o(e).assignRole())},"Assigner")])])])])):R("",!0)])]))}},_=x(ms);_.use(k());_.mount("#admin-user-roles-app");
